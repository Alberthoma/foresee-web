<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>
      Gestor de Presupuesto Web
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <script type="module">
              import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
              import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
              import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
              // Variables globales para Firebase (serán accesibles en el script principal)
              window.firebaseApp = null;
              window.db = null;
              window.auth = null;
              window.onAuthStateChanged = onAuthStateChanged;
              window.signInAnonymously = signInAnonymously;
              window.signInWithCustomToken = signInWithCustomToken;
              // Se asignan directamente las funciones importadas a window
              window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
              window.signInWithEmailAndPassword = signInWithEmailAndPassword;
              window.signOut = signOut;

              // ===== AÑADE ESTAS 3 LÍNEAS AQUÍ =====
              window.EmailAuthProvider = EmailAuthProvider;
              window.reauthenticateWithCredential = reauthenticateWithCredential;
              window.updatePassword = updatePassword;

              window.getFirestore = getFirestore;
              window.doc = doc;
              window.getDoc = getDoc;
              window.setDoc = setDoc;
              window.updateDoc = updateDoc;
              window.deleteDoc = deleteDoc;
              window.onSnapshot = onSnapshot;
              window.collection = collection;
              window.query = query;
              window.getDocs = getDocs;
              window.writeBatch = writeBatch;
      
              // Inicializar Firebase
              const firebaseConfig = {
                  apiKey: "AIzaSyCTicX5tqqVr3pK_RFqgvqpRavsUuTvS2g",
                  authDomain: "wittfinances-282f1.firebaseapp.com",
                  projectId: "wittfinances-282f1",
                  storageBucket: "wittfinances-282f1.firebasestorage.app",
                  messagingSenderId: "998192322959",
                  appId: "1:998192322959:web:e2afcdd7f47da3767853fa"
              };
      
              console.log("[Firebase Init] Configuración de Firebase recibida:", firebaseConfig); // Debugging
      
              if (firebaseConfig && firebaseConfig.projectId) {
                  window.firebaseApp = initializeApp(firebaseConfig);
                  window.db = getFirestore(window.firebaseApp);
                  window.auth = getAuth(window.firebaseApp);
                  // Hacemos el projectId accesible globalmente para construir las rutas de Firestore
                  window.firebaseProjectId = firebaseConfig.projectId;
                  console.log("[Firebase Init] Firebase inicializado con éxito."); // Debugging
              } else {
                  console.error("[Firebase Init] ERROR: 'projectId' no proporcionado en la configuración de Firebase.");
                  console.error("Asegúrate de que estás ejecutando la aplicación en un entorno que inyecta __firebase_config (como Canvas o Firebase Hosting).");
                  // Mostrar un mensaje de error al usuario si la inicialización falla
                  document.addEventListener('DOMContentLoaded', () => {
                      const loadingOverlay = document.getElementById('loading-overlay');
                      const messageModal = document.getElementById('message-modal');
                      const messageModalTitle = document.getElementById('message-modal-title');
                      const messageModalContent = document.getElementById('message-modal-content');
                      const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
      
                      loadingOverlay.classList.remove('active'); // Ocultar spinner
                      messageModalTitle.textContent = "Error de Configuración de Firebase";
                      messageModalContent.textContent = "La aplicación no pudo conectarse a Firebase. Asegúrate de que el proyecto esté configurado correctamente y que la aplicación se ejecute en un servidor (Firebase Hosting o localmente con 'firebase serve').";
                      messageModal.classList.add('active');
                      messageModalCloseBtn.addEventListener('click', () => messageModal.classList.remove('active'));
                  });
              }
    </script>
    <style>

/* ====================================================================== */
              /* TEMA OSCURO Y RESPONSIVO v2.1 by Gemini - CON MEJORAS             */
              /* ====================================================================== */

              /* --- Variables de Color para el Tema Oscuro --- */
              :root {
                  --bg-dark-primary: #111827;     /* Fondo principal (casi negro) */
                  --bg-dark-secondary: #1f2937;  /* Fondo para tarjetas y modales */
                  --bg-dark-tertiary: #374151;   /* Fondo para inputs y elementos sutiles */
                  --border-dark: #4b5563;        /* Color de bordes */
                  --text-light-primary: #f3f4f6; /* Texto principal (casi blanco) */
                  --text-light-secondary: #9ca3af;/* Texto secundario (gris claro) */
                  
                  /* Colores Eléctricos / Vibrantes */
                  --electric-blue: #0ea5e9;      /* Azul cielo brillante */
                  --electric-green: #22c55e;     /* Verde lima */
                  --electric-red: #ef4444;       /* Rojo vibrante */
                  --electric-orange: #f97316;    /* Naranja */
                  --electric-purple: #8b5cf6;    /* Púrpura */
                  
                  /* Colores para transacciones */
                  --income-color: var(--electric-green);
                  --expense-color: var(--electric-red);
                  --balance-color: var(--electric-blue);
                  --transfer-bg: rgba(14, 165, 233, 0.1); /* Fondo azul translúcido */
              }

              /* --- Estructura Principal y Footer Fijo --- */
              html {
                height: 100%;
              }
              body { 
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 0;
                background-color: var(--bg-dark-primary); /* FONDO OSCURO PRINCIPAL */
                color: var(--text-light-primary);
                transition: margin-top 0.3s ease-in-out;
                display: flex; /* Activa Flexbox */
                flex-direction: column; /* Apila los elementos verticalmente */
                min-height: 100%; /* Ocupa al menos toda la altura de la pantalla */
              }
              #main-content-wrapper {
                flex-grow: 1; /* Hace que el contenido principal crezca para empujar el footer hacia abajo */
              }
              footer {
                flex-shrink: 0; /* Evita que el footer se encoja */
                background-color: var(--bg-dark-secondary);
                border-top: 1px solid var(--border-dark);
              }

              .container {
                  padding: 1px 1rem;
              }

              /* --- Encabezado Principal (Header) --- */
              #main-header-bar {
                transition: height 0.3s ease-in-out;                
              }

              /* Clase para ocultar el header con un deslizamiento suave */
              .header-hidden {
                  transform: translateY(-100%);
              }

              #barr {
                background-color: var(--bg-dark-tertiary);
                transition: all 0.3s ease-in-out;/*
                border-bottom: 0.5px solid var(--electric-blue);*/
              }
              #barr h1 {
                font-size: 1.5rem;
                color: var(--text-light-primary);
              }
              #barr #ptitul {
                font-size: 0.8rem;
                color: var(--text-light-secondary);
              }
              #logout-btn {
                  background: var(--bg-dark-tertiary);
                  color: var(--text-light-primary);
                  padding: 4px;
                  border-radius:9999px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  border: 1px solid var(--border-dark);
                  transition: all 0.2s ease;
              }
              #logout-btn:hover {
                background-color: var(--electric-red);
                border-color: var(--electric-red);
                color: white;
              }
              .btn-philosophy {
                  background-color: transparent;
                  border: 1px solid var(--border-dark);
                  padding: 4px 12px;
                  border-radius: 9999px;
                  margin-top: 8px;
                  color: var(--text-light-secondary);
                  font-size: 0.75rem;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease-in-out;
              }
              .btn-philosophy:hover {
                  background-color: var(--electric-blue);
                  color: white;
                  border-color: var(--electric-blue);
                  transform: scale(1.05);
              }

              .btcloseScreen{
                  background-color: transparent;
                  border: 1px solid var(--border-dark);
                  padding: 4px 12px;
                  border-radius: 9999px;
                  margin-top: 1px;
                  color: var(--text-light-secondary);
                  font-size: 0.75rem;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease-in-out;
              }
              .btcloseScreen:hover {
                  background-color: var(--electric-blue);
                  color: white;
                  border-color: var(--electric-blue);
                  transform: scale(1.05);
              }

              .btOpenScreen{
                  background-color: transparent;
                  border: 1px solid var(--border-dark);
                  padding: 4px 12px;
                  border-radius: 9999px;
                  margin-top: 4px;
                  color: var(--text-light-secondary);
                  font-size: 0.75rem;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease-in-out;
              }
              .btOpenScreen:hover {
                  background-color: var(--electric-blue);
                  color: white;
                  border-color: var(--electric-blue);
                  transform: scale(1.05);
              }                 

              /* --- Panel Principal (Dashboard) --- */
              #dashboard > div {
                background-color: var(--bg-dark-secondary);
                border: 1px solid var(--border-dark);
                height: auto;
                min-height: 80px;
                padding: 1rem;          
                border: 1px solid var(--border-dark);
                border-radius: 0.75rem;                
                transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
                /*Sombra de profundidad suave (capa base) */
                box-shadow:
                  0 8px 18px rgb(58, 54, 54),
                  0 2px 0 rgba(171, 163, 163, 0.812) inset;
              }
              #dashboard > div:hover {
                transform: translateY(-8px) rotateX(1.2deg) rotateY(-1.2deg);
              }              

              #dashboard .text-gray-500 { color: var(--text-light-secondary); }
              #dashboard .text-3xl { font-size: 1.75rem; }
              #current-balance { color: var(--balance-color); }
              #monthly-income { color: var(--income-color); }
              #monthly-expenses { color: var(--expense-color); }
              #dashboard .bg-blue-100, #dashboard .bg-green-100, #dashboard .bg-red-100 {
                background-color: var(--bg-dark-tertiary);
              }

               /* === NEÓN + 3D PARA TARJETAS DEL DASHBOARD === */

              /* Activa perspectiva para que el hover tenga efecto 3D 
              #dashboard { perspective: 900px; }*/

               /*Base 3D para todas las tarjetas */


              /*Realce “flotante” al pasar el mouse: leve tilt 3D */


              /* Aro de brillo externo (neón) – controlado por color por tarjeta 
              #dashboard > div::before {
                content: "";
                position: absolute;
                inset: -2px;                /* sale un pelín para dar halo 
                border-radius: inherit;
                pointer-events: none;
                filter: blur(6px);
                opacity: .85;
                transition: opacity .25s ease, filter .25s ease;
              }

              /* — Tarjeta 1: SALDO ACTUAL → neón azul — 
              #dashboard > div:nth-child(1) {
                /* capa de brillo externo y profundidad 
                box-shadow:
                  0 12px 24px rgba(0,0,0,0.45),
                  0 0 14px rgba(14,165,233,.35),
                  0 0 28px rgba(14,165,233,.20),
                  0 2px 0 rgba(14,165,233,.25) inset;
                border-color: rgba(14,165,233,.45);
              }
              #dashboard > div:nth-child(1)::before {
                box-shadow:
                  0 0 18px var(--electric-blue),
                  0 0 36px var(--electric-blue),
                  0 0 54px rgba(14,165,233,.6);
              }

              /* — Tarjeta 2: INGRESOS DEL MES → neón verde — 
              #dashboard > div:nth-child(2) {
                box-shadow:
                  0 12px 24px rgba(0,0,0,0.45),
                  0 0 14px rgba(34,197,94,.35),
                  0 0 28px rgba(34,197,94,.20),
                  0 2px 0 rgba(34,197,94,.25) inset;
                border-color: rgba(34,197,94,.45);
              }
              #dashboard > div:nth-child(2)::before {
                box-shadow:
                  0 0 18px var(--electric-green),
                  0 0 36px var(--electric-green),
                  0 0 54px rgba(34,197,94,.6);
              }

              /* — Tarjeta 3: GASTOS DEL MES → neón rojo — 
              #dashboard > div:nth-child(3) {
                box-shadow:
                  0 12px 24px rgba(0,0,0,0.45),
                  0 0 14px rgba(239,68,68,.35),
                  0 0 28px rgba(239,68,68,.20),
                  0 2px 0 rgba(239,68,68,.25) inset;
                border-color: rgba(239,68,68,.45);
              }
              #dashboard > div:nth-child(3)::before {
                box-shadow:
                  0 0 18px var(--electric-red),
                  0 0 36px var(--electric-red),
                  0 0 54px rgba(239,68,68,.6);
              }

              /* Opcional: intensificar el halo en hover 
              #dashboard > div:hover::before {
                filter: blur(7px);
                opacity: 1;
              }*/             

              /* --- ESTILOS DE MODALES Y NOTIFICACIONES --- */
              
              .modal { display: none; z-index: 100; }
              .modal.active { display: flex; }
              .modal > div {
                background-color: var(--bg-dark-secondary);
                border: 1px solid var(--border-dark);
                color: var(--text-light-primary);
              }
              .modal h2 { color: var(--text-light-primary); }
              .modal .p-6.border-b, .modal .p-5.border-b {
                border-bottom: 1px solid var(--border-dark);
                background-color: var(--bg-dark-primary);
              }
              .modal input, .modal select {
                background-color: var(--bg-dark-tertiary);
                border: 1px solid var(--border-dark);
                color: var(--text-light-primary);
                border-radius: 0.5rem;
                transition: all 0.2s ease;
              }
              .modal input:focus, .modal select:focus {
                outline: none;
                border-color: var(--electric-blue);
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
              }
              .modal label { color: var(--text-light-secondary); font-weight: 500; }
              .radio-type-label {
                  display: inline-block; padding: 0.5rem 1rem;
                  border: 2px solid var(--border-dark);
                  border-radius: 0.5rem; cursor: pointer;
                  transition: all 0.2s ease-in-out; text-align: center;
                  width: 100%; color: var(--text-light-secondary);
              }
              .radio-type-input:checked + .radio-type-label {
                  border-color: var(--electric-blue);
                  background-color: rgba(14, 165, 233, 0.1);
                  color: var(--electric-blue); font-weight: 600;
              }
              .radio-type-input { display: none; }

              /* --- Notificaciones (Toasts) --- */
              #toast-container {
                  position: fixed; bottom: 1rem; right: 1rem;
                  z-index: 1050; display: flex;
                  flex-direction: column-reverse; gap: 0.5rem;
              }
              .toast {
                  color: white; padding: 0.75rem 1.25rem;
                  border-radius: 0.5rem;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
                  opacity: 0; transition: all 0.3s ease-in-out;
                  transform: translateY(100%); min-width: 250px;
                  max-width: 350px; display: flex;
                  align-items: center; gap: 0.75rem;
                  border: 1px solid rgba(255, 255, 255, 0.1);
              }
              .toast.show { opacity: 1; transform: translateY(0); }
              .toast.success { background-color: var(--electric-green); }
              .toast.error { background-color: var(--electric-red); }
              .toast.info { background-color: var(--electric-blue); }
              .toast-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
              .toast-icon svg { fill: currentColor; }
              .input-error-message {
                  color: var(--electric-red); font-size: 0.75rem;
                  margin-top: 0.25rem; display: none;
              }
              .input-error-message.active { display: block; }
              .loading-overlay {
                  display: none; position: fixed;
                  top: 0; left: 0; width: 100%; height: 100%;
                  background: rgba(17, 24, 39, 0.8);
                  backdrop-filter: blur(4px); justify-content: center;
                  align-items: center; z-index: 1000;
              }
              .loading-overlay.active { display: flex; }
              .spinner {
                  border: 4px solid rgba(243, 244, 246, 0.2);
                  border-left-color: var(--electric-blue);
                  border-radius: 50%; width: 40px; height: 40px;
                  animation: spin 1s linear infinite;
              }
              @keyframes spin { to { transform: rotate(360deg); } }
              .btn-spinner {
                  border: 2px solid rgba(255, 255, 255, 0.3);
                  border-left-color: #fff; width: 16px; height: 16px;
              }
              body.auth-modal-active #main-content-wrapper { display: none; }
              /* ====================================================================== */
              /* ===== ESTILOS PARA EL NUEVO PANEL DE ACCIÓN ÚNICA - 04/09/2025 ===== */
              /* ====================================================================== */
              
              /* Anula el fondo oscuro del modal para que solo el panel sea visible */
              #single-action-modal {
                  background-color: rgba(17, 24, 39, 0.4); /* Fondo semi-transparente */
                  pointer-events: none; /* Permite hacer clic "a través" del fondo */
              }

              /* Estilos para el panel que se desliza desde abajo */
              #single-action-modal-content {
                  background-color: var(--bg-dark-secondary); /* Fondo oscuro del panel */
                  border-top: 1px solid var(--border-dark);
                  pointer-events: all; /* El panel sí debe ser clickeable */
              }
              
              /* Estilos para el texto del panel */
              #single-action-modal-title {
                  color: var(--text-light-secondary);
              }

              /* Lógica para mostrar/ocultar el panel */
              #single-action-modal.active {
                  pointer-events: all;
              }
              #single-action-modal.active #single-action-modal-content {
                  transform: translateY(0); /* Lo trae a su posición visible */
              }

              /* --- ESTILOS DE TABLAS --- */

              .button-container /*flex items-center justify-between w-full mb-2 mt-0"*/ {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                margin-bottom: 0.5rem;
                margin-top: 0;
                padding-top: 0;
              }

              main.container {
                background-color: var(--bg-dark-secondary);
                border: 1px solid var(--border-dark);
                padding: 1rem;
              }
              #main-action-btn {
                background-color: var(--electric-blue); color: white;
                font-weight: 500;
                font-size: large;
                margin-left: 0;
              }
              #main-action-btn:hover { background-color: #0ea4e9c8; 
                transform: scale(1.05);
                width: auto;
                height: 40px;                
              }

              table { border-collapse: collapse; }

              .aparecer {
                padding: 0.25rem 0.5rem; border-radius: 0.5rem;
                border: 1px solid var(--border-dark);
                transition: all 0.2s ease-in-out;
                background-color: grey;
              }

              .aparecer:hover{
                background-color: var(--electric-red);
                color: white;
                border-color: var(--electric-red);
                transform: scale(1.05);
              }

               /* Aquí es donde debes pegar el código CSS */
              table {
                  border-collapse: separate; /* Importante para que border-radius funcione */
                  border-spacing: 0;
                  border-radius: 10px; /* Aquí establecemos el radio de las esquinas */
                  overflow: hidden; /* Esto es clave para que los bordes de las celdas no se salgan */
                  width: 80%;
                  margin: 20px auto;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                  border: 1px solid var(--border-dark);
                  margin-top: 1px;
              }

              th, td {
                  border: 1px solid #ddd;
                  padding: 2px;
                  text-align: left;
              }

              /* Estilos adicionales para que las esquinas de las celdas se vean bien */
              table tr:first-child th:first-child {
                  border-top-left-radius: 10px;
              }

              table tr:first-child th:last-child {
                  border-top-right-radius: 10px;
              }

              table tr:last-child td:first-child {
                  border-bottom-left-radius: 10px;
              }

              table tr:last-child td:last-child {
                  border-bottom-right-radius: 10px;
              }             

              /* CÓDIGO NUEVO */
              th {
                color: var(--text-light-primary); /* <-- Cambiado a un blanco más brillante */
                font-weight: 600;
                text-transform: uppercase; /* Opcional: añade mayúsculas para un look más definido */
                font-size: 0.75rem;      /* Opcional: ajusta el tamaño para que encaje mejor */
              }

              /* --- REGLA ESPECÍFICA PARA SOBRESCRIBIR TAILWIND EN ENCABEZADOS --- */
              #registros-content thead th,
              #recurrentes-content thead th,
              #tarjetas-content thead th,
              #presupuesto-content thead th {
                  color: var(--text-light-primary);
              }

              /* REGLA ÚNICA Y DEFINITIVA PARA EL ENCABEZADO NEGRO */
              thead,
              #registros-content thead,
              #recurrentes-content thead,
              #tarjetas-content thead,
              #presupuesto-content thead {
                  background-color: #000000; /* Negro puro para todos los encabezados */
              }                   

              tbody { background-color: var(--bg-dark-secondary); border-color: var(--border-dark); }
              td { color: var(--text-light-primary); }

              tbody tr {
                background-color: var(--bg-dark-tertiary); /* Color de hover AHORA es el por defecto */
                border-bottom: 1px solid var(--border-dark);
                transition: background-color 0.2s ease, color 0.2s ease; /* Transición suave para fondo y texto */
              }
              tbody tr:last-child { border-bottom: none; }

              tbody tr:hover { 
                background-color: var(--border-dark); /* Nuevo hover a un dark más claro */
              }

              /* Clases para colorear el TEXTO de TODA la fila (Regla más específica) */
              .income-text-row td { color: var(--income-color); }
              .expense-text-row td { color: var(--expense-color); }
              .transfer-text-row td { color: var(--balance-color); }

              tfoot { background-color: var(--bg-dark-primary); border-top: 2px solid var(--border-dark); }

              #no-transactions-message, #no-recurring-expenses-message, #no-credit-cards-message, #no-balances-message, #no-categories-for-budget-message {
                color: var(--text-light-secondary);
              }
              .table-input {
                  width: 100%; padding: 4px 8px;
                  border: 1px solid var(--border-dark);
                  border-radius: 0.375rem; background-color: var(--bg-dark-tertiary);
                  color: var(--text-light-primary); text-align: right;
                  transition: all 0.2s ease;
              }
              .table-input:focus {
                  outline: none; border-color: var(--electric-blue);
                  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
              }
              .budget-table-input {
                background-color: var(--bg-dark-tertiary); width: 120px;
                padding: 6px 10px; border: 1px solid var(--border-dark);
                border-radius: 0.375rem; text-align: right;
                color: var(--text-light-primary); transition: all 0.2s ease-in-out;
              }
              .budget-table-input:focus {
                  outline: none; border-color: var(--electric-blue);
                  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
              }
              .positive-balance { color: var(--income-color); font-weight: 600; }
              .negative-balance { color: var(--expense-color); font-weight: 600; }
              .zero-balance { color: var(--text-light-secondary); font-weight: 500; }
              .balance-cell-bg { background-color: var(--bg-dark-primary); }
              #filter-description, #filter-category, #filter-month {
                background-color: var(--bg-dark-tertiary);
                border: 1px solid var(--border-dark);
                color: var(--text-light-primary);
              }
              .edit-recurring-btn, .edit-btn { color: var(--electric-blue); }
              .edit-recurring-btn:hover,.edit-btn:hover { color: #cbdae1; }
              .delete-btn, .delete-card-btn, .delete-category-btn, .delete-bank-btn, .delete-description-btn { color: var(--electric-red); }
              .delete-btn:hover, .delete-card-btn:hover, .delete-category-btn:hover, .delete-bank-btn:hover, .delete-description-btn:hover { color: #f472b6; }

              /* --- ESTILOS DE COMPONENTES ESPECÍFICOS --- */
              #calculadora-content .bg-white { background-color: var(--bg-dark-secondary); }
              #calculadora-content .bg-gray-50 { background-color: var(--bg-dark-primary); }
              #calculadora-content .bg-blue-50 { background-color: var(--bg-dark-primary); border: 1px solid var(--border-dark); }
              #calculadora-content h3, #calculadora-content h2 { color: var(--text-light-primary); }
              #calculadora-content p, #calculadora-content label { color: var(--text-light-secondary); }
              #calculadora-content input, #calculadora-content select {
                background-color: var(--bg-dark-tertiary);
                border-color: var(--border-dark);
                color: var(--text-light-primary);
              }
              #titucalculadora {
                background: none; border-bottom: 1px solid var(--border-dark);
                border-radius: 0; padding-bottom: 1rem;
              }
              #calculateBtn { background-color: var(--electric-blue); }
              #calculateBtn:hover { background-color: #0ea4e9d5; }
              .result-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 1rem;
              }
              #results p.text-gray-500 { color: var(--text-light-secondary); }
              #results #grossPayResult { color: var(--income-color); }
              #results #preTaxDeductionsResult { color: var(--electric-orange); }
              #results #federalTaxResult, #results #ficaTaxResult, #results #postTaxDeductionsResult { color: var(--expense-color); }
              #results #netPayResult { color: var(--electric-blue); }

              /* --- Pestaña de Configuración (TEXTO CORREGIDO) --- */
              #configuración-content h3 { border-bottom: 1px solid var(--border-dark); padding-bottom: 0.5rem; }
              #configuración-content .max-h-60, #configuración-content .max-h-72 {
                background-color: var(--bg-dark-primary);
                border-color: var(--border-dark);
              }
              #configuración-content li { background-color: var(--bg-dark-tertiary) !important; }
              #add-category-btn, #add-bank-btn, #save-alias-btn, #initiate-new-month-btn, #import-json-btn, #reset-data-btn {
                color: white; /* TEXTO BLANCO PARA TODOS LOS BOTONES PRINCIPALES */
              }
              #add-category-btn, #add-bank-btn, #save-alias-btn { background-color: var(--electric-blue); }
              #initiate-new-month-btn { background-color: var(--electric-green); }
              #export-pdf-btn, #export-json-btn { background-color: var(--bg-dark-tertiary); border: 1px solid var(--border-dark); }
              #import-json-btn { background-color: var(--electric-purple); }
              #reset-data-btn { background-color: var(--electric-red); }

              /* --- CORRECCIÓN DEFINITIVA PARA EL TOUR DEMO (Shepherd.js) --- */
              .shepherd-tour-witfinances.shepherd-element { /* <--- CORREGIDO: Sin espacio aquí */
                  background-color: var(--bg-dark-secondary) !important;
                  border: 1px solid var(--border-dark) !important;
                  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
              }

              .shepherd-tour-witfinances .shepherd-header {
                  background-color: var(--bg-dark-primary) !important;
                  border-bottom: 1px solid var(--border-dark) !important;
              }

              .shepherd-tour-witfinances .shepherd-text {
                  color: var(--text-light-primary) !important;
              }

              .shepherd-tour-witfinances .shepherd-title {
                  color: var(--electric-blue) !important;
              }

              .shepherd-tour-witfinances .shepherd-cancel-icon { 
                  color: var(--text-light-secondary); 
              }

              .shepherd-tour-witfinances .shepherd-cancel-icon:hover { 
                  color: var(--text-light-primary); 
              }

              .shepherd-tour-witfinances .shepherd-footer { 
                  padding: 0 1.5rem 1rem; 
              }

              .shepherd-tour-witfinances .shepherd-button {
                  border: none;
                  border-radius: 8px;
                  padding: 0.75rem 1.5rem;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s ease;
              }

              .shepherd-tour-witfinances .shepherd-button:not(.shepherd-button-secondary) {
                  background-color: var(--electric-blue);
                  color: white;
              }

              .shepherd-tour-witfinances .shepherd-button:not(.shepherd-button-secondary):hover {
                  background-color: #0ea4e9d5;
                  transform: translateY(-2px);
                  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
              }

              .shepherd-tour-witfinances .shepherd-button.shepherd-button-secondary {
                  background-color: transparent;
                  color: var(--electric-blue);
              }

              .shepherd-tour-witfinances .shepherd-button.shepherd-button-secondary:hover {
                  background-color: var(--bg-dark-tertiary);
              }

              .shepherd-tour-witfinances .shepherd-arrow::before {
                  background-color: var(--bg-dark-secondary) !important;
                  border: 1px solid var(--border-dark) !important;
                  border-top: none !important;
                  border-right: none !important;
              }

              /* --- ESTILOS PARA EL AVISO DEL TOUR (TOAST) --- */
              #tour-toast {
                  background-color: var(--bg-dark-secondary);
                  border: 1px solid var(--border-dark);
                  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
              }

              #tour-toast .font-bold {
                  color: var(--text-light-primary);
              }

              #tour-toast .text-sm {
                  color: var(--text-light-secondary);
              }

              #tour-toast svg {
                  color: var(--electric-blue);
              }

              #tour-toast #start-tour-btn-toast {
                  background-color: var(--electric-blue);
                  color: var(--text-light-primary);
              }

              #tour-toast #start-tour-btn-toast:hover {
                  background-color: #0ea4e9c8;
              }

              #tour-toast #close-tour-toast-btn {
                  color: var(--text-light-primary);
              }

              #tour-toast #close-tour-toast-btn:hover {
                  color: var(--text-light-primary);
              }

              /* ====================================================================== */
              /* ===== AJUSTES DE ESTILO ADICIONALES by Gemini - 22/08/2025 ===== */
              /* ====================================================================== */

              /* 1. Encabezado de tabla para Proyección (igual que Registros) */
              #proyeccion-content thead {
                  background-color: var(--bg-dark-primary);
              }
              #proyeccion-content thead th {
                  color: var(--text-light-primary);
              }

              /* 2. Filas y texto de la tabla de Gastos Recurrentes */
              #recurrentes-content tbody td {
                  color: var(--text-light-primary); /* <-- Texto blanco por defecto */
              }
              #recurrentes-content tbody .text-red-600 {
                  color: var(--expense-color); /* <-- Se asegura que el monto siga siendo rojo */
              }

              /* 3. Filas de la tabla de Tarjetas de Crédito */
              #tarjetas-content .bg-white,
              #tarjetas-content .bg-red-100,
              #tarjetas-content .bg-yellow-100 {
                  background-color: var(--bg-dark-tertiary) !important;
                  color: var(--text-light-primary) !important;
              }
              #tarjetas-content tbody tr:hover {
                  background-color: var(--border-dark) !important;
              }

              /* 4. Ventanas (tarjetas) de la pestaña Saldos de Cuentas */
              #saldos-content .bg-white {
                  background-color: var(--bg-dark-secondary);
                  border: 1px solid var(--border-dark);
              }
              #saldos-content .text-gray-700 {
                  color: var(--text-light-primary);
              }

            /* ====================================================================== */
            /* === AJUSTES DE ESTILO TARJETAS DE CRÉDITO by Gemini - 22/08/2025 === */
            /* ====================================================================== */

            /* 1. Hace que el texto de las columnas (encabezado y celdas) sea blanco */
            #tarjetas-content thead th,
            #tarjetas-content tbody td {
                color: var(--text-light-primary);
            }

            /* 2. Oscurece el fondo de los campos de entrada para que resalten */
            #tarjetas-content .table-input {
                background-color: var(--bg-dark-primary); /* <-- El tono más oscuro de tu paleta */
                border: 1px solid var(--border-dark);   /* <-- Asegura que el borde sea visible */
            }

            /* 3. (Bonus) Ajusta el color del texto en el pie de la tabla para consistencia */
            #tarjetas-content tfoot .text-gray-700 {
                color: var(--text-light-secondary);
            }
            #tarjetas-content tfoot .text-gray-900 {
                color: var(--text-light-primary);
            }
            
            /* ====================================================================== */
            /* ===== AJUSTE DE COLOR EN TABLA REGISTROS by Gemini - 22/08/2025 ==== */
            /* ====================================================================== */

            /* Esta regla anula el color de toda la fila para las primeras 3 columnas,
              forzando el texto a ser blanco, pero deja que las demás columnas 
              (Monto, Saldo, Acciones) mantengan su color original.
            */
            #registros-content .income-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
            #registros-content .expense-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
            #registros-content .transfer-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)) {
                color: var(--text-light-primary);
            }

            /* ====================================================================== */
            /* === AJUSTE DE COLOR EN TABLA PROYECCION (Corregido) - 22/08/2025 === */
            /* ====================================================================== */

            /* Esta regla ahora solo anula el color de las primeras 3 columnas
              (Fecha, Descripción y Categoría), forzando su texto a ser blanco.
              Las columnas 'Monto' y 'Saldo' quedan excluidas para mantener
              su color dinámico.
            */
            #proyeccion-content .income-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
            #proyeccion-content .expense-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
            #proyeccion-content .transfer-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)) {
                color: var(--text-light-primary);
            }  
            
            /* ====================================================================== */
            /* ===== AJUSTE DE CONTRASTE EN PESTAÑA SALDOS by Gemini - 22/08/2025 ==== */
            /* ====================================================================== */

            /* Se aplica el fondo más oscuro al contenedor de la pestaña 'Saldos',
              creando así un contraste con las tarjetas de cada cuenta.
            */
            #saldos-content {
                background-color: var(--bg-dark-primary);
                padding: 1rem;
                margin: -1rem; /* Truco para que ocupe todo el espacio del contenedor padre */
                border-radius: 0.75rem;
            } 
            
            /* ====================================================================== */
            /* ===== AJUSTES DE VISUALES EN TABLA PRESUPUESTO by Gemini - 22/08/2025 ==== */
            /* ====================================================================== */

            /* 1. Cambia el color del texto de la primera columna ('Categoría') a blanco */
            #presupuesto-content tbody td:nth-child(1) {
                color: var(--text-light-primary);
            }

            /* 2. Oscurece el fondo de los campos editables para un mejor contraste */
            #presupuesto-content .budget-table-input {
                background-color: var(--bg-dark-primary); /* <-- El tono más oscuro */
                border: 1px solid var(--border-dark);
            }
            
            /* ====================================================================== */
            /* ===== AJUSTE DARK MODE PARA INPUTS DE CONFIGURACIÓN - 23/08/2025 ==== */
            /* ====================================================================== */

            /* Aplica el estilo base a los inputs de texto dentro de la pestaña Configuración */
            /* ===== PEGA ESTE BLOQUE COMPLETO REEMPLAZANDO LAS 3 REGLAS ANTERIORES ===== */

            /* Aplica el estilo base a los inputs de texto Y CONTRASEÑA */
            #configuración-content input[type="text"],
            #configuración-content input[type="password"] {
                background-color: var(--bg-dark-tertiary); /* Fondo oscuro para inputs */
                color: var(--text-light-primary);           /* Texto blanco */
                border: 1px solid var(--border-dark);       /* Borde gris oscuro */
                border-radius: 0.5rem;                      /* Bordes redondeados */
                transition: all 0.2s ease-in-out;           /* Transición suave */
            }

            /* Define el estilo para cuando el input está seleccionado (en foco) */
            #configuración-content input[type="text"]:focus,
            #configuración-content input[type="password"]:focus {
                outline: none;                              /* Quita el contorno por defecto */
                border-color: var(--electric-blue);         /* Borde azul brillante */
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4); /* Sombra exterior azul */
            }

            /* Aclara el color del texto de ejemplo (placeholder) */
            #configuración-content input[type="text"]::placeholder,
            #configuración-content input[type="password"]::placeholder {
                color: var(--text-light-secondary);         /* Texto secundario gris claro */
}

            /* Reducir altura de todas las filas de las tablas de transacciones */
            #registros-content table td,
            #proyeccion-content table td,
            #recurrentes-content table td,
            #tarjetas-content table td,
            #presupuesto-content table td {
              padding-top: 6px;   /* antes era ~16px */
              padding-bottom: 6px;
              line-height: 1.2;   /* hace que el texto no deje tanto espacio vertical */
              padding-right: 4px;
              padding-left: 4px;
              font: 400;
            }

            #category-totals-list{
              background-color: var(--bg-dark-primary);
              border: 1px solid var(--border-dark);
              border-radius: 0.5rem;
              padding: 1rem;
              max-height: 300px; /* Altura máxima para activar el scroll si es necesario */
              overflow-y: auto;  /* Habilita el scroll vertical */
            }

            /* Pestaña Reportes - Fondo oscuro y coherente con el tema */
            #reportes-content .bg-white,
            #reportes-content .bg-gray-100,
            #reportes-content .bg-gray-50 {
              background-color: var(--bg-dark-secondary) !important; /* mismo que otras tarjetas */
              color: var(--text-light-primary) !important;           /* texto blanco */
              border: 1px solid var(--border-dark);                  /* borde oscuro */
            }

            /* Ajustar los títulos y textos dentro de reportes */
            #reportes-content h3 {
              color: var(--text-light-primary);
            }

            #reportes-content span,
            #reportes-content p {
              color: var(--text-light-secondary);
            }



            /* PEGA AQUÍ EL CÓDIGO */
            /* --- Estilos para Checkboxes en Tablas --- */
            td > input[type="checkbox"], th > input[type="checkbox"] {
                cursor: pointer;
                width: 1rem;
                height: 1rem;
                accent-color: var(--electric-blue);
            }
            td > input[type="checkbox"]:hover, th > input[type="checkbox"]:hover {
                transform: scale(1.1);
                transition: transform 0.2s ease-in-out;
            }

            .logotipo {
              width: 180px;
              height: 100px;
            }

 /* --- Estilos para Iconos de Categorías y Modal de Selección --- */
            .category-icon {
                width: 24px;       /* Ancho del icono */
                height: 24px;      /* Alto del icono */
                margin-right: 8px; /* Espacio a la derecha del icono */
                vertical-align: middle; /* Alinea el icono con el texto */
                display: inline-block;  /* Asegura que se comporte como un elemento de línea */
            }

            /* Estilos para el nuevo modal de selección de iconos */
            #category-icon-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); /* Rejilla responsiva */
                gap: 1rem;
                padding: 1rem 0;
            }

            .icon-option {
                cursor: pointer;
                padding: 8px;
                border-radius: 8px;
                border: 2px solid transparent;
                transition: all 0.2s ease-in-out;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--bg-dark-tertiary);
            }
            .icon-option:hover {
                transform: scale(1.1);
                border-color: var(--electric-blue);
            }
            .icon-option.selected {
                border-color: var(--electric-green);
                box-shadow: 0 0 10px var(--electric-green);
            }
            .icon-option img {
                width: 40px;
                height: 40px;
            } 
            /* ====================================================================== */
            /* ===== MEJORA DE CONTROL DE VISTAS (Dashboard vs Contenido) ========= */
            /* ====================================================================== */

            /* --- Por defecto (Vista Dashboard) --- */
            body.view-dashboard #main-container,
            body.view-dashboard #mostrar {
                display: none;
            }

            /* --- Cuando la vista de Contenido está activa --- */
            body.view-content #dashboard,
            body.view-content #credit-card-alerts,
            body.view-content #recurring-alerts,
            body.view-content #ptitul,
            body.view-content #barr {
                display: none;
            }

            body.view-content #main-container,
            body.view-content #mostrar {
                display: block; /* o flex, grid, etc., según necesites */
            }

            body.view-content #main-header-bar {
                height: 5rem; /* 80px */
            }

            body.view-content {
                margin-top: 1rem; /* 16px */
            }

            /* Transición suave para el cambio de altura del header */
            #main-header-bar {
                transition: height 0.3s ease-in-out;
            }
            /* ====================================================================== */
            /* ===== ESTILOS PARA EL DASHBOARD EN CSS PURO ======================== */
            /* ====================================================================== */

            /* 1. Layout del contenedor del dashboard (reemplaza a 'grid grid-cols-3 gap-6') */
            #dashboard {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 1.5rem; /* 24px */
              margin: 0 2rem 1rem 2rem; /* Margen superior, horizontal, inferior */
            }

            /* 2. Estilo base para cada tarjeta (reemplaza a 'bg-white p-6 rounded-xl etc.') */
            .dashboard-card {
              background-color: var(--bg-dark-secondary);
              padding: 1.5rem; /* 24px */
              border-radius: 0.75rem; /* 12px */
              border: 1px solid var(--border-dark);
              display: flex;
              align-items: center;
              justify-content: space-between;
              transition: transform 0.25s ease, box-shadow 0.25s ease;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            }

            .dashboard-card:hover {
              transform: translateY(-5px);
              box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            }

            /* 3. Estilos para el texto dentro de las tarjetas */
            .dashboard-card p:first-child {
              font-size: 0.875rem; /* 14px */
              color: var(--text-light-secondary);
            }

            .dashboard-card p:last-child {
              font-size: 2.25rem; /* 36px */
              font-weight: 700;
            }

            #current-balance { color: var(--balance-color); }
            #monthly-income { color: var(--income-color); }
            #monthly-expenses { color: var(--expense-color); }

            /* 4. Estilo para el contenedor del icono */
            .card-icon-wrapper {
                background-color: var(--bg-dark-tertiary);
                padding: 0.75rem; /* 12px */
                border-radius: 9999px; /* fully rounded */
            }

              /* --- Alertas de Tarjetas y Recurrentes --- */
              #credit-card-alerts, #recurring-alerts {
                margin: 0.5rem 2rem 0 2rem; /* mt-2 mx-8 */
                font-size: 0.875rem; /* text-sm */
              }
              #credit-card-alerts p, #recurring-alerts p {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
                border-radius: 0.375rem;
                box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
              }
              #credit-card-alerts p {
                background-color: rgba(239, 68, 68, 0.1);
                border-left: 4px solid var(--electric-red);
                color: var(--electric-red);
              }
              #recurring-alerts p {
                background-color: rgba(14, 165, 233, 0.1);
                border-left: 4px solid var(--electric-blue);
                color: var(--electric-blue);
              }
              #credit-card-alerts svg, #recurring-alerts svg {
                  display: inline-block;
                  width: 1.25rem;
                  height: 1.25rem;
                  margin-right: 0.5rem;
              }

              /* Oculta el texto (span) dentro de la cuarta columna (Categoría)
              #registros-content tbody td:nth-child(4) span,
              #proyeccion-content tbody td:nth-child(4) span,
              #recurrentes-content tbody td:nth-child(4) span {
                  display: none;
              }

              (Opcional pero recomendado) Centra el icono en la celda
              #registros-content tbody td:nth-child(4),
              #proyeccion-content tbody td:nth-child(4),
              #recurrentes-content tbody td:nth-child(4) {
                  justify-content: center;
              } */

             /* ====================================================================== */
              /* ===== AJUSTES PARA MODALES LEGALES 31/08/2025 ======== */
              /* ====================================================================== */

              /* 1. Asegura que el área de contenido del modal sea desplazable (scroll) */
              .modal .overflow-y-auto {
                  overflow-y: auto;
              }

              /* 2. Define estilos para el texto dentro de los modales legales para mejor lectura */
              .modal .text-gray-600 h1,
              .modal .text-gray-600 h2,
              .modal .text-gray-600 h3 {
                  color: var(--text-light-primary); /* Usa el color de texto principal de tu tema oscuro */
                  border-bottom: 1px solid var(--border-dark);
                  padding-bottom: 0.5rem;
                  margin-bottom: 1rem;
              }

              .modal .text-gray-600 h1 {
                  font-size: 1.5rem; /* ~24px */
              }
              .modal .text-gray-600 h2 {
                  font-size: 1.25rem; /* ~20px */
              }
              .modal .text-gray-600 h3 {
                  font-size: 1.1rem; /* ~18px */
              }
              .modal .text-gray-600 p,
              .modal .text-gray-600 li {
                  font-size: 0.9rem; /* ~14px, un tamaño cómodo para leer textos largos */
                  color: var(--text-light-secondary); /* Usa el color de texto secundario */
                  margin-bottom: 1rem;
                  line-height: 1.6;
              }

              .card-icon-wrapper img {
                  height: 48px;     /* Tamaño de la imagen más pequeño y consistente */
                  width: 48px;      /* Hacemos que sea un cuadrado para que no se deforme */
              }
              .card-icon-wrapper {
                  width: 62px;      /* Ancho fijo y más pequeño para el círculo */
                  height: 62px;     /* Alto fijo y más pequeño para el círculo */
                  padding: 1px;       /* Anulamos el padding para controlar el tamaño de la imagen directamente */
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;   /* Evita que el círculo se encoja */
              }

/* ====================================================================== */
/* ===== AJUSTES PARA VISTA MÓVIL (Tablas y Filtros) - 01/09/2025 ======= */
/* -------------------- CSS RESPONSIVO (MÓVILES) ------------------------ */
/* ====================================================================== */ 

              /* --- Estilos para el botón 'i' solo en vista móvil --- */
              @media (max-width: 768px) {
                  .info-btn {
                      display: flex; /* Centra la 'i' dentro del círculo */
                      align-items: center;
                      justify-content: center;
                      width: 1rem;     /* 16px */
                      height: 1rem;    /* 16px */
                      margin-left: 8px; /* Espacio entre el texto de la categoría y el botón */
                      border-radius: 50%; /* Lo hace un círculo */
                      background-color: var(--bg-dark-tertiary);
                      color: var(--text-light-secondary);
                      border: 1px solid var(--border-dark);
                      font-size: 0.65rem;
                      font-weight: bold;
                      cursor: pointer;
                      transition: background-color 0.2s ease, transform 0.2s ease;
                      flex-shrink: 0; /* Evita que el botón se encoja */
                  }
                  .info-btn:hover {
                      background-color: var(--electric-blue);
                      color: white;
                      transform: scale(1.1);
                  }
                  /* Ocultamos la columna de descripción en móvil, ya que tenemos el botón */
                  #registros-content th:nth-child(3),
                  #registros-content td:nth-child(3),
                  #proyeccion-content th:nth-child(3),
                  #proyeccion-content td:nth-child(3) {
                      display: none;
                  }
              }
              /* Ocultamos el botón en la vista de escritorio */
              @media (min-width: 769px) {
                  .info-btn {
                      display: none;
                  }
              }
              
              @media (max-width: 768px) {
                #barr {
                  padding-left: 0.5rem;
                  padding-right: 0.5rem;
                  flex-direction: column; 
                  text-align: center;
                  height: auto; 
                  padding-bottom: 0.5rem;
                }
                #barr img { height: 80px; width: 80px; margin-bottom: -15px; }
                #barr .flex-1 { order: 2; }
                #logout-btn { order: 3; width: 100%; margin-top: 0.5rem; }
                #barr h1 { font-size: 1.25rem; }
                #barr #ptitul { font-size: 0.75rem; }
                #tabs { padding: 0.25rem; margin-bottom: 0.5rem;}

                #barr {
                    display: none;
                }

                /* Ajusta la altura del contenedor principal del header para que solo ocupe el espacio de las pestañas */
                #main-header-bar {
                    height: auto; 
                }

                /* Ajusta el margen superior del cuerpo para que el contenido principal no quede oculto debajo de las pestañas */
                body {
                    margin-top: 6rem !important; /* Aproximadamente la altura de la barra de pestañas */
                }
              
                /* Pega esta nueva regla para que el contenido se ajuste a las pestañas */
                body.view-content #main-container {
                    margin-top: 1rem; /* Un pequeño espacio en lugar del grande anterior */
                }           
              
              }

              /* 5. Responsividad para móviles (reemplaza a 'md:grid-cols-3') */
              @media (max-width: 768px) {
                #dashboard {
                  grid-template-columns: 1fr; /* Una columna en móviles */
                }
              }             

              @media (max-width: 768px) {
                  /* Oculta el texto (span) dentro de la cuarta columna */
                  #registros-content tbody td:nth-child(4) span,
                  #proyeccion-content tbody td:nth-child(4) span,
                  #recurrentes-content tbody td:nth-child(4) span {
                      display: none;
                  }

                  /* Centra el icono en la celda */
                  #registros-content tbody td:nth-child(4),
                  #proyeccion-content tbody td:nth-child(4),
                  #recurrentes-content tbody td:nth-child(4) {
                      justify-content: left;
                  }
              }              
              

              @media (max-width: 768px) {
                  /* 1. Oculta las columnas 'Descripción' y 'Acciones' en ambas tablas */
                  #recurrentes-content th:nth-child(6),
                  #recurrentes-content td:nth-child(6),
                  /*#tarjetas-content th:nth-child(3),
                  #tarjetas-content td:nth-child(3),*/
                  #tarjetas-content th:nth-child(7),
                  #tarjetas-content td:nth-child(7),
                  #recurrentes-content th:nth-child(7),
                  #recurrentes-content td:nth-child(7),

                  #registros-content th:nth-child(3),
                  #registros-content td:nth-child(3),
                  #registros-content th:nth-child(7),
                  #registros-content td:nth-child(7),
                  #proyeccion-content th:nth-child(3),
                  #proyeccion-content td:nth-child(3),
                  #proyeccion-content th:nth-child(7),
                  #proyeccion-content td:nth-child(7) {
                      display: none;
                  }

                  /* 2. Formato de fecha para móvil (muestra solo el día) */
                  .desktop-date { display: none; } /* Oculta la fecha completa */
                  .mobile-date { 
                      display: inline-block; /* Muestra solo el número del día */
                      font-weight: 600;      /* Opcional: lo hace más visible */
                      font-size: 1.1em;
                      text-align: center;
                      width: 100%;
                  }

/* ====================================================================== */
/* == AJUSTE TAMAÑO DE TEXTO ENCABEZADOS DE TABLA MÓVIL - 03/09/2025 == */
/* ====================================================================== */
                  #registros-content th,
                  #proyeccion-content th,
                  #recurrentes-content th,
                  #tarjetas-content th,
                  #presupuesto-content th {
                    font-weight: 400;      /* Cambia el peso de semi-negrita a normal */
                    text-transform: none;  /* Elimina la transformación a mayúsculas */
                  }
                  /* 3. Reduce el tamaño del texto y el espaciado en las tablas */
                  #recurrentes-content td, #recurrentes-content th,
                  #tarjetas-content td, #tarjetas-content th,
                  #registros-content td, #registros-content th,
                  #proyeccion-content td, #proyeccion-content th {
                      font-size: 1rem; /* 12px, texto más pequeño */
                      padding: 4px 2px;   /* Menos espaciado vertical y horizontal */
                  }

                  /* 4. Hace más pequeños los botones de acción principales */
                  #mostrar, #main-action-btn, #delete-selected-btn, #save-budgets-btn, #migrate-all-recurring-btn {
                      font-size: 0.7rem; /* 11px, texto del botón más pequeño */
                      padding: 2px 6px;
                      margin-top: 0rem;
                      
                  }

                  /* 5. Lógica para ocultar y mostrar los filtros */
                  #filters-container {
                      display: none; /* Oculta los filtros por defecto */
                      flex-direction: column; /* Apila los filtros verticalmente */
                  }

                  #filters-container.filters-visible {
                      display: flex; /* Muestra los filtros cuando el botón es presionado */
                  }
                  
                  
                  #toggle-filters-btn {
                      display: block; /* Asegura que el botón de filtros sea visible en móvil */
                  }

                  #dashboard .dashboard-card:first-child {
                      margin-top: 2rem;
                  }                  

                  /* Pega el nuevo código aquí, dentro del media query para móviles */
                  /* 1. Reduce el espaciado interno de las tarjetas para dar más espacio */
                  .dashboard-card {
                      margin-top: 0rem;
                      padding: 1rem; /* Antes era 1.5rem */
                      gap: 0.5rem;   /* Añade un espacio menor entre texto e icono */
                  }

                  /* 2. Reduce el tamaño del texto del monto (el número grande) */
                  .dashboard-card p:last-child {
                      font-size: 1.75rem; /* Antes era 2.25rem */
                  }

                  /* 3. (Opcional pero recomendado) Reduce un poco el tamaño de la etiqueta */
                  .dashboard-card p:first-child {
                      font-size: 0.8rem; /* Un poco más pequeño para mantener la proporción */
                  }
                  
                  /* AJUSTE PARA IMÁGENES DEL DASHBOARD EN MÓVIL */
              }


              @media (max-width: 768px) {
                  /* Identificadores de los modales a modificar */
                  .modal#transaction-modal,
                  .modal#recurring-expense-modal,
                  .modal#credit-card-modal {

                      /* NUEVO: Reduce el espacio del encabezado */
                      .p-6.border-b {
                          padding-bottom: 1px; /* Reduce el padding inferior del título */
                          
                      }

                      /* 1. Reduce el tamaño del título principal del modal (sin cambios) */
                      h2 {
                          font-size: 1rem; 
                          padding: 0.1rem;
                      }

                      /* 2. Hace más pequeños los labels (etiquetas) (sin cambios) */
                      label {
                          font-size: 0.75rem;
                      }

                      /* 3. AJUSTE DEFINITIVO DE INPUTS: Altura, ancho y tamaño de letra uniformes */
                      input, select {
                          font-size: 16px !important; /* Mantiene la corrección anti-zoom de iOS */
                          height: 44px; /* NUEVO: Altura fija para todos los campos (ideal para tocar con el dedo) */
                          width: 100% !important; /* CAMBIO: Se añade !important para forzar el ancho */
                          padding: 0 0.75rem; /* Padding solo horizontal, la altura ya está definida */
                          box-sizing: border-box; /* NUEVO: Asegura que el padding no altere el tamaño total */
                      }

                      /* 4. Hace más pequeñas las etiquetas de radio (sin cambios) */
                      .radio-type-label {
                          font-size: 0.8rem;
                          padding: 0.4rem 0.5rem;
                          display: flex; /* Centra el texto en la etiqueta de radio */
                          align-items: center;
                          justify-content: center;
                      }

                      /* 5. Reduce el tamaño de los botones de acción principales (sin cambios) */
                      #save-transaction-btn,
                      #save-recurring-btn,
                      #save-credit-card-btn,
                      #open-transfer-modal-btn {
                          font-size: 0.75rem;
                          padding: 0.5rem 1rem;
                      }

                      /* 6. AJUSTE DE ESPACIADO: Se reduce padding superior y espacio entre campos */
                      .modal .p-8.space-y-6 {
                          padding: 0px 1rem 1rem 1rem; /* NUEVO: Padding superior de 4px, el resto 1rem (16px) */
                      }
                      .modal .p-8.space-y-6 > * + * {
                          margin-top: 0.25rem; /* Espacio entre campos se mantiene en 12px */
                      }

                      /* 7. Reduce el espaciado del pie del modal (sin cambios) */
                      .modal .p-6.border-t {
                          padding: 0.75rem;
                      }
                  }
                  /* ===== CORRECCIÓN DEFINITIVA DE ESPACIO Y ANCHO (MÓVIL) ===== */
                  /* Estas reglas de alta especificidad anulan cualquier conflicto. */
                  
                  /* 1. Elimina el relleno inferior del encabezado para juntarlo al formulario. */
                  .modal#transaction-modal .p-6.border-b {
                      padding-bottom: 0 !important;
                  }

                  /* 2. Añade un pequeño espacio superior controlado al formulario. */
                  .modal#transaction-modal .p-8.space-y-6 {
                      padding-top: 12px !important; /* ¡Este es el espacio real y controlado! */
                  }

                  /* 3. Forza el ancho del input de fecha para que sea igual al resto. */
                  .modal#transaction-modal input#transaction-date {
                      width: 100% !important;
                  }                  
              }

              /* ====================================================================== */
              /* ===== LÓGICA PARA BOTÓN DE LOGOUT EN LA BARRA DE PESTAÑAS (MÓVIL) ===== */
              /* ====================================================================== */

              /* 1. Ocultamos el nuevo botón por defecto (en escritorio) */
              #logout-tab-btn {
                  display: none;
              }

              @media (max-width: 768px) {
                  /* 2. Lo mostramos como un elemento flex en la barra de pestañas móvil */
                  #logout-tab-btn {
                      display: flex;
                  }

                  /* 3. (Opcional) Le damos un color rojo al círculo para distinguirlo */
                  #logout-tab-btn .tab-icon-wrapper {
                      background-color: #581c1c; /* Un rojo oscuro */
                  }

                  #logout-tab-btn:hover .tab-icon-wrapper {
                      background-color: var(--electric-red); /* Rojo brillante al pasar el mouse */
                  }
              }

              @media (max-width: 768px) {
                /* ===== INICIO DEL CÓDIGO MODIFICADO PARA BOTONES DE PESTAÑAS MÓVIL ===== */
                
                /* 1. El botón principal se convierte en un contenedor flexible */
                .tab-button { 
                  padding: 0.5rem 0.25rem; /* Más espacio vertical */
                  border-radius: 8px;     /* Un radio sutil en lugar de la píldora */
                  margin-left: 3px;
                  margin-right: 3px;              
                  width: 80px;            /* Ancho fijo para alinear los botones */
                  flex-shrink: 0;
                  background: transparent;         /* Evita que se encojan */
                }

                /* 3. Ajustes para el icono (img) para que quepa bien en el círculo */
                .tab-button img {
                    height: 64px;           /* Tamaño del icono reducido */
                    width: auto;
                    margin-bottom: 0;
                    padding: 1px;       /* Resetea el margen que tenía */
                }

                /* 4. Ajustes para el texto (span) debajo del círculo */
                .tab-button span {
                    font-size: 0.7rem;      
                    line-height: 1.3;        /* Aumenta el espacio entre líneas para mejor lectura */
                    text-align: center;
                    word-break: break-word;  /* Permite que palabras largas se partan si es necesario */
                    hyphens: auto;           /* Añade guiones para una división más natural */
                }

                /* 5. Efecto visual para el botón activo */
                .tab-button.active {
                    background-color: transparent; /* Resalta el círculo */
                    transform: scale(1.05); /* Lo hace un poco más grande */
                }

                #main-action-btn {
                  background-color: var(--electric-blue); color: white;
                  font-size: 0.85rem;
                  margin-left: 0;
                }

                #main-action-btn:hover { 
                  background-color: #0ea4e9c8; 
                  transform: scale(1.05);
                  width: auto;
                  height: 20px;                
                }

                
                /* ===== FIN DEL CÓDIGO MODIFICADO ===== */

                /* ... otros estilos que ya tienes ... */
              }

/* ====================================================================== */
/* ===== AJUSTE PARA ALINEAR PESTAÑAS EN VISTA PC - 03/09/2025 ======== */
/* ====================================================================== */
              /* --- Estilos para la fecha en vista de escritorio --- */
              @media (min-width: 769px) {
                  .mobile-date { display: none; } /* Oculta el día solo */
                  .desktop-date { display: inline; } /* Muestra la fecha completa */
                  #toggle-filters-btn {
                      display: none; /* Oculta el botón de filtros en escritorio */
                  }
              }
              @media (min-width: 769px) {
                /* 1. Estilos para el contenedor de las pestañas (#tabs) */
                #tabs {
                  justify-content: space-between; /* Distribuye el espacio entre los botones */
                  width: 100%;                  /* Asegura que el contenedor ocupe todo el ancho */
                }

                /* 2. Estilos para cada botón individual (.tab-button) */
                .tab-button {
                  flex-grow: 1;        /* Permite que cada botón crezca para ocupar el espacio sobrante */
                  text-align: center;  /* Centra el contenido (ícono y texto) dentro del botón expandido */
                }
              }    

             /* === EFECTO NEÓN EN BOTONES DE PESTAÑAS === */

            .tab-button:hover {
              color: var(--electric-blue);
              background-color: transparent;
              border-bottom-color: var(--electric-blue);
              box-shadow: 
                0 0 8px var(--electric-blue),
                0 0 15px var(--electric-blue),
                0 0 25px var(--electric-blue); /* Efecto neón al pasar el mouse */
                inset: 0 0 10px rgba(14, 165, 233, 0.6); /* Neón interno al estar activo */               
            }
            .tab-button.active {
              box-shadow: 
                0 0 8px var(--bg-dark-tertiary),
                0 0 15px var(--bg-dark-tertiary),
                0 0 25px var(--bg-dark-tertiary); /* Efecto neón al pasar el mouse */
                inset: 0 0 5px rgba(112, 114, 115, 0.6); /* Neón interno al estar activo */ 
            }

              .tab-button img{
                height: 64px;
                width: auto;
              }
              .btn{
              display: flex;
              overflow-x: auto;
              }

              .tab-button{
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding-left: 1px;
                padding-right: 1px;
                margin-left: 2px;
                padding-top: 4px;
                border-radius: 10px;
                margin-bottom: 2px;
              }

              /* ====================================================================== */
              /* ===== ESTILOS PARA BOTÓN DE INFO Y TOOLTIP EN TABLAS - 03/09/2025 ==== */
              /* ====================================================================== */

              /* --- Estilos para el Tooltip (el cuadro de texto emergente) --- */
              .info-tooltip {
                  position: fixed; /* Se posiciona relativo a la ventana */
                  background-color: var(--bg-dark-primary);
                  color: var(--text-light-primary);
                  padding: 0.5rem 0.75rem;
                  border-radius: 6px;
                  border: 1px solid var(--border-dark);
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
                  font-size: 0.8rem;
                  max-width: 250px; /* Ancho máximo para el texto */
                  z-index: 1100;    /* Se asegura que esté por encima de todo */
                  opacity: 0;
                  transition: opacity 0.2s ease-in-out;
                  pointer-events: none; /* Evita que el tooltip interfiera con otros clics */
              }
              .info-tooltip.visible {
                  opacity: 1;
              }


    </style>
  </head>
  <body class="mt-56 view-dashboard">
    <div class="loading-overlay active" id="loading-overlay">
      <div class="spinner">
      </div>
      <p class="ml-4 text-lg text-gray-700">
        Cargando datos...
      </p>
    </div>
    <div id="toast-container"></div>
    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="auth-modal">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col">
        <h2 class="text-2xl font-bold p-6 border-b flex-shrink-0 text-center">
          Bienvenido al Gestor de Presupuesto
        </h2>
        <div class="p-6 flex-grow">
          <div class="mb-4 text-center">
            <p class="text-gray-600">
              Inicia sesión o regístrate para acceder a tus datos.
            </p>
          </div>
          <form class="space-y-4" id="auth-form">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="auth-email">
                Correo Electrónico
              </label>
              <input class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="auth-email" required="" type="email"/>
              <span class="input-error-message" id="auth-email-error">
              </span>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="auth-password">
                Contraseña
              </label>
              <input class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="auth-password" required="" type="password"/>
              <span class="input-error-message" id="auth-password-error">
              </span>
            </div>
            <div class="flex flex-col sm:flex-row justify-between gap-3 pt-4">
              <button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center" id="login-btn" type="submit">
                Iniciar Sesión
                <span class="btn-spinner hidden">
                </span>
              </button>
              <button class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center" id="register-btn" type="button">
                Registrarse
                <span class="btn-spinner hidden">
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div id="main-content-wrapper">
      <header>
          <div id="main-header-bar" class="mt-0 fixed top-0 left-0 w-full h-32">
            <div class="w-full pt-2 pb-2 flex items-center justify-between pr-4" id="barr">

              <img src="https://res.cloudinary.com/datwdagbf/image/upload/v1756514680/logo_jkwegt.png" alt="Logo" class="logotipo  pl-4"/>

              <div class="flex-1 text-center">
                <h1 class="text-3xl font-bold">
                  GESTOR FINANCIERO Y DE PRESUPUESTO WEB
                </h1>
                <p id="ptitul" class="text-lg">
                  Bienvenido,
                  <strong class="font-semibold" id="user-alias-display">Cargando...</strong>:
                  Tu panel de control financiero, moderno y eficiente.
                </p>
                <button id="open-brand-story-btn" class="btn-philosophy">Conoce nuestra filosofía</button>
              </div>

              <div class="flex flex-col items-end">
                <button id="IdbtOpenScreen" class="btOpenScreen mb-1 mr-1">Pantalla Completa</button>
                <button id="IdbtCloseScreen" class="btcloseScreen mb-1">Mostrar Navegador</button> 
                <button class="bttclose mr-6" id="logout-btn">
                  Cerrar Sesión
                  <span class="btn-spinner hidden"></span>
                </button>
              </div>  
              
            </div>
          
            <div class="contenedor-botones flex-col md:flex-row md:items-center md:justify-between">
              <div class="btn" id="tabs">
                
                <button class="tab-button" data-tab="registros">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514689/registro_mc8ed8.png" alt="Icono Registros" class="w-14 mb-1" />
                    <span>Registros</span>
                </button>

                <button class="tab-button" data-tab="proyeccion">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514685/proyeccion_hh3xyt.png" alt="Icono Proyección" class="h-12 w-14 mb-1" />
                    <span>Proyección</span>
                </button>                
                <button class="tab-button" data-tab="recurrentes">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes2_udrbey.png" alt="Icono recurrentes" class="h-11 w-11 mb-1" />
                    <span>Gastos Recurrentes</span>
                </button>
                <button class="tab-button" data-tab="tarjetas">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514697/tarjetas2_z3jokx.png" alt="Icono tarjetas" class="h-12 w-12 mb-1" />
                    <span>Tarjetas de Crédito</span>
                </button>
                <button class="tab-button" data-tab="saldos">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514692/saldos_lntcfz.png" alt="Icono saldos" class="h-9 w-12 mb-1" />
                    <span>Saldos de Cuentas</span>
                </button>
                <button class="tab-button" data-tab="calculadora">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/proyeccion2_iqtpug.png" alt="Icono calculadora" class="h-9 w-10 mb-1" />
                    <span>Calculadora</span>
                </button>
                <button class="tab-button" data-tab="reportes">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/reportes_qisw3e.png" alt="Icono reportes" class="h-9 w-11 mb-1" />
                    <span>Reportes</span>
                </button>
                <button class="tab-button" data-tab="presupuesto">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514684/presupuesto_r7qkr9.png" alt="Icono Presupuesto" class="h-10 w-11 mb-1" />
                    <span>Presupuesto</span>
                </button>                
                <button class="tab-button" data-tab="configuración">
                    <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/configuracion_puo2ap.png" alt="Icono configuración" class="h-11 w-11 mb-1" />
                    <span>Configuración</span>
                </button>
                <button class="tab-button" id="logout-tab-btn">
                    <div class="tab-icon-wrapper">
                      <img src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889218/51B410C2-D58E-47D8-9ECC-000296533E2C_udpy1y.png" alt="Icono Salir" />
                    </div>
                    <span>Salir</span>
                </button>
              </div>
            </div>
          </div>  
      </header>
  
      <div id="tour-toast" class="fixed bottom-5 right-5 z-50 max-w-sm bg-white rounded-lg shadow-lg flex items-center gap-4 p-4 transition-transform transform">
        <div class="flex-shrink-0">
          <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>        
        <div class="flex-grow">
          <p class="font-bold text-gray-800">¿Eres nuevo aquí?</p>
          <p class="text-sm text-gray-600">Toma un tour rápido para conocer todas las funciones.</p>
        </div>
        
        <div class="flex flex-col items-center gap-2">
          <button id="start-tour-btn-toast" class="bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-blue-700 w-full">
            Iniciar
          </button>
          <button id="close-tour-toast-btn" class="text-xs text-gray-500 hover:underline">
            Ahora no
          </button>
        </div>
      </div>

      <div id="dashboard">
        <div class="dashboard-card">
          <div>
            <p>Saldo Actual</p>
            <p id="current-balance">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png" alt="Icono Saldo Actual" class="p-0">
          </div>
        </div>
        <div class="dashboard-card">
          <div>
            <p>Ingresos del Mes</p>
            <p id="monthly-income">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514677/ingreso_yhpbrn.png" alt="Icono Ingresos" class="">
          </div>
        </div>
        <div class="dashboard-card">
          <div>
            <p>Gastos del Mes</p>
            <p id="monthly-expenses">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514672/gasto_dowgd2.png" alt="Icono Gastos" class="">
          </div>
        </div>
      </div>

      <div class="mr-8 ml-8 mt-2 text-sm text-yellow-700" id="credit-card-alerts"></div>
      <div class="mr-8 ml-8 mt-2 text-sm text-blue-700" id="recurring-alerts"></div>      

      <main id="main-container" class="container mx-auto bg-gray-200 rounded-xl shadow-md mt-24">              
        <div class="button-container">
          <div class="flex items-center space-x-2">
              <button id="migrate-all-recurring-btn" class="bg-green-600 text-white px-2 py-1 rounded-lg hover:bg-green-700 transition flex items-center space-x-2 hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                  <span>Registrar Todos</span>
                  <span class="btn-spinner hidden"></span>
              </button>
              <button class="bg-green-600 text-white px-2 py-1 rounded-lg hover:bg-green-700 transition flex items-center justify-center space-x-2 hidden" id="save-budgets-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                  <span>Guardar</span>
                  <span class="btn-spinner hidden"></span>
              </button>
              <button id="delete-selected-btn" class="bg-red-600 text-white px-2 py-1 rounded-lg hover:bg-red-700 transition flex items-center space-x-2 hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                  <span>Eliminar Seleccionados</span>
                  <span class="btn-spinner hidden"></span>
              </button>
              <button class="bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2 hidden" id="main-action-btn">
                <span id="main-action-btn-text"></span>
              </button>
          </div>
          <button id="toggle-filters-btn" class="bg-gray-700 text-white px-3 py-1 rounded-lg hover:bg-gray-800 text-xs">
              Filtros
          </button>
          <button class="aparecer" id="mostrar">
              <span>X</span>
          </button>

        </div>

            <div class="flex flex-col md:flex-row gap-4 mb-4" id="filters-container">
              <input class="flex-grow p-1 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-description" placeholder="Filtrar por descripción..." type="text"/>
              <select class="p-1 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-category" type="text">
                <option value="">
                  Todas las categorías
                </option>
              </select>
              <input class="p-1 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-month" type="month"/>
            </div>

            <div id="registros-content" class="tab-pane active">
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-2 py-3 text-center">
                          <input type="checkbox" id="select-all-registros" title="Seleccionar Todo">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Fecha
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Descripción
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Categoría
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Monto
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Saldo
                        </th>                    
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Acciones
                        </th>
                      </tr>
                    </thead>                
                    <tbody class="bg-white divide-y divide-gray-200" id="transactions-table-body">
                    </tbody>
                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                      <tr>
                        <td class="px-6 py-4 text-right text-gray-700 text-sm uppercase" colspan="2">Total Ingresos:</td>
                        <td class="px-6 py-4 text-right text-green-600 text-sm" id="registros-total-income">$0.00</td>
                        <td class="px-6 py-4 text-right text-gray-700 text-sm uppercase" colspan="2">Total Gastos:</td>
                        <td class="px-6 py-4 text-right text-red-600 text-sm" id="registros-total-expenses">$0.00</td>
                      </tr>
                    </tfoot>              
                  </table>
                  <p class="text-center text-gray-500 py-8" id="no-transactions-message">
                    No hay transacciones para el período seleccionado.
                  </p>
                </div>
            </div>

          <div class="tab-pane hidden" id="proyeccion-content">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-2 py-3 text-center">
                      <input type="checkbox" id="select-all-proyeccion" title="Seleccionar Todo">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Fecha
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Descripción
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Categoría
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Monto
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Saldo
                    </th>                    
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>                
                <tbody class="bg-white divide-y divide-gray-200" id="proyeccion-table-body">
                </tbody>
                <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                    <tr>
                      <td class="px-6 py-4 text-right text-gray-700 text-sm uppercase" colspan="2">Total Ingresos:</td>
                      <td class="px-6 py-4 text-right text-green-600 text-sm" id="proyeccion-total-income">$0.00</td>
                      <td class="px-6 py-4 text-right text-gray-700 text-sm uppercase" colspan="2">Total Gastos:</td>
                      <td class="px-6 py-4 text-right text-red-600 text-sm" id="proyeccion-total-expenses">$0.00</td>
                    </tr>
                </tfoot>               
              </table>
              <p class="text-center text-gray-500 py-8" id="no-proyeccion-message">
                No hay transacciones para el período seleccionado.
              </p>
            </div>
          </div>

          <div class="tab-pane hidden" id="recurrentes-content"> 
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-2 py-3 text-center">
                      <input type="checkbox" id="select-all-recurrentes" title="Seleccionar Todo">
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Día
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Descripción
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Categoría
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Monto
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Banco/Cuenta
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="recurring-expenses-table-body">
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td class="px-6 py-4 text-right text-gray-700 text-sm uppercase" colspan="5">
                      Total Mensual Proyectado
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-700" id="recurring-total">
                      $0.00
                    </td>
                  </tr>
                </tfoot>
              </table>
              <p class="text-center text-gray-500 py-8" id="no-recurring-expenses-message">
                No has añadido ningún gasto recurrente.
              </p>
            </div>
          </div>
          <div class="tab-pane hidden" id="tarjetas-content">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Banco
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Fecha de Pago
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Monto Adeudado
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Tasa Interés (Anual %)
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Meses para Saldar
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Pago Mensual Sugerido
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="credit-cards-table-body">
                    <tfoot class="bg-gray-50">
                      <tr>
                        <td colspan="2" class="px-4 py-4 text-right text-sm font-semibold text-gray-700">
                          Total Monto Adeudado
                        </td>
                        <td class="px-4 py-4 text-sm font-bold text-gray-900" id="cc-total-amount">$0.00</td>
                        <td colspan="2" class="px-4 py-4 text-right text-sm font-semibold text-gray-700">
                          Total Pago Mensual Sugerido
                        </td>
                        <td class="px-4 py-4 text-sm font-bold text-blue-700" id="cc-total-monthly">$0.00</td>
                        <td></td>
                      </tr>
                    </tfoot>

                </tbody>
              </table>
              <p class="text-center text-gray-500 py-8" id="no-credit-cards-message">
                No has añadido ninguna tarjeta de crédito.
              </p>
            </div>
          </div>
          <div class="tab-pane hidden" id="saldos-content">
            <h3 class="text-lg font-semibold mb-4">
              Saldos Actuales por Cuenta
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="bank-balances-grid">
              </div>
            <p class="text-center text-gray-500 py-8 hidden" id="no-balances-message">
              No hay cuentas con transacciones para mostrar saldos.
            </p>
          </div>
          <div class="tab-pane hidden" id="presupuesto-content">
          
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Categoría</th>
                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Presupuesto Asignado</th>
                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Monto Gastado</th>
                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Saldo Disponible</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="budget-table-body">
                </tbody>
                <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                  <tr>
                    <td class="px-6 py-4 text-left text-gray-800 text-sm uppercase">Totales</td>
                    <td class="px-6 py-4 text-right text-blue-700 text-sm" id="budget-total-budgeted">$0.00</td>
                    <td class="px-6 py-4 text-right text-orange-600 text-sm" id="budget-total-spent">$0.00</td>
                    <td class="px-6 py-4 text-right text-green-700 text-sm" id="budget-total-remaining">$0.00</td>
                  </tr>
                </tfoot>
              </table>
              <p class="text-center text-gray-500 py-8 hidden" id="no-categories-for-budget-message">
                No has añadido ninguna categoría en la sección de Configuración.
              </p>
            </div>
          </div>          
          <div class="tab-pane hidden" id="reportes-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
              <div>
                <h3 class="text-lg font-semibold mb-4">
                  Gastos por Categoría (Gráfico)
                </h3>
                <div class="w-full h-80 md:h-96 relative">
                  <canvas id="expenses-chart">
                  </canvas>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold mb-4">
                  Gastos por Categoría (Totales)
                </h3>
                <div class="space-y-3 max-h-96 overflow-y-auto pr-2" id="category-totals-list">
                </div>
                <div class="border-t mt-4 pt-4">
                  <div class="flex justify-between items-center font-bold text-lg">
                    <span>
                      Total de Gastos:
                    </span>
                    <span class="text-red-600" id="total-expenses-report">
                      $0.00
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-8">
              <h3 class="text-lg font-semibold mb-4">
                Flujo de Efectivo Mensual
              </h3>
              <div class="w-full h-80 md:h-96 relative">
                <canvas id="cash-flow-chart">
                </canvas>
              </div>
            </div>
          </div>
          <div class="tab-pane hidden" id="configuración-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
              <div>
                <h3 class="text-lg font-semibold mb-4">
                  Gestionar Categorías
                </h3>

                <div class="mb-4">
                  <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="open-add-category-modal-btn">
                    Añadir Nueva Categoría
                  </button>
                </div>                

                <div class="max-h-60 overflow-y-auto border rounded-lg p-2">
                  <ul class="space-y-2" id="category-list">
                  </ul>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold mb-4">
                  Gestionar Bancos/Cuentas
                </h3>
                <div class="mb-4">
                  <input class="w-full p-2 border rounded-lg mb-2" id="new-bank-name" placeholder="Nombre de nuevo banco" type="text"/>
                  <span class="input-error-message" id="new-bank-name-error">
                  </span>
                  <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="add-bank-btn">
                    Añadir Banco
                    <span class="btn-spinner hidden">
                    </span>
                  </button>
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-lg p-2">
                  <ul class="space-y-2" id="bank-list">
                  </ul>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold mb-4">
                  Gestionar Descripciones
                </h3>
                <div class="max-h-72 overflow-y-auto border rounded-lg p-2">
                  <ul class="space-y-2" id="description-list-config">
                  </ul>
                </div>
              </div>
            </div>
            <div class="mt-8 border-t pt-6">
              <h3 class="text-lg font-semibold mb-4">
                Configuración de Usuario
              </h3>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="user-alias">
                  Tu Alias/Nombre Visible
                </label>
                <input class="w-full p-2 border rounded-lg mb-2" id="user-alias" placeholder="Ej: Mi Presupuesto Feliz" type="text"/>
                <span class="input-error-message" id="user-alias-error">
                </span>
                <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="save-alias-btn">
                  Guardar Alias
                  <span class="btn-spinner hidden">
                  </span>
                </button>
              </div>
            </div>

            <div class="mt-8 border-t pt-6">
              <h3 class="text-lg font-semibold mb-4">
                Cambiar Contraseña
              </h3>
              <form id="change-password-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="current-password">
                    Contraseña Actual
                  </label>
                  <input class="w-full p-2 border rounded-lg" id="current-password" placeholder="Ingresa tu contraseña actual" type="password" required />
                  <span class="input-error-message" id="current-password-error"></span>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="new-password">
                    Nueva Contraseña
                  </label>
                  <input class="w-full p-2 border rounded-lg" id="new-password" placeholder="Mínimo 6 caracteres" type="password" required />
                  <span class="input-error-message" id="new-password-error"></span>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="confirm-new-password">
                    Confirmar Nueva Contraseña
                  </label>
                  <input class="w-full p-2 border rounded-lg" id="confirm-new-password" placeholder="Repite la nueva contraseña" type="password" required />
                  <span class="input-error-message" id="confirm-new-password-error"></span>
                </div>
                <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="change-password-btn" type="submit">
                  Actualizar Contraseña
                  <span class="btn-spinner hidden"></span>
                </button>
              </form>
            </div>           

            <div class="mt-8 border-t pt-6">
              <h3 class="text-lg font-semibold mb-4">
                Acciones de Período
              </h3>
              <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center justify-center" id="initiate-new-month-btn">
                Iniciar Nuevo Mes
                <span class="btn-spinner hidden">
                </span>
              </button>
              <p class="text-sm text-gray-500 mt-2">
                Crea un archivo de respaldo y prepara la aplicación para el siguiente mes.
              </p>
            </div>
            <div class="mt-8 border-t pt-6">
              <h3 class="text-lg font-semibold mb-4">
                Importar y Exportar
              </h3>
              <div class="flex flex-wrap gap-4">
                <button class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800" id="export-pdf-btn">
                  Exportar a PDF
                </button>
                <button class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800" id="export-json-btn">
                  Exportar Datos (JSON)
                </button>
                <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center" id="import-json-btn" type="button">
                  Importar Datos (JSON)
                  <span class="btn-spinner hidden">
                  </span>
                </button>
                <input accept=".json" class="hidden" id="import-file-input" type="file"/>
              </div>
              <p class="text-sm text-gray-500 mt-2">
                Guarda o carga los datos de un período específico.
              </p>
            </div>
            <div class="mt-8 border-t pt-6">
              <h3 class="text-lg font-semibold mb-4 text-red-600">
                Zona de Peligro
              </h3>
              <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center justify-center" id="reset-data-btn">
                Reiniciar Todos los Datos
                <span class="btn-spinner hidden">
                </span>
              </button>
              <p class="text-sm text-gray-500 mt-2">
                ¡Cuidado! Esta acción eliminará permanentemente todos los datos actuales.
              </p>
            </div>
          </div>
          <div class="tab-pane hidden p-0 m-0" id="calculadora-content">
            <div class="w-full max-w-4xl mx-auto">
              <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <div ID="titucalculadora" class="text-center mb-8">
                  <h3  class="text-3xl md:text-4xl font-bold text-blue-600">
                    Calculadora de Salario Neto Avanzada
                  </h3>
                    <p class="text-blue-500 mt-2">
                      Estima tu pago en Florida con Overtime y Préstamos (Año Fiscal 2025)
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  <div class="bg-gray-50 p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                      Información de Ingresos
                    </h2>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="hourlyRate">
                          Tarifa por Hora ($)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="hourlyRate" type="number" value="25"/>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="hoursWorked">
                          Horas Totales Trabajadas (Quincenal)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="hoursWorked" type="number" value="80"/>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="filingStatus">
                          Estado Civil Tributario
                        </label>
                        <select class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="filingStatus">
                          <option value="single">
                            Soltero/a
                          </option>
                          <option value="married">
                            Casado/a (declaración conjunta)
                          </option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="bg-gray-50 p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                      Deducciones Voluntarias
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="contribution401kType">
                          Tipo 401(k)
                        </label>
                        <select class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="contribution401kType">
                          <option value="percent">
                            % del Salario
                          </option>
                          <option value="amount">
                            Monto Fijo ($)
                          </option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="contribution401kValue" id="contribution401kLabel">
                          Valor 401(k)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="contribution401kValue" type="number" value="5"/>
                      </div>
                    </div>
                    <div class="space-y-4 mt-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="medicalDeduction">
                          Seguro Médico ($ por período)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="medicalDeduction" type="number" value="150"/>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="dentalDeduction">
                          Seguro Dental ($ por período)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="dentalDeduction" type="number" value="20"/>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="visionDeduction">
                          Seguro de Visión ($ por período)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="visionDeduction" type="number" value="10"/>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-600" for="loan401k">
                          Préstamo de 401(k) ($ por período)
                        </label>
                        <input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="loan401k" type="number" value="0"/>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center mb-8">
                  <button class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 text-lg shadow-md" id="calculateBtn">
                    Calcular Salario Neto
                  </button>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl hidden" id="results">
                  <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">
                    Resumen del Pago
                  </h2>
                  <div class="result-grid">
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                      <p class="text-sm text-gray-500">
                        Salario Bruto
                      </p>
                      <p class="text-xl font-semibold text-green-600" id="grossPayResult">
                        $0.00
                      </p>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                      <p class="text-sm text-gray-500">
                        Deduc. Pre-Impuestos
                      </p>
                      <p class="text-xl font-semibold text-orange-500" id="preTaxDeductionsResult">
                        $0.00
                      </p>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                      <p class="text-sm text-gray-500">
                        Impuesto Federal
                      </p>
                      <p class="text-xl font-semibold text-red-500" id="federalTaxResult">
                        $0.00
                      </p>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                      <p class="text-sm text-gray-500">
                        Impuestos FICA
                      </p>
                      <p class="text-xl font-semibold text-red-500" id="ficaTaxResult">
                        $0.00
                      </p>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                      <p class="text-sm text-gray-500">
                        Deduc. Post-Impuestos
                      </p>
                      <p class="text-xl font-semibold text-red-500" id="postTaxDeductionsResult">
                        $0.00
                      </p>
                    </div>
                  </div>
                  <div class="mt-6 pt-6 border-t-2 border-dashed border-blue-200 text-center">
                    <p class="text-lg text-gray-700">
                      Tu Salario Neto Estimado es:
                    </p>
                    <p class="text-4xl md:text-5xl font-extrabold text-blue-700 mt-2" id="netPayResult">
                      $0.00
                    </p>
                    <p class="text-xs text-gray-500 mt-4">
                      por período de pago quincenal
                    </p>
                  </div>
                </div>
                <div class="text-xs text-gray-400 text-center mt-6">
                  <p>
                    <strong>
                      Descargo de responsabilidad:
                    </strong>
                    Esta es una herramienta de estimación. Las cifras reales pueden variar. El cálculo del impuesto federal es una aproximación. El límite anual del Seguro Social no se tiene en cuenta en este cálculo por período.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-2" id="transaction-modal">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
          <h2 class="text-1xl font-bold hover:bg-blue-700 text-gray-800" id="modal-title">Registrar Transacción</h2>
          <button class="text-gray-400 hover:text-gray-600" id="close-transaction-modal-btn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        
        <form class="flex flex-col flex-grow overflow-hidden" id="transaction-form" novalidate>
          <div class="p-8 flex-grow overflow-y-auto space-y-6">
            <input id="transaction-id" type="hidden"/>
            
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1" for="transaction-date">Fecha</label>
              <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="transaction-date" required type="date"/>
              <span class="input-error-message" id="transaction-date-error"></span>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1" for="transaction-description">Descripción</label>
              <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="transaction-description" list="description-list" required type="text" placeholder="Ej: Compra de supermercado"/>
              <datalist id="description-list"></datalist>
              <span class="input-error-message" id="transaction-description-error"></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="transaction-category">Categoría</label>
                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="transaction-category" required></select>
                <span class="input-error-message" id="transaction-category-error"></span>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="transaction-bank">Banco/Cuenta</label>
                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="transaction-bank" required></select>
                <span class="input-error-message" id="transaction-bank-error"></span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1" for="transaction-amount">Monto</label>
              <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="transaction-amount" required step="0.01" type="number" placeholder="0.00"/>
              <span class="input-error-message" id="transaction-amount-error"></span>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Tipo de Transacción</label>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <input class="radio-type-input" id="type-income" name="transaction-type" type="radio" value="income" checked/>
                  <label class="radio-type-label" for="type-income">Ingreso</label>
                </div>
                <div>
                  <input class="radio-type-input" id="type-expense" name="transaction-type" type="radio" value="expense"/>
                  <label class="radio-type-label" for="type-expense">Gasto</label>
                </div>
              </div>
              <span class="input-error-message" id="transaction-type-error"></span>
            </div>
          </div>

          <div class="p-6 border-t flex-shrink-0 flex flex-col-reverse sm:flex-row justify-between items-center gap-4 bg-gray-50 rounded-b-2xl">
            <button class="w-full sm:w-auto bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200 text-sm font-semibold" id="open-transfer-modal-btn" type="button">
              Transferencia Interna
            </button>
            <div class="w-full sm:w-auto flex justify-end gap-4">
              <button class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center font-bold shadow-lg w-full" id="save-transaction-btn" type="submit">
                Guardar y Registrar Otro
                <span class="btn-spinner hidden"></span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="transfer-modal">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
        <h2 class="text-2xl font-bold p-6 border-b flex-shrink-0">
          Registrar Transferencia Interna
        </h2>
        <form class="flex flex-col flex-grow overflow-hidden" id="transfer-form">
          <div class="p-6 flex-grow overflow-y-auto">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-date">
                Fecha
              </label>
              <input class="w-full p-2 border rounded-lg" id="transfer-date" required="" type="date"/>
              <span class="input-error-message" id="transfer-date-error">
              </span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-from-bank">
                Desde la cuenta
              </label>
              <select class="w-full p-2 border rounded-lg" id="transfer-from-bank" required="" type="text">
              </select>
              <span class="input-error-message" id="transfer-from-bank-error">
              </span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-to-bank">
                Hacia la cuenta
              </label>
              <select class="w-full p-2 border rounded-lg" id="transfer-to-bank" required="" type="text">
              </select>
              <span class="input-error-message" id="transfer-to-bank-error">
              </span>
            </div>
            <div class="mb-2">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-amount">
                Monto a Transferir
              </label>
              <input class="w-full p-2 border rounded-lg" id="transfer-amount" required="" step="0.01" type="number"/>
              <span class="input-error-message" id="transfer-amount-error">
              </span>
            </div>
          </div>
          <div class="p-6 border-t flex-shrink-0 flex justify-end gap-4">
            <button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" id="transfer-cancel-btn" type="button">
              Cancelar
            </button>
            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="confirm-transfer-btn" type="submit">
              Confirmar Transferencia
              <span class="btn-spinner hidden">
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="recurring-expense-modal">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
          <h2 class="text-2xl font-bold text-gray-800" id="recurring-modal-title">Añadir Gasto Recurrente</h2>
          <button class="text-gray-400 hover:text-gray-600" id="close-recurring-modal-btn" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        
        <form class="flex flex-col flex-grow overflow-hidden" id="recurring-expense-form" novalidate>
          <div class="p-8 flex-grow overflow-y-auto space-y-6">
            <input id="recurring-expense-id" type="hidden"/>
            
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1" for="recurring-description">Descripción</label>
              <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="recurring-description" list="description-list" required type="text" placeholder="Ej: Pago de Alquiler"/>
              <span class="input-error-message" id="recurring-description-error"></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="recurring-category">Categoría</label>
                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="recurring-category" required></select>
                <span class="input-error-message" id="recurring-category-error"></span>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="recurring-bank">Banco/Cuenta</label>
                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="recurring-bank" required></select>
                <span class="input-error-message" id="recurring-bank-error"></span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="recurring-amount">Monto Fijo Mensual</label>
                <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="recurring-amount" required step="0.01" type="number" placeholder="0.00"/>
                <span class="input-error-message" id="recurring-amount-error"></span>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1" for="recurring-day">Día de Pago (1-31)</label>
                <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" id="recurring-day" max="31" min="1" required type="number" placeholder="Ej: 15"/>
                <span class="input-error-message" id="recurring-day-error"></span>
              </div>
            </div>
          </div>
          
          <div class="p-6 border-t flex-shrink-0 flex justify-end gap-4 bg-gray-50 rounded-b-2xl">
            <button class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center font-bold shadow-lg w-full sm:w-auto" id="save-recurring-btn" type="submit">
              Guardar y Añadir Otro
              <span class="btn-spinner hidden"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="credit-card-modal">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
        <h2 class="text-2xl font-bold p-6 border-b flex-shrink-0">
          Añadir Tarjeta
        </h2>
        <form class="flex flex-col flex-grow overflow-hidden" id="credit-card-form">
          <div class="p-6 flex-grow overflow-y-auto">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-bank">
                Banco
              </label>
              <input class="w-full p-2 border rounded-lg" id="credit-card-bank" placeholder="Ej: Banco Mercantil" required="" type="text"/>
              <span class="input-error-message" id="credit-card-bank-error">
              </span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-due-date">
                Día de Pago (1-31)
              </label>
              <input class="w-full p-2 border rounded-lg" id="credit-card-due-date" max="31" min="1" required="" type="number"/>
              <span class="input-error-message" id="credit-card-due-date-error">
              </span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-amount">
                Monto Adeudado
              </label>
              <input class="w-full p-2 border rounded-lg" id="credit-card-amount" required="" step="0.01" type="number"/>
              <span class="input-error-message" id="credit-card-amount-error">
              </span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-rate">
                Tasa de Interés (Anual %)
              </label>
              <input class="w-full p-2 border rounded-lg" id="credit-card-rate" required="" step="0.01" type="number"/>
              <span class="input-error-message" id="credit-card-rate-error">
              </span>
            </div>
            <div class="mb-2">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-months">
                Meses para Saldar
              </label>
              <input class="w-full p-2 border rounded-lg" id="credit-card-months" min="1" required="" type="number"/>
              <span class="input-error-message" id="credit-card-months-error">
              </span>
            </div>
          </div>
          <div class="p-2 border-t flex-shrink-0 flex justify-end gap-4">
            <button class="bg-gray-200 text-gray-800 px-2 py-2 rounded-lg hover:bg-gray-300" id="credit-card-cancel-btn" type="button">
              Cancelar
            </button>
            <button class="bg-blue-600 text-white px-2 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="save-credit-card-btn" type="submit">
              Añadir Tarjeta
              <span class="btn-spinner hidden">
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="confirm-modal">
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg aria-hidden="true" class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-linecap="round" stroke-linejoin="round">
            </path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold mb-4" id="confirm-modal-title">
          Confirmar Acción
        </h2>
        <p class="text-gray-600 mb-6" id="confirm-modal-message">
          ¿Estás seguro? Esta acción no se puede deshacer.
        </p>
        <div class="flex justify-center gap-4">
          <button class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300" id="confirm-modal-cancel-btn" type="button">
            Cancelar
          </button>
          <button class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700" id="confirm-modal-confirm-btn" type="button">
            Confirmar
          </button>
        </div>
      </div>
    </div>
    <div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="message-modal">
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
        <h2 class="text-2xl font-bold mb-4" id="message-modal-title">
          Mensaje
        </h2>
        <p class="text-gray-600 mb-6" id="message-modal-content">
        </p>
        <button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" id="message-modal-close-btn" type="button">
          Cerrar
        </button>
      </div>
    </div>
        <div class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4" id="brand-story-modal">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 class="text-2xl font-bold text-gray-700">
                El Corazón de Foresee Finances
              </h2>
              <button class="text-gray-400 hover:text-gray-600" id="close-brand-story-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto text-gray-600 leading-relaxed">
              <div class="mb-8">
                <h3 class="text-xl font-semibold text-blue-600 mb-2">Nuestra Misión</h3>
                <p class="italic">Empoderar a cada persona para que tome decisiones financieras con claridad y confianza, transformando la ansiedad económica en paz mental y la incertidumbre en un plan de acción para alcanzar sus sueños.</p>
              </div>              
              <div class="mb-8">
                <h3 class="text-xl font-semibold text-blue-600 mb-2">Nuestra Visión</h3>
                <p class="italic">Ser el aliado digital más intuitivo y confiable en el camino hacia el bienestar financiero, demostrando que con las herramientas adecuadas, cualquiera puede dominar sus finanzas personales y construir un futuro próspero.</p>
              </div>
              <div class="border-t pt-8">
                <h3 class="text-xl font-semibold text-blue-600 mb-2">El Origen de Foresee Finances: Una Historia Personal</h3>
                <p class="mb-4">Mi nombre es Melecio Matos, el creador de Foresee Finances. Esta aplicación no nació en una sala de juntas, sino a partir de conversaciones reales con amigos y familiares. Vi a personas trabajadoras, inteligentes y llenas de metas, sentirse atrapadas por el estrés financiero. Veía cómo la falta de un sistema simple para entender su propio dinero les robaba la tranquilidad y les impedía avanzar.</p>
                <p class="mb-4">Frustrado con las aplicaciones existentes, que eran o demasiado complejas o demasiado invasivas (exigiendo acceso a sus cuentas bancarias), decidí crear la solución que yo mismo querría usar. Una herramienta que respetara la privacidad del usuario y que se basara en un principio simple: <strong>la claridad es poder.</strong></p>
                <p>Foresee Finances fue diseñada para ser ese amigo honesto que te muestra la verdad de tus números sin juzgarte. Es el resultado de cientos de horas de desarrollo puestas al servicio de una sola idea: darte un mapa claro y sencillo de tu mundo financiero para que <strong>tú</strong>, y solo tú, seas el capitán de tu destino económico.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4" id="privacy-policy-modal">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 class="text-2xl font-bold text-gray-700">
                Política de Privacidad
              </h2>
              <button class="text-gray-400 hover:text-gray-600 close-legal-modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto text-gray-600 leading-relaxed">
              Política de Privacidad de Foresee Última actualización: 12 de agosto de 2025 Bienvenido a Foresee. Tu privacidad es de suma importancia para nosotros. Esta Política de Privacidad explica qué datos personales recopilamos, cómo los utilizamos, con quién los compartimos y los derechos que tienes sobre tu información.Al registrarte y utilizar Foresee, aceptas las prácticas descritas en esta política.1. Responsable del TratamientoEl responsable del tratamiento de tus datos es:Nombre: [Tu Nombre o el Nombre de tu Empresa]Correo electrónico de contacto: [Tu Correo Electrónico de Contacto]2. Datos que RecopilamosRecopilamos la siguiente información para poder ofrecerte nuestros servicios:Datos de Identificación y Contacto:Dirección de correo electrónico.Contraseña (almacenada de forma segura y encriptada por nuestro proveedor de autenticación).Alias o nombre de usuario que elijas en la aplicación.Datos Financieros:Toda la información que introduces voluntariamente en la aplicación, incluyendo, pero no limitándose a: transacciones, ingresos, gastos, presupuestos, categorías de gastos, información de cuentas bancarias (alias y saldos), detalles de tarjetas de crédito (alias, saldos, fechas de corte) y deudas.3. Finalidad del Uso de DatosUtilizamos tus datos con las siguientes finalidades:Para proveer y mantener el servicio: Autenticar tu acceso, gestionar tu presupuesto, calcular saldos, generar reportes personalizados y permitirte organizar tus finanzas.Para mejorar la aplicación: Podemos analizar datos de uso de forma anónima para identificar errores y mejorar la experiencia de usuario.Para comunicarnos contigo: Enviarte notificaciones importantes sobre tu cuenta o cambios en nuestros servicios y políticas.La base legal para el tratamiento de tus datos es el consentimiento explícito que nos otorgas al registrarte y aceptar nuestros Términos y Condiciones y esta Política de Privacidad.4. Terceros con los que Compartimos DatosPara poder operar, Foresee se apoya en servicios de terceros. No vendemos tus datos personales. El principal proveedor con el que compartimos datos es:Google (Firebase y Firestore): Utilizamos los servicios de Google Cloud Platform para la autenticación de usuarios y como base de datos para almacenar toda la información que registras en la aplicación. Tus datos se almacenan en los servidores seguros de Google. Te recomendamos revisar también la Política de Privacidad de Google.5. Derechos del Usuario (Derechos ARCO)Como usuario, tienes derecho a ejercer tus derechos de Acceso, Rectificación, Cancelación y Oposición (ARCO) sobre tus datos personales.Acceso y Rectificación: Puedes acceder y editar casi toda tu información directamente desde la aplicación (editar transacciones, cambiar nombres de categorías, actualizar saldos, etc.).Cancelación: Puedes eliminar datos específicos (como transacciones o categorías) en cualquier momento. Además, hemos incluido una función de "Reiniciar Todos los Datos" que te permite eliminar toda tu información financiera de nuestra base de datos de forma permanente. Para eliminar tu cuenta por completo, por favor, contáctanos.Oposición: Puedes oponerte al tratamiento de tus datos retirando tu consentimiento, lo que implicaría la eliminación de tu cuenta.Para ejercer cualquiera de estos derechos, puedes utilizar las herramientas de la aplicación o contactarnos a través de [Tu Correo Electrónico de Contacto].6. Seguridad de los DatosNos tomamos la seguridad muy en serio. Implementamos medidas técnicas y organizativas para proteger tu información, principalmente confiando en la infraestructura segura y robusta de Google Firebase para la autenticación, el almacenamiento y la encriptación de datos.7. Cambios en esta PolíticaPodemos actualizar esta Política de Privacidad ocasionalmente. Te notificaremos de cualquier cambio importante a través de la aplicación o por correo electrónico. Te recomendamos revisar esta página periódicamente para estar informado sobre cómo protegemos tu información.8. ContactoSi tienes preguntas o inquietudes sobre esta Política de Privacidad o nuestras prácticas de datos, por favor contáctanos en: [albertomatosgil@gmail.com]
              </div>
          </div>
        </div>

        <div class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4" id="terms-conditions-modal">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 class="text-2xl font-bold text-gray-700">
                Términos y Condiciones
              </h2>
              <button class="text-gray-400 hover:text-gray-600 close-legal-modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto text-gray-600 leading-relaxed">
              Términos y Condiciones de Uso de Foresee Última actualización: 12 de agosto de 2025Estos Términos y Condiciones ("Términos") rigen tu acceso y uso de la aplicación de finanzas personales Foresee ("la Aplicación", "el Servicio"). Al registrarte o utilizar la Aplicación, aceptas estar legalmente vinculado por estos Términos.1. Descripción del ServicioForesee es una herramienta digital diseñada para ayudarte a registrar, categorizar y visualizar tus finanzas personales. La Aplicación es una herramienta de estimación y organización y no debe ser considerada como asesoramiento financiero, legal o fiscal.2. Cuentas de UsuarioCreación de Cuenta: Para usar Foresee, debes registrarte con una dirección de correo electrónico válida y crear una contraseña.Responsabilidad del Usuario: Eres el único responsable de mantener la confidencialidad de tu contraseña y de toda la actividad que ocurra en tu cuenta. Notifícanos inmediatamente si sospechas de cualquier uso no autorizado.Exactitud de la Información: Eres responsable de la exactitud de la información financiera que introduces en la Aplicación.3. Uso AceptableTe comprometes a no utilizar la Aplicación para ningún propósito ilegal o no autorizado. Aceptas no:Intentar acceder sin autorización a nuestros sistemas o redes.Utilizar la Aplicación para cualquier actividad fraudulenta o ilícita.Realizar ingeniería inversa, descompilar o intentar extraer el código fuente de la Aplicación.4. Propiedad IntelectualEl Servicio y todo su contenido original, características y funcionalidades son y seguirán siendo propiedad exclusiva de [Tu Nombre o el Nombre de tu Empresa]. La Aplicación está protegida por derechos de autor y otras leyes. Esta aplicación no es de código abierto y todos los derechos están reservados.5. Limitación de Responsabilidad y Descargo de GarantíasEsta es la sección más importante. Por favor, léela con atención.La Aplicación se proporciona "tal cual". No ofrecemos ninguna garantía, expresa o implícita, de que el Servicio será ininterrumpido, seguro, libre de errores o que cumplirá con tus expectativas.Foresee es una herramienta informativa. Las proyecciones, cálculos y reportes generados por la Aplicación se basan únicamente en los datos que tú proporcionas. No garantizamos su exactitud o aplicabilidad a tu situación financiera particular.No somos asesores financieros. Las decisiones financieras que tomes basándote en la información de la Aplicación son de tu exclusiva responsabilidad. En ningún caso [Tu Nombre o el Nombre de tu Empresa] será responsable por pérdidas económicas, daños directos o indirectos, o cualquier consecuencia derivada del uso o la incapacidad de usar la Aplicación.6. Terminación del ServicioPor parte del usuario: Puedes dejar de usar el servicio y solicitar la eliminación de tu cuenta en cualquier momento.Por nuestra parte: Nos reservamos el derecho de suspender o cancelar tu cuenta si violas estos Términos.7. Cambios en los TérminosNos reservamos el derecho de modificar estos Términos en cualquier momento. Te notificaremos de los cambios importantes. El uso continuado de la Aplicación después de dichos cambios constituirá tu aceptación de los nuevos Términos.8. ContactoSi tienes alguna pregunta sobre estos Términos, contáctanos en [albertomatosgil@gmail.com].
              </div>
          </div>
        </div>

        <div class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4" id="cookie-policy-modal">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 class="text-2xl font-bold text-gray-700">
                Política de Cookies
              </h2>
              <button class="text-gray-400 hover:text-gray-600 close-legal-modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto text-gray-600 leading-relaxed">
              Política de Cookies de ForeseeÚltima actualización: 12 de agosto de 2025Esta Política de Cookies explica cómo Foresee ("nosotros", "nuestro") utiliza cookies y tecnologías similares para reconocerte cuando visitas nuestra aplicación web.1. ¿Qué son las cookies?Las cookies son pequeños archivos de datos que se colocan en tu dispositivo (ordenador o móvil) cuando visitas un sitio web. Se utilizan ampliamente para que los sitios web funcionen, o funcionen de manera más eficiente, así como para proporcionar información de informes.2. ¿Por qué usamos cookies?No creamos cookies personalizadas con fines de seguimiento o publicidad. Sin embargo, nuestro proveedor de infraestructura, Firebase (de Google), las utiliza por razones técnicas esenciales para el funcionamiento de Foresee.Utilizamos cookies para las siguientes finalidades:Cookies Técnicas o Esenciales: Son estrictamente necesarias para proporcionarte los servicios disponibles a través de nuestra Aplicación.Autenticación y Sesión: Firebase Authentication utiliza cookies o almacenamiento local (como localStorage) para gestionar tu sesión. Esto permite que te mantengas conectado mientras navegas por la aplicación sin tener que iniciar sesión en cada página.Seguridad: Ayudan a proteger tu cuenta y prevenir riesgos de seguridad.3. Tipos de Cookies que UtilizamosCookies de Sesión: Son temporales y se eliminan de tu dispositivo cuando cierras el navegador. Las usamos para mantener tu sesión de usuario activa.Cookies Persistentes: Permanecen en tu dispositivo durante un período determinado o hasta que las elimines. Firebase puede usarlas para recordar que has iniciado sesión previamente.4. Cómo puedes gestionar las cookiesTienes derecho a decidir si aceptas o rechazas las cookies.Configuración del Navegador: La mayoría de los navegadores web te permiten controlar las cookies a través de la configuración. Puedes configurar tu navegador para que te notifique cuando se envían cookies, o para que las rechace por completo.Impacto de deshabilitar las cookies: Si decides deshabilitar las cookies esenciales utilizadas por Firebase, no podrás iniciar sesión ni utilizar la aplicación Foresee, ya que son fundamentales para su funcionamiento.Al utilizar Foresee, aceptas el uso de estas cookies esenciales.5. Cambios en esta Política de CookiesPodemos actualizar esta Política de Cookies ocasionalmente para reflejar cambios en nuestras prácticas o por otras razones operativas, legales o regulatorias. Te notificaremos de cualquier cambio importante a través de la aplicación o por correo electrónico.6. ContactoSi tienes preguntas sobre nuestra Política de Cookies, contáctanos en [albertomatosgil@gmail.com].
                </div>
          </div>
        </div>        

        <div class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4" id="category-icon-modal">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
              <h2 class="text-2xl font-bold text-gray-700">
                Selecciona un Ícono para la Categoría
              </h2>
              <button class="text-gray-400 hover:text-gray-600" id="close-icon-modal-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="new-category-name-modal">
                  Nombre de la Nueva Categoría
                </label>
                <input class="w-full p-2 border rounded-lg mb-2" id="new-category-name-modal" placeholder="Ej: Vivienda, Comida, Ocio" type="text"/>
                <span class="input-error-message" id="new-category-name-modal-error"></span>
              </div>
              
              <label class="block text-sm font-medium text-gray-700 mt-4">
                Elige un ícono (o déjalo en "Por Defecto")
              </label>
              <div id="category-icon-grid">
                </div>
            </div>
            <div class="p-6 border-t flex-shrink-0 flex justify-end gap-4">
              <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="save-new-category-btn" type="button">
                Guardar Categoría
                <span class="btn-spinner hidden"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="modal fixed inset-0 bg-transparent items-end" id="single-action-modal">
          <div id="single-action-modal-content" class="bg-white w-full rounded-t-2xl shadow-2xl p-4 transform transition-transform duration-300 translate-y-full">
            <p class="text-sm text-center text-gray-500 mb-3" id="single-action-modal-title">
              Acción para el elemento seleccionado:
            </p>
            <div class="space-y-2">
              <button class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold" id="single-action-edit-btn">
                Editar Selección
              </button>
              <button class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-semibold" id="single-action-delete-btn">
                Eliminar Selección
              </button>
              <button class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 mt-2" id="single-action-cancel-btn">
                Cancelar
              </button>
            </div>
          </div>
        </div>        

        <footer class="bg-gray-800 text-white py-4">
          <div class="container mx-auto text-center">
            <p class="text-sm">
              © 2025 Foresee Finances. Todos los derechos reservados. by Melecio Matos
            </p>
            <p id="app-version" class="text-xs text-gray-400 mt-1">
              Versión 4.3.3
            </p>
            <div class="text-xs mt-2 space-x-4">
              <a href="#" id="open-privacy-policy" class="text-blue-400 hover:underline">Política de Privacidad</a>
              <span>|</span>
              <a href="#" id="open-terms-conditions" class="text-blue-400 hover:underline">Términos de Uso</a>
              <span>|</span>
              <a href="#" id="open-cookie-policy" class="text-blue-400 hover:underline">Política de Cookies</a>
            </div>
          </div>
        </footer>
      
    <script>
          document.addEventListener('DOMContentLoaded', () => {
              const { jsPDF } = window.jspdf;
      
              // --- REFERENCIAS DE FIREBASE (ACCESIBLES GLOBALMENTE) ---
              // Estas variables serán null si Firebase no se inicializó correctamente en el script type="module"
              const app = window.firebaseApp;
              const db = window.db;
              const auth = window.auth;
              const onAuthStateChanged = window.onAuthStateChanged;
              const signInAnonymously = window.signInAnonymously;
              const signInWithCustomToken = window.signInWithCustomToken;
              // Las funciones de autenticación se accederán directamente a través de window en las funciones handleRegister, handleLogin, handleLogout
              const doc = window.doc;
              const getDoc = window.getDoc;
              const setDoc = window.setDoc;
              const updateDoc = window.updateDoc;
              const deleteDoc = window.deleteDoc;
              const onSnapshot = window.onSnapshot;
              const collection = window.collection;
              const query = window.query;
              const getDocs = window.getDocs;
              const writeBatch = window.writeBatch;
      
              // Si Firebase no se inicializó, salimos temprano del script principal
              if (!app || !db || !auth) {
                  console.error("[App Init] Firebase no inicializado. La aplicación no puede funcionar.");
                  return;
              }
      
              // Obtenemos el Project ID de Firebase que se hizo global en el script type="module"
              const firebaseProjectId = window.firebaseProjectId;
              if (!firebaseProjectId) {
                  console.error("[App Init] Firebase Project ID no disponible. No se pueden construir las rutas de Firestore.");
                  showMessageModal("Error de Configuración", "El ID del proyecto Firebase no está disponible. Recarga la página o verifica tu configuración.", "error");
                  hideLoading();
                  return;
              }
      
      
// --- ESTADO DE LA APLICACIÓN ---

              // --- CONSTANTES DE CONFIGURACIÓN DE ICONOS ---
              // Icono que se usará si una categoría no tiene uno asignado.
              const DEFAULT_ICON = 'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514669/dinero_hgnyz4.png';
              
              // Lista de iconos predefinidos que el usuario podrá elegir.
              // ¡Aquí es donde pondrás las URLs de Cloudinary en el futuro!
              const PRESET_ICONS = [
                  DEFAULT_ICON, // Opción por defecto primero
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514703/vivienda_bsyk94.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514702/viajes_duy42o.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514701/transporte_kv5zty.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/transferencia-interna_wjuhnq.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/telefonia_tfmo9l.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514698/tecnologia_zzpzjl.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514698/tarjetas-de-credito_maojob.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514671/entretenimiento2_uxheb0.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514697/tarjetas2_z3jokx.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514696/tarjetas_ngrqvg.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514695/servicios3_wq8cno.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514694/servicios2_lrrt0u.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514694/servicios_vd3ljj.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514693/salud_qt9xjk.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514692/saldos_lntcfz.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514691/saldo_src7bv.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/ropa_lneukc.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/reportes_qisw3e.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514689/registro_mc8ed8.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514688/regalos_nlhx7g.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514687/recurrentes1_jllpdf.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/recurrentes_euwfqq.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/proyeccion2_iqtpug.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514685/proyeccion_hh3xyt.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514684/presupuesto_r7qkr9.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514683/otros_gg6l1e.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/ocio_reehch.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/mascotas_puroqw.png',                 
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514679/inversion2_yedas0.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/inversion_qyl3ly.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/ingresos_ci7j4p.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514677/ingreso_yhpbrn.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514676/impuestos2_l8lyx8.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514675/impuestos_anoyd1.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514674/gym_lihk76.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes2_udrbey.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes_fhbneu.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514672/gasto_dowgd2.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514670/entretenimiento_ltr2qc.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514670/educacion_jyz87e.png',                  
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/deudas_jcqhez.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/configuracion_puo2ap.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514667/compras_u7wb1e.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514666/comida_ecusji.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/celebraciones_pivh9h.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/categoria-default_mmpfg4.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514664/calculadora_k1j5hk.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514664/Banco_u87u1e.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514663/ahorro2_xugr6g.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514663/ahorro_vhwhw7.png',                  
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/deudas_jcqhez.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756767509/comunes_xjuxxt.png',
                  'https://res.cloudinary.com/datwdagbf/image/upload/v1756889218/51B410C2-D58E-47D8-9ECC-000296533E2C_udpy1y.png'

              ];

              // --- ESTRUCTURA DEL ESTADO DE LA APLICACIÓN MODIFICADA ---
              let appState = {
                  transactions: [],
                  projections: [],
                  // IMPORTANTE: 'categories' ya no es un array de strings.
                  // Ahora es un array de objetos, cada uno con 'name' y 'icon'.
                  categories: [], 
                  banks: [],
                  descriptions: [],
                  recurringExpenses: [],
                  creditCards: [],
                  openingBalance: 0,
                  userAlias: null,
                  categoryBudgets: {}, 
                  budgetAlertsShown: {}, 
              };

              let userId = null;
              // ===== AÑADE ESTE BLOQUE DE VARIABLES NUEVO AQUÍ =====
              let unsubscribePreferences = null;
              let unsubscribeTransactions = null;
              let unsubscribeProjections = null;
              let unsubscribeRecurring = null;
              let unsubscribeCreditCards = null;
              // =======================================================

              // Pega el nuevo código aquí
              let modalContext = 'registros'; // Para saber desde qué pestaña se abre el modal              
              let isAuthReady = false; // Bandera para saber si la autenticación ha terminado
              let currentMonthFilterValue = ''; // Para mantener el filtro de mes al recargar datos

              // --- PEGA AQUÍ LAS NUEVAS VARIABLES ---
              let initialTransactionsLoaded = false;
              let initialRecurringLoaded = false;
              let recurringProcessed = false;
      
              // --- ELEMENTOS DEL DOM ---
              const mainContentWrapper = document.getElementById('main-content-wrapper');
              const authModal = document.getElementById('auth-modal');
              const authForm = document.getElementById('auth-form');
              const authEmailInput = document.getElementById('auth-email');
              const authPasswordInput = document.getElementById('auth-password');
              const loginBtn = document.getElementById('login-btn');
              const registerBtn = document.getElementById('register-btn');
              const logoutBtn = document.getElementById('logout-btn');
      
              const mainActionBtn = document.getElementById('main-action-btn');
              const mainActionBtnText = document.getElementById('main-action-btn-text');
              const transactionModal = document.getElementById('transaction-modal');
              const transactionForm = document.getElementById('transaction-form');

              const transactionsTableBody = document.getElementById('transactions-table-body');
              const noTransactionsMessage = document.getElementById('no-transactions-message');

              // Pega el nuevo código aquí
              const proyeccionTableBody = document.getElementById('proyeccion-table-body');
              const noProyeccionMessage = document.getElementById('no-proyeccion-message');

              // PEGA AQUÍ EL CÓDIGO
              const deleteSelectedBtn = document.getElementById('delete-selected-btn');
              const selectAllRegistrosCheckbox = document.getElementById('select-all-registros');
              const selectAllProyeccionCheckbox = document.getElementById('select-all-proyeccion');
              const selectAllRecurrentesCheckbox = document.getElementById('select-all-recurrentes');              

              const filterMonth = document.getElementById('filter-month');
              const filterDescription = document.getElementById('filter-description');
              const filterCategory = document.getElementById('filter-category');
              const confirmModal = document.getElementById('confirm-modal');
              const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
              const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
              const importFileInput = document.getElementById('import-file-input');
              const creditCardsTableBody = document.getElementById('credit-cards-table-body');
              const noCreditCardsMessage = document.getElementById('no-credit-cards-message');
              const creditCardModal = document.getElementById('credit-card-modal');
              const creditCardForm = document.getElementById('credit-card-form');
              const openTransferModalBtn = document.getElementById('open-transfer-modal-btn');
              const transferModal = document.getElementById('transfer-modal');
              const transferForm = document.getElementById('transfer-form');
              const transferCancelBtn = document.getElementById('transfer-cancel-btn');
              const recurringExpenseModal = document.getElementById('recurring-expense-modal');
              const recurringExpenseForm = document.getElementById('recurring-expense-form');
              // Pega la nueva línea aquí
              const migrateAllRecurringBtn = document.getElementById('migrate-all-recurring-btn');
              const recurringExpensesTableBody = document.getElementById('recurring-expenses-table-body');
              const noRecurringExpensesMessage = document.getElementById('no-recurring-expenses-message');
              // const userIdDisplay = document.getElementById('user-id-display'); // Eliminado, ahora usamos user-alias-display
              const userAliasDisplay = document.getElementById('user-alias-display'); // Nuevo elemento para mostrar el alias
              const loadingOverlay = document.getElementById('loading-overlay');
              const messageModal = document.getElementById('message-modal');
              const messageModalTitle = document.getElementById('message-modal-title');
              const messageModalContent = document.getElementById('message-modal-content');
              const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
              const toastContainer = document.getElementById('toast-container');
              const creditCardAlertsDiv = document.getElementById('credit-card-alerts');              
              const userAliasInput = document.getElementById('user-alias'); // Input para el alias
              const saveAliasBtn = document.getElementById('save-alias-btn'); // Botón para guardar alias
      
      
              // Referencias a los spans de error de validación
              const authEmailError = document.getElementById('auth-email-error');
              const authPasswordError = document.getElementById('auth-password-error');
              const transactionDateError = document.getElementById('transaction-date-error');
              const transactionDescriptionError = document.getElementById('transaction-description-error');
              const transactionCategoryError = document.getElementById('transaction-category-error');
              const transactionBankError = document.getElementById('transaction-bank-error');
              const transactionAmountError = document.getElementById('transaction-amount-error');
              const recurringDescriptionError = document.getElementById('recurring-description-error');
              const recurringAmountError = document.getElementById('recurring-amount-error');
              const recurringCategoryError = document.getElementById('recurring-category-error');
              const recurringBankError = document.getElementById('recurring-bank-error');
              const recurringDayError = document.getElementById('recurring-day-error');
              const creditCardBankError = document.getElementById('credit-card-bank-error');
              const creditCardDueDateError = document.getElementById('credit-card-due-date-error');
              const creditCardAmountError = document.getElementById('credit-card-amount-error');
              const creditCardRateError = document.getElementById('credit-card-rate-error');
              const creditCardMonthsError = document.getElementById('credit-card-months-error');
              const newCategoryNameError = document.getElementById('new-category-name-error');
              const newBankNameError = document.getElementById('new-bank-name-error');
              const transferDateError = document.getElementById('transfer-date-error');
              const transferFromBankError = document.getElementById('transfer-from-bank-error');
              const transferToBankError = document.getElementById('transfer-to-bank-error');
              const transferAmountError = document.getElementById('transfer-amount-error');
              const userAliasError = document.getElementById('user-alias-error');

              // ===== PEGA ESTE BLOQUE AQUÍ =====
              const changePasswordForm = document.getElementById('change-password-form');
              const changePasswordBtn = document.getElementById('change-password-btn');
              const currentPasswordInput = document.getElementById('current-password');
              const newPasswordInput = document.getElementById('new-password');
              const confirmNewPasswordInput = document.getElementById('confirm-new-password');

              const currentPasswordError = document.getElementById('current-password-error');
              const newPasswordError = document.getElementById('new-password-error');
              const confirmNewPasswordError = document.getElementById('confirm-new-password-error');              
      
              // --- INSTANCIA DEL GRÁFICO ---
              let expensesChartInstance = null;
              let cashFlowChartInstance = null; // Para el nuevo gráfico de flujo de efectivo
              let confirmCallback = null;
              let listenersAttached = false; // Bandera para controlar los listeners
              // --- INICIALIZACIÓN DE LA APLICACIÓN Y AUTENTICACIÓN ---
              // El loadingOverlay ya está activo por defecto en el HTML
              onAuthStateChanged(auth, async (user) => {
                  console.log("[Auth State Changed] Usuario:", user ? user.uid : "null"); // Debugging
                  try {
                      if (user) {
                          enterFullscreen(document.documentElement); // Activa la pantalla completa
                          userId = user.uid;
                          // userAliasDisplay.textContent = userId; // Esto ahora se actualizará en renderHeaderAlias
                          isAuthReady = true;
                          hideAuthModal(); // Ocultar modal de autenticación si el usuario está logueado
                          showDashboardView(); // <-- ¡ESTA ES LA CORRECCIÓN! Asegura que se muestre el dashboard.
                          // ================== INICIO DE LA CORRECCIÓN IMPORTANTE ==================
                          // Esta nueva sección se asegura de que tu configuración solo se cree UNA VEZ.
                          const appId = window.firebaseProjectId;
                          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

                          // 1. Hacemos una lectura única para ver si el documento de preferencias ya existe.
                          const docSnap = await getDoc(userDocRef);

                          // 2. Si NO existe, lo creamos de forma segura. Esto solo debería ocurrir para usuarios 100% nuevos.
                          if (!docSnap.exists()) {
                              console.log("[Firestore] Documento de preferencias no existe. Creando uno nuevo...");
                              await setDoc(userDocRef, {
                                  categories: [],
                                  banks: [],
                                  descriptions: [],
                                  openingBalance: 0,
                                  userAlias: null,
                                  categoryBudgets: {}
                              });
                              console.log("[Firestore] Documento de preferencias inicial creado con éxito.");
                          }
                          // =================== FIN DE LA CORRECCIÓN IMPORTANTE ===================                          
                          
                          await loadUserDataAndListen(); // Cargar datos del usuario una once autenticado
                          initApp(); // Inicializar la UI de la aplicación
                      } else {
                          // Si no hay usuario, intentar iniciar sesión anónimamente (para el entorno Canvas)
                          // o mostrar el modal de autenticación para un entorno real.
                          const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                          console.log("[Auth State Changed] initialAuthToken presente:", !!initialAuthToken); // Debugging
      
                          if (initialAuthToken) {
                              try {
                                  await window.signInWithCustomToken(auth, initialAuthToken); // Usar window.signInWithCustomToken
                                  console.log("[Auth State Changed] Sesión iniciada con token personalizado."); // Debugging
                              } catch (error) {
                                  console.error("[Auth State Changed] Error al iniciar sesión con token personalizado:", error);
                                  showMessageModal("Error de Autenticación", "No se pudo iniciar sesión automáticamente. Intenta iniciar sesión manualmente.", "error");
                                  showAuthModal(); // Mostrar modal para login/registro manual
                              }
                          } else {
                              // En un entorno real sin token, mostrar el modal de autenticación
                              console.log("[Auth State Changed] No hay token inicial, mostrando modal de autenticación."); // Debugging
                              showAuthModal();
                          }
                          // Asegurarse de que initApp y hideLoading se llamen siempre al final de esta rama
                          initApp();
                      }
                  } catch (error) {
                      console.error("[Auth State Changed] Error general en el listener de autenticación:", error); // Debugging
                      showMessageModal("Error de Autenticación", "Hubo un problema con la autenticación. Por favor, recarga la página.", "error");
                  } finally {
                      hideLoading(); // Asegurarse de ocultar la carga SIEMPRE al final del onAuthStateChanged
                  
                      // Pega la nueva línea aquí
                      initializeTour(); // Inicia el tour solo cuando la app está lista


                  }
              }, (error) => {
                  console.error("[Auth State Changed] Error en el listener de autenticación:", error); // Debugging
                  showMessageModal("Error de Autenticación", "Hubo un problema con la autenticación. Por favor, recarga la página.", "error");
                  hideLoading(); // Asegurarse de ocultar la carga en caso de error de listener
              });
      
              function initApp() {
                  console.log("[initApp] Inicializando la aplicación..."); // Debugging
                  setupEventListeners();
                  setCurrentMonthFilter();
                  populateFilterDropdowns();
                  renderAll();
                  console.log("[initApp] Aplicación inicializada."); // Debugging
              }
      
              // ================== Pega este bloque completo ==================
              // Reemplaza tu función setupEventListeners() original con esta.

              function setupEventListeners() {
                  if (listenersAttached) return; // Si ya están asignados, no hagas nada.

                  // --- Conectar el nuevo botón de cerrar vista (flecha) ---
                  const closeContentViewBtn = document.getElementById('close-content-view-btn');
                  if (closeContentViewBtn) {
                      closeContentViewBtn.addEventListener('click', showDashboardView);
                  }

                  // --- Conectar el botón de logout de la barra de pestañas (icono de salir) ---
                  const logoutTabBtn = document.getElementById('logout-tab-btn');
                  if (logoutTabBtn) {
                      logoutTabBtn.addEventListener('click', handleLogout);
                  }
                  
                  // Eventos de Autenticación
                  authForm.addEventListener('submit', handleLogin);
                  registerBtn.addEventListener('click', handleRegister);
                  logoutBtn.addEventListener('click', handleLogout);

                  // Botones de Pantalla Completa
                  document.getElementById('IdbtOpenScreen').addEventListener('click', () => enterFullscreen(document.documentElement));
                  document.getElementById('IdbtCloseScreen').addEventListener('click', exitFullscreen);

                  // Eventos de la Aplicación
                  mainActionBtn.addEventListener('click', handleMainActionClick);
                  transactionModal.addEventListener('click', (e) => { if (e.target === transactionModal) closeTransactionModal(); });
                  transactionForm.addEventListener('submit', handleFormSubmit);

                  filterMonth.addEventListener('change', () => {
                      currentMonthFilterValue = filterMonth.value;
                      renderAll();
                  });
                  filterDescription.addEventListener('input', renderAll);
                  filterCategory.addEventListener('change', renderAll);

                  document.querySelectorAll('.tab-button').forEach(button => {
                      button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
                  });

                  document.getElementById('open-add-category-modal-btn').addEventListener('click', openAddCategoryModal);
                  document.getElementById('save-new-category-btn').addEventListener('click', addCategory);
                  document.getElementById('close-icon-modal-btn').addEventListener('click', closeAddCategoryModal);
                  document.getElementById('category-icon-modal').addEventListener('click', (e) => { 
                      if (e.target.id === 'category-icon-modal') closeAddCategoryModal(); 
                  });

                  document.getElementById('add-bank-btn').addEventListener('click', addBank);
                  document.getElementById('initiate-new-month-btn').addEventListener('click', initiateNewMonth);
                  document.getElementById('reset-data-btn').addEventListener('click', resetAllData);
                  document.getElementById('save-budgets-btn').addEventListener('click', handleSaveBudgets);
                  confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeConfirmModal(); });
                  confirmModalCancelBtn.addEventListener('click', closeConfirmModal);

                  confirmModalConfirmBtn.addEventListener('click', async () => { if (typeof confirmCallback === 'function') { await confirmCallback(); } closeConfirmModal(); });                  

                  messageModalCloseBtn.addEventListener('click', closeMessageModal);
                  messageModal.addEventListener('click', (e) => { if (e.target === messageModal) closeMessageModal(); });

                  document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
                  document.getElementById('export-json-btn').addEventListener('click', exportData);
                  document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
                  importFileInput.addEventListener('change', importData);

                  creditCardModal.addEventListener('click', (e) => { if (e.target === creditCardModal) closeCreditCardModal(); });
                  document.getElementById('credit-card-cancel-btn').addEventListener('click', closeCreditCardModal);
                  creditCardForm.addEventListener('submit', handleCreditCardFormSubmit);

                  creditCardsTableBody.addEventListener('change', handleCardDataChange);

                  openTransferModalBtn.addEventListener('click', openTransferModal);
                  transferCancelBtn.addEventListener('click', closeTransferModal);
                  transferModal.addEventListener('click', (e) => { if (e.target === transferModal) closeTransferModal(); });
                  transferForm.addEventListener('submit', handleTransferFormSubmit);
                  recurringExpenseModal.addEventListener('click', (e) => { if (e.target === recurringExpenseModal) closeRecurringExpenseModal(); });
                  recurringExpenseForm.addEventListener('submit', handleRecurringExpenseFormSubmit);
                  document.getElementById('migrate-all-recurring-btn').addEventListener('click', migrateAllRecurringToTransactions);

                  saveAliasBtn.addEventListener('click', handleSaveAlias);
                  changePasswordForm.addEventListener('submit', handleChangePassword);

                  const brandStoryModal = document.getElementById('brand-story-modal');
                  const openBrandStoryBtn = document.getElementById('open-brand-story-btn');
                  const closeBrandStoryBtn = document.getElementById('close-brand-story-btn');

                  if (brandStoryModal && openBrandStoryBtn && closeBrandStoryBtn) {
                      openBrandStoryBtn.addEventListener('click', () => brandStoryModal.classList.add('active'));
                      const closeModal = () => brandStoryModal.classList.remove('active');
                      closeBrandStoryBtn.addEventListener('click', closeModal);
                      brandStoryModal.addEventListener('click', (e) => { if (e.target === brandStoryModal) closeModal(); });
                  }

                  const privacyModal = document.getElementById('privacy-policy-modal');
                  const termsModal = document.getElementById('terms-conditions-modal');
                  const cookieModal = document.getElementById('cookie-policy-modal');

                  const openPrivacyBtn = document.getElementById('open-privacy-policy');
                  const openTermsBtn = document.getElementById('open-terms-conditions');
                  const openCookieBtn = document.getElementById('open-cookie-policy');

                  const closeLegalModals = () => {
                      privacyModal.classList.remove('active');
                      termsModal.classList.remove('active');
                      cookieModal.classList.remove('active');
                  };

                  openPrivacyBtn.addEventListener('click', (e) => {
                      e.preventDefault();
                      privacyModal.classList.add('active');
                  });
                  openTermsBtn.addEventListener('click', (e) => {
                      e.preventDefault();
                      termsModal.classList.add('active');
                  });
                  openCookieBtn.addEventListener('click', (e) => {
                      e.preventDefault();
                      cookieModal.classList.add('active');
                  });

                  document.querySelectorAll('.modal').forEach(modal => {
                      modal.addEventListener('click', (e) => {
                          if (e.target === modal) {
                              closeLegalModals();
                          }
                      });
                  });
                  document.querySelectorAll('.close-legal-modal').forEach(button => {
                      button.addEventListener('click', closeLegalModals);
                  });
                  
                  const closeTransactionBtn = document.getElementById('close-transaction-modal-btn');
                  if(closeTransactionBtn) closeTransactionBtn.addEventListener('click', closeTransactionModal);

                  const closeRecurringBtn = document.getElementById('close-recurring-modal-btn');
                  if(closeRecurringBtn) closeRecurringBtn.addEventListener('click', closeRecurringExpenseModal);

                  const setupEnterKeyNavigation = (formId, fieldIds) => {
                      const form = document.getElementById(formId);
                      if (!form) return;
                      fieldIds.forEach((fieldId, index) => {
                          const element = document.getElementById(fieldId);
                          if (!element) return;
                          element.addEventListener('keydown', (e) => {
                              if (e.key === 'Enter' && index < fieldIds.length - 1) {
                                  e.preventDefault();
                                  const nextElement = document.getElementById(fieldIds[index + 1]);
                                  if (nextElement) nextElement.focus();
                              }
                          });
                      });
                  };

                  setupEnterKeyNavigation('transaction-form', ['transaction-date', 'transaction-description', 'transaction-category', 'transaction-bank', 'transaction-amount', 'save-transaction-btn']);
                  setupEnterKeyNavigation('recurring-expense-form', ['recurring-description', 'recurring-category', 'recurring-bank', 'recurring-amount', 'recurring-day', 'save-recurring-btn']);

                  deleteSelectedBtn.addEventListener('click', handleDeleteSelected);
                  const tablesContainer = document.getElementById('main-container');
                  tablesContainer.addEventListener('change', (e) => {
                      if (e.target.matches('.transaction-checkbox, .projection-checkbox, .recurring-checkbox, #select-all-registros, #select-all-proyeccion, #select-all-recurrentes')) {
                          updateDeleteButtonVisibility();
                      }
                  });

                  selectAllRegistrosCheckbox.addEventListener('change', (e) => document.querySelectorAll('#registros-content .transaction-checkbox').forEach(cb => cb.checked = e.target.checked));
                  selectAllProyeccionCheckbox.addEventListener('change', (e) => document.querySelectorAll('#proyeccion-content .projection-checkbox').forEach(cb => cb.checked = e.target.checked));
                  selectAllRecurrentesCheckbox.addEventListener('change', (e) => document.querySelectorAll('#recurrentes-content .recurring-checkbox').forEach(cb => cb.checked = e.target.checked));
                  
                  const mostrarBtn = document.getElementById("mostrar");
                  const tabButtons = document.querySelectorAll("#tabs .tab-button");

                  tabButtons.forEach(btn => {
                      btn.addEventListener("click", showContentView);
                  });

                  if (mostrarBtn) {
                      mostrarBtn.addEventListener("click", showDashboardView);
                  }
                  
                  const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
                  const filtersContainer = document.getElementById('filters-container');

                  if (toggleFiltersBtn && filtersContainer) {
                      toggleFiltersBtn.addEventListener('click', () => {
                          filtersContainer.classList.toggle('filters-visible');
                          const isVisible = filtersContainer.classList.contains('filters-visible');
                          toggleFiltersBtn.textContent = isVisible ? 'Ocultar Filtros' : 'Mostrar Filtros';

                      });
                  }
                  // =========================================================================
                  // ===== PEGA EL NUEVO CÓDIGO DE LOS BOTONES DEL PANEL DE ACCIONES AQUÍ =====
                  // =========================================================================
                  document.getElementById('single-action-edit-btn').addEventListener('click', handleSingleEditAction);
                  document.getElementById('single-action-delete-btn').addEventListener('click', handleSingleDeleteAction);
                  document.getElementById('single-action-cancel-btn').addEventListener('click', () => {
                      document.getElementById('single-action-modal').classList.remove('active');
                      // Deselecciona cualquier casilla que estuviera marcada
                      const checkedCheckbox = document.querySelector('.tab-pane.active input[type="checkbox"]:checked');
                      if (checkedCheckbox) {
                          checkedCheckbox.checked = false;
                      }
                      updateDeleteButtonVisibility(); // Oculta el panel
                  });
                  // =========================================================================
                  // ===== FIN DEL NUEVO CÓDIGO A PEGAR =====================================
                  // =========================================================================

                  listenersAttached = true;
              }

              // ... Aquí termina la función setupEventListeners() ...



              // PEGA EL SIGUIENTE BLOQUE DE CÓDIGO AQUÍ
              // --- LÓGICA PARA EL TOOLTIP DE INFORMACIÓN DE TRANSACCIÓN ---
              document.body.addEventListener('click', (e) => {
                  // Primero, si hay un tooltip visible, lo eliminamos.
                  const existingTooltip = document.querySelector('.info-tooltip');
                  if (existingTooltip) {
                      existingTooltip.remove();
                  }

                  // Si el clic fue en un botón de info, creamos un nuevo tooltip.
                  const infoBtn = e.target.closest('.info-btn');
                  if (infoBtn) {
                      // Evita que el clic en el botón se propague y cierre el tooltip inmediatamente.
                      e.stopPropagation(); 
                      
                      const description = infoBtn.dataset.description;
                      if (!description) return;

                      const tooltip = document.createElement('div');
                      tooltip.className = 'info-tooltip';
                      tooltip.textContent = description;
                      document.body.appendChild(tooltip);

                      // Posicionar el tooltip
                      const btnRect = infoBtn.getBoundingClientRect();
                      tooltip.style.left = `${btnRect.left}px`;
                      tooltip.style.top = `${btnRect.bottom + 5}px`; // 5px debajo del botón

                      // Forzar un reflow para que la animación de opacidad funcione
                      void tooltip.offsetWidth; 
                      tooltip.classList.add('visible');
                  }
              });


              // ================== FIN DE LA FUNCIÓN A REEMPLAZAR =================
      
              // --- LÓGICA DE AUTENTICACIÓN ---
              function showAuthModal() {
                  authModal.classList.add('active');
                  document.body.classList.add('auth-modal-active'); // Ocultar contenido principal
                  mainContentWrapper.style.display = 'none';
              }
      
              function hideAuthModal() {
                  authModal.classList.remove('active');
                  document.body.classList.remove('auth-modal-active');
                  mainContentWrapper.style.display = 'block'; // Mostrar contenido principal
              }
      
              async function handleRegister(e) {
                  e.preventDefault();
                  clearValidationErrors(); // Limpiar errores previos
      
                  const email = authEmailInput.value;
                  const password = authPasswordInput.value;
      
                  let isValid = true;
                  if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
                  if (!validatePassword(authPasswordInput, authPasswordError, 6)) isValid = false;
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario.", "error");
                      return;
                  }
      
                  showButtonLoading(registerBtn);
                  console.log("[Auth] Intentando registrar usuario:", email); // Debugging
      
                  try {
                      // Acceder a createUserWithEmailAndPassword a través de window
                      await window.createUserWithEmailAndPassword(auth, email, password);
                      showToast("¡Tu cuenta ha sido creada y has iniciado sesión!", "success");
                      // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
                  } catch (error) {
                      console.error("[Auth] Error de registro:", error); // Debugging
                      let errorMessage = "Error al registrar la cuenta. Inténtalo de nuevo.";
                      if (error.code === 'auth/email-already-in-use') {
                          errorMessage = "Este correo electrónico ya está en uso. Intenta iniciar sesión o usa otro correo.";
                      } else if (error.code === 'auth/weak-password') {
                          errorMessage = "La contraseña debe tener al menos 6 caracteres.";
                      } else if (error.code === 'auth/invalid-email') {
                          errorMessage = "El formato del correo electrónico es inválido.";
                      }
                      showMessageModal("Error de Registro", errorMessage, "error");
                  } finally {
                      hideButtonLoading(registerBtn);
                  }
              }
      
              async function handleLogin(e) {
                  e.preventDefault();
                  clearValidationErrors(); // Limpiar errores previos
      
                  const email = authEmailInput.value;
                  const password = authPasswordInput.value;
      
                  let isValid = true;
                  if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
                  if (!validateRequired(authPasswordInput, authPasswordError, "La contraseña es obligatoria.")) isValid = false;
      
                  if (!isValid) {
                      showToast("Por favor, ingresa tu correo y contraseña.", "error");
                      return;
                  }
      
                  showButtonLoading(loginBtn);
                  console.log("[Auth] Intentando iniciar sesión con:", email); // Debugging
      
                  try {
                      // Acceder a signInWithEmailAndPassword a través de window
                      await window.signInWithEmailAndPassword(auth, email, password);
                      showToast("¡Inicio de Sesión Exitoso! Bienvenido de nuevo.", "success");
                      // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
                  } catch (error) {
                      console.error("[Auth] Error de inicio de sesión:", error); // Debugging
                      let errorMessage = "Error al iniciar sesión. Verifica tu correo y contraseña.";
                      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                          errorMessage = "Correo electrónico o contraseña incorrectos.";
                      } else if (error.code === 'auth/invalid-email') {
                          errorMessage = "El formato del correo electrónico es inválido.";
                      } else if (error.code === 'auth/too-many-requests') {
                          errorMessage = "Demasiados intentos fallidos. Inténtalo de nuevo más tarde.";
                      }
                      showMessageModal("Error de Inicio de Sesión", errorMessage, "error");
                  } finally {
                      hideButtonLoading(loginBtn);
                  }
              }
      
              // ===== REEMPLAZA LA FUNCIÓN handleLogout() EXISTENTE CON ESTA =====

// ===== REEMPLAZA TU FUNCIÓN handleLogout CON ESTAS DOS NUEVAS FUNCIONES =====

              /**
               * "Cuelga" todas las llamadas a la base de datos para evitar errores al cerrar sesión.
               */
              function unsubscribeAllListeners() {
                  if (unsubscribePreferences) unsubscribePreferences();
                  if (unsubscribeTransactions) unsubscribeTransactions();
                  if (unsubscribeProjections) unsubscribeProjections();
                  if (unsubscribeRecurring) unsubscribeRecurring();
                  if (unsubscribeCreditCards) unsubscribeCreditCards();
                  console.log("[Firestore] Todos los oyentes han sido desvinculados.");
              }

              /**
               * Gestiona el cierre de sesión del usuario de forma limpia.
               */
              async function handleLogout() {
                  openConfirmModal('Cerrar Sesión', '¿Estás seguro de que quieres cerrar tu sesión?', async () => {
                      exitFullscreen(); 
                      showButtonLoading(logoutBtn);
                      
                      // ===== ¡ESTA ES LA PARTE CLAVE! =====
                      // 1. Colgamos las llamadas a la base de datos.
                      unsubscribeAllListeners();

                      console.log("[Auth] Intentando cerrar sesión...");
                      try {
                          // 2. Ahora sí, cerramos la sesión de forma segura.
                          await window.signOut(auth);
                          showToast("Sesión Cerrada Exitosamente.", "info");
                          
                          // Limpia el estado de la aplicación
                          appState = {
                              transactions: [], projections: [], categories: [], 
                              banks: [], descriptions: [], recurringExpenses: [],
                              creditCards: [], openingBalance: 0, userAlias: null,
                              categoryBudgets: {}, budgetAlertsShown: {}, 
                          };
                          
                          // Vuelve a la pantalla de inicio de sesión
                          showAuthModal(); 
                      } catch (error) {
                          console.error("[Auth] Error al cerrar sesión:", error);
                          showMessageModal("Error", "No se pudo cerrar la sesión.", "error");
                      } finally {
                          hideButtonLoading(logoutBtn);
                      }
                  });
              }

              /**
               * Abre el modal para seleccionar un icono y añadir una nueva categoría.
               */
              function openAddCategoryModal() {
                  const modal = document.getElementById('category-icon-modal');
                  const grid = document.getElementById('category-icon-grid');
                  const nameInput = document.getElementById('new-category-name-modal');
                  
                  // Limpia el estado anterior del modal
                  nameInput.value = '';
                  grid.innerHTML = '';
                  clearValidationErrors();

                  // Rellena la rejilla con los iconos predefinidos
                  PRESET_ICONS.forEach(iconPath => {
                      const option = document.createElement('div');
                      option.className = 'icon-option';
                      option.dataset.icon = iconPath;
                      option.innerHTML = `<img src="${iconPath}" alt="Icono de categoría">`;
                      
                      // Marca el icono por defecto como seleccionado inicialmente
                      if (iconPath === DEFAULT_ICON) {
                          option.classList.add('selected');
                      }

                      // Añade el evento para seleccionar un icono
                      option.addEventListener('click', () => {
                          grid.querySelector('.selected')?.classList.remove('selected');
                          option.classList.add('selected');
                      });

                      grid.appendChild(option);
                  });

                  modal.classList.add('active');
                  nameInput.focus();
              }

              /**
               * Cierra el modal de selección de iconos.
               */
              function closeAddCategoryModal() {
                  document.getElementById('category-icon-modal').classList.remove('active');
              }
              
              /**
               * Función auxiliar para obtener el HTML de una categoría (icono + texto o solo texto).
               * @param {string} categoryName - El nombre de la categoría a mostrar.
               * @returns {string} El HTML para inyectar en la celda de la tabla.
               */
              function getCategoryDisplay(categoryName) {
                  // Busca el objeto de categoría completo en el estado de la aplicación.
                  const categoryObj = appState.categories.find(c => c.name === categoryName);
                  
                  // Si se encuentra la categoría y tiene un icono asignado...
                  if (categoryObj && categoryObj.icon) {
                      // Retorna un <img> para el icono junto con el texto.
                      return `<img src="${categoryObj.icon}" class="category-icon" alt="${categoryName}"> <span>${categoryName}</span>`;
                  }
                  
                  // Si no, o si es una categoría especial como 'Transferencia Interna', retorna solo el texto.
                  return `<span>${categoryName}</span>`;
              }              
      
              // --- LÓGICA DE DATOS (FIREBASE) ---
      
// ===== REEMPLAZA TU FUNCIÓN loadUserDataAndListen ENTERA CON ESTA =====
              async function loadUserDataAndListen() {
                  if (!userId) {
                      console.warn("[Firestore] No hay ID de usuario para cargar datos.");
                      hideLoading();
                      return;
                  }
                  console.log(`[Firestore] Cargando datos para el usuario: ${userId}`);
      
                  const appId = firebaseProjectId;
                  if (!appId) {
                      console.error("[Firestore] ERROR: appId no disponible al cargar datos.");
                      showMessageModal("Error de Configuración", "El ID del proyecto Firebase no está disponible.");
                      hideLoading();
                      return;
                  }

                  // Función para desuscribirse de todos los oyentes antes de crear nuevos
                  if (typeof unsubscribeAllListeners === 'function') {
                    unsubscribeAllListeners();
                  }
      
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                  const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                  const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
                  const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                  const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`);
      
                  // Guardamos la función "unsubscribe" para cada oyente
                  unsubscribePreferences = onSnapshot(userDocRef, (docSnap) => {
                      console.log("[Firestore] onSnapshot preferences fired.");
                      if (docSnap.exists()) {
                          const data = docSnap.data();
                          appState.categories = (data.categories || []).map(cat => 
                              typeof cat === 'string' ? { name: cat, icon: DEFAULT_ICON } : cat
                          );
                          appState.banks = data.banks || [];
                          appState.descriptions = data.descriptions || [];
                          appState.openingBalance = data.openingBalance || 0;
                          appState.userAlias = data.userAlias || null;
                          appState.categoryBudgets = data.categoryBudgets || {};
                      }
                      if (isAuthReady) {
                          populateFilterDropdowns();
                          populateModalDropdowns();
                          populateRecurringModalDropdowns();
                          populateDescriptionDatalist();
                          populateTransferModalDropdowns();
                          renderConfigurationLists();
                          renderHeaderAlias();
                          renderAll();
                      }
                  }, (error) => {
                      console.error("[Firestore] Error al escuchar preferencias del usuario:", error);
                      showMessageModal("Error de Carga", "Hubo un problema al cargar tus preferencias.", "error");
                  });
      
                  unsubscribeTransactions = onSnapshot(transactionsColRef, (snapshot) => {
                      console.log("[Firestore] onSnapshot transactions fired.");
                      appState.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      initialTransactionsLoaded = true;
                      tryProcessRecurringExpenses();                     
                      if (isAuthReady) renderAll();
                  }, (error) => {
                      console.error("[Firestore] Error al escuchar transacciones:", error);
                      showMessageModal("Error de Carga", "Hubo un problema al cargar tus transacciones.", "error");
                  });

                  unsubscribeRecurring = onSnapshot(recurringExpensesColRef, (snapshot) => {
                      console.log("[Firestore] onSnapshot recurringExpenses fired.");
                      appState.recurringExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      initialRecurringLoaded = true;
                      tryProcessRecurringExpenses();                      
                      if (isAuthReady) {
                          checkRecurringPaymentReminders();
                          renderAll();
                      }
                  }, (error) => {
                      console.error("[Firestore] Error al escuchar gastos recurrentes:", error);
                      showMessageModal("Error de Carga", "Hubo un problema al cargar tus gastos recurrentes.", "error");
                  });
      
                  unsubscribeCreditCards = onSnapshot(creditCardsColRef, (snapshot) => {
                      console.log("[Firestore] onSnapshot creditCards fired.");
                      appState.creditCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      if (isAuthReady) renderAll();
                  }, (error) => {
                      console.error("[Firestore] Error al escuchar tarjetas de crédito:", error);
                      showMessageModal("Error de Carga", "Hubo un problema al cargar tus tarjetas de crédito.", "error");
                  });

                  unsubscribeProjections = onSnapshot(projectionsColRef, (snapshot) => {
                      console.log("[Firestore] onSnapshot projections fired.");
                      appState.projections = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      if (isAuthReady) renderAll();
                  }, (error) => {
                      console.error("[Firestore] Error al escuchar proyecciones:", error);
                      showMessageModal("Error de Carga", "Hubo un problema al cargar tus proyecciones.", "error");
                  });
              }
      
              // --- REEMPLAZA las dos funciones existentes con estas dos ---
              function getFilteredTransactions() {
                  const selectedMonth = filterMonth.value;
                  const descriptionFilter = filterDescription.value.toLowerCase();
                  const categoryFilter = filterCategory.value;

                  return appState.transactions.filter(t => {
                      // --- INICIO DE LA CORRECCIÓN ---
                      // Se añade una comprobación para asegurar que la transacción 't' y 't.date' existen antes de usarlos.
                      if (!t || typeof t.date !== 'string') {
                          console.warn('Se encontró una transacción sin fecha válida:', t);
                          return false; // Se ignora esta transacción para evitar el error.
                      }
                      // --- FIN DE LA CORRECCIÓN ---

                      const transactionMonth = t.date.substring(0, 7);
                      const matchesMonth = !selectedMonth || transactionMonth === selectedMonth;
                      // Se asegura que t.description exista antes de llamar a toLowerCase()
                      const matchesDescription = (t.description || '').toLowerCase().includes(descriptionFilter);
                      const matchesCategory = !categoryFilter || t.category === categoryFilter;
                      return matchesMonth && matchesDescription && matchesCategory;
                  }).sort((a, b) => {
                      // Orden principal: por fecha
                      const dateComparison = new Date(a.date) - new Date(b.date);
                      if (dateComparison !== 0) {
                          return dateComparison;
                      }

                      // Orden secundario: dentro de la misma fecha, los ingresos van primero
                      if (a.type === 'income' && b.type !== 'income') {
                          return -1; // 'a' (ingreso) va antes que 'b'
                      }
                      if (a.type !== 'income' && b.type === 'income') {
                          return 1; // 'b' (ingreso) va antes que 'a'
                      }
                      return 0; // Mantener el orden relativo si son del mismo tipo
                  });
              }

              function getFilteredTransactionsForProyeccion() {
                  const selectedMonth = filterMonth.value;
                  const descriptionFilter = filterDescription.value.toLowerCase();
                  const categoryFilter = filterCategory.value;
      
                  // Esta función ahora lee de appState.projections
                  return appState.projections.filter(t => {
                      // --- INICIO DE LA CORRECCIÓN ---
                      if (!t || typeof t.date !== 'string') {
                          console.warn('Se encontró una proyección sin fecha válida:', t);
                          return false; // Se ignora para evitar el error.
                      }
                      // --- FIN DE LA CORRECCIÓN ---

                      const transactionMonth = t.date.substring(0, 7);
                      const matchesMonth = !selectedMonth || transactionMonth === selectedMonth;
                      const matchesDescription = (t.description || '').toLowerCase().includes(descriptionFilter);
                      const matchesCategory = !categoryFilter || t.category === categoryFilter;
                      return matchesMonth && matchesDescription && matchesCategory;
                  }).sort((a, b) => new Date(a.date) - new Date(b.date));
              }
      
              // --- RENDERIZADO ---
              // --- NUEVA FUNCIÓN: Revisar Límites de Presupuesto ---
              // --- NUEVA FUNCIÓN: Recordatorios de Pagos Recurrentes ---
              function checkRecurringPaymentReminders() {
                  const today = new Date();
                  const tomorrow = new Date(today);
                  tomorrow.setDate(today.getDate() + 1);
                  const tomorrowDay = tomorrow.getDate();

                  appState.recurringExpenses.forEach(expense => {
                      // Comprobar si el día de pago es mañana
                      if (parseInt(expense.day, 10) === tomorrowDay) {
                          const reminderKey = `reminder-${expense.id}-${tomorrow.toISOString().split('T')[0]}`;
                          
                          // Usar sessionStorage para no repetir el aviso en la misma sesión
                          if (!sessionStorage.getItem(reminderKey)) {
                              showToast(`Recordatorio: Mañana vence tu pago de "${expense.description}" por ${formatCurrency(expense.amount)}.`, "info", 6000); // Duración de 6 segundos
                              sessionStorage.setItem(reminderKey, 'true');
                          }
                      }
                  });
              }              
              function checkBudgetLimits() {
                  const transactionsForMonth = getFilteredTransactions();
                  const expensesByCategory = transactionsForMonth
                      .filter(t => t.type === 'expense')
                      .reduce((acc, t) => {
                          acc[t.category] = (acc[t.category] || 0) + t.amount;
                          return acc;
                      }, {});

                  for (const category in appState.categoryBudgets) {
                      const budget = appState.categoryBudgets[category];
                      const spent = expensesByCategory[category] || 0;

                      if (budget > 0 && spent > 0) {
                          const percentage = (spent / budget) * 100;
                          const alertKey = `${filterMonth.value}-${category}`;

                          // Comprobar si la alerta para esta categoría/mes ya se mostró
                          if (!appState.budgetAlertsShown[alertKey]) {
                              if (percentage >= 90) {
                                  showToast(`¡Alerta! Has gastado el ${percentage.toFixed(0)}% de tu presupuesto para "${category}".`, "error");
                                  appState.budgetAlertsShown[alertKey] = true; // Marcar como mostrada
                              } else if (percentage >= 80) {
                                  showToast(`Aviso: Has gastado el ${percentage.toFixed(0)}% de tu presupuesto para "${category}".`, "info");
                                  appState.budgetAlertsShown[alertKey] = true; // Marcar como mostrada
                              }
                          }
                      }
                  }
              }
              
              function renderAll() {
                  renderDashboard();
                  renderTransactionsTable();

                  // Pega el nuevo código aquí
                  renderProyeccionTable();

                  renderConfigurationLists();
                  renderCreditCardAlerts(); // Renderizar alertas de tarjetas
                  renderRecurringAlerts(); // Renderizar alertas de recurrentes
                  renderHeaderAlias(); // Asegurarse de que el alias se muestre correctamente
                  const activeTabElement = document.querySelector('.tab-pane.active');
                  if (activeTabElement) {
                      const activeTab = activeTabElement.id;
                      if (activeTab === 'reportes-content') renderReports();
                      if (activeTab === 'presupuesto-content') renderBudgetTable(); // <-- AGREGA ESTA LÍNEA
                      if (activeTab === 'tarjetas-content') renderCreditCardsTable();
                      if (activeTab === 'recurrentes-content') renderRecurringExpensesTable();
                      if (activeTab === 'saldos-content') renderBankBalances(); // MODIFICACIÓN
                  }
              }
      
              function renderHeaderAlias() {
                  if (appState.userAlias) {
                      userAliasDisplay.textContent = appState.userAlias;
                      userAliasInput.value = appState.userAlias; // Cargar el alias en el input de configuración
                  } else {
                      userAliasDisplay.textContent = `Usuario (${userId ? userId.substring(0, 8) + '...' : 'Cargando...'})`; // Mostrar parte del UID si no hay alias
                      userAliasInput.value = ''; // Limpiar el input si no hay alias
                  }
              }
      
              // --- REEMPLAZA LA FUNCIÓN COMPLETA ---
              function renderDashboard() {
                  const transactionsForMonth = getFilteredTransactions(); // Usa transacciones activas del mes
                  const income = transactionsForMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                  const expenses = transactionsForMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      
                  // Filtrar TODAS las transacciones activas para el Saldo Actual
                  const activeTransactions = appState.transactions.filter(t => !t.isArchived);
                  const totalIncome = activeTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                  const totalExpenses = activeTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                  const currentBalance = appState.openingBalance + totalIncome - totalExpenses;
      
                  document.getElementById('current-balance').textContent = formatCurrency(currentBalance);
                  document.getElementById('monthly-income').textContent = formatCurrency(income);
                  document.getElementById('monthly-expenses').textContent = formatCurrency(expenses);
                  
                  checkBudgetLimits();                  
              }
      
              function renderTransactionsTable() {
                  const selectedMonth = filterMonth.value;
                  const activeTransactions = appState.transactions; 
                  
                  let runningBalance = appState.openingBalance;
                  if (selectedMonth) {
                      const transactionsBeforeFilter = activeTransactions.filter(t => t.date.substring(0, 7) < selectedMonth).sort((a, b) => new Date(a.date) - new Date(b.date));
                      transactionsBeforeFilter.forEach(t => {
                          runningBalance += (t.type === 'income' ? t.amount : -t.amount);
                      });
                  }
                  const filteredTransactions = getFilteredTransactions();                
                  transactionsTableBody.innerHTML = '';      
                  
                  const tableElement = document.querySelector('#registros-content table');
                  const footerElement = tableElement.querySelector('tfoot');

                  if (filteredTransactions.length === 0) {
                      transactionsTableBody.classList.add('hidden');
                      if (footerElement) footerElement.classList.add('hidden');
                      noTransactionsMessage.classList.remove('hidden');
                  } else {
                      transactionsTableBody.classList.remove('hidden');
                      if (footerElement) footerElement.classList.remove('hidden');
                      noTransactionsMessage.classList.add('hidden');
                      
                      filteredTransactions.forEach(t => {
                          runningBalance += (t.type === 'income' ? t.amount : -t.amount);
                          const balanceStyle = runningBalance < 0 ? 'color: var(--expense-color);' : 'color: var(--electric-blue);';
                          const row = document.createElement('tr');
                          let rowTextColorClass = '';
                          if (t.category === 'Transferencia Interna') rowTextColorClass = 'transfer-text-row';
                          else if (t.type === 'income') rowTextColorClass = 'income-text-row';
                          else rowTextColorClass = 'expense-text-row';
                          row.className = rowTextColorClass;
                          
                          // --- LÍNEA MODIFICADA ---
                          // Ahora usamos getCategoryDisplay para mostrar el icono y el texto.
                          row.innerHTML = `
                                <td class="px-2 py-4 text-center">
                                  <input type="checkbox" class="transaction-checkbox" data-id="${t.id}">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                  <span class="desktop-date">${formatDate(t.date)}</span>
                                  <span class="mobile-date">${formatDateForMobile(t.date)}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${t.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm flex items-center">
                                    ${getCategoryDisplay(t.category)}
                                    <button class="info-btn" data-description="${t.description}">i</button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-right" style="font-weight: 400;">${formatCurrency(t.amount)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-right balance-cell-bg"><span style="${balanceStyle}">${formatCurrency(runningBalance)}</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm" style="font-weight: 400;">
                                  <button data-id="${t.id}" class="edit-btn mr-3">Editar</button>
                                  <button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900">Eliminar</button>
                                </td>
                            `;
                          transactionsTableBody.appendChild(row);
                      });

                      const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                      const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                      tableElement.querySelector('tfoot tr td:first-child').colSpan = 3;
                      document.getElementById('registros-total-income').textContent = formatCurrency(totalIncome);
                      document.getElementById('registros-total-expenses').textContent = formatCurrency(totalExpenses);
                  }
      
                  document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openTransactionModal(e.target.dataset.id)));
                  document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id)));
                  updateDeleteButtonVisibility();
              }

              // --- REEMPLAZA LA FUNCIÓN COMPLETA ---
              function renderProyeccionTable() {
                  const filteredTransactions = getFilteredTransactionsForProyeccion();
                  let runningBalance = 0; 
                                  
                  proyeccionTableBody.innerHTML = '';
                  
                  const tableElement = document.querySelector('#proyeccion-content table');
                  const footerElement = tableElement.querySelector('tfoot');

                  if (filteredTransactions.length === 0) {
                      proyeccionTableBody.classList.add('hidden');
                      if (footerElement) footerElement.classList.add('hidden');
                      noProyeccionMessage.classList.remove('hidden');
                  } else {
                      proyeccionTableBody.classList.remove('hidden');
                      if (footerElement) footerElement.classList.remove('hidden');
                      noProyeccionMessage.classList.add('hidden');

                      filteredTransactions.forEach(t => {
                          runningBalance += (t.type === 'income' ? t.amount : -t.amount);
                          const balanceStyle = runningBalance < 0 ? 'color: var(--expense-color);' : 'color: var(--electric-blue);';
                          const row = document.createElement('tr');
                          let rowTextColorClass = '';
                          if (t.category === 'Transferencia Interna') rowTextColorClass = 'transfer-text-row';
                          else if (t.type === 'income') rowTextColorClass = 'income-text-row';
                          else rowTextColorClass = 'expense-text-row';
                          row.className = rowTextColorClass;

                          row.innerHTML = `
                              <td class="px-2 py-4 text-center">
                                <input type="checkbox" class="projection-checkbox" data-id="${t.id}">
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="desktop-date">${formatDate(t.date)}</span>
                                <span class="mobile-date">${formatDateForMobile(t.date)}</span>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm">${t.description}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm flex items-center">
                                  ${getCategoryDisplay(t.category)}
                                  <button class="info-btn" data-description="${t.description}">i</button>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-right" style="font-weight: 400;">${formatCurrency(t.amount)}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-right balance-cell-bg"><span style="${balanceStyle}">${formatCurrency(runningBalance)}</span></td>
                              <td class="px-6 py-4 whitespace-nowrap text-center text-sm" style="font-weight: 400;">
                                <button data-id="${t.id}" class="delete-projection-btn text-red-600 hover:text-red-900">Eliminar</button>
                              </td>
                          `;
                          proyeccionTableBody.appendChild(row);
                      });

                      const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                      const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                      tableElement.querySelector('tfoot tr td:first-child').colSpan = 3;
                      document.getElementById('proyeccion-total-income').textContent = formatCurrency(totalIncome);
                      document.getElementById('proyeccion-total-expenses').textContent = formatCurrency(totalExpenses);
                  }
                  
                  document.querySelectorAll('.delete-projection-btn').forEach(btn => btn.addEventListener('click', (e) => deleteProjection(e.target.dataset.id)));
                  updateDeleteButtonVisibility();
              }        

              // --- REEMPLAZA LA FUNCIÓN COMPLETA ---
              function renderBankBalances() {
                  const balancesGrid = document.getElementById('bank-balances-grid');
                  const noBalancesMessage = document.getElementById('no-balances-message');
                  balancesGrid.innerHTML = ''; 

                  // Filtrar solo transacciones activas
                  const activeTransactions = appState.transactions.filter(t => !t.isArchived);

                  const bankBalances = appState.banks.map(bankName => {
                      const income = activeTransactions
                          .filter(t => t.bank === bankName && t.type === 'income')
                          .reduce((sum, t) => sum + t.amount, 0);
                      const expenses = activeTransactions
                          .filter(t => t.bank === bankName && t.type === 'expense')
                          .reduce((sum, t) => sum + t.amount, 0);
                      return { name: bankName, balance: income - expenses };
                  });

                  if (bankBalances.length === 0) {
                      noBalancesMessage.classList.remove('hidden');
                      balancesGrid.classList.add('hidden');
                  } else {
                      noBalancesMessage.classList.add('hidden');
                      balancesGrid.classList.remove('hidden');

                      bankBalances.forEach(bank => {
                          const balanceColor = bank.balance >= 0 ? 'text-green-600' : 'text-red-600';
                          const card = document.createElement('div');
                          card.className = 'bg-white p-6 rounded-xl shadow-md flex flex-col justify-between';
                          card.innerHTML = `
                              <div>
                                  <p class="text-lg font-semibold text-gray-700">${bank.name}</p>
                                  <p class="text-3xl font-bold ${balanceColor} mt-2">${formatCurrency(bank.balance)}</p>
                              </div>
                          `;
                          balancesGrid.appendChild(card);
                      });
                  }
              }

              // ======================================================================
              // 1. NUEVA FUNCIÓN: renderBudgetTable()
              // Pégala después de la función renderBankBalances()
              // ======================================================================
              /**
               * Dibuja y actualiza la tabla de presupuestos.
               * Esta función se encarga de:
               * 1. Obtener las transacciones filtradas por el mes seleccionado.
               * 2. Calcular el total de gastos por cada categoría.
               * 3. Iterar sobre todas las categorías del usuario para construir la tabla.
               * 4. Para cada categoría, muestra el presupuesto, el gasto y el saldo.
               * 5. Calcula y muestra los totales en el pie de la tabla.
               * 6. Permite la edición directa de los montos presupuestados.
               */
              function renderBudgetTable() {
                  const budgetTableBody = document.getElementById('budget-table-body');
                  const noCategoriesMessage = document.getElementById('no-categories-for-budget-message');
                  budgetTableBody.innerHTML = '';

                  // MODIFICADO: Ahora comprueba si el array de objetos está vacío.
                  if (!appState.categories || appState.categories.length === 0) {
                      budgetTableBody.classList.add('hidden');
                      noCategoriesMessage.classList.remove('hidden');
                      return;
                  }
                  
                  budgetTableBody.classList.remove('hidden');
                  noCategoriesMessage.classList.add('hidden');

                  const transactionsForMonth = getFilteredTransactions();
                  const expensesByCategory = transactionsForMonth
                      .filter(t => t.type === 'expense')
                      .reduce((acc, t) => {
                          acc[t.category] = (acc[t.category] || 0) + t.amount;
                          return acc;
                      }, {});

                  let totalBudgeted = 0;
                  let totalSpent = 0;
                  let totalRemaining = 0;

                  // MODIFICADO: Itera sobre el array de objetos de categoría.
                  appState.categories.forEach(categoryObj => {
                      const categoryName = categoryObj.name;
                      
                      if (categoryName === 'Sueldo' || categoryName === 'Transferencia Interna') {
                          return;
                      }

                      const budgetAmount = appState.categoryBudgets[categoryName] || 0;
                      const spentAmount = expensesByCategory[categoryName] || 0;
                      const remainingAmount = budgetAmount - spentAmount;

                      totalBudgeted += budgetAmount;
                      totalSpent += spentAmount;
                      totalRemaining += remainingAmount;

                      let balanceClass = 'zero-balance';
                      if (remainingAmount > 0) balanceClass = 'positive-balance';
                      if (remainingAmount < 0) balanceClass = 'negative-balance';

                      const row = document.createElement('tr');
                      // --- LÍNEA MODIFICADA ---
                      row.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 flex items-center">${getCategoryDisplay(categoryName)}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                              <input 
                                  type="number" 
                                  min="0" 
                                  step="1" 
                                  data-category="${categoryName}"
                                  class="budget-table-input category-budget-input" 
                                  placeholder="Asignar" 
                                  value="${budgetAmount > 0 ? budgetAmount : ''}">
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-orange-500">${formatCurrency(spentAmount)}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${balanceClass}">${formatCurrency(remainingAmount)}</td>
                      `;
                      budgetTableBody.appendChild(row);
                  });

                  document.getElementById('budget-total-budgeted').textContent = formatCurrency(totalBudgeted);
                  document.getElementById('budget-total-spent').textContent = formatCurrency(totalSpent);
                  document.getElementById('budget-total-remaining').textContent = formatCurrency(totalRemaining);
              }

              function renderReports() {
                  const transactionsForMonth = getFilteredTransactions();
                  const expensesByCategory = transactionsForMonth
                      .filter(t => t.type === 'expense')
                      .reduce((acc, t) => {
                          acc[t.category] = (acc[t.category] || 0) + t.amount;
                          return acc;
                      }, {});
      
                  const labels = Object.keys(expensesByCategory);
                  const data = Object.values(expensesByCategory);
                  const totalExpenses = data.reduce((sum, amount) => sum + amount, 0);
      
                  const categoryTotalsList = document.getElementById('category-totals-list');
                  categoryTotalsList.innerHTML = '';
                  if (labels.length > 0) {
                      const sortedCategories = Object.entries(expensesByCategory).sort(([,a],[,b]) => b-a);
                      sortedCategories.forEach(([category, amount]) => {
                          const item = document.createElement('div');
                          item.className = 'flex justify-between items-center text-sm p-2 bg-gray-50 rounded-md';
                          // --- LÍNEA MODIFICADA ---
                          item.innerHTML = `
                              <span class="text-gray-700 flex items-center">${getCategoryDisplay(category)}</span>
                              <span class="font-medium text-red-500">${formatCurrency(amount)}</span>
                          `;
                          categoryTotalsList.appendChild(item);
                      });
                  } else {
                      categoryTotalsList.innerHTML = '<p class="text-gray-500 text-center">No hay gastos para mostrar en este período.</p>';
                  }
                  document.getElementById('total-expenses-report').textContent = formatCurrency(totalExpenses);
      
                  const ctx = document.getElementById('expenses-chart').getContext('2d');
                  if (expensesChartInstance) expensesChartInstance.destroy();
                  expensesChartInstance = new Chart(ctx, {
                      type: 'doughnut',
                      data: {
                          labels: labels,
                          datasets: [{
                              label: 'Gastos por Categoría',
                              data: data,
                              backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
                              hoverOffset: 4
                          }]
                      },
                      options: {
                          responsive: true, maintainAspectRatio: false,
                          plugins: {
                              legend: { position: 'top' },
                              title: { display: true, text: `Distribución de Gastos para ${formatMonthYear(filterMonth.value)}` }
                          }
                      }
                  });
      
                  renderCashFlowChart();
              }
      
              function renderCashFlowChart() {
                  // --- INICIO DE LA CORRECCIÓN ---
                  // Se filtra cualquier transacción sin fecha antes de procesarla.
                  const validTransactions = appState.transactions.filter(t => t && typeof t.date === 'string');
                  const allMonths = [...new Set(validTransactions.map(t => t.date.substring(0, 7)))].sort();
                  // --- FIN DE LA CORRECCIÓN ---

                  const monthlyData = allMonths.map(month => {
                      // Usamos 'validTransactions' en lugar de 'appState.transactions'
                      const transactionsInMonth = validTransactions.filter(t => t.date.startsWith(month));
                      const income = transactionsInMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                      const expenses = transactionsInMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                      return { month, income, expenses };
                  });
      
                  const labels = monthlyData.map(d => formatMonthYear(d.month));
                  const incomeData = monthlyData.map(d => d.income);
                  const expensesData = monthlyData.map(d => d.expenses);
      
                  const ctx = document.getElementById('cash-flow-chart').getContext('2d');
                  if (cashFlowChartInstance) cashFlowChartInstance.destroy();
                  cashFlowChartInstance = new Chart(ctx, {
                      type: 'bar',
                      data: {
                          labels: labels,
                          datasets: [
                              {
                                  label: 'Ingresos',
                                  data: incomeData,
                                  backgroundColor: '#22c55e', // green-500
                                  borderColor: '#16a34a',
                                  borderWidth: 1
                              },
                              {
                                  label: 'Gastos',
                                  data: expensesData,
                                  backgroundColor: '#ef4444', // red-500
                                  borderColor: '#dc2626',
                                  borderWidth: 1
                              }
                          ]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: { position: 'top' },
                              title: { display: true, text: 'Ingresos vs. Gastos por Mes' }
                          },
                          scales: {
                              x: { stacked: false },
                              y: { stacked: false, beginAtZero: true }
                          }
                      }
                  });
              }
      
              function renderCreditCardAlerts() {
                  creditCardAlertsDiv.innerHTML = '';
                  const today = new Date();
                  const alerts = [];
      
                  appState.creditCards.forEach(card => {
                      const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
                      if (today.getDate() > card.dueDate) {
                          nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                      }
                      const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
      
                      if (daysDiff >= 0 && daysDiff <= 5) {
                          let message = `¡Atención! El pago de tu tarjeta ${card.bank} vence en ${daysDiff} día(s). Monto: ${formatCurrency(card.amount)}.`;
                          if (daysDiff === 0) {
                              message = `¡Atención! El pago de tu tarjeta ${card.bank} vence HOY. Monto: ${formatCurrency(card.amount)}.`;
                          }
                          alerts.push(message);
                      }
                  });
      
                  if (alerts.length > 0) {
                      alerts.forEach(alertText => {
                          const p = document.createElement('p');
                          p.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-2 mb-1 rounded-md shadow-sm';
                          p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>${alertText}`;
                          creditCardAlertsDiv.appendChild(p);
                      });
                  }
              }

              /**
               * Renders on-screen reminders for recurring expenses due in the next 5 days.
               */
              function renderRecurringAlerts() {
                  const recurringAlertsDiv = document.getElementById('recurring-alerts');
                  recurringAlertsDiv.innerHTML = '';
                  const today = new Date();
                  const alerts = [];

                  appState.recurringExpenses.forEach(expense => {
                      const expenseDay = parseInt(expense.day, 10);
                      const nextDueDate = new Date(today.getFullYear(), today.getMonth(), expenseDay);
                      
                      // If the due date has passed in the current month, check next month
                      if (today.getDate() > expenseDay) {
                          nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                      }

                      const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

                      if (daysDiff >= 0 && daysDiff <= 5) {
                          let message = `¡Atención! El pago de "${expense.description}" vence en ${daysDiff} día(s). Monto: ${formatCurrency(expense.amount)}.`;
                          if (daysDiff === 0) {
                              message = `¡Atención! El pago de "${expense.description}" vence HOY. Monto: ${formatCurrency(expense.amount)}.`;
                          }
                          alerts.push(message);
                      }
                  });

                  if (alerts.length > 0) {
                      alerts.forEach(alertText => {
                          const p = document.createElement('p');
                          p.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 mb-1 rounded-md shadow-sm';
                          p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><path d="M12 8v4l-2 2"/></svg>${alertText}`;
                          recurringAlertsDiv.appendChild(p);
                      });
                  }
              }              
      
      
              // --- MODALES Y NOTIFICACIONES ---
      
              function showLoading() {
                  loadingOverlay.classList.add('active');
              }
      
              function hideLoading() {
                  loadingOverlay.classList.remove('active');
              }
      
              /**
               * Muestra un modal de mensaje con título, contenido y tipo.
               * @param {string} title - Título del modal.
               * @param {string} message - Contenido del mensaje.
               * @param {'info'|'success'|'error'} type - Tipo de mensaje para estilos (info por defecto).
               */
              function showMessageModal(title, message, type = 'info') {
                  // ===== AÑADE ESTA LÍNEA DE VERIFICACIÓN AQUÍ =====
                  if (!messageModal) return;                
                  messageModalTitle.textContent = title;
                  messageModalContent.textContent = message;
      
                  // Limpiar clases de tipo previas
                  messageModalTitle.classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
                  messageModalContent.classList.remove('text-blue-700', 'text-green-700', 'text-red-700');
                  messageModal.querySelector('.mx-auto.flex').classList.remove('bg-blue-100', 'bg-green-100', 'bg-red-100');
                  messageModal.querySelector('.mx-auto.flex svg').classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
      
                  let iconSvg = '';
                  switch (type) {
                      case 'success':
                          messageModalTitle.classList.add('text-green-600');
                          messageModalContent.classList.add('text-green-700');
                          messageModal.querySelector('.mx-auto.flex').classList.add('bg-green-100');
                          messageModal.querySelector('.mx-auto.flex svg').classList.add('text-green-600');
                          iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                      case 'error':
                          messageModalTitle.classList.add('text-red-600');
                          messageModalContent.classList.add('text-red-700');
                          messageModal.querySelector('.mx-auto.flex').classList.add('bg-red-100');
                          messageModal.querySelector('.mx-auto.flex svg').classList.add('text-red-600');
                          iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                      case 'info':
                      default:
                          messageModalTitle.classList.add('text-blue-600');
                          messageModalContent.classList.add('text-blue-700');
                          messageModal.querySelector('.mx-auto.flex').classList.add('bg-blue-100');
                          messageModal.querySelector('.mx-auto.flex svg').classList.add('text-blue-600');
                          iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                  }
                  messageModal.querySelector('.mx-auto.flex').innerHTML = iconSvg; // Actualizar el icono
                  messageModal.classList.add('active');
              }
      
              function closeMessageModal() {
                  messageModal.classList.remove('active');
              }
      
              /**
               * Muestra una notificación "toast" temporal.
               * @param {string} message - Mensaje a mostrar.
               * @param {'success'|'error'|'info'} type - Tipo de notificación.
               * @param {number} duration - Duración en milisegundos (por defecto 3000).
               */
              function showToast(message, type = 'info', duration = 3000) {
                  const toast = document.createElement('div');
                  toast.className = `toast ${type}`;
                  let iconSvg = '';
                  switch (type) {
                      case 'success':
                          iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                      case 'error':
                          iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                      case 'info':
                      default:
                          iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                          break;
                  }
                  toast.innerHTML = `${iconSvg}<span>${message}</span>`;
                  toastContainer.appendChild(toast);
      
                  // Forzar reflow para la animación
                  void toast.offsetWidth;
                  toast.classList.add('show');
      
                  setTimeout(() => {
                      toast.classList.remove('show');
                      toast.addEventListener('transitionend', () => toast.remove());
                  }, duration);
              }
      
              function openConfirmModal(title, message, onConfirm) {
                  document.getElementById('confirm-modal-title').textContent = title;
                  document.getElementById('confirm-modal-message').textContent = message;
                  confirmCallback = onConfirm;
                  confirmModal.classList.add('active');
              }
      
              function closeConfirmModal() {
                  confirmModal.classList.remove('active');
                  confirmCallback = null;
              }
      
              // ================================== PEGA AQUÍ ==================================
              /**
               * MODIFICADO Y CORREGIDO: Abre el modal de transacciones.
               * La corrección clave es que el event listener para el botón de cerrar 'X'
               * se declara aquí. Esto garantiza que el botón siempre funcionará al abrir el modal.
               */
              function openTransactionModal(id = null) {
                  transactionForm.reset();
                  clearValidationErrors();
                  populateModalDropdowns();
                  populateDescriptionDatalist();
                  
                  if (id) {
                      // Lógica para editar una transacción existente (sin cambios)
                      const transaction = appState.transactions.find(t => t.id === id);
                      if (transaction) {
                          document.getElementById('modal-title').textContent = 'Editar Transacción';
                          document.getElementById('transaction-id').value = transaction.id;
                          document.getElementById('transaction-date').value = transaction.date;
                          document.getElementById('transaction-description').value = transaction.description;
                          document.getElementById('transaction-category').value = transaction.category;
                          document.getElementById('transaction-bank').value = transaction.bank;
                          document.getElementById('transaction-amount').value = transaction.amount;
                          document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
                      } else {
                          showMessageModal("Error", "Transacción no encontrada.", "error");
                          return;
                      }
                  } else {
                      // Lógica para una nueva transacción (sin cambios)
                      document.getElementById('modal-title').textContent = 'Registrar Transacción';
                      document.getElementById('transaction-id').value = '';
                      document.getElementById('transaction-date').valueAsDate = new Date();
                      document.querySelector('input[name="transaction-type"][value="income"]').checked = true;
                  }
                  
                  // Muestra el modal
                  transactionModal.classList.add('active');
                  
                  // --- ¡CORRECCIÓN IMPORTANTE! ---
                  // Ponemos el foco en el primer campo para iniciar la navegación con 'Enter'.
                  document.getElementById('transaction-date').focus();
              }
              // ================================ FIN DEL PEGADO ===============================
      
              function closeTransactionModal() {
                  transactionModal.classList.remove('active');
                  clearValidationErrors(); // Limpiar errores al cerrar el modal
              }
      
              // ================================== PEGA AQUÍ ==================================
              // --- REEMPLAZA LA FUNCIÓN COMPLETA CON ESTA VERSIÓN ---
              async function handleFormSubmit(e) {
                  e.preventDefault();
                  clearValidationErrors();

                  const description = toTitleCase(document.getElementById('transaction-description').value.trim());
                  const amount = parseFloat(document.getElementById('transaction-amount').value);
                  const date = document.getElementById('transaction-date').value;
                  const category = document.getElementById('transaction-category').value;
                  const bank = document.getElementById('transaction-bank').value;
                  const type = document.querySelector('input[name="transaction-type"]:checked').value;
                  const id = document.getElementById('transaction-id').value;

                  let isValid = true;
                  if (!validateRequired(document.getElementById('transaction-date'), transactionDateError, "La fecha es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('transaction-description'), transactionDescriptionError, "La descripción es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('transaction-category'), transactionCategoryError, "La categoría es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('transaction-bank'), transactionBankError, "El banco/cuenta es obligatorio.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('transaction-amount'), transactionAmountError, "El monto debe ser un número positivo.")) isValid = false;
                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario.", "error");
                      return;
                  }

                  const saveBtn = document.getElementById('save-transaction-btn');
                  showButtonLoading(saveBtn);
                  const appId = firebaseProjectId;
                  const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                  const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`);
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

                  const transactionData = { date, description, category, bank, amount, type };

                  try {
                      if (modalContext === 'registros') {
                          // Si estamos en la pestaña REGISTROS
                          if (id) {
                              // --- LÓGICA DE ACTUALIZACIÓN MODIFICADA ---
                              // Al editar, se actualizan AMBAS colecciones a la vez.
                              const batch = writeBatch(db);
                              const transactionDocRef = doc(transactionsColRef, id);
                              const projectionDocRef = doc(projectionsColRef, id); // Apunta al mismo ID en la otra colección

                              batch.set(transactionDocRef, transactionData, { merge: true });
                              batch.set(projectionDocRef, transactionData, { merge: true });
                              
                              await batch.commit();
                              showToast("Transacción actualizada en Registros y Proyección.", "success");
                              closeTransactionModal(); 
                          } else {
                              // Al crear, se registra en paralelo en AMBAS colecciones con el MISMO ID
                              const batch = writeBatch(db);
                              // Se genera un único ID para ambos registros
                              const newDocRef = doc(transactionsColRef); 
                              const newId = newDocRef.id;

                              batch.set(doc(transactionsColRef, newId), { ...transactionData, id: newId });
                              batch.set(doc(projectionsColRef, newId), { ...transactionData, id: newId });
                              
                              await batch.commit();
                              showToast("Transacción registrada en Registros y Proyección.", "success");
                          }
                      } else if (modalContext === 'proyeccion') {
                          // Si estamos en la pestaña PROYECCION (esta lógica no cambia)
                          if (id) {
                              console.warn("La edición solo es posible desde la pestaña Registros.");
                              closeTransactionModal();
                              return;
                          } else {
                              // Al crear, se registra SOLO en la colección de proyecciones
                              const newProjectionRef = doc(projectionsColRef);
                              await setDoc(newProjectionRef, { ...transactionData, id: newProjectionRef.id });
                              showToast("Proyección registrada exitosamente.", "success");
                          }
                      }

                      if (!id) { // Solo si es una entrada nueva
                          const isNewDescription = description && !appState.descriptions.some(d => d.toLowerCase() === description.toLowerCase());
                          if (isNewDescription) {
                              openConfirmModal('Guardar Descripción', `La descripción "${description}" es nueva. ¿Deseas guardarla para usarla en el futuro?`,
                                  async () => {
                                      const updatedDescriptions = [...appState.descriptions, description].sort((a, b) => a.localeCompare(b));
                                      await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                                      showToast(`Descripción "${description}" guardada.`, "info");
                                  }
                              );
                          }
                          transactionForm.reset();
                          document.getElementById('transaction-date').valueAsDate = new Date();
                          document.getElementById('transaction-date').focus();
                      }
                  } catch (error) {
                      console.error("[Firestore] Error al guardar:", error);
                      showMessageModal("Error al Guardar", "No se pudo guardar el registro.", "error");
                  } finally {
                      hideButtonLoading(saveBtn);
                  }
              }
              // ================================ FIN DEL PEGADO ===============================
      
              // --- REEMPLAZA la función 'archiveTransaction' con estas DOS ---
              // --- REEMPLAZA LA FUNCIÓN COMPLETA CON ESTA VERSIÓN ---
              async function deleteTransaction(id) {
                  openConfirmModal('Eliminar Transacción', 'Esta acción eliminará la transacción permanentemente de sus Registros y de su Proyección. ¿Continuar?', async () => {
                      showLoading();
                      const appId = firebaseProjectId;
                      const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                      const projectionDocRef = doc(db, `artifacts/${appId}/users/${userId}/projections`, id); // Apunta al mismo ID

                      try {
                          // Usamos un batch para asegurar que ambas eliminaciones ocurran juntas
                          const batch = writeBatch(db);
                          batch.delete(transactionDocRef);
                          batch.delete(projectionDocRef);
                          await batch.commit();

                          showToast("Transacción eliminada de Registros y Proyección.", "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar transacción sincronizada:", error);
                          showMessageModal("Error al Eliminar", "No se pudo eliminar la transacción de ambas secciones.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }

              async function deleteProjection(id) {
                  // Borra solo de 'Proyección' y NO afecta los saldos
                  openConfirmModal('Eliminar Proyección', 'Esta acción eliminará el registro únicamente de esta pestaña. No afectará sus saldos ni la pestaña de Registros. ¿Continuar?', async () => {
                      showLoading();
                      const appId = firebaseProjectId;
                      const projectionDocRef = doc(db, `artifacts/${appId}/users/${userId}/projections`, id);
                      try {
                          await deleteDoc(projectionDocRef);
                          showToast("Registro eliminado de Proyección.", "success");
                      } catch (error) {
                          showMessageModal("Error al Eliminar", "No se pudo eliminar la proyección.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              function openTransferModal() {
                  closeTransactionModal();
                  transferForm.reset();
                  clearValidationErrors(); // Limpiar errores
                  populateTransferModalDropdowns();
                  document.getElementById('transfer-date').valueAsDate = new Date();
                  transferModal.classList.add('active');
              }
      
              function closeTransferModal() {
                  transferModal.classList.remove('active');
                  clearValidationErrors(); // Limpiar errores
              }
      
              async function handleTransferFormSubmit(e) {
                  e.preventDefault();
                  clearValidationErrors(); // Limpiar errores previos
      
                  const fromBank = document.getElementById('transfer-from-bank').value;
                  const toBank = document.getElementById('transfer-to-bank').value;
                  const amount = parseFloat(document.getElementById('transfer-amount').value);
                  const date = document.getElementById('transfer-date').value;
      
                  let isValid = true;
                  if (!validateRequired(document.getElementById('transfer-date'), transferDateError, "La fecha es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('transfer-from-bank'), transferFromBankError, "La cuenta de origen es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('transfer-to-bank'), transferToBankError, "La cuenta de destino es obligatoria.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('transfer-amount'), transferAmountError, "El monto debe ser un número positivo.")) isValid = false;
      
                  if (fromBank === toBank) {
                      showError(transferToBankError, "La cuenta de origen y destino no pueden ser la misma.");
                      isValid = false;
                  }
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario de transferencia.", "error");
                      return;
                  }
      
                  showButtonLoading(document.getElementById('confirm-transfer-btn'));
                  const appId = firebaseProjectId;
                  const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
      
                  const batch = writeBatch(db);
                  const newExpenseDocRef = doc(transactionsColRef);
                  const newIncomeDocRef = doc(transactionsColRef);
      
                  const expenseTransaction = {
                      id: newExpenseDocRef.id, date: date, description: `Transferencia a ${toBank}`,
                      category: 'Transferencia Interna', bank: fromBank, amount: amount, type: 'expense',
                  };
                  const incomeTransaction = {
                      id: newIncomeDocRef.id, date: date, description: `Transferencia desde ${fromBank}`,
                      category: 'Transferencia Interna', bank: toBank, amount: amount, type: 'income',
                  };
      
                  batch.set(newExpenseDocRef, expenseTransaction);
                  batch.set(newIncomeDocRef, incomeTransaction);
                  console.log("[Firestore] Registrando transferencia interna."); // Debugging
      
                  try {
                      await batch.commit();
                      closeTransferModal();
                      showToast("Transferencia registrada exitosamente.", "success");
                  } catch (error) {
                      console.error("[Firestore] Error al registrar transferencia:", error); // Debugging
                      showMessageModal("Error al Registrar Transferencia", "No se pudo registrar la transferencia. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                  } finally {
                      hideButtonLoading(document.getElementById('confirm-transfer-btn'));
                  }
              }
      
              // --- CONFIGURACIÓN ---
      
              // ======================================================================
              // 4. FUNCIÓN MODIFICADA: renderConfigurationLists()
              // Reemplaza la función original completa con esta nueva versión.
              // ======================================================================
              /**
               * Dibuja las listas en la pestaña de Configuración (Categorías, Bancos, Descripciones).
               * La decisión de modificar esta función es para simplificar la pestaña de 'Configuración',
               * eliminando la gestión de montos de presupuesto de aquí, ya que ahora se gestionan
               * directamente en la nueva sección 'Presupuesto'. Esto centraliza la funcionalidad
               * y hace la interfaz más intuitiva.
               */
              function renderConfigurationLists() {
                  const categoryList = document.getElementById('category-list');
                  const bankList = document.getElementById('bank-list');
                  const descriptionListConfig = document.getElementById('description-list-config');

                  categoryList.innerHTML = '';
                  bankList.innerHTML = '';
                  descriptionListConfig.innerHTML = '';

                  // MODIFICADO: Muestra el icono junto al nombre de la categoría.
                  if (appState.categories.length > 0) {
                      appState.categories.forEach(cat => {
                          const li = document.createElement('li');
                          li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg gap-2";
                          li.innerHTML = `
                              <span class="flex-grow flex items-center">${getCategoryDisplay(cat.name)}</span>
                              <button data-name="${cat.name}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>
                          `;
                          categoryList.appendChild(li);
                      });
                  } else {
                      categoryList.innerHTML = '<p class="text-gray-500 text-sm p-2">No hay categorías añadidas.</p>';
                  }

                  if (appState.banks.length > 0) {
                      appState.banks.forEach(bank => {
                          const li = document.createElement('li');
                          li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg";
                          li.innerHTML = `<span>${bank}</span><button data-name="${bank}" class="delete-bank-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
                          bankList.appendChild(li);
                      });
                  } else {
                      bankList.innerHTML = '<p class="text-gray-500 text-sm p-2">No hay bancos/cuentas añadidos.</p>';
                  }

                  if (appState.descriptions.length === 0) {
                      descriptionListConfig.innerHTML = '<p class="text-gray-500 text-sm p-2">No hay descripciones guardadas.</p>';
                  } else {
                      appState.descriptions.forEach(desc => {
                          const li = document.createElement('li');
                          li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg";
                          li.innerHTML = `<span class="truncate pr-2">${desc}</span><button data-name="${desc}" class="delete-description-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
                          descriptionListConfig.appendChild(li);
                      });
                  }

                  document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCategory(e.target.dataset.name)));
                  document.querySelectorAll('.delete-bank-btn').forEach(btn => btn.addEventListener('click', (e) => deleteBank(e.target.dataset.name)));
                  document.querySelectorAll('.delete-description-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDescription(e.target.dataset.name)));             
              }

              async function addCategory() {
                  clearValidationErrors();
                  const input = document.getElementById('new-category-name-modal');
                  const errorElement = document.getElementById('new-category-name-modal-error');
                  const name = toTitleCase(input.value.trim());
                  const selectedIconElement = document.querySelector('#category-icon-grid .icon-option.selected');
                  const icon = selectedIconElement ? selectedIconElement.dataset.icon : DEFAULT_ICON;

                  let isValid = true;
                  if (!validateRequired(input, errorElement, "El nombre de la categoría es obligatorio.")) isValid = false;

                  // MODIFICADO: Busca en el array de objetos por la propiedad 'name'.
                  if (name && appState.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                      showError(errorElement, `La categoría "${name}" ya existe.`);
                      isValid = false;
                  }
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores para añadir la categoría.", "error");
                      return;
                  }
      
                  showButtonLoading(document.getElementById('save-new-category-btn'));
                  const appId = firebaseProjectId;
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
      
                  try {
                      // MODIFICADO: Crea el nuevo objeto de categoría y lo añade al array.
                      const newCategory = { name, icon };
                      const updatedCategories = [...appState.categories, newCategory].sort((a, b) => a.name.localeCompare(b.name));
                      
                      console.log("[Firestore] Añadiendo categoría:", newCategory);
                      await updateDoc(userDocRef, { categories: updatedCategories });
                      
                      closeAddCategoryModal(); // Cierra el modal de iconos
                      showToast(`Categoría "${name}" añadida.`, "success");
                  } catch (error) {
                      console.error("[Firestore] Error al añadir categoría:", error);
                      showMessageModal("Error al Añadir Categoría", "No se pudo añadir la categoría.", "error");
                  } finally {
                      hideButtonLoading(document.getElementById('save-new-category-btn'));
                  }
              }
      
              async function deleteCategory(name) {
                  openConfirmModal('Eliminar Categoría', `¿Seguro que quieres eliminar la categoría "${name}"? Esto no eliminará las transacciones existentes con esta categoría.`, async () => {
                      showLoading();
                      const appId = firebaseProjectId;
                      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                      console.log("[Firestore] Eliminando categoría:", name);
                      try {
                          // MODIFICADO: Filtra el array de objetos para eliminar la categoría por su nombre.
                          const updatedCategories = appState.categories.filter(c => c.name !== name);
                          await updateDoc(userDocRef, { categories: updatedCategories });
                          showToast(`Categoría "${name}" eliminada.`, "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar categoría:", error);
                          showMessageModal("Error al Eliminar Categoría", "No se pudo eliminar la categoría.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              async function addBank() {
                  clearValidationErrors(); // Limpiar errores previos
                  const input = document.getElementById('new-bank-name');
                  const name = toTitleCase(input.value.trim());
      
                  let isValid = true;
                  if (!validateRequired(input, newBankNameError, "El nombre del banco/cuenta es obligatorio.")) isValid = false;
      
                  if (name && appState.banks.some(b => b.toLowerCase() === name.toLowerCase())) {
                      showError(newBankNameError, `El banco/cuenta "${name}" ya existe.`);
                      isValid = false;
                  }
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores para añadir el banco/cuenta.", "error");
                      return;
                  }
      
                  showButtonLoading(document.getElementById('add-bank-btn'));
                  const appId = firebaseProjectId;
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
      
                  try {
                      const updatedBanks = [...appState.banks, name].sort((a, b) => a.localeCompare(b));
                      console.log("[Firestore] Añadiendo banco:", name); // Debugging
                      await updateDoc(userDocRef, { banks: updatedBanks });
                      input.value = '';
                      showToast(`Banco/Cuenta "${name}" añadido.`, "success");
                  } catch (error) {
                      console.error("[Firestore] Error al añadir banco:", error); // Debugging
                      showMessageModal("Error al Añadir Banco/Cuenta", "No se pudo añadir el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                  } finally {
                      hideButtonLoading(document.getElementById('add-bank-btn'));
                  }
              }
      
              async function deleteBank(name) {
                  openConfirmModal('Eliminar Banco/Cuenta', `Al eliminar "${name}", también se eliminará la tarjeta de crédito asociada, si existe. ¿Deseas continuar?`, async () => {
                      showLoading(); // Usar overlay global
                      const appId = firebaseProjectId;
                      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                      const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                      console.log("[Firestore] Eliminando banco:", name); // Debugging
      
                      try {
                          const batch = writeBatch(db);
      
                          // Eliminar el banco de la lista de bancos
                          const updatedBanks = appState.banks.filter(b => b !== name);
                          batch.update(userDocRef, { banks: updatedBanks });
      
                          // Eliminar tarjetas de crédito asociadas
                          const cardsToDelete = appState.creditCards.filter(cc => cc.bank === name);
                          cardsToDelete.forEach(card => {
                              batch.delete(doc(creditCardsColRef, card.id));
                          });
      
                          await batch.commit();
                          showToast(`Banco/Cuenta "${name}" y tarjetas asociadas eliminados.`, "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar banco/cuenta:", error); // Debugging
                          showMessageModal("Error al Eliminar Banco/Cuenta", "No se pudo eliminar el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              async function deleteDescription(name) {
                  openConfirmModal('Eliminar Descripción', `¿Seguro que quieres eliminar la descripción guardada "${name}"?`, async () => {
                      showLoading(); // Usar overlay global
                      const appId = firebaseProjectId;
                      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                      console.log("[Firestore] Eliminando descripción:", name); // Debugging
                      try {
                          const updatedDescriptions = appState.descriptions.filter(d => d !== name);
                          await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                          showToast(`Descripción "${name}" eliminada.`, "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar descripción:", error); // Debugging
                          showMessageModal("Error al Eliminar Descripción", "No se pudo eliminar la descripción. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              async function handleSaveAlias() {
                  clearValidationErrors(); // Limpiar errores previos
                  const alias = userAliasInput.value.trim();
      
                  let isValid = true;
                  if (!validateRequired(userAliasInput, userAliasError, "El alias no puede estar vacío.")) isValid = false;
                  // Puedes añadir más validaciones aquí, como longitud máxima, caracteres permitidos, etc.
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores para guardar el alias.", "error");
                      return;
                  }
      
                  showButtonLoading(saveAliasBtn);
                  const appId = firebaseProjectId;
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
      
                  try {
                      await updateDoc(userDocRef, { userAlias: alias });
                      appState.userAlias = alias; // Actualizar el estado local inmediatamente
                      renderHeaderAlias(); // Actualizar la cabecera
                      showToast("Alias guardado exitosamente.", "success");
                  } catch (error) {
                      console.error("[Firestore] Error al guardar alias:", error);
                      showMessageModal("Error al Guardar Alias", "No se pudo guardar el alias. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                  } finally {
                      hideButtonLoading(saveAliasBtn);
                  }
              }

              // ===== ESTA ES LA FUNCIÓN COMPLETA QUE DEBES PEGAR =====
              /**
              * Gestiona el proceso de cambio de contraseña del usuario.
              * Por seguridad, primero re-autentica al usuario con su contraseña actual
              * antes de permitir la actualización a la nueva contraseña.
              */
              async function handleChangePassword(e) {
                  e.preventDefault();
                  clearValidationErrors();

                  const currentPassword = currentPasswordInput.value;
                  const newPassword = newPasswordInput.value;
                  const confirmNewPassword = confirmNewPasswordInput.value;
                  const user = auth.currentUser;

                  // --- 1. Validaciones del formulario ---
                  let isValid = true;
                  if (!validateRequired(currentPasswordInput, currentPasswordError, "La contraseña actual es obligatoria.")) isValid = false;
                  if (!validatePassword(newPasswordInput, newPasswordError, 6)) isValid = false; // Mínimo 6 caracteres
                  
                  if (newPassword !== confirmNewPassword) {
                      showError(confirmNewPasswordError, "Las nuevas contraseñas no coinciden.");
                      isValid = false;
                  }
                  
                  if (currentPassword === newPassword) {
                      showError(newPasswordError, "La nueva contraseña no puede ser igual a la actual.");
                      isValid = false;
                  }

                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario.", "error");
                      return;
                  }

                  if (!user) {
                      showMessageModal("Error", "No se ha encontrado un usuario activo. Por favor, inicia sesión de nuevo.", "error");
                      return;
                  }

                  showButtonLoading(changePasswordBtn);

                  try {
                      // --- 2. Re-autenticar al usuario (Paso de seguridad) ---
                      const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
                      await window.reauthenticateWithCredential(user, credential);
                      
                      // --- 3. Si la re-autenticación es exitosa, actualizar la contraseña ---
                      await window.updatePassword(user, newPassword);                     
                      
                      showMessageModal("Éxito", "Tu contraseña ha sido actualizada correctamente.", "success");
                      changePasswordForm.reset(); // Limpiar el formulario

                  } catch (error) {
                      console.error("Error al cambiar la contraseña:", error);
                      if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                          showError(currentPasswordError, "La contraseña actual es incorrecta.");
                      } else if (error.code === 'auth/weak-password') {
                          showError(newPasswordError, "La nueva contraseña es demasiado débil. Debe tener al menos 6 caracteres.");
                      } else {
                          showMessageModal("Error", "Ocurrió un error inesperado al cambiar la contraseña. Inténtalo de nuevo.", "error");
                      }
                  } finally {
                      hideButtonLoading(changePasswordBtn);
                  }
              }



       // --- NUEVA FUNCIÓN: Guardar Presupuestos ---
              async function handleSaveBudgets() {
                  showButtonLoading(document.getElementById('save-budgets-btn'));
                  const newBudgets = {};
                  document.querySelectorAll('.category-budget-input').forEach(input => {
                      const category = input.dataset.category;
                      const amount = parseFloat(input.value);
                      if (category && !isNaN(amount) && amount > 0) {
                          newBudgets[category] = amount;
                      }
                  });

                  const appId = firebaseProjectId;
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

                  try {
                      await updateDoc(userDocRef, { categoryBudgets: newBudgets });
                      appState.categoryBudgets = newBudgets; // Actualizar estado local
                      showToast("Presupuestos guardados exitosamente.", "success");
                  } catch (error) {
                      console.error("[Firestore] Error al guardar presupuestos:", error);
                      showMessageModal("Error al Guardar", "No se pudieron guardar los presupuestos.", "error");
                  } finally {
                      hideButtonLoading(document.getElementById('save-budgets-btn'));
                  }
              }      
              // ===== FUNCIÓN REEMPLAZADA POR COMPLETO =====
              async function initiateNewMonth() {
                  openConfirmModal(
                      'Iniciar Nuevo Mes', 
                      'Este proceso hará lo siguiente: 1. Limpiará y llenará su Proyección con todos los gastos recurrentes. 2. Registrará en sus Registros solo los gastos recurrentes ya vencidos. 3. Archivará sus registros actuales y actualizará su saldo inicial. ¿Continuar?', 
                      async () => {
                          showLoading();
                          const appId = firebaseProjectId;
                          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                          const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                          const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`);
                          const archivesColRef = collection(db, `artifacts/${appId}/users/${userId}/archives`);
                          
                          console.log("[Firestore] Iniciando nuevo mes con lógica personalizada...");

                          try {
                              const transactionsToArchive = [...appState.transactions];
                              // --- NUEVO: Obtener todas las proyecciones actuales para borrarlas ---
                              const projectionsToDeleteSnapshot = await getDocs(projectionsColRef);

                              if (transactionsToArchive.length > 0) {
                                  const archiveTimestamp = new Date();
                                  const archiveId = `archive-${archiveTimestamp.toISOString()}`;
                                  await setDoc(doc(archivesColRef, archiveId), {
                                      archivedAt: archiveTimestamp,
                                      transactions: transactionsToArchive
                                  });
                              }

                              const finalBalance = appState.openingBalance + 
                                  transactionsToArchive.reduce((sum, t) => (t.type === 'income' ? sum + t.amount : sum), 0) -
                                  transactionsToArchive.reduce((sum, t) => (t.type === 'expense' ? sum + t.amount : sum), 0);

                              const batch = writeBatch(db);

                              // Borrar todas las transacciones y proyecciones actuales
                              transactionsToArchive.forEach(t => batch.delete(doc(transactionsColRef, t.id)));
                              projectionsToDeleteSnapshot.forEach(p => batch.delete(doc(projectionsColRef, p.id)));

                              // Actualizar el saldo inicial
                              batch.update(userDocRef, { openingBalance: finalBalance });

                              // --- LÓGICA DE REGISTRO MODIFICADA ---
                              const now = new Date();
                              const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                              const currentDay = now.getDate(); // Día actual para la comparación

                              appState.recurringExpenses.forEach(re => {
                                  const transactionDate = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth(), re.day);
                                  const newId = doc(transactionsColRef).id; // Generar un ID único

                                  const newTransactionData = {
                                      id: newId,
                                      date: transactionDate.toISOString().split('T')[0],
                                      description: re.description,
                                      category: re.category,
                                      bank: re.bank,
                                      amount: re.amount,
                                      type: 'expense',
                                  };

                                  // 1. SIEMPRE se registra en Proyección
                                  batch.set(doc(projectionsColRef, newId), newTransactionData);

                                  // 2. SOLO se registra en Registros si el día de pago ya pasó en el mes actual
                                  if (parseInt(re.day, 10) <= currentDay) {
                                      batch.set(doc(transactionsColRef, newId), newTransactionData);
                                  }
                              });

                              await batch.commit();

                              setCurrentMonthFilter(nextMonthDate.toISOString().substring(0, 7));
                              switchTab('registros');
                              showToast("Nuevo mes iniciado con la nueva configuración.", "success");

                          } catch (error) {
                              console.error("[Firestore] Error al iniciar nuevo mes:", error);
                              showMessageModal("Error al Iniciar Nuevo Mes", "No se pudo completar el proceso.", "error");
                          } finally {
                              hideLoading();
                          }
                      }
                  );
              }
      
              async function resetAllData() {
                  // MODIFICADO: El mensaje ahora indica que las descripciones se conservan.
                  openConfirmModal('Reiniciar Período', '¡ADVERTENCIA! Esto eliminará permanentemente sus Transacciones, Proyecciones y Presupuestos. Su Saldo Inicial volverá a cero. Se conservará toda su configuración (Categorías, Bancos, Descripciones, etc.). ¿Está seguro?', async () => {
                      showLoading();
                      const appId = firebaseProjectId;
                      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                      const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                      const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`); // AÑADIDO: Referencia a la colección de proyecciones.
                      
                      console.log("[Firestore] Reiniciando datos del período, conservando toda la configuración...");

                      try {
                          // Guardamos todos los datos que queremos conservar del estado local.
                          const categoriesToKeep = appState.categories;
                          const banksToKeep = appState.banks;
                          const descriptionsToKeep = appState.descriptions; // AÑADIDO: Guardamos las descripciones.
                          const recurringExpensesToKeep = appState.recurringExpenses;
                          const creditCardsToKeep = appState.creditCards;
                          const userAliasToKeep = appState.userAlias;

                          const batch = writeBatch(db);
      
                          // Borrar todas las transacciones existentes.
                          const transactionsSnapshot = await getDocs(transactionsColRef);
                          transactionsSnapshot.docs.forEach(d => batch.delete(doc(transactionsColRef, d.id)));

                          // AÑADIDO: Borrar todas las proyecciones existentes.
                          const projectionsSnapshot = await getDocs(projectionsColRef);
                          projectionsSnapshot.docs.forEach(d => batch.delete(doc(projectionsColRef, d.id)));
      
                          // MODIFICADO: Actualizamos el documento de preferencias.
                          // Se elimina la línea que reiniciaba las descripciones.
                          batch.update(userDocRef, {
                            openingBalance: 0,
                            categoryBudgets: {}
                          });
      
                          await batch.commit();
      
                          // Reconstruimos el estado local de la aplicación.
                          appState = {
                              transactions: [],                   // Reiniciado
                              projections: [],                    // AÑADIDO: Se limpia el estado local de proyecciones.
                              categories: categoriesToKeep,       // Conservado
                              banks: banksToKeep,                 // Conservado
                              descriptions: descriptionsToKeep,     // MODIFICADO: Se usan las descripciones conservadas.
                              recurringExpenses: recurringExpensesToKeep, // Conservado
                              creditCards: creditCardsToKeep,     // Conservado
                              openingBalance: 0,                  // Reiniciado
                              userAlias: userAliasToKeep,         // Conservado
                              categoryBudgets: {},                // Reiniciado
                              budgetAlertsShown: {}               // Reiniciado
                          };
                          
                          initApp(); 

                          // MODIFICADO: Mensaje de éxito actualizado.
                          showMessageModal("Período Reiniciado", "Se han eliminado las transacciones y proyecciones. Toda tu configuración se ha conservado.", "success");
                      } catch (error) {
                          console.error("[Firestore] Error al reiniciar datos:", error);
                          showMessageModal("Error al Reiniciar Datos", "No se pudieron reiniciar los datos.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              // --- GASTOS RECURRENTES ---
      
              function renderRecurringExpensesTable() {
                  recurringExpensesTableBody.innerHTML = '';
                  const table = recurringExpensesTableBody.closest('table');
      
                  if (appState.recurringExpenses.length === 0) {
                      table.querySelector('tbody').classList.add('hidden');
                      table.querySelector('tfoot').classList.add('hidden');
                      noRecurringExpensesMessage.classList.remove('hidden');
                      return;
                  }
      
                  table.querySelector('tbody').classList.remove('hidden');
                  table.querySelector('tfoot').classList.remove('hidden');
                  noRecurringExpensesMessage.classList.add('hidden');
      
                  const sortedRecurringExpenses = [...appState.recurringExpenses].sort((a, b) => {
                      return a.day - b.day;
                  });
      
                  sortedRecurringExpenses.forEach(re => {
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td class="px-2 py-4 text-center">
                            <input type="checkbox" class="recurring-checkbox" data-id="${re.id}">
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${re.day}</td> 
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${re.description}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex items-center">${getCategoryDisplay(re.category)}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${formatCurrency(re.amount)}</td> 
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${re.bank}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-weight: 400">
                              <button data-id="${re.id}" class="edit-recurring-btn mr-3">Editar</button>
                              <button data-id="${re.id}" class="delete-recurring-btn text-red-600 hover:text-red-900">Eliminar</button>
                          </td>
                      `;
                      recurringExpensesTableBody.appendChild(row);
                  });
      
                  const totalRecurring = appState.recurringExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                   // Ajustar el colspan del pie de tabla debido a la nueva columna
                  table.querySelector('tfoot tr td:first-child').colSpan = 6;
                  document.getElementById('recurring-total').textContent = formatCurrency(totalRecurring);
      
                  document.querySelectorAll('.edit-recurring-btn').forEach(btn => btn.addEventListener('click', (e) => openRecurringExpenseModal(e.target.dataset.id)));
                  document.querySelectorAll('.delete-recurring-btn').forEach(btn => btn.addEventListener('click', (e) => deleteRecurringExpense(e.target.dataset.id)));
                  updateDeleteButtonVisibility();
              }
              
              function openRecurringExpenseModal(id = null) {
                  recurringExpenseForm.reset();
                  clearValidationErrors(); // Limpiar errores
                  populateRecurringModalDropdowns();
                  populateDescriptionDatalist();
                  if (id) {
                      const expense = appState.recurringExpenses.find(re => re.id === id);
                      if (expense) {
                          document.getElementById('recurring-modal-title').textContent = 'Editar Gasto Recurrente';
                          document.getElementById('recurring-expense-id').value = expense.id;
                          document.getElementById('recurring-description').value = expense.description;
                          document.getElementById('recurring-amount').value = expense.amount;
                          document.getElementById('recurring-category').value = expense.category;
                          document.getElementById('recurring-bank').value = expense.bank;
                          document.getElementById('recurring-day').value = expense.day;
                      } else {
                          showMessageModal("Error", "Gasto recurrente no encontrado.", "error");
                          closeRecurringExpenseModal();
                          return;
                      }
                  } else {
                      document.getElementById('recurring-modal-title').textContent = 'Añadir Gasto Recurrente';
                      document.getElementById('recurring-expense-id').value = '';
                  }
                  recurringExpenseModal.classList.add('active');
              }
      
              function closeRecurringExpenseModal() {
                  recurringExpenseModal.classList.remove('active');
                  clearValidationErrors(); // Limpiar errores
              }      
              // ================================== PEGA AQUÍ ==================================
              /**
               * MODIFICADO: Maneja el envío del formulario de gastos recurrentes.
               * Ahora, en lugar de cerrar el modal, resetea el formulario para añadir otro.
               */
              async function handleRecurringExpenseFormSubmit(e) {
                  e.preventDefault();
                  clearValidationErrors();

                  const id = document.getElementById('recurring-expense-id').value;
                  const description = toTitleCase(document.getElementById('recurring-description').value.trim());
                  const amount = parseFloat(document.getElementById('recurring-amount').value);
                  const category = document.getElementById('recurring-category').value;
                  const bank = document.getElementById('recurring-bank').value;
                  const day = parseInt(document.getElementById('recurring-day').value);

                  // Validaciones (sin cambios)
                  let isValid = true;
                  if (!validateRequired(document.getElementById('recurring-description'), recurringDescriptionError, "La descripción es obligatoria.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('recurring-amount'), recurringAmountError, "El monto debe ser un número positivo.")) isValid = false;
                  if (!validateRequired(document.getElementById('recurring-category'), recurringCategoryError, "La categoría es obligatoria.")) isValid = false;
                  if (!validateRequired(document.getElementById('recurring-bank'), recurringBankError, "El banco/cuenta es obligatorio.")) isValid = false;
                  if (!validateDayOfMonth(document.getElementById('recurring-day'), recurringDayError, "El día de pago debe ser entre 1 y 31.")) isValid = false;
                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario.", "error");
                      return;
                  }

                  const saveBtn = document.getElementById('save-recurring-btn');
                  showButtonLoading(saveBtn);
                  const appId = firebaseProjectId;
                  const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
                  const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

                  const newRecurringExpenseData = { description, amount, category, bank, day };

                  try {
                      if (id) {
                          await setDoc(doc(recurringExpensesColRef, id), newRecurringExpenseData, { merge: true });
                          showToast("Gasto recurrente actualizado exitosamente.", "success");
                          // Si se estaba editando, sí cerramos el modal.
                          closeRecurringExpenseModal();
                      } else {
                          const newDocRef = doc(recurringExpensesColRef);
                          await setDoc(newDocRef, { ...newRecurringExpenseData, id: newDocRef.id });
                          showToast("Gasto recurrente añadido exitosamente.", "success");
                          
                          // --- ¡CAMBIO CLAVE! ---
                          // Reseteamos el formulario y devolvemos el foco al primer campo.
                          recurringExpenseForm.reset();
                          document.getElementById('recurring-description').focus();
                      }

                      const isNewDescription = description && !appState.descriptions.some(d => d.toLowerCase() === description.toLowerCase());
                      if (isNewDescription) {
                          const updatedDescriptions = [...appState.descriptions, description].sort((a, b) => a.localeCompare(b));
                          await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                          showToast(`Descripción "${description}" guardada.`, "info");
                      }
                       // --- LÍNEA ELIMINADA ---
                       // Ya no cerramos el modal al crear un nuevo gasto: closeRecurringExpenseModal();
                  } catch (error) {
                      console.error("[Firestore] Error al guardar gasto recurrente:", error);
                      showMessageModal("Error al Guardar", "No se pudo guardar el gasto recurrente.", "error");
                  } finally {
                      hideButtonLoading(saveBtn);
                  }
              }
              // ================================ FIN DEL PEGADO ===============================      
              async function deleteRecurringExpense(id) {
                  openConfirmModal('Eliminar Gasto Recurrente', '¿Estás seguro? Esto no afectará a transacciones ya creadas.', async () => {
                      showLoading(); // Usar overlay global
                      const appId = firebaseProjectId;
                      const recurringExpenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/recurringExpenses`, id);
                      console.log("[Firestore] Eliminando gasto recurrente:", id); // Debugging
                      try {
                          await deleteDoc(recurringExpenseDocRef);
                          showToast("Gasto recurrente eliminado exitosamente.", "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar gasto recurrente:", error); // Debugging
                          showMessageModal("Error al Eliminar Gasto Recurrente", "No se pudo eliminar el gasto recurrente. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }

              /* ================================================== */
              /* ===== PEGA LA NUEVA FUNCIÓN COMPLETA AQUÍ ===== */
              /* ================================================== */
              /**
               * Registra TODOS los gastos recurrentes como transacciones en el mes actual.
               * Ideal para que los nuevos usuarios inicialicen su primer mes.
               */

              // --- REEMPLAZA LA FUNCIÓN COMPLETA ---
              // Nota: El nombre de la función se mantiene por consistencia, pero su lógica ha cambiado.
              async function migrateAllRecurringToTransactions() {
                  openConfirmModal(
                      'Poblar Proyección', 
                      'Esto registrará sus gastos recurrentes en la pestaña de Proyección para el mes actual, evitando duplicados. Esta acción NO afectará sus Registros. ¿Desea continuar?', 
                      async () => {
                          showLoading();
                          
                          if (appState.recurringExpenses.length === 0) {
                              hideLoading();
                              showMessageModal("Información", "No hay gastos recurrentes para registrar.", "info");
                              return;
                          }

                          const appId = firebaseProjectId;
                          // --- MODIFICADO: Solo necesitamos la referencia a Proyecciones ---
                          const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`);
                          
                          try {
                              const batch = writeBatch(db);
                              const now = new Date();
                              const currentYear = now.getFullYear();
                              const currentMonth = now.getMonth();
                              let newEntriesCount = 0;

                              appState.recurringExpenses.forEach(re => {
                                  const transactionDate = new Date(currentYear, currentMonth, re.day);
                                  const formattedDate = transactionDate.toISOString().split('T')[0];

                                  // --- LÓGICA NUEVA: Comprobación de duplicados ---
                                  const alreadyExists = appState.projections.some(p => 
                                      p.date === formattedDate &&
                                      p.description.toLowerCase() === re.description.toLowerCase() &&
                                      p.category === re.category
                                  );

                                  // Si no existe, se prepara para añadirlo
                                  if (!alreadyExists) {
                                      const newTransactionData = {
                                          date: formattedDate,
                                          description: re.description,
                                          category: re.category,
                                          bank: re.bank,
                                          amount: re.amount,
                                          type: 'expense'
                                      };

                                      const newDocRef = doc(projectionsColRef);
                                      batch.set(newDocRef, { ...newTransactionData, id: newDocRef.id });
                                      newEntriesCount++;
                                  }
                              });

                              if (newEntriesCount > 0) {
                                  await batch.commit();
                                  showToast(`${newEntriesCount} gasto(s) recurrente(s) han sido añadidos a Proyección.`, 'success');
                              } else {
                                  showToast('No se añadieron gastos nuevos, parece que ya estaban todos registrados en Proyección.', 'info');
                              }
                              
                              switchTab('proyeccion');

                          } catch (error) {
                              console.error("[Firestore] Error al registrar gastos en proyección:", error);
                              showMessageModal("Error en el Proceso", "No se pudieron registrar los gastos en Proyección.", "error");
                          } finally {
                              hideLoading();
                          }
                      }
                  );
              }
              /* ================================================== */
              /* =====          FIN DE LA NUEVA FUNCIÓN         ===== */
              /* ================================================== */
      
              // --- TARJETAS DE CRÉDITO ---
      
              function renderCreditCardsTable() {
                creditCardsTableBody.innerHTML = '';
                if (appState.creditCards.length === 0) {
                  creditCardsTableBody.classList.add('hidden');
                  noCreditCardsMessage.classList.remove('hidden');
                  return;
                }

                creditCardsTableBody.classList.remove('hidden');
                noCreditCardsMessage.classList.add('hidden');

                // ORDENAR POR FECHA DE PAGO (dueDate) DE MENOR A MAYOR
                const sortedCards = [...appState.creditCards].sort((a, b) => a.dueDate - b.dueDate);

                sortedCards.forEach(card => {
                  const row = document.createElement('tr');
                  row.dataset.cardId = card.id;

                  const today = new Date();
                  const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
                  if (today.getDate() > card.dueDate) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                  }
                  const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

                  let bgColor = 'bg-white';
                  if (daysDiff >= 0 && daysDiff <= 2) {
                    bgColor = 'bg-red-100';
                  } else if (daysDiff > 2 && daysDiff <= 5) {
                    bgColor = 'bg-yellow-100';
                  }
                  row.className = bgColor;

                  const monthlyPayment = calculateMonthlyPayment(card.amount, card.rate, card.months);

                  row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-weight: 400 text-gray-900">${card.bank}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">Día ${card.dueDate} de cada mes</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="amount" value="${Number(card.amount).toFixed(2)}" step="0.01"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="rate" value="${Number(card.rate).toFixed(2)}" step="0.01"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="months" value="${card.months}" min="1"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 monthly-payment-cell">${formatCurrency(monthlyPayment)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-weight: 400">
                      <button class="delete-card-btn text-red-600 hover:text-red-900" data-id="${card.id}">Eliminar</button>
                    </td>
                  `;
                  creditCardsTableBody.appendChild(row);
                  // Totales
                  const totalAdeudado = sortedCards.reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
                  const totalPago = sortedCards.reduce((s, c) => s + calculateMonthlyPayment(c.amount, c.rate, c.months), 0);

                  // Pinta los totales
                  const totalAmountEl = document.getElementById('cc-total-amount');
                  const totalMonthlyEl = document.getElementById('cc-total-monthly');
                  if (totalAmountEl) totalAmountEl.textContent = formatCurrency(totalAdeudado);
                  if (totalMonthlyEl) totalMonthlyEl.textContent = formatCurrency(totalPago);

                });

                document.querySelectorAll('.delete-card-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCreditCard(e.target.dataset.id)));
              }
      
              async function handleCardDataChange(e) {
                  if (!e.target.classList.contains('card-data-input')) return;
      
                  const inputElement = e.target;
                  const field = inputElement.dataset.field;
                  let value = parseFloat(inputElement.value);
      
                  // Validación en línea para los campos de la tabla
                  let isValid = true;
                  if (field === 'amount' || field === 'rate' || field === 'months') {
                      if (isNaN(value) || value < 0) {
                          showToast(`El valor para "${field}" debe ser un número positivo.`, "error");
                          inputElement.value = inputElement.defaultValue; // Revertir al valor original
                          isValid = false;
                      }
                      if (field === 'months' && value < 1) {
                          showToast("Los meses para saldar deben ser al menos 1.", "error");
                          inputElement.value = inputElement.defaultValue;
                          isValid = false;
                      }
                  }
      
                  if (!isValid) return; // Detener si la validación falla
      
                  showButtonLoading(inputElement); // Mostrar spinner en el input (simulado)
                  const appId = firebaseProjectId;
                  const creditCardDocRef = doc(db, `artifacts/${appId}/users/${userId}/creditCards`, e.target.closest('tr').dataset.cardId);
      
                  try {
                      console.log(`[Firestore] Actualizando tarjeta ${e.target.closest('tr').dataset.cardId}, campo ${field}: ${value}`); // Debugging
                      await updateDoc(creditCardDocRef, { [field]: value });
                      showToast("Datos de tarjeta actualizados.", "success");
                      // El onSnapshot se encargará de re-renderizar la tabla y actualizar los cálculos
                  } catch (error) {
                      console.error("[Firestore] Error al actualizar datos de la tarjeta:", error); // Debugging
                      showMessageModal("Error al Actualizar Tarjeta", "No se pudieron actualizar los datos de la tarjeta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                  } finally {
                      hideButtonLoading(inputElement); // Ocultar spinner
                  }
              }
      
              function calculateMonthlyPayment(principal, annualRate, months) {
                  if (principal <= 0 || months <= 0) return 0;
                  if (annualRate <= 0) return principal / months;
      
                  const monthlyRate = (annualRate / 100) / 12;
                  const payment = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));
                  return payment;
              }
      
              async function deleteCreditCard(cardId) {
                  openConfirmModal('Eliminar Tarjeta', `¿Seguro que quieres eliminar esta tarjeta?`, async () => {
                      showLoading(); // Usar overlay global
                      const appId = firebaseProjectId;
                      const creditCardDocRef = doc(db, `artifacts/${appId}/users/${userId}/creditCards`, cardId);
                      console.log("[Firestore] Eliminando tarjeta de crédito:", cardId); // Debugging
                      try {
                          await deleteDoc(creditCardDocRef);
                          showToast("Tarjeta de crédito eliminada exitosamente.", "success");
                      } catch (error) {
                          console.error("[Firestore] Error al eliminar tarjeta de crédito:", error); // Debugging
                          showMessageModal("Error al Eliminar Tarjeta", "No se pudo eliminar la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                      } finally {
                          hideLoading();
                      }
                  });
              }
      
              function openCreditCardModal() {
                  creditCardForm.reset();
                  clearValidationErrors(); // Limpiar errores
                  creditCardModal.classList.add('active');
              }
      
              function closeCreditCardModal() {
                  creditCardModal.classList.remove('active');
                  clearValidationErrors(); // Limpiar errores
              }
      
              async function handleCreditCardFormSubmit(e) {
                  e.preventDefault();
                  clearValidationErrors(); // Limpiar errores previos
      
                  const bank = toTitleCase(document.getElementById('credit-card-bank').value.trim());
                  const dueDate = parseInt(document.getElementById('credit-card-due-date').value);
                  const amount = parseFloat(document.getElementById('credit-card-amount').value);
                  const rate = parseFloat(document.getElementById('credit-card-rate').value);
                  const months = parseInt(document.getElementById('credit-card-months').value);
      
                  let isValid = true;
                  if (!validateRequired(document.getElementById('credit-card-bank'), creditCardBankError, "El nombre del banco es obligatorio.")) isValid = false;
                  if (!validateDayOfMonth(document.getElementById('credit-card-due-date'), creditCardDueDateError, "El día de pago debe ser entre 1 y 31.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('credit-card-amount'), creditCardAmountError, "El monto adeudado debe ser un número positivo.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('credit-card-rate'), creditCardRateError, "La tasa de interés debe ser un número positivo.")) isValid = false;
                  if (!validatePositiveNumber(document.getElementById('credit-card-months'), creditCardMonthsError, "Los meses para saldar deben ser un número positivo.")) isValid = false;
      
                  if (bank && appState.creditCards.some(c => c.bank.toLowerCase() === bank.toLowerCase())) {
                      showError(creditCardBankError, 'Ya existe una tarjeta para este banco.');
                      isValid = false;
                  }
      
                  if (!isValid) {
                      showToast("Por favor, corrige los errores en el formulario.", "error");
                      return;
                  }
      
                  showButtonLoading(document.getElementById('save-credit-card-btn'));
                  const appId = firebaseProjectId;
                  const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
      
                  const newCardData = {
                      bank: bank,
                      dueDate: dueDate,
                      amount: amount,
                      rate: rate,
                      months: months
                  };
                  try {
                      console.log("[Firestore] Añadiendo nueva tarjeta de crédito."); // Debugging
                      const newDocRef = doc(creditCardsColRef);
                      await setDoc(newDocRef, { ...newCardData, id: newDocRef.id });
                      closeCreditCardModal();
                      showToast("Tarjeta añadida exitosamente.", "success");
                  } catch (error) {
                      console.error("[Firestore] Error al añadir tarjeta de crédito:", error); // Debugging
                      showMessageModal("Error al Añadir Tarjeta", "No se pudo añadir la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                  } finally {
                      hideButtonLoading(document.getElementById('save-credit-card-btn'));
                  }
              }
      
              // --- IMPORTAR Y EXPORTAR ---
      
              function exportToPDF() {
                  const doc = new jsPDF();
                  const transactions = getFilteredTransactions();
                  const monthString = formatMonthYear(filterMonth.value);
      
                  doc.text(`Reporte de Transacciones - ${monthString}`, 14, 16);
      
                  const tableColumn = ["Fecha", "Descripción", "Categoría", "Ingreso", "Gasto"];
                  const tableRows = [];
      
                  transactions.forEach(tx => {
                      const transactionData = [
                          formatDate(tx.date),
                          tx.description,
                          tx.category,
                          tx.type === 'income' ? formatCurrency(tx.amount) : '-',
                          tx.type === 'expense' ? formatCurrency(tx.amount) : '-'
                      ];
                      tableRows.push(transactionData);
                  });
      
                  doc.autoTable({
                      head: [tableColumn],
                      body: tableRows,
                      startY: 24,
                  });
      
                  const finalY = doc.lastAutoTable.finalY || 24;
                  const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                  const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      
                  doc.text("Resumen del Mes:", 14, finalY + 10);
                  doc.text(`Total Ingresos: ${formatCurrency(income)}`, 14, finalY + 16);
                  doc.text(`Total Gastos: ${formatCurrency(expenses)}`, 14, finalY + 22);
                  doc.text(`Balance del Mes: ${formatCurrency(income - expenses)}`, 14, finalY + 28);
      
                  doc.save(`reporte_${filterMonth.value}.pdf`);
                  showToast("Reporte PDF generado exitosamente.", "success");
              }
      
              function exportData() {
                  // Exportar el estado actual de appState (que ya está sincronizado con Firestore)
                  const dataToExport = {
                      transactions: appState.transactions,
                      categories: appState.categories,
                      banks: appState.banks,
                      descriptions: appState.descriptions,
                      recurringExpenses: appState.recurringExpenses,
                      creditCards: appState.creditCards,
                      openingBalance: appState.openingBalance,
                      userAlias: appState.userAlias, // Exportar el alias
                      // Futura mejora: Exportar presupuestos por categoría
                      // categoryBudgets: appState.categoryBudgets,
                  };
                  const dataStr = JSON.stringify(dataToExport, null, 2);
                  const dataBlob = new Blob([dataStr], {type: "application/json"});
                  const url = URL.createObjectURL(dataBlob);
                  const link = document.createElement('a');
                  link.download = `presupuesto_datos_${new Date().toISOString().split('T')[0]}.json`;
                  link.href = url;
                  link.click();
                  URL.revokeObjectURL(url);
                  showToast("Datos exportados a JSON exitosamente.", "success");
              }
      
              async function importData(event) {
                  const file = event.target.files[0];
                  if (!file) return;
      
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      try {
                          const importedState = JSON.parse(e.target.result);
                          openConfirmModal('Importar Datos', 'Esto reemplazará tus registros, proyecciones, gastos recurrentes, tarjetas y presupuestos con los datos del archivo. Tu configuración de categorías, bancos y alias NO será modificada. ¿Deseas continuar?', async () => {
                              showLoading();
                              const appId = firebaseProjectId;
                              const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                              const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                              const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`); // AÑADIDO: Referencia a proyecciones
                              const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
                              const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                              console.log("[Firestore] Importando datos con categorías preservadas...");
      
                              try {
                                  const batch = writeBatch(db);
      
                                  // --- Borrar datos de colecciones existentes ---
                                  const currentTransactions = await getDocs(transactionsColRef);
                                  currentTransactions.docs.forEach(d => batch.delete(doc(transactionsColRef, d.id)));
                                  
                                  const currentProjections = await getDocs(projectionsColRef); // AÑADIDO: Limpiar proyecciones
                                  currentProjections.docs.forEach(d => batch.delete(doc(projectionsColRef, d.id)));
                                  
                                  const currentRecurring = await getDocs(recurringExpensesColRef);
                                  currentRecurring.docs.forEach(d => batch.delete(doc(recurringExpensesColRef, d.id)));
                                  
                                  const currentCreditCards = await getDocs(creditCardsColRef);
                                  currentCreditCards.docs.forEach(d => batch.delete(doc(creditCardsColRef, d.id)));
      
                                  // --- Actualizar solo los campos necesarios en las preferencias ---
                                  // MODIFICADO: Se usa batch.update() en lugar de batch.set()
                                  // Se eliminan 'categories', 'banks', 'descriptions', 'openingBalance' y 'userAlias'
                                  batch.update(userDocRef, {
                                      categoryBudgets: importedState.categoryBudgets || {}, // AÑADIDO: Se importan los presupuestos
                                  });
      
                                  // --- Escribir nuevos datos en las colecciones ---
                                  if (importedState.transactions) {
                                    importedState.transactions.forEach(tx => {
                                        const newTxRef = doc(transactionsColRef);
                                        batch.set(newTxRef, { ...tx, id: newTxRef.id });
                                    });
                                  }

                                  // AÑADIDO: Lógica para importar proyecciones
                                  if (importedState.projections) {
                                    importedState.projections.forEach(proj => {
                                        const newProjRef = doc(projectionsColRef);
                                        batch.set(newProjRef, { ...proj, id: newProjRef.id });
                                    });
                                  }
      
                                  if (importedState.recurringExpenses) {
                                    importedState.recurringExpenses.forEach(re => {
                                        const newReRef = doc(recurringExpensesColRef);
                                        batch.set(newReRef, { ...re, id: newReRef.id });
                                    });
                                  }
      
                                  if (importedState.creditCards) {
                                    importedState.creditCards.forEach(cc => {
                                        const newCcRef = doc(creditCardsColRef);
                                        batch.set(newCcRef, { ...cc, id: newCcRef.id });
                                    });
                                  }
      
                                  await batch.commit();
                                  showMessageModal("Importación Exitosa", "Los datos han sido importados correctamente, manteniendo tu configuración de categorías.", "success");
                                  // onSnapshot se encargará de actualizar appState y el renderizado
                              } catch (error) {
                                  console.error("[Firestore] Error al importar datos a Firebase:", error);
                                  showMessageModal("Error de Importación", "Hubo un error al importar los datos. Asegúrate de que el archivo sea válido.", "error");
                              } finally {
                                  hideLoading();
                              }
                          });
                      } catch (error) {
                          showMessageModal('Error de Archivo', 'El archivo seleccionado no es un archivo de datos válido.', "error");
                      }
                  };
                  reader.readAsText(file);
                  importFileInput.value = ''; // Limpiar el input de archivo
              }
      
              // --- UTILIDADES Y VALIDACIÓN ---

              /**
               * Formatea una fecha para mostrar solo el número del día.
               * @param {string} dateString - La cadena de fecha (ej. "2025-09-01").
               * @returns {string} El número del día.
               */
              function formatDateForMobile(dateString) {
                  const date = new Date(dateString + 'T00:00:00');
                  return date.getDate().toString();
              }              

              // ================== REEMPLAZA ESTE BLOQUE COMPLETO ==================
              /**
               * Entra en el modo de pantalla completa con depuración.
               * @param {HTMLElement} element El elemento a expandir.
               */
              function enterFullscreen(element) {
                  console.log("Intentando entrar en pantalla completa..."); // Mensaje de depuración
                  if (element.requestFullscreen) {
                      element.requestFullscreen().catch(err => console.error(`Error al solicitar pantalla completa: ${err.message}`));
                  } else if (element.mozRequestFullScreen) { // Firefox
                      element.mozRequestFullScreen().catch(err => console.error(`Error al solicitar pantalla completa (Firefox): ${err.message}`));
                  } else if (element.webkitRequestFullscreen) { // Chrome, Safari & Opera
                      element.webkitRequestFullscreen().catch(err => console.error(`Error al solicitar pantalla completa (WebKit): ${err.message}`));
                  } else if (element.msRequestFullscreen) { // IE/Edge
                      element.msRequestFullscreen().catch(err => console.error(`Error al solicitar pantalla completa (MS): ${err.message}`));
                  } else {
                      console.error("La API de pantalla completa no es compatible con este navegador.");
                  }
              }

              /**
               * Sale del modo de pantalla completa con depuración.
               */
// ===== REEMPLAZA LA FUNCIÓN ANTERIOR CON ESTA =====
              function exitFullscreen() {
                  try {
                      console.log("Intentando salir de pantalla completa...");
                      if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                          if (document.exitFullscreen) {
                              document.exitFullscreen();
                          } else if (document.mozCancelFullScreen) { /* Firefox */
                              document.mozCancelFullScreen();
                          } else if (document.webkitExitFullscreen) { /* Chrome, Safari & Opera */
                              document.webkitExitFullscreen();
                          } else if (document.msExitFullscreen) { /* IE/Edge */
                              document.msExitFullscreen();
                          }
                      } else {
                          console.log("No se está en modo de pantalla completa.");
                      }
                  } catch (error) {
                      // Este catch evita que un error aquí detenga otras funciones, como el logout.
                      console.error("Error controlado al intentar salir de pantalla completa:", error.message);
                  }
              }

      //<!-- ================== FIN DEL CÓDIGO #1 ===================== -->
              /**
               * Convierte una cadena a formato Title Case.
               * @param {string} str - La cadena a convertir.
               * @returns {string} La cadena en Title Case.
               */
              function toTitleCase(str) {
                  if (!str) return '';
                  return str.toLowerCase().split(' ').map(word => {
                      return word.charAt(0).toUpperCase() + word.slice(1);
                  }).join(' ');
              }
      
              /**
               * Muestra un spinner dentro de un botón y deshabilita el botón.
               * @param {HTMLElement} buttonElement - El botón HTML.
               */
              function showButtonLoading(buttonElement) {
                  const spinner = buttonElement.querySelector('.btn-spinner');
                  if (spinner) {
                      spinner.classList.remove('hidden');
                  }
                  buttonElement.disabled = true;
                  // Opcional: guardar el texto original y reemplazarlo
                  // buttonElement.dataset.originalText = buttonElement.textContent;
                  // buttonElement.textContent = '';
              }
      
              /**
               * Oculta el spinner de un botón y lo habilita.
               * @param {HTMLElement} buttonElement - El botón HTML.
               */
              function hideButtonLoading(buttonElement) {
                  const spinner = buttonElement.querySelector('.btn-spinner');
                  if (spinner) {
                      spinner.classList.add('hidden');
                  }
                  buttonElement.disabled = false;
                  // Opcional: restaurar el texto original
                  // if (buttonElement.dataset.originalText) {
                  //     buttonElement.textContent = buttonElement.dataset.originalText;
                  // }
              }
      
              /**
               * Muestra un mensaje de error para un campo de entrada.
               * @param {HTMLElement} errorElement - El elemento span donde se muestra el error.
               * @param {string} message - El mensaje de error.
               */
              function showError(errorElement, message) {
                  if (errorElement) {
                      errorElement.textContent = message;
                      errorElement.classList.add('active');
                  }
              }
      
              /**
               * Oculta un mensaje de error para un campo de entrada.
               * @param {HTMLElement} errorElement - El elemento span del error.
               */
              function hideError(errorElement) {
                  if (errorElement) {
                      errorElement.textContent = '';
                      errorElement.classList.remove('active');
                  }
              }
      
              /**
               * Limpia todos los mensajes de error de validación en la página.
               */
              function clearValidationErrors() {
                  document.querySelectorAll('.input-error-message').forEach(el => hideError(el));
              }
      
              /**
               * Valida que un campo requerido no esté vacío.
               * @param {HTMLInputElement|HTMLSelectElement} inputElement - El elemento de entrada.
               * @param {HTMLElement} errorElement - El elemento span para el error.
               * @param {string} errorMessage - Mensaje si está vacío.
               * @returns {boolean} True si es válido, false en caso contrario.
               */
              function validateRequired(inputElement, errorElement, errorMessage) {
                  if (!inputElement.value.trim()) {
                      showError(errorElement, errorMessage);
                      return false;
                  }
                  hideError(errorElement);
                  return true;
              }
      
              /**
               * Valida que un campo numérico sea positivo.
               * @param {HTMLInputElement} inputElement - El elemento de entrada.
               * @param {HTMLElement} errorElement - El elemento span para el error.
               * @param {string} errorMessage - Mensaje si no es positivo.
               * @returns {boolean} True si es válido, false en caso contrario.
               */
              function validatePositiveNumber(inputElement, errorElement, errorMessage) {
                  const value = parseFloat(inputElement.value);
                  if (isNaN(value) || value <= 0) {
                      showError(errorElement, errorMessage);
                      return false;
                  }
                  hideError(errorElement);
                  return true;
              }
      
              /**
               * Valida un formato de correo electrónico básico.
               * @param {HTMLInputElement} inputElement - El elemento de entrada.
               * @param {HTMLElement} errorElement - El elemento span para el error.
               * @returns {boolean} True si es válido, false en caso contrario.
               */
              function validateEmail(inputElement, errorElement) {
                  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                  if (!inputElement.value.trim()) {
                      showError(errorElement, "El correo electrónico es obligatorio.");
                      return false;
                  }
                  if (!emailRegex.test(inputElement.value.trim())) {
                      showError(errorElement, "Formato de correo electrónico inválido.");
                      return false;
                  }
                  hideError(errorElement);
                  return true;
              }
      
              /**
               * Valida la longitud mínima de una contraseña.
               * @param {HTMLInputElement} inputElement - El elemento de entrada.
               * @param {HTMLElement} errorElement - El elemento span para el error.
               * @param {number} minLength - Longitud mínima requerida.
               * @returns {boolean} True si es válido, false en caso contrario.
               */
              function validatePassword(inputElement, errorElement, minLength) {
                  if (!inputElement.value.trim()) {
                      showError(errorElement, "La contraseña es obligatoria.");
                      return false;
                  }
                  if (inputElement.value.length < minLength) {
                      showError(errorElement, `La contraseña debe tener al menos ${minLength} caracteres.`);
                      return false;
                  }
                  hideError(errorElement);
                  return true;
              }
      
              /**
               * Valida que un día del mes esté entre 1 y 31.
               * @param {HTMLInputElement} inputElement - El elemento de entrada.
               * @param {HTMLElement} errorElement - El elemento span para el error.
               * @param {string} errorMessage - Mensaje si no es válido.
               * @returns {boolean} True si es válido, false en caso contrario.
               */
              function validateDayOfMonth(inputElement, errorElement, errorMessage) {
                  const value = parseInt(inputElement.value);
                  if (isNaN(value) || value < 1 || value > 31) {
                      showError(errorElement, errorMessage);
                      return false;
                  }
                  hideError(errorElement);
                  return true;
              }

          // ================== PEGA LAS NUEVAS FUNCIONES AQUÍ ==================
          function showDashboardView() {
              document.body.classList.remove('view-content');
              document.body.classList.add('view-dashboard');
          }
  
          function showContentView() {
              document.body.classList.remove('view-dashboard');
              document.body.classList.add('view-content');
          }

              // ================== Pega este bloque ==================
              // Reemplaza las 3 funciones de "populate" para categorías y bancos

              /**
              * Función genérica para poblar un elemento <select> con opciones.
              * @param {string} elementId - El ID del elemento <select>.
              * @param {Array<Object|string>} options - El array de datos (ej. appState.categories).
              * @param {string|null} valueKey - La propiedad del objeto a usar como valor (ej. 'name'). Si es null, se usa el item mismo.
              * @param {string|null} textKey - La propiedad del objeto a usar como texto (ej. 'name'). Si es null, se usa el item mismo.
              * @param {string|null} placeholder - Texto para la primera opción deshabilitada (opcional).
              */
              function populateSelectWithOptions(elementId, options, valueKey, textKey, placeholder = null) {
                  const selectElement = document.getElementById(elementId);
                  if (!selectElement) return;

                  const currentValue = selectElement.value; // Guarda la selección actual
                  selectElement.innerHTML = ''; // Limpia opciones existentes

                  if (placeholder) {
                      const placeholderOption = document.createElement('option');
                      placeholderOption.value = "";
                      placeholderOption.textContent = placeholder;
                      selectElement.appendChild(placeholderOption);
                  }

                  options.forEach(optionData => {
                      const option = document.createElement('option');
                      option.value = valueKey ? optionData[valueKey] : optionData;
                      option.textContent = textKey ? optionData[textKey] : optionData;
                      selectElement.appendChild(option);
                  });

                  selectElement.value = currentValue; // Intenta restaurar la selección
              }

              // Ahora, reemplazamos las llamadas antiguas por la nueva función
              function populateFilterDropdowns() {
                  populateSelectWithOptions('filter-category', appState.categories, 'name', 'name', 'Todas las categorías');
              }

              function populateModalDropdowns() {
                  populateSelectWithOptions('transaction-category', appState.categories, 'name', 'name');
                  populateSelectWithOptions('transaction-bank', appState.banks, null, null);
              }

              function populateRecurringModalDropdowns() {
                  populateSelectWithOptions('recurring-category', appState.categories, 'name', 'name');
                  populateSelectWithOptions('recurring-bank', appState.banks, null, null);
              }
      
              function populateDescriptionDatalist() {
                  const datalist = document.getElementById('description-list');
                  datalist.innerHTML = '';
                  appState.descriptions.forEach(desc => {
                      const option = document.createElement('option');
                      option.value = desc;
                      datalist.appendChild(option);
                  });
              }
      
              function populateTransferModalDropdowns() {
                  const fromBankSelect = document.getElementById('transfer-from-bank');
                  const toBankSelect = document.getElementById('transfer-to-bank');
                  fromBankSelect.innerHTML = '';
                  toBankSelect.innerHTML = '';
                  appState.banks.forEach(bank => {
                      const option1 = document.createElement('option');
                      option1.value = bank;
                      option1.textContent = bank;
                      fromBankSelect.appendChild(option1);
      
                      const option2 = document.createElement('option');
                      option2.value = bank;
                      option2.textContent = bank;
                      toBankSelect.appendChild(option2);
                  });
              }
      
              function setCurrentMonthFilter(month = null) {
                  if (month) {
                      filterMonth.value = month;
                  } else if (!currentMonthFilterValue) {
                      const now = new Date();
                      const year = now.getFullYear();
                      const monthValue = (now.getMonth() + 1).toString().padStart(2, '0');
                      filterMonth.value = `${year}-${monthValue}`;
                  }
                  currentMonthFilterValue = filterMonth.value;
              }

              // ================== REEMPLAZA ESTA FUNCIÓN COMPLETA =================
              // ================== REEMPLAZA ESTA FUNCIÓN COMPLETA =================
              function switchTab(tabName) {
                  // Lógica para activar la pestaña correcta
                  document.querySelectorAll('.tab-pane').forEach(pane => {
                      pane.classList.add('hidden');
                      pane.classList.remove('active');
                  });
                  document.querySelectorAll('.tab-button').forEach(button => {
                      button.classList.remove('active');
                  });
                  const activePane = document.getElementById(`${tabName}-content`);

                  // ===== LÍNEA DE CORRECCIÓN AÑADIDA AQUÍ =====
                  // Si no se encuentra un panel (como cuando se hace clic en "Salir"), la función se detiene.
                  if (!activePane) return; 
                  
                  activePane.classList.remove('hidden');
                  activePane.classList.add('active');
                  document.querySelector(`button[data-tab="${tabName}"]`).classList.add('active');

                  // Lógica para controlar Títulos y Botones
                  const mainContentTitle = document.getElementById('main-content-title');
                  const saveBudgetsBtn = document.getElementById('save-budgets-btn');
                  const migrateAllRecurringBtn = document.getElementById('migrate-all-recurring-btn');

                  // 1. Ocultar TODOS los botones de acción primero
                  mainActionBtn.classList.add('hidden');
                  saveBudgetsBtn.classList.add('hidden');
                  migrateAllRecurringBtn.classList.add('hidden');
                  // PEGA AQUÍ EL CÓDIGO (1 de 2)
                  deleteSelectedBtn.classList.add('hidden'); // Ocultar siempre al cambiar de pestaña
                  // Limpiar los checkboxes "seleccionar todo"
                  selectAllRegistrosCheckbox.checked = false;
                  selectAllProyeccionCheckbox.checked = false;
                  selectAllRecurrentesCheckbox.checked = false;

                  // 2. Mostrar el título y el BOTÓN ESPECÍFICO para la pestaña activa
                  switch (tabName) {
                      case 'registros':
                          //mainContentTitle.textContent = 'Registros de Transacciones'.remove('hidden');//
                          mainActionBtn.classList.remove('hidden');
                          mainActionBtnText.textContent = 'Registrar Transacción';
                          break;
                      case 'proyeccion':
                          //mainContentTitle.textContent = 'Proyección de Transacciones';//
                          mainActionBtn.classList.remove('hidden');
                          mainActionBtnText.textContent = 'Registrar Proyección';
                          break;
                      
                      case 'recurrentes':
                          //mainContentTitle.textContent = 'Gastos Recurrentes';//
                          migrateAllRecurringBtn.classList.remove('hidden');
                          mainActionBtn.classList.remove('hidden');
                          mainActionBtnText.textContent = 'Añadir Gasto Recurrente';
                          break;

                      case 'tarjetas':
                          //mainContentTitle.textContent = 'Tarjetas de Crédito';//
                          mainActionBtn.classList.remove('hidden');
                          mainActionBtnText.textContent = 'Añadir Tarjeta';
                          break;
                      case 'saldos':
                          //mainContentTitle.textContent = 'Saldos de Cuentas';
                          break;
                      case 'calculadora':
                          //mainContentTitle.textContent = 'Calculadora de Salario';
                          break;
                      case 'reportes':
                          //mainContentTitle.textContent = 'Reportes Financieros';
                          break;
                      case 'presupuesto':
                          //mainContentTitle.textContent = 'Gestión de Presupuesto Mensual';
                          saveBudgetsBtn.classList.remove('hidden');
                          break;
                      case 'configuración':
                          //mainContentTitle.textContent = 'Configuración General';
                          break;
                  }

                  // 3. Llamar a renderAll() para asegurar que TODAS las tablas se dibujen
                  renderAll(); 
              }
              // ================== FIN DE LA FUNCIÓN A REEMPLAZAR =================
              // ================== FIN DE LA FUNCIÓN A REEMPLAZAR =================

              // --- REEMPLAZA LA FUNCIÓN COMPLETA ---
              function handleMainActionClick() {
                  const activeTab = document.querySelector('.tab-button.active').dataset.tab;
                  
                  if (activeTab === 'registros') {
                      modalContext = 'registros'; // Establece el contexto para una transacción real
                      openTransactionModal();
                  } else if (activeTab === 'proyeccion') {
                      modalContext = 'proyeccion'; // Establece el contexto para una proyección
                      openTransactionModal();
                  } else if (activeTab === 'recurrentes') {
                      openRecurringExpenseModal();
                  } else if (activeTab === 'tarjetas') {
                      openCreditCardModal();
                  }
              }
      
              function formatCurrency(amount) {
                  return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
              }
      
              function formatDate(dateString) {
                  const date = new Date(dateString + 'T00:00:00');
                  return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
              }
      
              function formatMonthYear(dateString) {
                  if (!dateString) return "el período actual";
                  const [year, month] = dateString.split('-');
                  const date = new Date(year, month - 1);
                  return date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
              }

              // --- PEGA AQUÍ LAS NUEVAS FUNCIONES DE LÓGICA DE BORRADO ---
              /**
               * Muestra u oculta el botón "Eliminar Seleccionados" según si hay
               * casillas marcadas en la tabla de la pestaña activa.
               */
/**
               * Muestra u oculta los botones de acción según el número de casillas marcadas.
               * - Si hay 1 seleccionada: Muestra el panel de Editar/Eliminar.
               * - Si hay >1 seleccionadas: Muestra el botón "Eliminar Seleccionados".
               * - Si no hay ninguna: Oculta todo.
               */
              function updateDeleteButtonVisibility() {
                  const activeTabElement = document.querySelector('.tab-pane.active');
                  const singleActionModal = document.getElementById('single-action-modal');
                  if (!activeTabElement || !singleActionModal) return;

                  const activeTab = activeTabElement.id.replace('-content', '');
                  let selector, selectAllCheckbox;

                  // Define los selectores según la pestaña activa
                  if (activeTab === 'registros') {
                      selector = '.transaction-checkbox';
                      selectAllCheckbox = selectAllRegistrosCheckbox;
                  } else if (activeTab === 'proyeccion') {
                      selector = '.projection-checkbox';
                      selectAllCheckbox = selectAllProyeccionCheckbox;
                  } else if (activeTab === 'recurrentes') {
                      selector = '.recurring-checkbox';
                      selectAllCheckbox = selectAllRecurrentesCheckbox;
                  } else {
                      deleteSelectedBtn.classList.add('hidden');
                      singleActionModal.classList.remove('active');
                      return;
                  }

                  const allCheckboxes = document.querySelectorAll(`#${activeTab}-content ${selector}`);
                  const checkedCheckboxes = document.querySelectorAll(`#${activeTab}-content ${selector}:checked`);
                  const checkedCount = checkedCheckboxes.length;
                  
                  // ===== LÓGICA PRINCIPAL =====
                  if (checkedCount === 1) {
                      // Si hay exactamente UNA selección
                      deleteSelectedBtn.classList.add('hidden'); // Oculta el botón viejo
                      singleActionModal.classList.add('active');   // Muestra el nuevo panel
                  } else if (checkedCount > 1) {
                      // Si hay MÁS DE UNA selección
                      deleteSelectedBtn.classList.remove('hidden'); // Muestra el botón viejo
                      singleActionModal.classList.remove('active');    // Oculta el nuevo panel
                  } else {
                      // Si NO HAY NINGUNA selección
                      deleteSelectedBtn.classList.add('hidden'); // Oculta ambos
                      singleActionModal.classList.remove('active');
                  }

                  // Actualiza el estado del checkbox "seleccionar todo"
                  if (allCheckboxes.length > 0 && checkedCount === allCheckboxes.length) {
                      selectAllCheckbox.checked = true;
                      selectAllCheckbox.indeterminate = false;
                  } else if (checkedCount > 0) {
                      selectAllCheckbox.checked = false;
                      selectAllCheckbox.indeterminate = true;
                  } else {
                      selectAllCheckbox.checked = false;
                      selectAllCheckbox.indeterminate = false;
                  }
              }

              /**
               * Maneja la lógica para eliminar los elementos seleccionados de Firestore.
               */
              async function handleDeleteSelected() {
                  const activeTab = document.querySelector('.tab-pane.active').id.replace('-content', '');
                  let collectionName, checkboxSelector, itemTypeName;

                  if (activeTab === 'registros') {
                      collectionName = 'transactions';
                      checkboxSelector = '.transaction-checkbox';
                      itemTypeName = 'registros';
                  } else if (activeTab === 'proyeccion') {
                      collectionName = 'projections';
                      checkboxSelector = '.projection-checkbox';
                      itemTypeName = 'proyecciones';
                  } else if (activeTab === 'recurrentes') {
                      collectionName = 'recurringExpenses';
                      checkboxSelector = '.recurring-checkbox';
                      itemTypeName = 'gastos recurrentes';
                  } else {
                      return;
                  }

                  const checkedCheckboxes = document.querySelectorAll(`#${activeTab}-content ${checkboxSelector}:checked`);
                  const idsToDelete = Array.from(checkedCheckboxes).map(cb => cb.dataset.id);

                  if (idsToDelete.length === 0) {
                      showToast('No has seleccionado ningún elemento para eliminar.', 'info');
                      return;
                  }

                  openConfirmModal(
                      `Eliminar ${itemTypeName} seleccionados`,
                      `¿Estás seguro de que quieres eliminar permanentemente los ${idsToDelete.length} ${itemTypeName} seleccionados? Esta acción no se puede deshacer.`,
                      async () => {
                          showLoading();
                          const appId = firebaseProjectId;
                          const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                          try {
                              const batch = writeBatch(db);
                              idsToDelete.forEach(id => {
                                  const docRef = doc(collectionRef, id);
                                  batch.delete(docRef);
                              });
                              await batch.commit();
                              showToast(`${idsToDelete.length} ${itemTypeName} eliminados con éxito.`, 'success');
                              // onSnapshot actualizará la UI automáticamente
                          } catch (error) {
                              console.error(`Error al eliminar ${itemTypeName} seleccionados:`, error);
                              showMessageModal('Error al Eliminar', `No se pudieron eliminar los ${itemTypeName} seleccionados.`, 'error');
                          } finally {
                              hideLoading();
                          }
                      }
                  );
              }
              

              /**
               * Obtiene la información del único elemento seleccionado en la tabla activa.
               * @returns { {id: string, tab: string} | null }
               */
              function getSingleSelectedItem() {
                  const activeTab = document.querySelector('.tab-pane.active')?.id.replace('-content', '');
                  const checkedCheckbox = document.querySelector(`#${activeTab}-content input[type="checkbox"]:checked`);
                  
                  if (checkedCheckbox && activeTab) {
                      return {
                          id: checkedCheckbox.dataset.id,
                          tab: activeTab
                      };
                  }
                  return null;
              }

              /**
               * Maneja la acción de edición para el único elemento seleccionado.
               */
              function handleSingleEditAction() {
                  const selected = getSingleSelectedItem();
                  if (!selected) return;

                  // Llama a la función de abrir modal correspondiente según la pestaña
                  if (selected.tab === 'registros') {
                      openTransactionModal(selected.id);
                  } else if (selected.tab === 'recurrentes') {
                      openRecurringExpenseModal(selected.id);
                  } else if (selected.tab === 'proyeccion') {
                      showToast("La edición solo está disponible en la pestaña 'Registros'.", "info");
                  }
                  
                  document.getElementById('single-action-modal').classList.remove('active');
              }

              /**
               * Maneja la acción de eliminación para el único elemento seleccionado.
               */
              function handleSingleDeleteAction() {
                  const selected = getSingleSelectedItem();
                  if (!selected) return;
                  
                  // Llama a la función de eliminar correspondiente según la pestaña
                  if (selected.tab === 'registros') {
                      deleteTransaction(selected.id);
                  } else if (selected.tab === 'recurrentes') {
                      deleteRecurringExpense(selected.id);
                  } else if (selected.tab === 'proyeccion') {
                      deleteProjection(selected.id);
                  }

                  document.getElementById('single-action-modal').classList.remove('active');
              }
              
              // --- PEGA AQUÍ EL CÓDIGO NUEVO ---
              /**
               * Procesa los gastos recurrentes para registrar automáticamente los que han vencido
               * en el mes actual y que aún no han sido registrados.
               */
              async function processRecurringExpenses() {
                  // Si no hay gastos recurrentes configurados, no hace nada.
                  if (!appState.recurringExpenses || appState.recurringExpenses.length === 0) {
                      console.log("[Auto-Registro] No hay gastos recurrentes para procesar.");
                      return;
                  }

                  const today = new Date();
                  const currentYear = today.getFullYear();
                  const currentMonth = today.getMonth(); // 0 para Enero, 11 para Diciembre
                  const currentDay = today.getDate();

                  const transactionsToCreate = [];

                  // 1. Revisa cada gasto recurrente configurado.
                  for (const expense of appState.recurringExpenses) {
                      const expenseDay = parseInt(expense.day, 10);

                      // Solo considera los gastos cuya fecha de pago ya pasó en el mes actual.
                      if (expenseDay <= currentDay) {
                          // 2. Comprueba si ya existe un registro similar para este gasto en el mes actual.
                          const alreadyExists = appState.transactions.some(t => {
                              const transactionDate = new Date(t.date + 'T00:00:00');
                              // La condición de duplicado: mismo año, mes, día, descripción y categoría.
                              // El monto se ignora intencionadamente.
                              return transactionDate.getFullYear() === currentYear &&
                                     transactionDate.getMonth() === currentMonth &&
                                     transactionDate.getDate() === expenseDay &&
                                     t.description.toLowerCase() === expense.description.toLowerCase() &&
                                     t.category === expense.category;
                          });

                          // 3. Si NO existe, lo añade a una lista para crearlo.
                          if (!alreadyExists) {
                              transactionsToCreate.push(expense);
                          }
                      }
                  }

                  // 4. Si hay transacciones en la lista, las crea en la base de datos.
                  if (transactionsToCreate.length > 0) {
                      console.log(`[Auto-Registro] Se van a registrar ${transactionsToCreate.length} gastos recurrentes.`);
                      showLoading();
                      const appId = firebaseProjectId;
                      const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                      const projectionsColRef = collection(db, `artifacts/${appId}/users/${userId}/projections`);
                      
                      try {
                          const batch = writeBatch(db);
                          
                          transactionsToCreate.forEach(expense => {
                              const newTransactionDate = new Date(currentYear, currentMonth, expense.day);
                              const formattedDate = newTransactionDate.toISOString().split('T')[0];
                              
                              const newTransactionData = {
                                  date: formattedDate,
                                  description: expense.description,
                                  category: expense.category,
                                  bank: expense.bank,
                                  amount: expense.amount,
                                  type: 'expense'
                              };

                              // Crea el registro en ambas colecciones (Registros y Proyección) con el mismo ID
                              const newDocRef = doc(transactionsColRef);
                              const newId = newDocRef.id;
                              batch.set(doc(transactionsColRef, newId), { ...newTransactionData, id: newId });
                              batch.set(doc(projectionsColRef, newId), { ...newTransactionData, id: newId });
                          });

                          await batch.commit();
                          showToast(`${transactionsToCreate.length} gasto(s) recurrente(s) se registraron automáticamente.`, "success", 4000);
                          // La UI se actualizará sola gracias a los listeners onSnapshot que ya existen.

                      } catch (error) {
                          console.error("[Auto-Registro] Error al registrar gastos recurrentes:", error);
                          showMessageModal("Error de Auto-Registro", "No se pudieron registrar los gastos recurrentes vencidos.", "error");
                      } finally {
                          hideLoading();
                      }
                  } else {
                      console.log("[Auto-Registro] Todos los gastos recurrentes vencidos ya están registrados.");
                  }
              }
              
              // --- PEGA AQUÍ LA NUEVA FUNCIÓN ---
              /**
               * Intenta ejecutar el procesamiento de gastos recurrentes.
               * Solo se ejecuta UNA VEZ por sesión, cuando tanto las transacciones iniciales
               * como los gastos recurrentes iniciales se han cargado.
               */
              function tryProcessRecurringExpenses() {
                  // Si ambas cargas iniciales no han terminado, o si el proceso ya se ejecutó, no hace nada.
                  if (!initialTransactionsLoaded || !initialRecurringLoaded || recurringProcessed) {
                      return;
                  }

                  // Marca que el proceso ya se va a ejecutar para no repetirlo.
                  recurringProcessed = true;
                  
                  console.log("[Auto-Registro] Datos listos. Iniciando la verificación de gastos recurrentes.");
                  // Llama a la función principal que hace el trabajo.
                  processRecurringExpenses();
              }              
              // --- LÓGICA PARA OCULTAR ENCABEZADO AL HACER SCROLL ---
              let lastScrollTop = 0;
              const headerBar = document.getElementById('main-header-bar');

              window.addEventListener('scroll', function() {
                  // `window.scrollY` es la posición actual del scroll.
                  let scrollTop = window.scrollY || document.documentElement.scrollTop;

                  // Comparamos la posición actual con la última guardada.
                  // La condición "scrollTop > 100" evita que se oculte con el más mínimo movimiento.
                  if (scrollTop > lastScrollTop && scrollTop > 100) {
                      // Si bajamos y hemos pasado los 100px, ocultamos el encabezado.
                      headerBar.classList.add('header-hidden');
                  } else {
                      // Si subimos, lo mostramos.
                      headerBar.classList.remove('header-hidden');
                  }
                  // Actualizamos la última posición de scroll para la próxima vez.
                  lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
              }, false);
              
          });
    </script>
    <script>
              const contributionTypeSelect = document.getElementById('contribution401kType');
              const contributionValueInput = document.getElementById('contribution401kValue');
              const contributionLabel = document.getElementById('contribution401kLabel');
      
              contributionTypeSelect.addEventListener('change', () => {
                  if (contributionTypeSelect.value === 'percent') {
                      contributionLabel.textContent = 'Valor 401(k) (%)';
                      contributionValueInput.value = "5";
                  } else {
                      contributionLabel.textContent = 'Valor 401(k) ($)';
                      contributionValueInput.value = "100";
                  }
              });     
      
              document.getElementById('calculateBtn').addEventListener('click', () => {
                  // --- 1. OBTENER DATOS DEL USUARIO ---
                  const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
                  const totalHours = parseFloat(document.getElementById('hoursWorked').value) || 0;
                  const filingStatus = document.getElementById('filingStatus').value;
                  const contribution401kType = document.getElementById('contribution401kType').value;
                  const contribution401kValue = parseFloat(document.getElementById('contribution401kValue').value) || 0;
                  const medicalDeduction = parseFloat(document.getElementById('medicalDeduction').value) || 0;
                  const dentalDeduction = parseFloat(document.getElementById('dentalDeduction').value) || 0;
                  const visionDeduction = parseFloat(document.getElementById('visionDeduction').value) || 0;
                  const loan401k = parseFloat(document.getElementById('loan401k').value) || 0;
      
                  const payPeriods = 26; // Quincenal
                  const regularHoursThreshold = 80;
      
                  // --- 2. CONSTANTES FISCALES 2025 ---
                  const FICA_RATES = {
                      SOCIAL_SECURITY: 0.062,
                      MEDICARE: 0.0145,
                  };
                  const FEDERAL_TAX = {
                      DEDUCTION: { single: 15000, married: 30000 },
                      BRACKETS: {
                          single: [
                              { rate: 0.10, upto: 11925 }, { rate: 0.12, upto: 48475 },
                              { rate: 0.22, upto: 103350 }, { rate: 0.24, upto: 197300 },
                              { rate: 0.32, upto: 250525 }, { rate: 0.35, upto: 626350 },
                              { rate: 0.37, upto: Infinity }
                          ],
                          married: [
                              { rate: 0.10, upto: 23850 }, { rate: 0.12, upto: 96950 },
                              { rate: 0.22, upto: 206700 }, { rate: 0.24, upto: 394600 },
                              { rate: 0.32, upto: 501050 }, { rate: 0.35, upto: 751600 },
                              { rate: 0.37, upto: Infinity }
                          ]
                      }
                  };
      
                  // --- 3. CÁLCULOS PRINCIPALES ---
      
                  // Salario Bruto con Overtime
                  let regularHours = Math.min(totalHours, regularHoursThreshold);
                  let overtimeHours = Math.max(0, totalHours - regularHoursThreshold);
                  let overtimeRate = hourlyRate * 1.5;
                  let grossPay = (regularHours * hourlyRate) + (overtimeHours * overtimeRate);
      
                  // Deducciones Pre-Impuestos (401k Contribution)
                  let contribution401kAmount = 0;
                  if (contribution401kType === 'percent') {
                      contribution401kAmount = grossPay * (contribution401kValue / 100);
                  } else {
                      contribution401kAmount = contribution401kValue;
                  }
                  const preTaxDeductions = contribution401kAmount + medicalDeduction + dentalDeduction + visionDeduction;
      
                  // Ingreso Imponible para Impuesto Federal
                  const annualTaxableIncome = (grossPay - preTaxDeductions) * payPeriods;
      
                  // Calcular Impuesto Federal Anual
                  const standardDeduction = FEDERAL_TAX.DEDUCTION[filingStatus];
                  const finalTaxableIncome = Math.max(0, annualTaxableIncome - standardDeduction);
                  const brackets = FEDERAL_TAX.BRACKETS[filingStatus];
      
                  let federalTaxAnnual = 0;
                  let incomeLeft = finalTaxableIncome;
                  let previousLimit = 0;
      
                  for (const bracket of brackets) {
                      if (incomeLeft > 0) {
                          const taxableInBracket = Math.min(incomeLeft, bracket.upto - previousLimit);
                          federalTaxAnnual += taxableInBracket * bracket.rate;
                          incomeLeft -= taxableInBracket;
                          previousLimit = bracket.upto;
                      }
                  }
                  const federalTaxPerPeriod = federalTaxAnnual / payPeriods;
      
                  // Calcular Impuestos FICA (Social Security & Medicare)
                  // Se basa en el Salario Bruto total
                  const socialSecurityTax = grossPay * FICA_RATES.SOCIAL_SECURITY;
                  const medicareTax = grossPay * FICA_RATES.MEDICARE;
                  const ficaTaxes = socialSecurityTax + medicareTax;
      
                  // Deducciones Post-Impuestos
                  const postTaxDeductions = loan401k;
      
                  // Calcular Salario Neto
                  const totalDeductions = preTaxDeductions + federalTaxPerPeriod + ficaTaxes + postTaxDeductions;
                  const netPay = grossPay - totalDeductions;
      
                  // --- 4. MOSTRAR RESULTADOS ---
                  document.getElementById('results').classList.remove('hidden');
      
                  const formatCurrency = (value) => `$${Math.max(0, value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
      
                  document.getElementById('grossPayResult').textContent = formatCurrency(grossPay);
                  document.getElementById('preTaxDeductionsResult').textContent = formatCurrency(preTaxDeductions);
                  document.getElementById('federalTaxResult').textContent = formatCurrency(federalTaxPerPeriod);
                  document.getElementById('ficaTaxResult').textContent = formatCurrency(ficaTaxes);
                  document.getElementById('postTaxDeductionsResult').textContent = formatCurrency(postTaxDeductions);
                  document.getElementById('netPayResult').textContent = formatCurrency(netPay);
              });
              




              
    </script>

    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <script>
  // --- REEMPLAZA el script del tour existente con este bloque ---    
    function initializeTour() {
        const tourToast = document.getElementById('tour-toast');
        const startTourBtn = document.getElementById('start-tour-btn-toast');
        const closeTourBtn = document.getElementById('close-tour-toast-btn');

        // Si el usuario ya vio el tour en esta sesión, no mostramos el aviso
        if (sessionStorage.getItem('tourViewed')) {
            tourToast.style.display = 'none';
            return;
        }

        if (!tourToast || !startTourBtn || !closeTourBtn) {
            console.error("Los elementos del toast para el tour no se encontraron.");
            return;
        }

        const tour = new Shepherd.Tour({
            useModalOverlay: true,
            defaultStepOptions: {
                cancelIcon: { enabled: true },
                classes: 'shepherd-tour-witfinances',
                scrollTo: { behavior: 'smooth', block: 'center' }
            }
        });

        // --- INICIO DEL TUTORIAL ---

// --- INICIO DEL TUTORIAL ---

        tour.addStep({
            id: 'step-0-welcome',
            title: '¡Bienvenido a tu Panel de Control!',
            text: `Aquí tienes una vista rápida y poderosa de tu situación actual. Es el punto de partida para tomar decisiones inteligentes cada día.`,
            attachTo: { element: '#dashboard', on: 'bottom' },
            // ----- LÍNEA MODIFICADA -----
            // ANTES: buttons: [{ action() { return this.next(); }, text: 'Empezar el Tour &rarr;' }]
            // AHORA: Simula un clic en la primera pestaña del tour para sincronizar la UI
            buttons: [{ 
                action() { 
                    document.querySelector('[data-tab="configuración"]').click(); // <-- ESTO SINCRONIZA LA VISTA
                    return this.next(); 
                }, 
                text: 'Empezar el Tour &rarr;' 
            }]
        });
        
        tour.addStep({
            id: 'step-1-configuracion',
            title: 'Paso 1: Los Cimientos',
            text: `<p>Todo gran plan comienza con una buena base. Aquí personalizarás la aplicación para que hable tu mismo idioma financiero.</p>
                   <p><strong>Crea tus Categorías</strong> (Vivienda, Comida) y tus <strong>Cuentas</strong> (Efectivo, Cuenta Principal) para tener un sistema a tu medida.</p>`,
            attachTo: { element: '[data-tab="configuración"]', on: 'bottom' },
            buttons: [
                { action() { return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="configuración"]').click(); return this.next(); }, text: '¡Entendido!' }
            ]
        });

        tour.addStep({
            id: 'step-2-recurrentes',
            title: 'Paso 2: Dibuja tu Mapa Financiero',
            text: `<p>Ahora, vamos a registrar esos gastos que llegan todos los meses sin falta: alquiler, internet, suscripciones...</p>
                   <p>Al hacerlo una vez, la app los registrará por ti cada nuevo mes. ¡Ahorrarás tiempo y nunca olvidarás un pago!</p>`,
            attachTo: { element: '[data-tab="recurrentes"]', on: 'bottom' },
            buttons: [
                { action() { document.querySelector('[data-tab="configuración"]').click(); return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="recurrentes"]').click(); return this.next(); }, text: 'Siguiente &rarr;' }
            ]
        });

        tour.addStep({
            id: 'step-3-tarjetas',
            title: 'Paso 3: Conquista tus Tarjetas',
            text: `<p>Esta sección es tu centro de comando para la libertad. Añade tus tarjetas, tu deuda actual y, lo más importante, <strong>en cuántos meses quieres saldarla.</strong></p>
                   <p>La app calculará el <strong>pago mensual sugerido</strong> para que cumplas tu meta y te alertará de las fechas de pago.</p>
                   <p><strong>Consejo de Finanzas:</strong> Una vez que las tengas todas aquí, puedes usar el <strong>Método Avalancha</strong> (pagar primero la de mayor interés) o <strong>Bola de Nieve</strong> (pagar primero la de menor deuda). ¡Tú decides la estrategia!</p>`,
            attachTo: { element: '[data-tab="tarjetas"]', on: 'bottom' },
            buttons: [
                { action() { document.querySelector('[data-tab="recurrentes"]').click(); return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="tarjetas"]').click(); return this.next(); }, text: '¡Qué Potente! &rarr;' }
            ]
        });

        tour.addStep({
            id: 'step-4-presupuesto',
            title: 'Paso 4: Crea tu Plan de Gastos',
            text: `<p>Ahora que sabes cuánto se va en gastos fijos, vamos a planificar el resto.</p>
                   <p>Asigna un límite de gasto a cada categoría (Ej: $400 en Alimentación). A medida que registres tus movimientos, verás en tiempo real <strong>cuánto te queda disponible.</strong> ¡Es el fin de las fugas de dinero!</p>`,
            attachTo: { element: '[data-tab="presupuesto"]', on: 'bottom' },
            buttons: [
                { action() { document.querySelector('[data-tab="tarjetas"]').click(); return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="presupuesto"]').click(); return this.next(); }, text: '¡Excelente! &rarr;' }
            ]
        });

        tour.addStep({
            id: 'step-5-registros',
            title: 'Paso 5: El Hábito Diario',
            text: `<p>Esta es la acción principal que mantendrá todo al día. Cada vez que recibas un ingreso o hagas un gasto, anótalo aquí.</p>
                   <p>Este botón cambiará según la pestaña en la que estés. En 'Registros', te permitirá añadir una nueva transacción rápidamente.</p>`,
            attachTo: { element: '[data-tab="registros"]', on: 'bottom' },
            buttons: [
                { action() { document.querySelector('[data-tab="presupuesto"]').click(); return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="registros"]').click(); return this.next(); }, text: 'Entendido, ¡a registrar!' }
            ]
        });

        tour.addStep({
            id: 'step-6-reportes',
            title: 'Paso 6: Analiza y Aprende',
            text: `<p>Después de unos días, la magia sucede aquí. En <strong>Reportes</strong>, verás gráficos claros que te dirán exactamente a dónde se va tu dinero.</p>
                   <p>En <strong>Saldos de Cuentas</strong>, tendrás un resumen de cuánto dinero tienes en cada una de tus cuentas. ¡Información es poder!</p>`,
            attachTo: { element: '[data-tab="reportes"]', on: 'bottom' },
            buttons: [
                { action() { document.querySelector('[data-tab="registros"]').click(); return this.back(); }, text: '&larr; Atrás', classes: 'shepherd-button-secondary' },
                { action() { document.querySelector('[data-tab="reportes"]').click(); return this.next(); }, text: 'Ver mis Gráficos &rarr;' }
            ]
        });

        tour.addStep({
            id: 'step-7-final',
            title: '¡Estás Listo para Tomar el Control!',
            text: `<p>¡Felicidades! Has completado el recorrido. Recuerda, la clave del éxito financiero es la <strong>constancia.</strong></p>
                   <p>Usa la app a diario y transforma tu relación con el dinero. ¡Ahora es tu turno de empezar a construir el futuro que deseas!</p>`,
            buttons: [{ action() { return this.complete(); }, text: 'Finalizar y Empezar' }]
        });

        // --- FIN DEL TUTORIAL ---

        const restoreView = () => {
            const mostrarBtn = document.getElementById('mostrar');
            if (mostrarBtn && !mostrarBtn.classList.contains('hidden')) {
                mostrarBtn.click();
            }
        };

        tour.on('complete', () => { 
            sessionStorage.setItem('tourViewed', 'true');
            restoreView();
        });
        tour.on('cancel', () => { 
            sessionStorage.setItem('tourViewed', 'true');
            restoreView();
        });

        startTourBtn.addEventListener('click', () => {
            tourToast.style.display = 'none';
            tour.start();
        });

        closeTourBtn.addEventListener('click', () => {
            tourToast.style.display = 'none';
            sessionStorage.setItem('tourViewed', 'true');
        });
    }
    </script>    

  </body>
</html>