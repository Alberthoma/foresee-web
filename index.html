<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
      name="viewport"
    />
    <title>Gestor de Presupuesto Web</title>

    <link
      rel="icon"
      type="image/png"
      href="https://res.cloudinary.com/datwdagbf/image/upload/v1756514685/proyeccion_hh3xyt.png"
    />

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Foresee" />
    <link
      rel="apple-touch-icon"
      href="https://res.cloudinary.com/datwdagbf/image/upload/v1756514685/proyeccion_hh3xyt.png"
    />

    <link rel="manifest" href="manifest.json" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        EmailAuthProvider,
        reauthenticateWithCredential,
        updatePassword,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        getDocs,
        writeBatch,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

      // Variables globales para Firebase (serán accesibles en el script principal)
      window.firebaseApp = null;
      window.db = null;
      window.auth = null;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signInAnonymously = signInAnonymously;
      window.signInWithCustomToken = signInWithCustomToken;
      // Se asignan directamente las funciones importadas a window
      window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.EmailAuthProvider = EmailAuthProvider;
      window.reauthenticateWithCredential = reauthenticateWithCredential;
      window.updatePassword = updatePassword;
      window.getFirestore = getFirestore;
      window.doc = doc;
      window.getDoc = getDoc;
      window.setDoc = setDoc;
      window.updateDoc = updateDoc;
      window.deleteDoc = deleteDoc;
      window.onSnapshot = onSnapshot;
      window.collection = collection;
      window.query = query;
      window.getDocs = getDocs;
      window.writeBatch = writeBatch;

      // Inicializar Firebase
      const firebaseConfig = {
        apiKey: 'AIzaSyCTicX5tqqVr3pK_RFqgvqpRavsUuTvS2g',
        authDomain: 'wittfinances-282f1.firebaseapp.com',
        projectId: 'wittfinances-282f1',
        storageBucket: 'wittfinances-282f1.firebasestorage.app',
        messagingSenderId: '998192322959',
        appId: '1:998192322959:web:e2afcdd7f47da3767853fa',
      };

      console.log('[Firebase Init] Configuración de Firebase recibida:', firebaseConfig); // Debugging

      if (firebaseConfig && firebaseConfig.projectId) {
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        // Hacemos el projectId accesible globalmente para construir las rutas de Firestore
        window.firebaseProjectId = firebaseConfig.projectId;
        console.log('[Firebase Init] Firebase inicializado con éxito.'); // Debugging
      } else {
        console.error(
          "[Firebase Init] ERROR: 'projectId' no proporcionado en la configuración de Firebase.",
        );
        console.error(
          'Asegúrate de que estás ejecutando la aplicación en un entorno que inyecta __firebase_config (como Canvas o Firebase Hosting).',
        );
        // Mostrar un mensaje de error al usuario si la inicialización falla
        document.addEventListener('DOMContentLoaded', () => {
          const loadingOverlay = document.getElementById('loading-overlay');
          const messageModal = document.getElementById('message-modal');
          const messageModalTitle = document.getElementById('message-modal-title');
          const messageModalContent = document.getElementById('message-modal-content');
          const messageModalCloseBtn = document.getElementById('message-modal-close-btn');

          loadingOverlay.classList.remove('active'); // Ocultar spinner
          messageModalTitle.textContent = 'Error de Configuración de Firebase';
          messageModalContent.textContent =
            "La aplicación no pudo conectarse a Firebase. Asegúrate de que el proyecto esté configurado correctamente y que la aplicación se ejecute en un servidor (Firebase Hosting o localmente con 'firebase serve').";
          messageModal.classList.add('active');
          messageModalCloseBtn.addEventListener('click', () =>
            messageModal.classList.remove('active'),
          );
        });
      }
    </script>
    <style>
      /* ====================================================================== */
      /* 1. CONFIGURACIÓN GLOBAL Y VARIABLES DE TEMA
              /* ====================================================================== */
      :root {
        --bg-dark-primary: #111827;
        --bg-dark-secondary: #1f2937;
        --bg-dark-tertiary: #374151;
        --border-dark: #4b5563;
        --text-light-primary: #f3f4f6;
        --text-light-secondary: #9ca3af;
        --electric-blue: #0ea5e9;
        --electric-green: #22c55e;
        --electric-red: #ef4444;
        --electric-orange: #f97316;
        --electric-purple: #8b5cf6;
        --electric-yellow: #facc15;
        --income-color: var(--electric-green);
        --expense-color: var(--electric-red);
        --balance-color: var(--electric-blue);
        --transfer-bg: rgba(14, 165, 233, 0.1);
      }

      html {
        height: 100%;
      }

      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-dark-primary);
        color: var(--text-light-primary);
        transition: margin-top 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        min-height: 100%;
      }

      /* --- Estilos para la funcionalidad Pull-to-Refresh --- */
      #ptr-container {
        position: fixed; /* Se queda fijo en la parte superior de la pantalla */
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(-100%); /* Inicialmente oculto por encima de la pantalla */
        transition: transform 0.3s ease; /* Animación suave para aparecer y desaparecer */
        z-index: 998; /* Se asegura de que esté por encima del contenido pero debajo de los modales */
      }

      .ptr-arrow,
      .ptr-spinner {
        width: 28px;
        height: 28px;
        transition: transform 0.3s ease;
      }

      /* Estilo de la flecha que indica "deslizar" */
      .ptr-arrow {
        border: solid var(--text-light-secondary);
        border-width: 0 3px 3px 0;
        display: inline-block;
        padding: 4px;
        transform: rotate(45deg); /* Apunta hacia abajo */
      }

      /* Cuando el usuario desliza lo suficiente, la flecha gira para indicar "soltar" */
      .ptr-arrow.release {
        transform: rotate(-135deg);
      }

      /* Estilo del spinner (círculo giratorio) */
      .ptr-spinner {
        display: none; /* Oculto por defecto */
        border: 4px solid rgba(243, 244, 246, 0.2);
        border-left-color: var(--electric-blue); /* Usa el color azul de tu tema */
        border-radius: 50%;
        animation: spin 1s linear infinite; /* Usa la misma animación de giro que tus otros spinners */
      }

      /* Cuando está refrescando, se oculta la flecha y se muestra el spinner */
      #ptr-container.refreshing .ptr-arrow {
        display: none;
      }
      #ptr-container.refreshing .ptr-spinner {
        display: block;
      }

      .container {
        padding: 1px 1rem;
      }

      /* ====================================================================== */
      /* 2. ESTRUCTURA Y LAYOUT PRINCIPAL
      /* ====================================================================== */
      #main-content-wrapper {
        flex-grow: 1;
      }

      footer {
        flex-shrink: 0;
        background-color: var(--bg-dark-secondary);
        border-top: 1px solid var(--border-dark);
      }

      /* --- Encabezado --- */
      #main-header-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 8rem; /* h-32 */
        margin-top: 0;
        transition: height 0.3s ease-in-out;
        background-color: var(--bg-dark-secondary);
        border-bottom: 1px solid var(--border-dark);
      }

      #barr {
        width: 100%;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        padding-right: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: var(--bg-dark-tertiary);
        transition: all 0.3s ease-in-out;
      }

      #barr h1 {
        font-size: 1.5rem; /* text-3xl */
        font-weight: 700; /* font-bold */
        color: var(--text-light-primary);
      }

      #barr #ptitul {
        font-size: 0.8rem;
        color: var(--text-light-secondary);
      }

      .logotipo {
        width: 180px;
        height: 100px;
        padding-left: 1rem;
      }

      /* Contenido central del header (título y bienvenida) */
      .header-center-content {
        flex: 1 1 0%; /* flex-1 */
        text-align: center;
      }

      .header-center-content #user-alias-display {
        font-weight: 600; /* font-semibold */
      }

      /* Contenedor de botones a la derecha del header */
      .header-right-buttons {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      /* Márgenes para los botones del header */
      #IdbtOpenScreen {
        margin-bottom: 0.25rem;
        margin-right: 0.25rem;
      }
      #IdbtCloseScreen {
        margin-bottom: 0.25rem;
      }
      /* Modificamos tu #logout-btn existente para añadir el margen */
      #logout-btn {
        margin-right: 1.5rem;
      }

      /* Contenedor principal de los botones de pestañas */
      .contenedor-botones {
        display: flex;
        flex-direction: column;
      }

      /* --- Pestañas de Navegación --- */
      .btn {
        display: flex;
        overflow-x: auto;
      }

      .tab-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-left: 1px;
        padding-right: 1px;
        margin-left: 2px;
        padding-top: 4px;
        border-radius: 10px;
        margin-bottom: 2px;
      }

      .tab-button img {
        height: 56px;
        width: auto;
      }

      .tab-button span {
        font-size: 0.75rem;
        margin-top: 4px;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
        text-align: center;
        white-space: nowrap;
      }

      .tab-button:hover {
        color: var(--electric-blue);
        background-color: transparent;
        border-bottom-color: var(--electric-blue);
        box-shadow: 0 0 8px var(--electric-blue), 0 0 15px var(--electric-blue),
          0 0 25px var(--electric-blue);
        inset: 0 0 10px rgba(14, 165, 233, 0.6);
      }

      .tab-button.active {
        box-shadow: 0 0 8px var(--bg-dark-tertiary), 0 0 15px var(--bg-dark-tertiary),
          0 0 25px var(--bg-dark-tertiary);
        inset: 0 0 5px rgba(112, 114, 115, 0.6);
      }

      #main-container {
        margin-top: 7rem;
      }

      /* Tamaño base para los íconos de las pestañas */
      .tab-button img {
        width: 3.5rem; /* w-14 */
        margin-bottom: 0.25rem; /* mb-1 */
        height: auto; /* Permitir que la altura se ajuste */
      }

      /* Tamaños específicos para cada ícono (sobrescribe la regla anterior) */
      button[data-tab='proyeccion'] img {
        height: 3rem; /* h-12 */
        width: 3.5rem; /* w-14 */
      }
      button[data-tab='recurrentes'] img,
      button[data-tab='gastos-comunes'] img,
      button[data-tab='configuración'] img {
        height: 2.75rem; /* h-11 */
        width: 2.75rem; /* w-11 */
      }
      button[data-tab='tarjetas'] img {
        height: 3rem; /* h-12 */
        width: 3rem; /* w-12 */
      }
      button[data-tab='saldos'] img {
        height: 2.25rem; /* h-9 */
        width: 3rem; /* w-12 */
      }
      button[data-tab='calculadora'] img {
        height: 2.25rem; /* h-9 */
        width: 2.5rem; /* w-10 */
      }
      button[data-tab='reportes'] img {
        height: 2.25rem; /* h-9 */
        width: 2.75rem; /* w-11 */
      }
      button[data-tab='presupuesto'] img {
        height: 2.5rem; /* h-10 */
        width: 2.75rem; /* w-11 */
      }

      /* ====================================================================== */
      /* 3. LÓGICA DE CONTROL DE VISTAS (Dashboard vs Contenido)
      /* ====================================================================== */
      body.view-dashboard #main-container,
      body.view-dashboard #mostrar {
        display: none;
      }

      body.view-content #dashboard,
      body.view-content #credit-card-alerts,
      body.view-content #recurring-alerts,
      body.view-content #ptitul,
      body.view-content #barr {
        display: none;
      }

      body.view-content #main-container,
      body.view-content #mostrar {
        display: block;
      }

      body.view-content #main-header-bar {
        height: 5rem;
      }

      body.view-content {
        margin-top: 1rem;
      }

      /* --- Estilos del Pie de Página (Footer) --- */
      footer {
        background-color: var(--bg-dark-primary); /* bg-gray-800 */
        color: var(--text-light-primary); /* text-white */
        padding-top: 1rem; /* py-4 */
        padding-bottom: 1rem; /* py-4 */
        flex-shrink: 0; /* Evita que el footer se encoja */
        border-top: 1px solid var(--border-dark);
      }

      .footer-container {
        max-width: 1280px; /* Ancho estándar de un contenedor */
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
        text-align: center;
      }

      .footer-container p {
        font-size: 0.875rem; /* text-sm */
        margin: 0;
      }

      #app-version {
        font-size: 0.75rem; /* text-xs */
        color: var(--text-light-secondary); /* text-gray-400 */
        margin-top: 0.25rem; /* mt-1 */
      }

      .footer-links {
        font-size: 0.75rem; /* text-xs */
        margin-top: 0.5rem; /* mt-2 */
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem; /* Reemplaza space-x-4 */
      }

      .footer-links a {
        color: var(--electric-blue); /* text-blue-400 adaptado */
        text-decoration: none; /* Quitamos el subrayado por defecto */
        transition: text-decoration 0.2s ease;
      }

      .footer-links a:hover {
        text-decoration: underline; /* hover:underline */
      }

      .footer-links span {
        color: var(--border-dark); /* Color más sutil para el separador */
      }

      /* --- Prompt de Pantalla Completa para Móviles --- */
      #mobile-fullscreen-prompt {
        display: none; /* Inicia oculto, controlado por JS con la clase .active */
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(17, 24, 39, 0.95); /* bg-gray-900 bg-opacity-95 */
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem; /* p-8 */
      }

      /* El JS añade esta clase para mostrar el prompt */
      #mobile-fullscreen-prompt.active {
        display: flex;
      }

      #mobile-fullscreen-prompt img {
        width: 6rem; /* w-24 */
        height: auto;
        margin-bottom: 1.5rem; /* mb-6 */
      }

      #mobile-fullscreen-prompt h2 {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 700; /* font-bold */
        color: var(--text-light-primary); /* text-white */
        margin-bottom: 1rem; /* mb-4 */
      }

      #mobile-fullscreen-prompt p {
        color: #d1d5db; /* text-gray-300 */
        margin-bottom: 2rem; /* mb-8 */
      }

      #enter-fullscreen-btn {
        background-color: var(--electric-blue);
        color: white;
        font-weight: 700;
        padding: 1rem 2rem; /* py-4 px-8 */
        border-radius: 9999px; /* rounded-full */
        font-size: 1.125rem; /* text-lg */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        border: none;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s ease;
      }

      #enter-fullscreen-btn:hover {
        background-color: #0c87bf; /* hover:bg-blue-700 */
        transform: scale(1.05); /* hover:scale-105 */
      }

      /* ====================================================================== */
      /* 4. COMPONENTES REUTILIZABLES
      /* ====================================================================== */

      /* --- Botones --- */
      .hidden {
        display: none !important;
      }
      #logout-btn {
        background: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        padding: 4px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid var(--border-dark);
        transition: all 0.2s ease;
      }

      #logout-btn:hover {
        background-color: var(--electric-red);
        border-color: var(--electric-red);
        color: white;
      }

      .btn-philosophy,
      .btcloseScreen,
      .btOpenScreen {
        background-color: transparent;
        border: 1px solid var(--border-dark);
        padding: 4px 12px;
        border-radius: 9999px;
        color: var(--text-light-secondary);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }

      .btn-philosophy {
        margin-top: 8px;
      }

      .btcloseScreen {
        margin-top: 1px;
      }

      .btOpenScreen {
        margin-top: 4px;
      }

      .btn-philosophy:hover,
      .btcloseScreen:hover,
      .btOpenScreen:hover {
        background-color: var(--electric-blue);
        color: white;
        border-color: var(--electric-blue);
        transform: scale(1.05);
      }

      .button-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 0.5rem;
      }

      main.container {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        padding: 1rem;
      }

      #main-action-btn {
        background-color: var(--electric-blue);
        color: white;
        font-weight: 500;
        font-size: large;
      }

      #main-action-btn:hover {
        background-color: #0ea4e9c8;
        transform: scale(1.05);
        width: auto;
        height: 40px;
      }

      .aparecer {
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-dark);
        transition: all 0.2s ease-in-out;
        background-color: grey;
      }

      .aparecer:hover {
        background-color: var(--electric-red);
        color: white;
        border-color: var(--electric-red);
        transform: scale(1.05);
      }

      #open-tutorials-btn {
        position: fixed;
        bottom: 1.25rem;
        left: 1.25rem;
        z-index: 999;
        width: 60px;
        height: 60px;
        background-color: var(--electric-blue);
        color: white;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease-in-out, background-color 0.2s ease;
      }

      #open-tutorials-btn:hover {
        transform: scale(1.1);
        background-color: #0ea4e9d5;
      }

      /* --- Estilos para Botones de Acción y Filtros --- */
      .action-buttons-left {
        display: flex;
        align-items: center;
      }

      /* Espaciado entre botones de acción */
      .action-buttons-left > * + * {
        margin-left: 0.5rem; /* space-x-2 */
      }

      /* Estilo base para todos los botones de acción */
      #migrate-all-recurring-btn,
      #save-budgets-btn,
      #delete-selected-btn,
      #main-action-btn,
      #add-income-btn,
      #add-expense-btn,
      #toggle-filters-btn {
        color: #ffffff;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.15s ease-in-out;
        display: flex; /* Mantiene el comportamiento flex por defecto */
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
      }

      /* Espaciado interno de los botones con íconos */
      #migrate-all-recurring-btn > * + *,
      #save-budgets-btn > * + *,
      #delete-selected-btn > * + * {
        margin-left: 0.5rem; /* space-x-2 */
      }

      /* Padding específico para botones sin íconos */
      #add-income-btn,
      #add-expense-btn,
      #toggle-filters-btn {
        padding-left: 0.75rem; /* px-3 */
        padding-right: 0.75rem;
      }

      /* Colores de fondo */
      #migrate-all-recurring-btn,
      #save-budgets-btn,
      #add-income-btn {
        background-color: var(--electric-green);
      }

      #delete-selected-btn,
      #add-expense-btn {
        background-color: var(--electric-red);
      }

      #main-action-btn {
        background-color: var(--electric-blue);
      }

      #toggle-filters-btn {
        background-color: var(--bg-dark-tertiary);
        font-size: 0.75rem; /* text-xs */
      }

      /* Efectos Hover */
      #migrate-all-recurring-btn:hover,
      #save-budgets-btn:hover,
      #add-income-btn:hover {
        background-color: #15803d; /* hover:bg-green-700 */
      }

      #delete-selected-btn:hover,
      #add-expense-btn:hover {
        background-color: #b91c1c; /* hover:bg-red-700 */
      }

      #main-action-btn:hover {
        background-color: #0c87bf; /* hover:bg-blue-700 */
      }

      #toggle-filters-btn:hover {
        background-color: var(--bg-dark-primary); /* hover:bg-gray-800 */
      }

      /* Tamaño de los íconos SVG */
      #migrate-all-recurring-btn svg,
      #save-budgets-btn svg,
      #delete-selected-btn svg {
        height: 1.25rem; /* h-5 */
        width: 1.25rem; /* w-5 */
      }

      /* Contenedor de filtros y botones derechos */
      #filters-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 1rem; /* gap-4 */
        flex-grow: 1;
      }

      .action-buttons-right {
        display: flex;
        align-items: center;
      }

      #mostrar {
        margin-left: 0.5rem; /* ml-2 */
      }

      /* --- Modales (Estilos Generales) --- */
      .modal {
        display: none;
        position: fixed; /* <-- AÑADIDO: Despega el modal del flujo de la página */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(17, 24, 39, 0.8); /* Fondo oscuro semitransparente */
        padding: 1rem; /* Espaciado interno para que el contenido no pegue a los bordes */
        z-index: 100;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal > div {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
      }

      .modal h2 {
        color: var(--text-light-primary);
      }

      .modal .p-6.border-b,
      .modal .p-5.border-b {
        border-bottom: 1px solid var(--border-dark);
        background-color: var(--bg-dark-primary);
      }

      /* --- Formularios y Entradas (Inputs) --- */
      .modal input,
      .modal select {
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
        border-radius: 0.5rem;
        transition: all 0.2s ease;
      }

      .modal input:focus,
      .modal select:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
      }

      .modal label {
        color: var(--text-light-secondary);
        font-weight: 500;
      }

      .radio-type-label {
        border: 2px solid var(--border-dark);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        text-align: center;
        width: 100%;
        color: var(--text-light-secondary);
      }

      .radio-type-input:checked + .radio-type-label {
        border-color: var(--electric-blue);
        background-color: rgba(14, 165, 233, 0.1);
        color: var(--electric-blue);
        font-weight: 600;
      }

      .radio-type-input {
        display: none;
      }

      #distribution-input-modal .bg-white {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
      }
      #distribution-input-modal h2,
      #distribution-input-modal label {
        color: var(--text-light-primary);
      }
      #distribution-input-modal input {
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
      }
      #distribution-input-modal input:focus {
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
      }
      #distribution-input-modal .border-b,
      #distribution-input-modal .border-t {
        border-color: var(--border-dark);
      }
      #distribution-input-modal #cancel-distribution-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
      }
      #distribution-input-modal #cancel-distribution-btn:hover {
        background-color: var(--border-dark);
      }
      #distribution-input-modal #save-distribution-btn {
        background-color: var(--electric-blue);
      }
      #distribution-input-modal #save-distribution-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Tablas (Estilos Generales) --- */
      /* --- Contenedor de Tabla --- */
      .table-container {
        overflow-x: auto;
      }
      table {
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        overflow: hidden;
        width: 80%;
        margin: 20px auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-dark);
        margin-top: 1px;
      }

      #registros-content table,
      #proyeccion-content table,
      #recurrentes-content table,
      #tarjetas-content table,
      #presupuesto-content table {
        width: 100%;
        margin: 1px auto 0;
      }

      /*th,
      td {
        border: 1px solid #ddd;
        padding: 2px;
        text-align: left;
      }*/

      table tr:first-child th:first-child {
        border-top-left-radius: 10px;
      }

      table tr:first-child th:last-child {
        border-top-right-radius: 10px;
      }

      table tr:last-child td:first-child {
        border-bottom-left-radius: 10px;
      }

      table tr:last-child td:last-child {
        border-bottom-right-radius: 10px;
      }

      thead,
      #registros-content thead,
      #recurrentes-content thead,
      #tarjetas-content thead,
      #presupuesto-content thead,
      #proyeccion-content thead {
        background-color: #000000;
      }

      th {
        color: var(--text-light-primary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
      }

      tbody {
        background-color: var(--bg-dark-secondary);
        border-color: var(--border-dark);
      }

      td {
        color: var(--text-light-primary);
      }

      tbody tr {
        background-color: var(--bg-dark-tertiary);
        border-bottom: 1px solid var(--border-dark);
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      tbody tr:last-child {
        border-bottom: none;
      }

      tbody tr:hover {
        background-color: var(--border-dark);
      }

      tfoot {
        background-color: var(--bg-dark-primary);
        border-top: 2px solid var(--border-dark);
      }

      /* Clases de color para filas de tablas */
      .income-text-row td {
        color: var(--income-color);
      }

      .expense-text-row td {
        color: var(--expense-color);
      }

      .transfer-text-row td {
        color: var(--balance-color);
      }

      /* Reducir altura de filas en tablas */
      #registros-content table td,
      #proyeccion-content table td,
      #recurrentes-content table td,
      #tarjetas-content table td,
      #presupuesto-content table td {
        padding-top: 6px;
        padding-bottom: 6px;
        line-height: 1.2;
        padding-right: 4px;
        padding-left: 4px;
        font: 400;
      }

      /* Checkboxes en tablas */
      td > input[type='checkbox'],
      th > input[type='checkbox'] {
        cursor: pointer;
        width: 1rem;
        height: 1rem;
        accent-color: var(--electric-blue);
      }

      td > input[type='checkbox']:hover,
      th > input[type='checkbox']:hover {
        transform: scale(1.1);
        transition: transform 0.2s ease-in-out;
      }

      /* --- Notificaciones, Overlays y Spinners --- */
      #toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1050;
        display: flex;
        flex-direction: column-reverse;
        gap: 0.5rem;
      }

      .toast {
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: all 0.3s ease-in-out;
        transform: translateY(100%);
        min-width: 250px;
        max-width: 350px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.success {
        background-color: var(--electric-green);
      }

      .toast.error {
        background-color: var(--electric-red);
      }

      .toast.info {
        background-color: var(--electric-blue);
      }

      .toast-icon {
        width: 1.25rem;
        height: 1.25rem;
        flex-shrink: 0;
      }

      .toast-icon svg {
        fill: currentColor;
      }

      .input-error-message {
        color: var(--electric-red);
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: none;
      }

      .input-error-message.active {
        display: block;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner {
        border: 4px solid rgba(243, 244, 246, 0.2);
        border-left-color: var(--electric-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .btn-spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-left-color: #fff;
        width: 16px;
        height: 16px;
      }

      /* Cuando el modal de autenticación está activo, oculta las secciones específicas del contenido */
      body.auth-modal-active #open-tutorials-btn,
      body.auth-modal-active .bttclose,
      body.auth-modal-active #tabs,
      body.auth-modal-active #dashboard,
      body.auth-modal-active #main-container,
      body.auth-modal-active #credit-card-alerts,
      body.auth-modal-active #recurring-alerts {
        display: none;
      }

      /* Ancla el footer a la parte inferior de la pantalla en la vista de autenticación */
      body.auth-modal-active footer {
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      /* ====================================================================== */
      /* 5. ESTILOS ESPECÍFICOS POR PESTAÑA Y VISTA
      /* ====================================================================== */

      /* --- Contenido de la celda de Categoría --- */
      .category-cell-content {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 4px;
      }

      /* --- Dashboard y Alertas --- */
      #dashboard {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin: 1.5rem 2rem 1rem 2rem;
      }

      .dashboard-card {
        background-color: var(--bg-dark-secondary);
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid var(--border-dark);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      }

      .dashboard-card p:first-child {
        font-size: 0.875rem;
        color: var(--text-light-secondary);
      }

      .dashboard-card p:last-child {
        font-size: 2.25rem;
        font-weight: 700;
      }

      .card-icon-wrapper img {
        height: 64px;
        width: auto;
      }

      .card-icon-wrapper {
        width: 62px;
        height: 62px;
        padding: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      #current-balance {
        color: var(--balance-color);
      }

      #monthly-income {
        color: var(--income-color);
      }

      #monthly-expenses {
        color: var(--expense-color);
      }

      #credit-card-alerts,
      #recurring-alerts {
        margin: 0.5rem 2rem 0 2rem;
        font-size: 0.875rem;
      }

      #credit-card-alerts p,
      #recurring-alerts p {
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      }

      #recurring-alerts p.danger {
        background-color: rgba(239, 68, 68, 0.1);
        border-left: 4px solid var(--electric-red);
        color: var(--electric-red);
      }

      #recurring-alerts p.warning {
        background-color: rgba(250, 204, 21, 0.15);
        border-left: 4px solid var(--electric-yellow);
        color: var(--electric-yellow);
      }

      /* --- Pestaña Registros y Proyección (Estilos compartidos) --- */
      #registros-content .income-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
      #registros-content .expense-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
      #registros-content .transfer-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
      #proyeccion-content .income-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
      #proyeccion-content .expense-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)),
      #proyeccion-content .transfer-text-row td:is(:nth-child(1), :nth-child(2), :nth-child(3)) {
        color: var(--text-light-primary);
      }

      #registros-content th:nth-child(2),
      #registros-content td:nth-child(2),
      #proyeccion-content th:nth-child(2),
      #proyeccion-content td:nth-child(2) {
        text-align: center;
        padding-left: 2px;
        padding-right: 2px;
        width: 1%;
        white-space: nowrap;
      }

      #proyeccion-content td:nth-child(4) {
        white-space: nowrap;
      }

      #no-transactions-message,
      #no-recurring-expenses-message,
      #no-credit-cards-message,
      #no-balances-message,
      #no-categories-for-budget-message,
      #no-proyeccion-message,
      #no-shared-expenses-message {
        color: var(--text-light-secondary);
        text-align: center;
        padding-top: 2rem; /* py-8 */
        padding-bottom: 2rem;
      }

      .edit-recurring-btn,
      .edit-btn {
        color: var(--electric-blue);
      }

      .edit-recurring-btn:hover,
      .edit-btn:hover {
        color: #cbdae1;
      }

      .delete-btn,
      .delete-card-btn,
      .delete-category-btn,
      .delete-bank-btn,
      .delete-description-btn {
        color: var(--electric-red);
      }

      .delete-btn:hover,
      .delete-card-btn:hover,
      .delete-category-btn:hover,
      .delete-bank-btn:hover,
      .delete-description-btn:hover {
        color: #f472b6;
      }

      #registros-content td:nth-child(4) {
        padding-right: 1.5rem; /* Crea un "cojín" de espacio a la derecha del texto */
      }
      /* --- Estilos específicos para la tabla de Registros --- */
      #registros-content th:first-child {
        padding-left: 0.5rem; /* px-2 */
        padding-right: 0.5rem;
        text-align: center;
      }
      #registros-content th:nth-child(6),
      #registros-content th:nth-child(7) {
        text-align: right;
      }

      #registros-content th:nth-child(8) {
        text-align: center;
      }

      /* Estilos del Footer */
      #registros-content tfoot td {
        font-size: 0.875rem; /* text-sm */
        text-transform: uppercase;
        text-align: right;
        color: var(--text-light-secondary); /* text-gray-700 */
      }

      /* Footer de Escritorio */
      #registros-content tfoot .desktop-footer-row td {
        padding: 1rem 1.5rem; /* py-4 px-6 */
      }

      /* Footer de Móvil */
      #registros-content tfoot .mobile-footer-row td {
        padding: 0.75rem 1rem; /* py-3 px-4 */
      }

      #registros-content tfoot #registros-total-income,
      #registros-content tfoot #mobile-registros-total-income {
        color: var(--income-color); /* text-green-600 */
        text-transform: none;
      }
      #registros-content tfoot #registros-total-expenses,
      #registros-content tfoot #mobile-registros-total-expenses {
        color: var(--expense-color); /* text-red-600 */
        text-transform: none;
      }

      /* --- Lógica Responsiva del Footer --- */
      .desktop-footer-row {
        display: none;
      }
      .mobile-footer-row {
        display: table-row;
      }
      @media (min-width: 768px) {
        /* md: en Tailwind */
        .desktop-footer-row {
          display: table-row;
        }
        .mobile-footer-row {
          display: none;
        }
      }

      /* --- Filtros --- */
      #filter-category,
      #filter-bank,
      #filter-month {
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
        border-radius: 0.5rem;
        padding: 0.25rem; /* p-1 */
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      #filter-category:focus,
      #filter-bank:focus,
      #filter-month:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4); /* focus:ring-2 focus:ring-blue-500 */
      }

      /* --- Panel de Entrada por Voz --- */
      #voice-input-panel.visible {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- Estilos completos del Panel de Voz --- */
      #voice-input-panel {
        display: none; /* Reemplaza a la clase 'hidden' */
        margin-bottom: 1rem; /* mb-4 */
        padding: 1rem; /* p-4 */
        border: 1px solid var(--border-dark); /* border, border-gray-700 */
        border-radius: 0.5rem; /* rounded-lg */
        background-color: var(--bg-dark-secondary); /* bg-gray-800 */
      }

      /* El .visible que ya tenías se encarga de mostrarlo */
      #voice-input-panel.visible {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }

      #voice-input-panel label {
        display: block;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        color: var(--text-light-secondary); /* text-gray-400 */
        margin-bottom: 0.5rem; /* mb-2 */
      }

      #voice-text-input {
        width: 100%;
        padding: 0.625rem; /* p-2.5 */
        background-color: var(--bg-dark-primary); /* bg-gray-900 */
        border: 1px solid var(--border-dark); /* border, border-gray-600 */
        border-radius: 0.5rem; /* rounded-lg */
        color: #e5e7eb; /* text-gray-200 */
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      #voice-text-input::placeholder {
        color: var(--text-light-secondary);
      }

      #voice-text-input:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4); /* focus:ring-2 focus:ring-blue-500 */
      }

      .voice-panel-buttons {
        display: flex;
        justify-content: flex-end; /* justify-end */
        margin-top: 0.5rem; /* mt-2 */
      }

      #save-voice-text-btn,
      #cancel-voice-text-btn {
        color: #ffffff;
        padding: 0.5rem 1rem; /* px-4 py-2 */
        border-radius: 0.5rem; /* rounded-lg */
        transition: background-color 0.15s ease-in-out;
        border: none;
        cursor: pointer;
      }

      #save-voice-text-btn {
        background-color: var(--electric-green); /* bg-green-600 */
      }
      #save-voice-text-btn:hover {
        background-color: #15803d; /* hover:bg-green-700 */
      }

      #cancel-voice-text-btn {
        background-color: var(--border-dark); /* bg-gray-600 */
        margin-left: 0.5rem; /* ml-2 */
      }
      #cancel-voice-text-btn:hover {
        background-color: var(--bg-dark-tertiary); /* hover:bg-gray-700 */
      }

      /* --- Pestaña Gastos Recurrentes --- */
      #recurrentes-content tbody td {
        color: var(--text-light-primary);
      }

      #recurrentes-content tbody .text-red-600 {
        color: var(--expense-color);
      }

      #migrate-all-recurring-btn {
        display: none !important;
      }

      /* --- Estilos específicos para la tabla de Proyección --- */
      #proyeccion-content th {
        padding: 0.75rem 1.5rem;
        text-align: left;
        letter-spacing: 0.05em;
      }

      #proyeccion-content th:first-child {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        text-align: center;
      }

      #proyeccion-content th:nth-child(5),
      #proyeccion-content th:nth-child(6) {
        text-align: right;
      }

      #proyeccion-content th:nth-child(7) {
        text-align: center;
      }

      #recurrentes-content th {
        padding: 0.75rem 1.5rem; /* px-6 py-3 */
        letter-spacing: 0.05em; /* tracking-wider */
        font-weight: 500; /* font-medium */
        color: var(--text-light-secondary); /* text-gray-500 */
      }

      #recurrentes-content th:nth-child(1), /* Checkbox */
      #recurrentes-content th:nth-child(2), /* Día */
      #recurrentes-content th:nth-child(7) {
        /* Acciones */
        text-align: center;
      }

      #recurrentes-content th:nth-child(3), /* Descripción */
      #recurrentes-content th:nth-child(4), /* Categoría */
      #recurrentes-content th:nth-child(6) {
        /* Banco/Cuenta */
        text-align: left;
      }

      #recurrentes-content th:nth-child(5) {
        /* Monto */
        text-align: right;
      }

      /* Estilos para el pie de la tabla */
      #recurrentes-content tfoot td {
        padding: 1rem 1.5rem;
        font-weight: 500;
        color: var(--text-light-secondary);
        white-space: nowrap; /* Evita que el texto se divida en varias líneas */
      }

      #recurrentes-content tfoot td:last-child {
        text-align: right;
        font-weight: 600;
        color: var(--text-light-primary);
      }

      /* --- Estilos para el Checkbox de Exclusión en Tarjetas --- */
      .exclude-checkbox {
        appearance: none;
        -webkit-appearance: none;
        background-color: transparent;
        margin: 0;
        font: inherit;
        color: currentColor;
        width: 1.25em;
        height: 1.25em;
        border: 0.15em solid var(--border-dark);
        border-radius: 50%;
        transform: translateY(-0.075em);
        display: grid;
        place-content: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .exclude-checkbox:hover {
        border-color: var(--electric-blue);
      }
      .exclude-checkbox::before {
        content: '';
        width: 0.75em;
        height: 0.75em;
        border-radius: 50%;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em var(--electric-blue);
      }
      .exclude-checkbox:checked::before {
        transform: scale(1);
      }
      /* --- Pestaña Tarjetas de Crédito --- */
      #tarjetas-content th {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        padding-left: 1rem;
        padding-right: 1rem;
        letter-spacing: 0.05em;
        text-align: center;
      }

      #tarjetas-content th:first-child {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      #tarjetas-content tfoot td {
        padding: 0.75rem 1rem;
        text-align: right;
        font-size: 0.875rem;
        vertical-align: middle;
      }

      /* Estilo para etiquetas como "Totales" */
      #tarjetas-content tfoot td[colspan] {
        color: var(--text-light-secondary);
        font-weight: 600;
        text-align: center;
      }

      /* Estilo para los montos totales */
      #tarjetas-content tfoot td:not([colspan]) {
        color: var(--text-light-primary);
        font-weight: 700;
        font-size: 1rem;
      }

      /* Estilo específico para el total del pago mensual sugerido */
      #tarjetas-content tfoot #cc-total-monthly {
        color: var(--electric-blue);
      }

      /* Reglas para inputs y fondos dinámicos dentro de esta tabla específica */
      #tarjetas-content .table-input {
        background-color: var(--bg-dark-primary);
        border: 1px solid var(--border-dark);
      }

      #tarjetas-content .bg-red-100,
      #tarjetas-content .bg-yellow-100 {
        background-color: var(--bg-dark-tertiary) !important;
      }

      #tarjetas-content tbody tr:hover {
        background-color: var(--border-dark) !important;
      }
      #tarjetas-content .table-input {
        background-color: var(--bg-dark-primary);
        border: 1px solid var(--border-dark);
      }

      #tarjetas-content tfoot td {
        padding: 0.75rem 1rem; /* Adds vertical and horizontal spacing */
        text-align: right; /* Aligns all text to the right */
        font-size: 0.875rem; /* 14px font size */
        vertical-align: middle;
      }

      /* Style for labels like "Totals" */
      #tarjetas-content tfoot td[colspan] {
        color: var(--text-light-secondary); /* Uses your secondary text color (dimmer) */
        font-weight: 600; /* Semibold font */
      }

      /* Style for total amounts */
      #tarjetas-content tfoot td:not([colspan]) {
        color: var(--text-light-primary); /* Uses your main text color (brighter) */
        font-weight: 700; /* Bold font */
        font-size: 1rem; /* 16px, slightly larger for emphasis */
      }

      /* Specific style for the suggested monthly payment total */
      #tarjetas-content tfoot #cc-total-monthly {
        color: var(--electric-blue); /* Uses your blue accent color */
      }

      #tarjetas-content thead th,
      #tarjetas-content tbody td {
        color: var(--text-light-primary);
      }

      #tarjetas-content tfoot .text-gray-700 {
        color: var(--text-light-secondary);
      }

      #tarjetas-content tfoot .text-gray-900 {
        color: var(--text-light-primary);
      }

      /* Reglas específicas para sobreescribir colores de fondo dinámicos en la tabla de tarjetas */
      #tarjetas-content .bg-white,
      #tarjetas-content .bg-red-100,
      #tarjetas-content .bg-yellow-100 {
        background-color: var(--bg-dark-tertiary) !important;
        color: var(--text-light-primary) !important;
      }

      #tarjetas-content tbody tr:hover {
        background-color: var(--border-dark) !important;
      }

      /* --- Pestaña Saldos de Cuentas --- */
      #saldos-content {
        background-color: var(--bg-dark-primary);
        padding: 1rem;
        margin: -1rem;
        border-radius: 0.75rem;
      }

      #saldos-content h3 {
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
        margin-bottom: 1rem; /* mb-4 */
      }

      #saldos-content .bg-white {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
      }

      #saldos-content .text-gray-700 {
        color: var(--text-light-primary);
      }

      .balance-card-label {
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        font-weight: 700;
        font-size: 2rem;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .balance-card-label:hover {
        transform: scale(1.03);
      }

      .balance-card-positive {
        background-color: rgba(34, 197, 94, 0.15);
        color: var(--income-color);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2),
          inset 0 0 8px rgba(34, 197, 94, 0.4);
      }

      .balance-card-negative {
        background-color: rgba(239, 68, 68, 0.15);
        color: var(--expense-color);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2),
          inset 0 0 8px rgba(239, 68, 68, 0.4);
      }

      #bank-balances-grid {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr)); /* grid-cols-1 */
        gap: 1.5rem; /* gap-6 */
      }

      @media (min-width: 768px) {
        #bank-balances-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr)); /* md:grid-cols-2 */
        }
      }

      @media (min-width: 1024px) {
        #bank-balances-grid {
          grid-template-columns: repeat(3, minmax(0, 1fr)); /* lg:grid-cols-3 */
        }
      }

      /* --- Pestaña Presupuesto --- */
      #presupuesto-content tbody td:nth-child(1) {
        color: var(--text-light-primary);
      }

      .table-input,
      .budget-table-input {
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        border-radius: 0.375rem;
        color: var(--text-light-primary);
        text-align: right;
        transition: all 0.2s ease;
      }

      .table-input {
        width: 100%;
        padding: 4px 8px;
      }

      .budget-table-input {
        width: 120px;
        padding: 6px 10px;
      }

      .table-input:focus,
      .budget-table-input:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
      }

      #presupuesto-content .budget-table-input {
        background-color: var(--bg-dark-primary);
      }

      .positive-balance {
        color: var(--income-color);
        font-weight: 600;
      }

      .negative-balance {
        color: var(--expense-color);
        font-weight: 600;
      }

      .zero-balance {
        color: var(--text-light-secondary);
        font-weight: 500;
      }

      .balance-cell-bg {
        background-color: var(--bg-dark-primary);
      }

      #presupuesto-content thead th {
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        color: var(--text-light-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      #presupuesto-content thead th:first-child {
        text-align: left;
      }

      #presupuesto-content thead th:not(:first-child) {
        text-align: right;
      }

      #presupuesto-content tfoot {
        border-top: 2px solid var(--border-dark);
      }

      #presupuesto-content tfoot td {
        padding: 1rem 1.5rem;
        font-size: 0.875rem;
      }

      #presupuesto-content tfoot td:first-child {
        text-align: left;
        color: var(--text-light-primary);
        text-transform: uppercase;
      }

      #presupuesto-content tfoot td:not(:first-child) {
        text-align: right;
      }

      #presupuesto-content #budget-total-budgeted {
        color: var(--electric-blue);
      }

      #presupuesto-content #budget-total-spent {
        color: var(--electric-orange);
      }

      #presupuesto-content #budget-total-remaining {
        color: var(--income-color); /* Green */
      }

      /* --- Pestaña Reportes --- */
      #reportes-content h3 {
        color: var(--text-light-primary);
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
        margin-bottom: 1rem; /* mb-4 */
      }

      .reports-grid {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 2rem; /* gap-8 */
        align-items: flex-start;
      }

      .chart-container {
        width: 100%;
        height: 20rem; /* h-80 */
        position: relative;
      }

      #category-totals-list {
        background-color: var(--bg-dark-primary);
        border: 1px solid var(--border-dark);
        border-radius: 0.5rem;
        padding-right: 0.5rem; /* pr-2 */
        max-height: 24rem; /* max-h-96 */
        overflow-y: auto;
      }

      /* Simula el "space-y-3" */
      #category-totals-list > * + * {
        margin-top: 0.75rem;
      }

      .totals-section {
        border-top: 1px solid var(--border-dark);
        margin-top: 1rem; /* mt-4 */
        padding-top: 1rem; /* pt-4 */
      }

      .totals-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700; /* font-bold */
        font-size: 1.125rem; /* text-lg */
      }

      #total-expenses-report {
        color: var(--expense-color); /* text-red-600 */
      }

      .reports-footer-section {
        margin-top: 2rem; /* mt-8 */
      }

      /* --- Media Query para Responsividad --- */
      @media (min-width: 768px) {
        .reports-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .chart-container {
          height: 24rem; /* md:h-96 */
        }
      }

      /* --- Pestaña Configuración --- */
      .config-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      @media (min-width: 768px) {
        .config-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      #configuración-content h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-dark);
        padding-bottom: 0.5rem;
      }

      .config-section {
        margin-top: 2rem;
        border-top: 1px solid var(--border-dark);
        padding-top: 1.5rem;
      }

      .config-button-container {
        margin-bottom: 1rem;
      }

      .config-list-container {
        overflow-y: auto;
        border: 1px solid var(--border-dark);
        border-radius: 0.5rem;
        padding: 0.5rem;
        background-color: var(--bg-dark-primary);
        max-height: 18rem; /* Altura unificada para todos los contenedores */
      }

      .config-list-container ul > * + * {
        margin-top: 0.5rem;
      }

      #configuración-content li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--bg-dark-tertiary) !important;
        padding: 0.5rem;
        border-radius: 0.5rem;
        gap: 0.5rem; /* Espacio entre el texto y el botón */
      }

      /* Estilos para el texto dentro del item de la lista */
      .config-item-text {
        flex-grow: 1; /* Permite que el texto ocupe el espacio disponible */
        white-space: nowrap; /* Evita que el texto se parta en varias líneas */
        overflow: hidden; /* Oculta el texto que se desborda */
        text-overflow: ellipsis; /* Añade "..." al final del texto cortado */
        min-width: 0; /* Corrección clave para que flexbox permita encoger el elemento */
      }

      #configuración-content label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light-secondary);
        margin-bottom: 0.25rem;
      }

      #configuración-content input[type='text'],
      #configuración-content input[type='password'] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-dark);
        border-radius: 0.5rem;
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        transition: all 0.2s ease-in-out;
        margin-bottom: 0.5rem;
        box-sizing: border-box;
      }

      #configuración-content input[type='text']:focus,
      #configuración-content input[type='password']:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
      }

      #configuración-content input[type='text']::placeholder,
      #configuración-content input[type='password']::placeholder {
        color: var(--text-light-secondary);
      }

      #change-password-form > * + * {
        margin-top: 1rem;
      }

      #configuración-content p {
        font-size: 0.875rem;
        color: var(--text-light-secondary);
        margin-top: 0.5rem;
      }

      /* Estilos para botones generales en la sección */
      #configuración-content button {
        width: 100%;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
      }

      /* Estilo específico para los botones de eliminar en las listas */
      #configuración-content .delete-category-btn,
      #configuración-content .delete-bank-btn,
      #configuración-content .delete-description-btn {
        width: auto; /* Ancho automático */
        background: none; /* Sin fondo */
        color: var(--electric-red); /* Color rojo */
        padding: 0;
        font-size: 0.875rem;
        flex-shrink: 0; /* Evita que el botón se encoja */
      }

      #configuración-content .delete-category-btn:hover,
      #configuración-content .delete-bank-btn:hover,
      #configuración-content .delete-description-btn:hover {
        color: #fca5a5; /* Rojo más claro al pasar el mouse */
      }

      /* Colores específicos para los botones de acción principales */
      #open-add-category-modal-btn,
      #add-bank-btn,
      #save-alias-btn,
      #change-password-btn {
        background-color: var(--electric-blue);
      }
      #open-add-category-modal-btn:hover,
      #add-bank-btn:hover,
      #save-alias-btn:hover,
      #change-password-btn:hover {
        background-color: #0c87bf;
      }

      #initiate-new-month-btn {
        background-color: var(--electric-green);
      }
      #initiate-new-month-btn:hover {
        background-color: #15803d;
      }

      .config-actions-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .config-actions-group button {
        width: auto;
      }

      #export-pdf-btn,
      #export-json-btn {
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
      }
      #export-pdf-btn:hover,
      #export-json-btn:hover {
        background-color: var(--border-dark);
      }

      #import-json-btn {
        background-color: var(--electric-purple);
      }
      #import-json-btn:hover {
        background-color: #6d28d9;
      }

      #reset-data-btn {
        background-color: var(--electric-red);
      }
      #reset-data-btn:hover {
        background-color: #b91c1c;
      }

      .danger-zone-title {
        color: var(--electric-red) !important;
      }

      /* --- Pestaña Calculadora --- */
      #calculadora-content {
        padding: 0;
        margin: 0;
      }

      .calculator-wrapper {
        width: 100%;
        max-width: 56rem; /* max-w-4xl */
        margin-left: auto;
        margin-right: auto;
      }

      .calculator-card {
        background-color: var(--bg-dark-secondary);
        border-radius: 1rem; /* rounded-2xl */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
      }

      #titucalculadora {
        text-align: center;
        margin-bottom: 2rem;
        background: none;
        border-bottom: 1px solid var(--border-dark);
        border-radius: 0;
        padding-bottom: 1rem;
      }

      #titucalculadora h3 {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--electric-blue);
      }

      #titucalculadora p {
        color: var(--electric-blue);
        opacity: 0.8;
        margin-top: 0.5rem;
      }

      .calculator-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .calculator-column {
        background-color: var(--bg-dark-primary);
        padding: 1.5rem;
        border-radius: 0.75rem;
      }

      .calculator-column h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-dark);
        padding-bottom: 0.5rem;
        color: var(--text-light-primary);
      }

      .form-section > * + * {
        margin-top: 1rem;
      }

      .deductions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      #calculadora-content label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light-secondary);
      }

      #calculadora-content input,
      #calculadora-content select {
        margin-top: 0.25rem;
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
        box-sizing: border-box;
      }

      #calculadora-content input:focus,
      #calculadora-content select:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
      }

      .calculate-btn-container {
        text-align: center;
        margin-bottom: 2rem;
      }

      #calculateBtn {
        background-color: var(--electric-blue);
        color: white;
        font-weight: 700;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-size: 1.125rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: background-color 0.3s ease;
      }
      #calculateBtn:hover {
        background-color: #0c87bf;
      }

      #results {
        background-color: var(--bg-dark-primary);
        border: 1px solid var(--border-dark);
        padding: 1.5rem;
        border-radius: 0.75rem;
      }

      #results h2 {
        font-size: 1.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.5rem;
        color: var(--electric-blue);
        opacity: 0.9;
      }

      .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }

      .result-item {
        text-align: center;
        padding: 1rem;
        background-color: var(--bg-dark-secondary);
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .result-item p:first-child {
        font-size: 0.875rem;
        color: var(--text-light-secondary);
      }

      .result-item p:last-child {
        font-size: 1.25rem;
        font-weight: 600;
      }

      #grossPayResult {
        color: var(--income-color);
      }
      #preTaxDeductionsResult {
        color: var(--electric-orange);
      }
      #federalTaxResult,
      #ficaTaxResult,
      #postTaxDeductionsResult {
        color: var(--expense-color);
      }

      .net-pay-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px dashed var(--border-dark);
        text-align: center;
      }

      .net-pay-section p:first-child {
        font-size: 1.125rem;
        color: var(--text-light-primary);
      }

      #netPayResult {
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--electric-blue);
        margin-top: 0.5rem;
      }

      .net-pay-period {
        font-size: 0.75rem;
        color: var(--text-light-secondary);
        margin-top: 1rem;
      }

      .disclaimer {
        font-size: 0.75rem;
        color: var(--text-light-secondary);
        opacity: 0.7;
        text-align: center;
        margin-top: 1.5rem;
      }

      /* Media Queries para responsividad */
      @media (min-width: 768px) {
        .calculator-card {
          padding: 2rem;
        }
        #titucalculadora h3 {
          font-size: 2.25rem;
        }
        .calculator-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        #netPayResult {
          font-size: 3rem;
        }
      }

      /* ====================================================================== */
      /* --- PESTAÑA GASTOS COMUNES --- */
      /* ====================================================================== */

      #gastos-comunes-content .table-input {
        width: 100%;
        padding: 6px 10px;
        box-sizing: border-box;
      }

      /* Para alinear el texto del Ítem a la izquierda */
      #gastos-comunes-content .item-name-input {
        text-align: left;
      }

      /* REEMPLAZA la regla anterior con esta: */
      #gastos-comunes-content .item-total-input {
        padding-right: 10px !important; /* Aumentamos el valor y forzamos la regla */
        text-align: right;
      }

      #gastos-comunes-content th,
      #gastos-comunes-content td {
        min-width: 150px;
        white-space: nowrap;
        padding: 8px;
      }

      #gastos-comunes-content th.actions-column,
      #gastos-comunes-content td.actions-column {
        min-width: 80px;
        width: 80px;
      }

      #gastos-comunes-content th[contenteditable='true'] {
        background-color: var(--bg-dark-primary);
        cursor: text;
        transition: all 0.2s ease;
      }

      #gastos-comunes-content th[contenteditable='true']:hover,
      #gastos-comunes-content th[contenteditable='true']:focus {
        outline: 2px solid var(--electric-blue);
        background-color: var(--border-dark);
      }

      #gastos-comunes-content .distribution-cell {
        cursor: pointer;
        position: relative;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      #gastos-comunes-content .distribution-cell:hover {
        background-color: var(--border-dark);
      }

      #gastos-comunes-content .distribution-cell.active {
        background-color: rgba(14, 165, 233, 0.15);
        outline: 2px solid var(--electric-blue);
      }

      #gastos-comunes-content .distribution-cell .method-indicator {
        font-size: 0.65rem;
        color: var(--text-light-secondary);
        display: block;
        margin-top: 2px;
      }

      #distribution-popover {
        position: absolute;
        background-color: var(--bg-dark-primary);
        border: 1px solid var(--border-dark);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
      }

      #distribution-popover div {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.2s ease;
        color: var(--text-light-primary);
      }

      #distribution-popover div:hover {
        background-color: var(--electric-blue);
        color: white;
      }

      #gastos-comunes-content tfoot td {
        font-weight: 700;
        font-size: 1rem;
      }

      #gastos-comunes-content tfoot .total-general {
        color: var(--electric-orange);
      }

      #gastos-comunes-content .delete-person-btn,
      #gastos-comunes-content .delete-item-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-light-secondary);
      }
      #gastos-comunes-content .delete-person-btn:hover,
      #gastos-comunes-content .delete-item-btn:hover {
        color: var(--electric-red);
        transform: scale(1.1);
      }

      #gastos-comunes-content .person-header-container {
        display: flex; /* Activa Flexbox para alinear elementos en una línea */
        justify-content: space-between; /* Empuja el nombre a la izquierda y el botón a la derecha */
        align-items: center; /* Centra verticalmente los elementos */
        gap: 8px; /* Añade un pequeño espacio entre el nombre y el botón */
      }

      #gastos-comunes-content .person-name-editable {
        flex-grow: 1; /* Permite que el nombre ocupe el espacio disponible */
        text-align: left; /* Asegura que el texto del nombre comience a la izquierda */
      }

      #gastos-comunes-content .delete-person-btn {
        flex-shrink: 0; /* Evita que el botón 'X' se encoja si el nombre es muy largo */
      }

      .shared-buttons-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      #add-shared-item-btn,
      #add-person-btn {
        flex: 1 1 0%;
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.15s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
      }

      #add-shared-item-btn > * + *,
      #add-person-btn > * + * {
        margin-left: 0.5rem;
      }

      #add-shared-item-btn svg,
      #add-person-btn svg {
        height: 1.25rem;
        width: 1.25rem;
      }

      #add-shared-item-btn {
        background-color: var(--electric-blue);
      }
      #add-shared-item-btn:hover {
        background-color: #0c87bf;
      }

      #add-person-btn {
        background-color: var(--electric-green);
      }
      #add-person-btn:hover {
        background-color: #15803d;
      }

      @media (min-width: 640px) {
        .shared-buttons-container {
          flex-direction: row;
        }
      }

      /* --- Íconos de Categoría y Modal de Selección --- */
      .category-icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        vertical-align: middle;
        display: inline-block;
      }

      #category-icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 1rem;
        padding: 1rem 0;
      }

      .icon-option {
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-dark-tertiary);
      }

      .icon-option:hover {
        transform: scale(1.1);
        border-color: var(--electric-blue);
      }

      .icon-option.selected {
        border-color: var(--electric-green);
        box-shadow: 0 0 10px var(--electric-green);
      }

      .icon-option img {
        width: 40px;
        height: 40px;
      }

      /* --- Modales Legales (Privacidad, Términos, etc.) --- */
      .modal .overflow-y-auto {
        overflow-y: auto;
      }

      .modal .text-gray-600 h1,
      .modal .text-gray-600 h2,
      .modal .text-gray-600 h3 {
        color: var(--text-light-primary);
        border-bottom: 1px solid var(--border-dark);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .modal .text-gray-600 h1 {
        font-size: 1.5rem;
      }

      .modal .text-gray-600 h2 {
        font-size: 1.25rem;
      }

      .modal .text-gray-600 h3 {
        font-size: 1.1rem;
      }

      .modal .text-gray-600 p,
      .modal .text-gray-600 li {
        font-size: 0.9rem;
        color: var(--text-light-secondary);
        margin-bottom: 1rem;
        line-height: 1.6;
      }

      /* --- Botón de Info y Tooltip --- */
      .info-tooltip {
        position: fixed;
        background-color: var(--bg-dark-primary);
        color: var(--text-light-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--border-dark);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        font-size: 0.8rem;
        max-width: 250px;
        z-index: 1100;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        pointer-events: none;
      }

      .info-tooltip.visible {
        opacity: 1;
      }

      /* --- Componentes Específicos de Modales de Registro --- */
      #transaction-modal,
      #recurring-expense-modal,
      #credit-card-modal {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(17, 24, 39, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        z-index: 100;
      }

      #transaction-modal.active,
      #recurring-expense-modal.active,
      #credit-card-modal.active {
        display: flex;
      }

      #transaction-modal-content,
      #recurring-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 32rem;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #transaction-form,
      #recurring-expense-form {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
      }

      #transaction-modal-header,
      #recurring-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1rem 1.5rem; /* Aumentado para más espacio */
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
      }

      #modal-title,
      #recurring-modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #transaction-modal-header > div {
        display: flex;
        align-items: center;
      }

      #voice-recognition-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
        margin-right: 1rem;
        padding: 0;
      }

      #voice-recognition-btn:hover {
        color: var(--electric-blue);
      }

      #close-transaction-modal-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-transaction-modal-btn:hover {
        color: var(--text-light-primary);
      }

      #close-transaction-modal-btn svg {
        height: 1.25rem; /* Aumentado para mejor tacto */
        width: 1.25rem;
      }

      #transaction-modal-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem; /* Padding unificado */
        display: flex;
        flex-direction: column;
        gap: 0.25rem; /* Espacio entre campos del formulario */
      }

      #transaction-modal-footer,
      #recurring-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        background-color: var(--bg-dark-primary);
        border-bottom-left-radius: 1rem;
        border-bottom-right-radius: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Permite que los botones se reordenen en pantallas pequeñas */
        gap: 1rem;
      }

      #transaction-modal-footer > div {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        width: 100%;
      }

      #open-transfer-modal-btn {
        width: 100%;
        background-color: rgba(34, 197, 94, 0.1);
        color: var(--income-color);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid var(--income-color);
      }
      #open-transfer-modal-btn:hover {
        background-color: rgba(34, 197, 94, 0.2);
      }

      #save-transaction-btn,
      #save-recurring-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #save-transaction-btn:hover,
      #save-recurring-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Media Queries para el Footer del Modal --- */
      @media (min-width: 640px) {
        #transaction-modal-footer {
          flex-wrap: nowrap;
        }
        #open-transfer-modal-btn,
        #save-transaction-btn,
        #save-recurring-btn,
        #transaction-modal-footer > div {
          width: auto;
        }
      }

      /* --- Modal de Transferencia --- */
      /* Las clases .modal y .modal.active ya se encargan del centrado y el fondo. */
      /* Este CSS se enfoca en el contenido del modal. */
      #transfer-modal > div {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 28rem; /* max-w-md */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #transfer-modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1rem;
        border-bottom: 1px solid var(--border-dark);
        flex-shrink: 0;
        color: var(--text-light-primary);
        text-align: center;
      }

      #transfer-modal form {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
      }

      #transfer-modal form > div:first-of-type {
        /* Body */
        padding: 1.5rem;
        flex-grow: 1;
        overflow-y: auto;
      }

      #transfer-modal .form-field {
        margin-bottom: 1rem;
      }
      #transfer-modal .form-field:last-child {
        margin-bottom: 0.5rem;
      }

      /* Asegura que los campos usen todo el ancho */
      #transfer-modal input,
      #transfer-modal select {
        width: 100%;
        box-sizing: border-box; /* Crucial para que el padding no desborde el ancho */
      }

      #transfer-modal form > div:last-of-type {
        /* Footer */
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: space-between; /* Justifica los botones */
        gap: 1rem;
      }

      #transfer-cancel-btn {
        background-color: var(--electric-red); /* Color rojo */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #transfer-cancel-btn:hover {
        background-color: #b91c1c; /* Rojo más oscuro al pasar el cursor */
      }

      #confirm-transfer-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #confirm-transfer-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Modal de Gasto Recurrente --- */
      /* Se reutilizan #recurring-modal-content, #recurring-modal-header, etc. del modal anterior */
      #close-recurring-modal-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-recurring-modal-btn:hover {
        color: var(--text-light-primary);
      }
      #close-recurring-modal-btn svg {
        height: 1.5rem; /* h-6 */
        width: 1.5rem; /* w-6 */
      }

      #recurring-modal-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      #recurring-expense-modal input,
      #recurring-expense-modal select {
        width: 100%;
        box-sizing: border-box; /* Asegura que el padding no desborde el ancho */
      }

      .recurring-grid-container {
        display: grid;
        grid-template-columns: 1fr; /* Una columna por defecto para móviles */
        gap: 1rem;
      }

      #recurring-modal-footer {
        justify-content: flex-end; /* Alinea el botón a la derecha */
      }

      /* --- Modal Tarjeta de Crédito (Diseño en Cuadrícula) --- */
      #credit-card-modal > div {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 32rem; /* Aumentado ligeramente para acomodar la cuadrícula */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #credit-card-modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-dark);
        flex-shrink: 0;
        color: var(--text-light-primary);
        text-align: left;
      }

      #credit-card-modal form {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
      }

      /* ===== INICIO DE LOS CAMBIOS DE CUADRÍCULA ===== */
      #credit-card-modal form > div:first-of-type {
        /* Body */
        padding: 1.5rem;
        flex-grow: 1;
        overflow-y: auto;
        display: grid; /* 1. Activamos el layout de cuadrícula */
        grid-template-columns: 1fr 1fr; /* 2. Creamos dos columnas de igual tamaño */
        gap: 1rem; /* 3. Añadimos espacio entre los campos */
      }

      /* 4. Hacemos que este campo ocupe las dos columnas */
      #credit-card-modal .full-width-field {
        grid-column: 1 / -1; /* Ocupa desde la primera hasta la última columna */
      }

      /* Ya no necesitamos el margen inferior en cada campo, el 'gap' lo maneja */
      #credit-card-modal .form-field {
        margin-bottom: 0;
      }

      /* ===== FIN DE LOS CAMBIOS DE CUADRÍCULA ===== */
      #credit-card-modal label {
        text-align: left;
        color: var(--text-light-primary);
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
      }

      #credit-card-modal form > div:last-of-type {
        /* Footer */
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
      }

      #credit-card-cancel-btn {
        background-color: var(--electric-red);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #credit-card-cancel-btn:hover {
        background-color: #b91c1c;
      }

      #save-credit-card-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #save-credit-card-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Estilos para Formulario Guiado (Modal de Transacción) --- */
      .guided-form-field {
        margin-bottom: 1rem;
      }

      .guided-form-label {
        display: block;
        color: var(--text-light-secondary);
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .guided-form-input,
      .guided-form-select,
      .guided-form-category-button {
        width: 100%;
        background-color: var(--bg-dark-tertiary);
        border: 1px solid var(--border-dark);
        color: var(--text-light-primary);
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        box-sizing: border-box;
      }

      .guided-form-category-button {
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .guided-form-category-button img {
        width: 24px;
        height: 24px;
      }

      .guided-form-input:focus,
      .guided-form-select:focus,
      .guided-form-category-button:focus {
        outline: none;
        border-color: var(--electric-blue);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.4);
      }

      /* --- Modal de Confirmación (Estilo Corregido y Mejorado) --- */
      #confirm-modal > div {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem; /* Bordes más redondeados */
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        padding: 2rem;
        width: 100%;
        max-width: 28rem; /* max-w-md */
        text-align: center;
        display: flex; /* Usamos flexbox para mejor control */
        flex-direction: column;
        align-items: center;
      }

      /* Contenedor del ícono de advertencia */
      #confirm-modal > div > div:first-of-type {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 3.5rem; /* Ajustado para un tamaño adecuado */
        width: 3.5rem;
        border-radius: 50%; /* Círculo perfecto */
        background-color: rgba(239, 68, 68, 0.1); /* Fondo rojo translúcido */
        margin-bottom: 1rem;
      }

      /* Ícono SVG de advertencia */
      #confirm-modal svg {
        height: 2rem; /* Tamaño del ícono corregido */
        width: 2rem;
        color: var(--electric-red); /* Color rojo de tu tema */
      }

      #confirm-modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem; /* Espaciado ajustado */
        color: var(--text-light-primary);
      }

      #confirm-modal-message {
        color: var(--text-light-secondary);
        margin-bottom: 1.5rem;
      }

      /* Contenedor de los botones */
      #confirm-modal > div > div:last-of-type {
        display: flex;
        justify-content: center;
        gap: 1rem;
        width: 100%; /* Asegura que los botones usen el ancho completo si es necesario */
      }

      /* Botones con estilo base */
      #confirm-modal-cancel-btn,
      #confirm-modal-confirm-btn {
        padding: 0.6rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 600; /* Texto en negrita */
        transition: all 0.2s ease;
        flex-grow: 1; /* Permite que los botones crezcan para llenar el espacio */
        max-width: 150px;
      }

      /* Botón de Cancelar (estilo neutro) */
      #confirm-modal-cancel-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
      }
      #confirm-modal-cancel-btn:hover {
        background-color: var(--border-dark);
        transform: translateY(-2px);
      }

      /* Botón de Confirmar (estilo de peligro) */
      #confirm-modal-confirm-btn {
        background-color: var(--electric-red);
        color: white;
      }
      #confirm-modal-confirm-btn:hover {
        background-color: #b91c1c; /* Rojo más oscuro */
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
      }

      /* --- Modal de Mensaje (Estilo Mejorado) --- */
      #message-modal > div {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        padding: 2rem;
        width: 100%;
        max-width: 28rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #message-modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-light-primary);
      }

      #message-modal-content {
        color: var(--text-light-secondary);
        margin-bottom: 1.5rem;
      }

      #message-modal-close-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      #message-modal-close-btn:hover {
        background-color: #0c87bf;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
      }

      /* --- Modal Historia de la Marca --- */
      #brand-story-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 42rem; /* max-w-2xl */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #brand-story-header {
        background-color: var(--bg-dark-primary);
        padding: 1.25rem; /* p-5 */
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      #brand-story-header h2 {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #close-brand-story-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-brand-story-btn:hover {
        color: var(--text-light-primary);
      }
      #close-brand-story-btn svg {
        width: 1.5rem; /* w-6 */
        height: 1.5rem; /* h-6 */
      }

      #brand-story-body {
        padding: 2rem; /* p-8 */
        flex-grow: 1;
        overflow-y: auto;
        line-height: 1.6; /* leading-relaxed */
      }

      #brand-story-body > div {
        margin-bottom: 2rem; /* mb-8 */
      }

      #brand-story-body h3 {
        font-size: 1.25rem; /* text-xl */
        font-weight: 600; /* font-semibold */
        color: var(--electric-blue);
        margin-bottom: 0.5rem; /* mb-2 */
      }

      #brand-story-body p {
        color: var(--text-light-secondary);
        margin-bottom: 1rem; /* Simula el espaciado entre párrafos */
      }

      #brand-story-body .italic {
        font-style: italic;
      }

      .story-separator {
        border-top: 1px solid var(--border-dark);
        padding-top: 2rem; /* pt-8 */
      }

      /* --- Modales Legales (Privacidad, Términos, Cookies) --- */
      .legal-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 42rem; /* max-w-2xl */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      .legal-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      .legal-modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      .close-legal-modal {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      .close-legal-modal:hover {
        color: var(--text-light-primary);
      }
      .close-legal-modal svg {
        width: 1.5rem;
        height: 1.5rem;
      }

      .legal-modal-body {
        padding: 2rem;
        flex-grow: 1;
        overflow-y: auto;
        line-height: 1.7; /* Aumentado para mejor legibilidad */
      }

      .legal-modal-body h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--electric-blue);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-dark);
      }

      .legal-modal-body p,
      .legal-modal-body li {
        color: var(--text-light-secondary);
        margin-bottom: 1rem;
      }

      .legal-modal-body strong {
        color: var(--text-light-primary);
        font-weight: 600;
      }

      .legal-modal-body ul {
        list-style-position: inside;
        padding-left: 0.5rem;
      }

      /* --- Modal de Selección de Íconos de Categoría --- */
      #new-category-name-modal {
        padding-left: 0.5rem;
        width: 100%;
        margin-bottom: 0.25rem;
      }
      #category-icon-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 32rem; /* max-w-lg */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #category-icon-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1rem;
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      #category-icon-modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #close-icon-modal-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-icon-modal-btn:hover {
        color: var(--text-light-primary);
      }
      #close-icon-modal-btn svg {
        width: 1.5rem;
        height: 1.5rem;
      }

      #category-icon-modal-body {
        padding: 0.25rem;
        flex-grow: 1;
        overflow-y: auto;
      }

      #category-icon-modal-body > div:first-of-type {
        margin-bottom: 1rem; /* Espacio debajo del input de nombre */
      }

      #category-icon-modal-body label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light-primary);
        margin-bottom: 0.25rem;
        margin-top: 0.25rem; /* mt-4 */
      }

      #category-icon-modal-body input {
        margin-bottom: 0.5rem; /* mb-2 */
      }

      #category-icon-modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      #save-new-category-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #save-new-category-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Modal de Acción Única (Panel Inferior) --- */
      #single-action-modal {
        align-items: flex-end; /* Alinea el contenido en la parte inferior */
        background-color: rgba(17, 24, 39, 0.6); /* Fondo oscuro semitransparente */
      }

      #single-action-modal-content {
        background-color: var(--bg-dark-secondary);
        width: 100%;
        max-width: 640px; /* Limita el ancho en pantallas grandes */
        margin: 0 auto;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.5);
        padding: 1rem 1rem 1.5rem 1rem;
        transform: translateY(100%); /* Comienza oculto abajo */
        transition: transform 0.3s ease-in-out;
      }

      /* El JS añade .active al #single-action-modal para mostrarlo */
      #single-action-modal.active #single-action-modal-content {
        transform: translateY(0); /* Lo desliza a su posición visible */
      }

      #single-action-modal-title {
        font-size: 0.875rem;
        text-align: center;
        color: var(--text-light-secondary);
        margin-bottom: 1rem;
      }

      #single-action-modal-content > div:last-of-type {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* Espacio entre botones */
      }

      /* Estilo base para los botones de acción */
      #single-action-edit-btn,
      #single-action-delete-btn,
      #single-action-cancel-btn {
        width: 100%;
        padding: 0.8rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      #single-action-edit-btn {
        background-color: var(--electric-blue);
        color: white;
      }
      #single-action-edit-btn:hover {
        background-color: #0c87bf;
      }

      #single-action-delete-btn {
        background-color: var(--electric-red);
        color: white;
      }
      #single-action-delete-btn:hover {
        background-color: #b91c1c;
      }

      #single-action-cancel-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
      }
      #single-action-cancel-btn:hover {
        background-color: var(--border-dark);
      }

      /* --- Modal Opciones de Importación --- */
      #import-options-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 32rem; /* max-w-lg */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #import-options-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      #import-options-modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #close-import-options-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-import-options-btn:hover {
        color: var(--text-light-primary);
      }
      #close-import-options-btn svg {
        width: 1.5rem;
        height: 1.5rem;
      }

      #import-options-modal-body {
        padding: 2rem;
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem; /* space-y-6 */
      }

      #import-options-modal-body p {
        color: var(--text-light-secondary);
        margin-bottom: 1rem;
      }

      #select-import-file-btn {
        width: 100%;
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s ease;
      }
      #select-import-file-btn:hover {
        background-color: #0c87bf;
      }

      #selected-file-name {
        font-size: 0.875rem;
        text-align: center;
        color: var(--text-light-secondary);
        font-style: italic;
      }

      #import-checkboxes-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* space-y-3 */
      }

      #import-checkboxes-container h3 {
        font-size: 1.125rem;
        font-weight: 600;
        border-bottom: 1px solid var(--border-dark);
        padding-bottom: 0.5rem;
        color: var(--text-light-primary);
      }

      #import-checkboxes-container hr {
        border-color: var(--border-dark);
      }

      #import-checkboxes-container label {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
        cursor: pointer;
      }
      #import-checkboxes-container label:hover {
        background-color: var(--bg-dark-tertiary);
      }

      #import-checkboxes-container input[type='checkbox'] {
        height: 1.25rem;
        width: 1.25rem;
        accent-color: var(--electric-blue);
        margin-right: 0.75rem;
      }

      #import-checkboxes-container .import-label-bold {
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #import-options-modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      #cancel-import-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #cancel-import-btn:hover {
        background-color: var(--border-dark);
      }

      #confirm-import-btn {
        background-color: var(--electric-green);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #confirm-import-btn:hover {
        background-color: #15803d;
      }
      #confirm-import-btn:disabled {
        background-color: var(--border-dark);
        cursor: not-allowed;
      }

      /* --- Modal de Selección de Categoría --- */
      #category-select-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 32rem; /* max-w-lg */
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      #category-select-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      #category-select-modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #close-category-select-modal-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-light-secondary);
        transition: color 0.2s ease-in-out;
      }
      #close-category-select-modal-btn:hover {
        color: var(--text-light-primary);
      }
      #close-category-select-modal-btn svg {
        width: 1.5rem;
        height: 1.5rem;
      }

      #category-select-modal-body {
        padding: 2rem;
        flex-grow: 1;
        overflow-y: auto;
      }

      #category-select-modal-body > div:first-of-type {
        margin-bottom: 1.5rem; /* mb-6 */
      }

      #open-add-category-from-select-btn {
        width: 100%;
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        font-weight: 600;
      }
      #open-add-category-from-select-btn:hover {
        background-color: #0c87bf; /* hover:bg-blue-600 */
      }

      /* --- Modal de Input para Distribución (Gastos Comunes) --- */
      #distribution-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 24rem; /* max-w-sm */
        display: flex;
        flex-direction: column;
      }

      #distribution-modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-dark);
        flex-shrink: 0;
        color: var(--text-light-primary);
      }

      #distribution-modal-body {
        padding: 1.5rem;
        flex-grow: 1;
      }

      #distribution-modal-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light-primary);
        margin-bottom: 0.5rem;
      }

      #distribution-modal-input {
        width: 100%;
        box-sizing: border-box;
      }

      #distribution-modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      #cancel-distribution-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #cancel-distribution-btn:hover {
        background-color: var(--border-dark);
      }

      #save-distribution-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #save-distribution-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Modal Selección de Banco (Gastos Comunes) --- */
      #shared-expense-bank-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 24rem; /* max-w-sm */
        display: flex;
        flex-direction: column;
      }

      #shared-expense-bank-title {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-dark);
        flex-shrink: 0;
        color: var(--text-light-primary);
      }

      #shared-expense-bank-body {
        padding: 1.5rem;
        flex-grow: 1;
      }

      #shared-expense-summary {
        color: var(--text-light-secondary);
        margin-bottom: 1.5rem;
        text-align: center;
        line-height: 1.5;
      }

      #shared-expense-bank-body label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light-primary);
        margin-bottom: 0.5rem;
      }

      #shared-expense-bank-select {
        width: 100%;
        box-sizing: border-box;
      }

      #shared-expense-bank-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border-dark);
        flex-shrink: 0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      #cancel-shared-expense-bank-btn {
        background-color: var(--bg-dark-tertiary);
        color: var(--text-light-primary);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      #cancel-shared-expense-bank-btn:hover {
        background-color: var(--border-dark);
      }

      #confirm-shared-expense-bank-btn {
        background-color: var(--electric-blue);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }
      #confirm-shared-expense-bank-btn:hover {
        background-color: #0c87bf;
      }

      /* --- Modal Tutoriales --- */
      #tutorials-modal.active {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 5000;
        background-color: rgba(17, 24, 39, 0.85);
        backdrop-filter: blur(4px);
      }

      #tutorials-modal-content {
        background-color: var(--bg-dark-secondary);
        border: 1px solid var(--border-dark);
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 90%;
        max-width: 900px;
        display: flex;
        flex-direction: column;
        max-height: 85vh;
      }

      #tutorials-modal-header {
        background-color: var(--bg-dark-primary);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
      }

      #tutorials-modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-light-primary);
      }

      #tutorials-modal-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: auto;
        padding: 1rem;
        gap: 1.5rem;
      }

      #video-player-section {
        flex: 2;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      #current-video-title {
        color: var(--electric-blue);
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-align: center;
      }

      .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        border-radius: 0.5rem;
        border: 1px solid var(--border-dark);
      }

      .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #video-list-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      #video-list-section h4 {
        color: var(--text-light-secondary);
        font-weight: 500;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-dark);
      }

      #tutorials-list {
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .tutorial-list-item {
        padding: 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        border: 1px solid transparent;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        margin-bottom: 0.5rem;
        background-color: var(--bg-dark-tertiary);
      }

      .tutorial-list-item:hover {
        background-color: var(--border-dark);
      }

      .tutorial-list-item.active {
        background-color: rgba(14, 165, 233, 0.15);
        border-color: var(--electric-blue);
      }

      .tutorial-list-item h5 {
        color: var(--text-light-primary);
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .tutorial-list-item p {
        font-size: 0.8rem;
        color: var(--text-light-secondary);
      }

      #proyeccion-content td:nth-child(4),
      #registros-content td:nth-child(4) {
        white-space: nowrap;
      }

      /* ====================================================================== */
      /* 6. MEDIA QUERIES (DISEÑO RESPONSIVO)
      /* ====================================================================== */
      /* --- Vistas de Escritorio y Tablets (min-width) --- */
      @media (min-width: 640px) {
        #transaction-modal-footer {
          flex-direction: row;
        }

        #save-transaction-btn {
          width: auto;
        }
      }

      @media (min-width: 768px) {
        .contenedor-botones {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }
        .recurring-grid-container {
          grid-template-columns: repeat(2, 1fr);
        }

        #save-recurring-btn {
          width: auto;
        }

        #tutorials-modal-body {
          flex-direction: row;
        }
      }

      @media (min-width: 769px) {
        .info-btn {
          display: none;
        }

        #toggle-filters-btn {
          display: none;
        }

        .mobile-date {
          display: inline-block;
          width: auto;
          text-align: center;
          font-size: 1em;
        }

        .desktop-date {
          display: none;
        }

        #tabs {
          justify-content: space-between;
          width: 100%;
          background: #111827d3;
          padding: 0.25rem;
          margin-bottom: 0.5rem;
        }

        .tab-button {
          flex-grow: 1;
          text-align: center;
        }
      }

      /* --- Vistas Móviles (max-width) --- */
      @media (max-width: 768px) {
        #barr {
          display: none;
        }

        #main-header-bar {
          height: auto;
        }

        body {
          margin-top: 6rem !important;
        }

        body.view-content #main-container {
          margin-top: 1rem;
        }

        #tabs {
          padding: 0.25rem;
          margin-bottom: 0.5rem;
          background: #111827d3;
        }

        #dashboard {
          grid-template-columns: 1fr;
        }

        #dashboard .dashboard-card:first-child {
          margin-top: 2rem;
        }

        .dashboard-card {
          padding: 1rem;
          gap: 0.5rem;
        }

        .dashboard-card p:last-child {
          font-size: 1.75rem;
        }

        .dashboard-card p:first-child {
          font-size: 0.8rem;
        }

        .tab-button {
          padding: 0.5rem 0.25rem;
          border-radius: 8px;
          margin-left: 3px;
          margin-right: 3px;
          width: 80px;
          flex-shrink: 0;
          background: transparent;
        }

        .tab-button img {
          height: 64px;
          width: auto;
          margin-bottom: 0;
          padding: 1px;
        }

        .tab-button span {
          font-size: 0.7rem;
          line-height: 1.3;
          text-align: center;
          word-break: break-word;
          hyphens: auto;
        }

        .tab-button.active {
          background-color: transparent;
          transform: scale(1.05);
        }

        #main-action-btn {
          font-size: 0.85rem;
        }

        #main-action-btn:hover {
          height: 20px;
        }

        #logout-tab-btn {
          display: flex;
        }

        #logout-tab-btn .tab-icon-wrapper {
          background-color: #581c1c;
        }

        #logout-tab-btn:hover .tab-icon-wrapper {
          background-color: var(--electric-red);
        }

        /* Ocultar columnas en tablas 
        #tarjetas-content th:nth-child(7),
        #tarjetas-content td:nth-child(7),*/
        #registros-content th:nth-child(3),
        #registros-content td:nth-child(3),
        #registros-content th:nth-child(5),
        #registros-content td:nth-child(5),
        #registros-content th:nth-child(8),
        #registros-content td:nth-child(8),
        #proyeccion-content th:nth-child(3),
        #proyeccion-content td:nth-child(3),
        #proyeccion-content th:nth-child(7),
        #proyeccion-content td:nth-child(7),
        #recurrentes-content th:nth-child(6),
        #recurrentes-content td:nth-child(6),
        #recurrentes-content th:nth-child(7),
        #recurrentes-content td:nth-child(7) {
          display: none;
        }

        /* Corrección de anchos para la tabla de Recurrentes en Móvil */
        #recurrentes-content th,
        #recurrentes-content td {
          white-space: normal; /* Permite que el texto largo (como en Descripción) se divida */
          word-break: break-word;
        }

        /* FORZAR LA COMPRESIÓN DE LA COLUMNA "CATEGORÍA" (la 4ta columna) */
        #recurrentes-content th:nth-child(4),
        #recurrentes-content td:nth-child(4) {
          width: 40px; /* Ancho fijo muy pequeño */
          max-width: 40px; /* Ancho máximo igual al fijo */
          padding-left: 0px;
          padding-right: 0px;
          text-align: center; /* Centra el ícono horizontalmente */
          vertical-align: middle; /* Centra el ícono verticalmente */
          white-space: nowrap; /* Evita que el contenido se divida en varias líneas */
          overflow: hidden; /* Oculta cualquier desbordamiento */
          text-overflow: ellipsis; /* Añade "..." si el contenido es demasiado largo */
        }

        /* Mejora para la columna "Monto" (la 5ta columna), para que no se parta el número */
        #recurrentes-content th:nth-child(5),
        #recurrentes-content td:nth-child(5) {
          padding-left: 0px;
          padding-right: 10px;
          text-align: right;
          white-space: nowrap; /* Evita que el monto se divida en varias líneas */
        }

        #recurrentes-content th:nth-child(2),
        #recurrentes-content td:nth-child(2) {
          min-width: 60px; /* Asegura un ancho mínimo para que el monto sea visible */
        }

        #tarjetas-content th:nth-child(7),
        #tarjetas-content td:nth-child(7) {
          min-width: 120px; /* Asegura un ancho mínimo para que el input sea visible */
        }

        .info-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 1rem;
          height: 1rem;
          margin-left: 8px;
          border-radius: 50%;
          background-color: var(--bg-dark-tertiary);
          color: var(--text-light-secondary);
          border: 1px solid var(--border-dark);
          font-size: 0.65rem;
          font-weight: bold;
          cursor: pointer;
          transition: background-color 0.2s ease, transform 0.2s ease;
          flex-shrink: 0;
        }

        .info-btn:hover {
          background-color: var(--electric-blue);
          color: white;
          transform: scale(1.1);
        }

        #recurrentes-content td:nth-child(4) > span,
        #proyeccion-content td:nth-child(4) > span,
        #registros-content td:nth-child(4) > span {
          display: none;
        }

        #registros-content tbody td:nth-child(4),
        #proyeccion-content tbody td:nth-child(4),
        #recurrentes-content tbody td:nth-child(4) {
          justify-content: left;
        }

        .desktop-date {
          display: none;
        }

        .mobile-date {
          display: inline-block;
          font-weight: 600;
          font-size: 1.1em;
          text-align: center;
          width: 100%;
        }

        #registros-content th,
        #proyeccion-content th,
        #recurrentes-content th,
        #tarjetas-content th,
        #presupuesto-content th {
          font-weight: 400;
          text-transform: none;
        }

        #recurrentes-content td,
        #recurrentes-content th,
        #tarjetas-content td,
        #tarjetas-content th,
        #registros-content td,
        #registros-content th,
        #proyeccion-content td,
        #proyeccion-content th {
          font-size: 1rem;
          padding: 4px 2px;
        }

        .category-cell-content span {
          display: none;
        }

        #filters-container {
          display: none;
          flex-direction: column;
        }

        #filters-container.filters-visible {
          display: flex;
        }

        #toggle-filters-btn {
          display: block;
        }

        #mostrar,
        #main-action-btn,
        #delete-selected-btn,
        #save-budgets-btn,
        #migrate-all-recurring-btn {
          font-size: 0.7rem;
          padding: 2px 6px;
          margin-top: 0rem;
          margin-right: 2px;
        }

        .modal#transaction-modal,
        .modal#recurring-expense-modal,
        .modal#credit-card-modal {
          .p-6.border-b {
            padding-bottom: 1px;
          }

          h2 {
            font-size: 1rem;
            padding: 0.1rem;
          }

          label {
            font-size: 0.75rem;
          }

          input,
          select {
            font-size: 16px !important;
            height: 44px;
            width: 100% !important;
            padding: 0 0.75rem;
            box-sizing: border-box;
          }

          .radio-type-label {
            font-size: 0.8rem;
            padding: 0.4rem 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          #save-transaction-btn,
          #save-recurring-btn,
          #save-credit-card-btn,
          #open-transfer-modal-btn {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
          }

          .modal .p-8.space-y-6 {
            padding: 4px 1rem 1rem 1rem;
          }

          .modal .p-8.space-y-6 > * + * {
            margin-top: 0.25rem;
          }

          .modal .p-6.border-t {
            padding: 0.75rem;
          }
        }

        .modal#transaction-modal .p-6.border-b {
          padding-bottom: 0 !important;
        }

        .modal#transaction-modal .p-8.space-y-6 {
          padding-top: 12px !important;
        }

        .modal#transaction-modal input#transaction-date {
          width: 100% !important;
        }

        #mobile-fullscreen-prompt {
          display: none;
        }

        #mobile-fullscreen-prompt.active {
          display: flex;
        }
      }

      /* --- Estilo para hacer visible el panel de acción única --- */
      #single-action-modal.active #single-action-modal-content {
        transform: translateY(0);
      }

      /* Estilos para la cuadrícula del modal de selección de categoría */
      #category-select-grid {
        display: grid;
        /* Define que habrá varias columnas que se ajustan automáticamente */
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 1rem;
      }

      /* Estilos para cada ítem individual en la cuadrícula */
      .category-select-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid var(--border-dark);
        background-color: var(--bg-dark-tertiary);
        transition: all 0.2s ease-in-out;
        text-align: center;
      }

      .category-select-option:hover {
        transform: scale(1.05);
        border-color: var(--electric-blue);
      }

      /* Controla el tamaño de la imagen (ícono) */
      .category-select-option img {
        width: 40px;
        height: 40px;
        margin-bottom: 4px;
      }

      /* Controla el tamaño del texto debajo del ícono */
      .category-select-option span {
        font-size: 0.7rem;
        line-height: 1.2;
        color: var(--text-light-secondary);
        word-break: break-word;
      }

      .bodymargin {
        margin-top: 14rem;
      }

      /* --- Estilos para la Pantalla de Carga --- */
      /* Ya tenías .loading-overlay en tu CSS, aquí añado el estilo del texto */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(4px);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #loading-overlay .loading-text {
        margin-left: 1rem; /* ml-4 */
        font-size: 1.125rem; /* text-lg */
        color: white; /* text-gray-700 */
      }

      /* --- Contenedor del Modal de Autenticación --- */
      /* La clase .modal y .modal.active ya la tienes, esto añade el posicionamiento y fondo */
      /* --- Contenedor del Modal de Autenticación (Corregido) --- */
      #auth-modal {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        /* -- Líneas añadidas para centrar el contenido -- */
      }

      /* --- Contenido de la tarjeta del Modal --- */
      .auth-modal-content {
        background-color: #ffffff; /* bg-white */
        border-radius: 0.5rem; /* rounded-lg */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
        width: 100%; /* w-full */
        max-width: 28rem; /* max-w-md */
        display: flex;
        flex-direction: column; /* flex flex-col */
      }

      /* --- Título y Subtítulo --- */
      .auth-modal-title {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 700; /* font-bold */
        padding: 0; /* p-0 */
        border-bottom: 1px solid #e5e7eb; /* border-b */
        flex-shrink: 0; /* flex-shrink-0 */
        text-align: center; /* text-center */
      }

      .auth-modal-subtitle {
        font-weight: 100; /* font-thin */
        font-size: 1rem; /* xx-small (interpretado) */
      }

      /* --- Cuerpo y Formulario del Modal --- */
      .auth-modal-body {
        padding: 0.25rem; /* p-1 */
      }

      .auth-modal-intro {
        margin-bottom: 0.25rem; /* mb-1 */
        text-align: center; /* text-center */
      }

      .auth-modal-intro p {
        color: #ebeff4; /* text-gray-600 */
        padding-left: 0.5rem; /* px-1 */
      }

      /* --- Espaciado entre elementos del formulario --- */
      #auth-form > * + * {
        margin-top: 1rem; /* space-y-4 */
      }

      /* --- Etiquetas (Labels) --- */
      #auth-form label {
        display: block; /* block */
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        color: white; /* text-gray-700 */
        margin-bottom: 0.25rem; /* mb-1 */
        padding-left: 0.5rem; /* px-1 */
      }

      /* --- Cajas de Texto (Inputs) --- */
      #auth-form input {
        width: 95%; /* w-full */
        padding: 0.25rem; /* p-1 */
        border: 1px solid #d1d5db; /* border */
        border-radius: 0.5rem; /* rounded-lg */
        margin-left: 0.5rem; /* ml-2 */
        margin-right: 0.5rem; /* mr-2 */
      }

      #auth-form input:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        box-shadow: 0 0 0 2px #60a5fa; /* focus:ring-2 focus:ring-blue-500 */
        border-color: #3b82f6;
      }

      /* --- Contenedor de Botones --- */
      .auth-buttons-container {
        display: flex;
        flex-direction: column; /* flex flex-col */
        justify-content: space-between; /* justify-between */
        gap: 0.75rem; /* gap-3 */
        padding-top: 0.5rem;
        padding-bottom: 1rem; /* pt-4 */
        padding-right: 0.5rem; /* pr-4 */
        padding-left: 0.5rem; /* px-4 */
      }

      /* --- Diseño responsivo para botones (uno al lado del otro en pantallas grandes) --- */
      @media (min-width: 640px) {
        .auth-buttons-container {
          flex-direction: row; /* sm:flex-row */
        }
      }

      /* --- Estilo de los Botones --- */
      #login-btn,
      #register-btn {
        flex: 1 1 0%; /* flex-1 */
        color: #ffffff; /* text-white */
        margin-bottom: 0; /* mb-2 */
        padding: 0.25rem; /* px-1 py-1 */
        border-radius: 0.5rem; /* rounded-lg */
        transition: background-color 0.15s ease-in-out; /* transition */
        display: flex;
        align-items: center;
        justify-content: center; /* flex items-center justify-center */
        border: none;
        cursor: pointer;
      }

      #login-btn {
        background-color: #2563eb; /* bg-blue-600 */
      }
      #login-btn:hover {
        background-color: #1d4ed8; /* hover:bg-blue-700 */
      }

      #register-btn {
        background-color: #16a34a; /* bg-green-600 */
      }
      #register-btn:hover {
        background-color: #15803d; /* hover:bg-green-700 */
      }
    </style>
  </head>
  <body class="bodymargin view-dashboard">
    <div id="ptr-container">
      <div class="ptr-arrow"></div>
      <div class="ptr-spinner"></div>
    </div>
    <div id="mobile-fullscreen-prompt">
      <img
        src="https://res.cloudinary.com/datwdagbf/image/upload/v1756514680/logo_jkwegt.png"
        alt="Logo"
      />
      <h2>Bienvenido a tu Gestor Financiero</h2>
      <p>
        Toca el botón para iniciar en modo de pantalla completa y disfrutar de una mejor
        experiencia.
      </p>
      <button id="enter-fullscreen-btn">Iniciar Aplicación</button>
    </div>

    <div class="loading-overlay active" id="loading-overlay">
      <div class="spinner"></div>
      <p class="loading-text">Cargando datos...</p>
    </div>

    <div id="toast-container"></div>

    <div class="modal" id="auth-modal">
      <div class="auth-modal-content">
        <h2 class="auth-modal-title">
          Foresee Finances, <br /><span class="auth-modal-subtitle">Bienvenido</span>
        </h2>

        <div class="auth-modal-body">
          <div class="auth-modal-intro">
            <p>Inicia sesión o regístrate para acceder a tus datos.</p>
          </div>

          <form id="auth-form">
            <div>
              <label for="auth-email"> Correo Electrónico </label>
              <input id="auth-email" required="" type="email" />
              <span class="input-error-message" id="auth-email-error"> </span>
            </div>

            <div>
              <label for="auth-password"> Contraseña </label>
              <input id="auth-password" required="" type="password" />
              <span class="input-error-message" id="auth-password-error"> </span>
            </div>

            <div class="auth-buttons-container">
              <button id="login-btn" type="submit">
                Iniciar Sesión
                <span class="btn-spinner hidden"></span>
              </button>
              <button id="register-btn" type="button">
                Registrarse
                <span class="btn-spinner hidden"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <header>
      <div id="main-header-bar">
        <div id="barr">
          <img
            src="https://res.cloudinary.com/datwdagbf/image/upload/v1756514680/logo_jkwegt.png"
            alt="Logo"
            class="logotipo"
          />

          <div class="header-center-content">
            <h1>GESTOR FINANCIERO Y DE PRESUPUESTO WEB</h1>
            <p id="ptitul">
              Bienvenido,
              <strong id="user-alias-display">Cargando...</strong>: Tu panel de control financiero,
              moderno y eficiente.
            </p>
            <button id="open-brand-story-btn" class="btn-philosophy">
              Conoce nuestra filosofía
            </button>
          </div>

          <div class="header-right-buttons">
            <button id="IdbtOpenScreen" class="btOpenScreen">Pantalla Completa</button>
            <button id="IdbtCloseScreen" class="btcloseScreen">Mostrar Navegador</button>
            <button class="bttclose" id="logout-btn">
              Cerrar Sesión
              <span class="btn-spinner hidden"></span>
            </button>
          </div>
        </div>

        <div class="contenedor-botones">
          <div class="btn" id="tabs">
            <button class="tab-button" data-tab="registros">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514689/registro_mc8ed8.png"
                alt="Icono Registros"
              />
              <span>Registros</span>
            </button>
            <button class="tab-button" id="quick-voice-record-btn">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/v1757199087/voz_w5ctvq.png"
                alt="Icono Grabar Gasto"
              />
              <span>Voz</span>
            </button>
            <button class="tab-button" data-tab="proyeccion">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514685/proyeccion_hh3xyt.png"
                alt="Icono Proyección"
              />
              <span>Proyección</span>
            </button>
            <button class="tab-button" data-tab="recurrentes">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes2_udrbey.png"
                alt="Icono recurrentes"
              />
              <span>Gastos<br />Recurrentes</span>
            </button>
            <button class="tab-button" data-tab="gastos-comunes">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756767509/comunes_xjuxxt.png"
                alt="Icono Gastos Comunes"
              />
              <span>Gastos<br />Comunes</span>
            </button>
            <button class="tab-button" data-tab="tarjetas">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514697/tarjetas2_z3jokx.png"
                alt="Icono tarjetas"
              />
              <span>Tarjetas<br />de Crédito</span>
            </button>
            <button class="tab-button" data-tab="saldos">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514692/saldos_lntcfz.png"
                alt="Icono saldos"
              />
              <span>Saldos<br />de Cuentas</span>
            </button>
            <button class="tab-button" data-tab="calculadora">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/proyeccion2_iqtpug.png"
                alt="Icono calculadora"
              />
              <span>Calculadora</span>
            </button>
            <button class="tab-button" data-tab="reportes">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/reportes_qisw3e.png"
                alt="Icono reportes"
              />
              <span>Reportes</span>
            </button>
            <button class="tab-button" data-tab="presupuesto">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514684/presupuesto_r7qkr9.png"
                alt="Icono Presupuesto"
              />
              <span>Presupuesto</span>
            </button>
            <button class="tab-button" data-tab="configuración">
              <img
                src="https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/configuracion_puo2ap.png"
                alt="Icono configuración"
              />
              <span>Configuración</span>
            </button>
            <button class="tab-button" id="logout-tab-btn">
              <div class="tab-icon-wrapper">
                <img
                  src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889218/51B410C2-D58E-47D8-9ECC-000296533E2C_udpy1y.png"
                  alt="Icono Salir"
                />
              </div>
              <span>Salir</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div id="main-content-wrapper">
      <div id="dashboard">
        <div id="balance-card" class="dashboard-card">
          <div>
            <p>Saldo Actual</p>
            <p id="current-balance">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img
              src="https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png"
              alt="Icono Saldo Actual"
              class=""
            />
          </div>
        </div>
        <div id="income-card" class="dashboard-card">
          <div>
            <p>Ingresos del Mes</p>
            <p id="monthly-income">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img
              src="https://res.cloudinary.com/datwdagbf/image/upload/v1757548984/ingresos1_mhofiz.png"
              alt="Icono Ingresos"
              class=""
            />
          </div>
        </div>
        <div id="expense-card" class="dashboard-card">
          <div>
            <p>Gastos del Mes</p>
            <p id="monthly-expenses">$0.00</p>
          </div>
          <div class="card-icon-wrapper">
            <img
              src="https://res.cloudinary.com/datwdagbf/image/upload/v1757548983/egresos1_zpgahj.png"
              alt="Icono Gastos"
              class=""
            />
          </div>
        </div>
      </div>

      <div id="credit-card-alerts"></div>
      <div id="recurring-alerts"></div>

      <main id="main-container" class="container mx-auto bg-gray-200 rounded-xl shadow-md mt-24">
        <div class="button-container">
          <div class="action-buttons-left">
            <button id="migrate-all-recurring-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <span>Registrar Todos</span>
              <span class="btn-spinner hidden"></span>
            </button>
            <button id="save-budgets-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <span>Guardar</span>
              <span class="btn-spinner hidden"></span>
            </button>
            <button id="delete-selected-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <span>Eliminar Seleccionados</span>
              <span class="btn-spinner hidden"></span>
            </button>
            <button id="main-action-btn">
              <span id="main-action-btn-text"></span>
            </button>
            <button id="add-income-btn">
              <span>+ Ingreso</span>
            </button>
            <button id="add-expense-btn">
              <span>+ Gasto</span>
            </button>
          </div>

          <div id="filters-container">
            <select id="filter-category">
              <option value="">Todas las categorías</option>
            </select>
            <select id="filter-bank">
              <option value="">Todos los bancos</option>
            </select>
            <input id="filter-month" type="month" />
          </div>

          <div class="action-buttons-right">
            <button id="toggle-filters-btn">Filtros</button>
            <button class="aparecer" id="mostrar">
              <span>X</span>
            </button>
          </div>
        </div>

        <div id="voice-input-panel">
          <label for="voice-text-input">
            Dicta tu transacción aquí. Di "guardar" al final para registrarla automáticamente.
          </label>
          <textarea
            id="voice-text-input"
            rows="3"
            placeholder="Ej: Gasto 50 dólares en gasolina en wells fargo ayer guardar..."
          ></textarea>
          <div class="voice-panel-buttons">
            <button id="save-voice-text-btn">Guardar Voz</button>
            <button id="cancel-voice-text-btn">Cancelar</button>
          </div>
        </div>

        <div id="registros-content" class="tab-pane active">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="select-all-registros" title="Seleccionar Todo" />
                  </th>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th>Categoría</th>
                  <th>Banco</th>
                  <th>Monto</th>
                  <th>Saldo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="transactions-table-body"></tbody>
              <tfoot>
                <tr class="desktop-footer-row">
                  <td colspan="4">Total Ingresos:</td>
                  <td id="registros-total-income">$0.00</td>
                  <td>Total Gastos:</td>
                  <td id="registros-total-expenses">$0.00</td>
                  <td></td>
                </tr>
                <tr class="mobile-footer-row">
                  <td colspan="4">Total Gastos:</td>
                  <td id="mobile-registros-total-expenses">$0.00</td>
                </tr>
                <tr class="mobile-footer-row">
                  <td colspan="4">Total Ingresos:</td>
                  <td id="mobile-registros-total-income">$0.00</td>
                </tr>
              </tfoot>
            </table>
            <p id="no-transactions-message">No hay transacciones para el período seleccionado.</p>
          </div>
        </div>

        <div class="tab-pane hidden" id="proyeccion-content">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="select-all-proyeccion" title="Seleccionar Todo" />
                  </th>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th>Categoría</th>
                  <th>Monto</th>
                  <th>Saldo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="proyeccion-table-body"></tbody>
              <tfoot id="proyeccion-footer">
                <tr class="desktop-footer-row">
                  <td colspan="3">Total Ingresos:</td>
                  <td id="proyeccion-total-income">$0.00</td>
                  <td>Total Gastos:</td>
                  <td id="proyeccion-total-expenses">$0.00</td>
                  <td></td>
                </tr>
                <tr class="mobile-footer-row">
                  <td colspan="4">Total Gastos Proyectados:</td>
                  <td id="mobile-proyeccion-total-expenses">$0.00</td>
                </tr>
                <tr class="mobile-footer-row">
                  <td colspan="4">Total Ingresos Proyectados:</td>
                  <td id="mobile-proyeccion-total-income">$0.00</td>
                </tr>
              </tfoot>
            </table>
            <p id="no-proyeccion-message">No hay transacciones para el período seleccionado.</p>
          </div>
        </div>

        <div class="tab-pane hidden" id="recurrentes-content">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="select-all-recurrentes" title="Seleccionar Todo" />
                  </th>
                  <th>Día</th>
                  <th>Descripción</th>
                  <th>Categoría</th>
                  <th>Monto</th>
                  <th>Banco/Cuenta</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="recurring-expenses-table-body"></tbody>
              <tfoot id="recurrentes-footer">
                <tr class="desktop-footer-row">
                  <td colspan="6">Total Mensual Proyectado</td>
                  <td id="recurring-total">$0.00</td>
                </tr>
                <tr class="mobile-footer-row">
                  <td colspan="4">Total Mensual:</td>
                  <td id="mobile-recurring-total">$0.00</td>
                </tr>
              </tfoot>
            </table>
            <p id="no-recurring-expenses-message">No has añadido ningún gasto recurrente.</p>
          </div>
        </div>
        <div class="tab-pane hidden" id="tarjetas-content">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th title="Excluir del Total Adeudado">Excluir</th>
                  <th>Banco</th>
                  <th>Fecha de Pago</th>
                  <th>Monto Adeudado</th>
                  <th>Línea de Crédito</th>
                  <th>Saldo Disponible</th>
                  <th>Interés (Anual %)</th>
                  <th>Meses para Saldar</th>
                  <th>Pago Mensual Sugerido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="credit-cards-table-body"></tbody>
              <tfoot>
                <tr>
                  <td colspan="3">Totales</td>
                  <td id="cc-total-amount">$0.00</td>
                  <td id="cc-total-limit">$0.00</td>
                  <td id="cc-total-available">$0.00</td>
                  <td colspan="2">Total Pago Mensual Sugerido</td>
                  <td id="cc-total-monthly">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            <p id="no-credit-cards-message">No has añadido ninguna tarjeta de crédito.</p>
          </div>
        </div>

        <div class="tab-pane hidden" id="gastos-comunes-content">
          <div class="shared-buttons-container">
            <button id="add-shared-item-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <span>Añadir Ítem a Pagar</span>
            </button>
            <button id="add-person-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 11a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1v-1z"
                ></path>
              </svg>
              <span>Añadir Persona</span>
            </button>
          </div>
          <div class="table-container">
            <table id="gastos-comunes-table">
              <thead></thead>
              <tbody></tbody>
              <tfoot></tfoot>
            </table>
            <p id="no-shared-expenses-message">
              Aún no hay gastos comunes. ¡Añade un ítem y una persona para empezar!
            </p>
          </div>
          <div id="distribution-popover" class="hidden">
            <div data-method="equal">Dividir en partes iguales</div>
            <div data-method="percentage">Dividir por Porcentaje (%)</div>
            <div data-method="manual">Ingresar Monto Manual</div>
          </div>
        </div>

        <div class="tab-pane hidden" id="saldos-content">
          <h3>Saldos Actuales por Cuenta</h3>
          <div id="bank-balances-grid"></div>
          <p id="no-balances-message">No hay cuentas con transacciones para mostrar saldos.</p>
        </div>

        <div class="tab-pane hidden" id="presupuesto-content">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th>Presupuesto Asignado</th>
                  <th>Monto Gastado</th>
                  <th>Saldo Disponible</th>
                </tr>
              </thead>
              <tbody id="budget-table-body"></tbody>
              <tfoot>
                <tr>
                  <td>Totales</td>
                  <td id="budget-total-budgeted">$0.00</td>
                  <td id="budget-total-spent">$0.00</td>
                  <td id="budget-total-remaining">$0.00</td>
                </tr>
              </tfoot>
            </table>
            <p id="no-categories-for-budget-message">
              No has añadido ninguna categoría en la sección de Configuración.
            </p>
          </div>
        </div>

        <div class="tab-pane hidden" id="reportes-content">
          <div class="reports-grid">
            <div class="reports-column">
              <h3>Gastos por Categoría (Gráfico)</h3>
              <div class="chart-container">
                <canvas id="expenses-chart"> </canvas>
              </div>
            </div>
            <div class="reports-column">
              <h3>Gastos por Categoría (Totales)</h3>
              <div id="category-totals-list"></div>
              <div class="totals-section">
                <div class="totals-row">
                  <span> Total de Gastos: </span>
                  <span id="total-expenses-report"> $0.00 </span>
                </div>
              </div>
            </div>
          </div>
          <div class="reports-footer-section">
            <h3>Flujo de Efectivo Mensual</h3>
            <div class="chart-container">
              <canvas id="cash-flow-chart"> </canvas>
            </div>
          </div>
        </div>

        <div class="tab-pane hidden" id="configuración-content">
          <div class="config-grid">
            <div>
              <h3>Gestionar Categorías</h3>
              <div class="config-button-container">
                <button id="open-add-category-modal-btn">Añadir Nueva Categoría</button>
              </div>
              <div class="config-list-container">
                <ul id="category-list"></ul>
              </div>
            </div>

            <div>
              <h3>Gestionar Bancos/Cuentas</h3>
              <div class="config-button-container">
                <input id="new-bank-name" placeholder="Nombre de nuevo banco" type="text" />
                <span class="input-error-message" id="new-bank-name-error"> </span>
                <button id="add-bank-btn">
                  Añadir Banco
                  <span class="btn-spinner hidden"> </span>
                </button>
              </div>
              <div class="config-list-container">
                <ul id="bank-list"></ul>
              </div>
            </div>

            <div>
              <h3>Gestionar Descripciones</h3>
              <div class="config-list-container">
                <ul id="description-list-config"></ul>
              </div>
            </div>
          </div>

          <div class="config-section">
            <h3>Configuración de Usuario</h3>
            <div class="config-button-container">
              <label for="user-alias">Tu Alias/Nombre Visible</label>
              <input id="user-alias" placeholder="Ej: Mi Presupuesto Feliz" type="text" />
              <span class="input-error-message" id="user-alias-error"> </span>
              <button id="save-alias-btn">
                Guardar Alias
                <span class="btn-spinner hidden"> </span>
              </button>
            </div>
          </div>

          <div class="config-section">
            <h3>Cambiar Contraseña</h3>
            <form id="change-password-form">
              <div>
                <label for="current-password">Contraseña Actual</label>
                <input
                  id="current-password"
                  placeholder="Ingresa tu contraseña actual"
                  type="password"
                  required
                />
                <span class="input-error-message" id="current-password-error"></span>
              </div>
              <div>
                <label for="new-password">Nueva Contraseña</label>
                <input
                  id="new-password"
                  placeholder="Mínimo 6 caracteres"
                  type="password"
                  required
                />
                <span class="input-error-message" id="new-password-error"></span>
              </div>
              <div>
                <label for="confirm-new-password">Confirmar Nueva Contraseña</label>
                <input
                  id="confirm-new-password"
                  placeholder="Repite la nueva contraseña"
                  type="password"
                  required
                />
                <span class="input-error-message" id="confirm-new-password-error"></span>
              </div>
              <button id="change-password-btn" type="submit">
                Actualizar Contraseña
                <span class="btn-spinner hidden"></span>
              </button>
            </form>
          </div>

          <div class="config-section">
            <h3>Acciones de Período</h3>
            <button id="initiate-new-month-btn">
              Iniciar Nuevo Mes
              <span class="btn-spinner hidden"> </span>
            </button>
            <p>Crea un archivo de respaldo y prepara la aplicación para el siguiente mes.</p>
          </div>

          <div class="config-section">
            <h3>Importar y Exportar</h3>
            <div class="config-actions-group">
              <button id="export-pdf-btn">Exportar a PDF</button>
              <button id="export-json-btn">Exportar Datos (JSON)</button>
              <button id="import-json-btn" type="button">
                Importar Datos (JSON)
                <span class="btn-spinner hidden"> </span>
              </button>
              <input accept=".json" class="hidden" id="import-file-input" type="file" />
            </div>
            <p>Guarda o carga los datos de un período específico.</p>
          </div>

          <div class="config-section">
            <h3 class="danger-zone-title">Zona de Peligro</h3>
            <button id="reset-data-btn">
              Reiniciar Todos los Datos
              <span class="btn-spinner hidden"> </span>
            </button>
            <p>¡Cuidado! Esta acción eliminará permanentemente todos los datos actuales.</p>
          </div>
        </div>

        <div class="tab-pane hidden" id="calculadora-content">
          <div class="calculator-wrapper">
            <div class="calculator-card">
              <div id="titucalculadora">
                <h3>Calculadora de Salario Neto Avanzada</h3>
                <p>Estima tu pago en Florida con Overtime y Préstamos (Año Fiscal 2025)</p>
              </div>

              <div class="calculator-grid">
                <div class="calculator-column">
                  <h2>Información de Ingresos</h2>
                  <div class="form-section">
                    <div>
                      <label for="hourlyRate">Tarifa por Hora ($)</label>
                      <input id="hourlyRate" type="number" value="25" />
                    </div>
                    <div>
                      <label for="hoursWorked">Horas Totales Trabajadas (Quincenal)</label>
                      <input id="hoursWorked" type="number" value="80" />
                    </div>
                    <div>
                      <label for="filingStatus">Estado Civil Tributario</label>
                      <select id="filingStatus">
                        <option value="single">Soltero/a</option>
                        <option value="married">Casado/a (declaración conjunta)</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="calculator-column">
                  <h2>Deducciones Voluntarias</h2>
                  <div class="deductions-grid">
                    <div>
                      <label for="contribution401kType">Tipo 401(k)</label>
                      <select id="contribution401kType">
                        <option value="percent">% del Salario</option>
                        <option value="amount">Monto Fijo ($)</option>
                      </select>
                    </div>
                    <div>
                      <label for="contribution401kValue" id="contribution401kLabel"
                        >Valor 401(k)</label
                      >
                      <input id="contribution401kValue" type="number" value="5" />
                    </div>
                  </div>
                  <div class="form-section" style="margin-top: 1rem">
                    <div>
                      <label for="medicalDeduction">Seguro Médico ($ por período)</label>
                      <input id="medicalDeduction" type="number" value="150" />
                    </div>
                    <div>
                      <label for="dentalDeduction">Seguro Dental ($ por período)</label>
                      <input id="dentalDeduction" type="number" value="20" />
                    </div>
                    <div>
                      <label for="visionDeduction">Seguro de Visión ($ por período)</label>
                      <input id="visionDeduction" type="number" value="10" />
                    </div>
                    <div>
                      <label for="loan401k">Préstamo de 401(k) ($ por período)</label>
                      <input id="loan401k" type="number" value="0" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="calculate-btn-container">
                <button id="calculateBtn">Calcular Salario Neto</button>
              </div>

              <div id="results" class="hidden">
                <h2>Resumen del Pago</h2>
                <div class="result-grid">
                  <div class="result-item">
                    <p>Salario Bruto</p>
                    <p id="grossPayResult">$0.00</p>
                  </div>
                  <div class="result-item">
                    <p>Deduc. Pre-Impuestos</p>
                    <p id="preTaxDeductionsResult">$0.00</p>
                  </div>
                  <div class="result-item">
                    <p>Impuesto Federal</p>
                    <p id="federalTaxResult">$0.00</p>
                  </div>
                  <div class="result-item">
                    <p>Impuestos FICA</p>
                    <p id="ficaTaxResult">$0.00</p>
                  </div>
                  <div class="result-item">
                    <p>Deduc. Post-Impuestos</p>
                    <p id="postTaxDeductionsResult">$0.00</p>
                  </div>
                </div>
                <div class="net-pay-section">
                  <p>Tu Salario Neto Estimado es:</p>
                  <p id="netPayResult">$0.00</p>
                  <p class="net-pay-period">por período de pago quincenal</p>
                </div>
              </div>

              <div class="disclaimer">
                <p>
                  <strong>Descargo de responsabilidad:</strong>
                  Esta es una herramienta de estimación. Las cifras reales pueden variar. El cálculo
                  del impuesto federal es una aproximación. El límite anual del Seguro Social no se
                  tiene en cuenta en este cálculo por período.
                </p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="modal" id="transaction-modal">
      <div id="transaction-modal-content">
        <div id="transaction-modal-header">
          <h2 id="modal-title">Registrar Transacción</h2>
          <div>
            <button id="voice-recognition-btn" type="button" title="Registrar por Voz">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                class="bi bi-mic-fill"
                viewBox="0 0 16 16"
              >
                <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0z" />
                <path
                  d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"
                />
              </svg>
            </button>
            <button id="close-transaction-modal-btn" type="button">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <form id="transaction-form" novalidate>
          <div id="transaction-modal-body">
            <input id="transaction-id" type="hidden" />
            <input id="transaction-type-hidden" type="hidden" />

            <div class="guided-form-field">
              <label for="transaction-date" class="guided-form-label">Fecha</label>
              <input id="transaction-date" required type="date" class="guided-form-input" />
              <span class="input-error-message" id="transaction-date-error"></span>
            </div>

            <div class="guided-form-field">
              <label for="category-select-button" class="guided-form-label">Categoría</label>
              <button type="button" id="category-select-button" class="guided-form-category-button">
                <span>Seleccionar Categoría...</span>
              </button>
              <input type="hidden" id="transaction-category-hidden" required />
              <span class="input-error-message" id="transaction-category-error"></span>
            </div>

            <div class="guided-form-field">
              <label for="transaction-amount" class="guided-form-label">Monto</label>
              <input
                id="transaction-amount"
                required
                step="0.01"
                type="number"
                placeholder="0.00"
                class="guided-form-input"
              />
              <span class="input-error-message" id="transaction-amount-error"></span>
            </div>

            <div class="guided-form-field">
              <label for="transaction-bank" class="guided-form-label">Banco/Cuenta</label>
              <select id="transaction-bank" required class="guided-form-select"></select>
              <span class="input-error-message" id="transaction-bank-error"></span>
            </div>

            <div class="guided-form-field">
              <label for="transaction-description" class="guided-form-label">Descripción</label>
              <input
                id="transaction-description"
                list="description-list"
                required
                type="text"
                placeholder="Ej: Compra de supermercado"
                class="guided-form-input"
              />
              <datalist id="description-list"></datalist>
              <span class="input-error-message" id="transaction-description-error"></span>
            </div>
          </div>

          <div id="transaction-modal-footer">
            <button id="open-transfer-modal-btn" type="button">Transferencia Interna</button>
            <div>
              <button id="save-transaction-btn" type="submit">
                Guardar y Registrar Otro
                <span class="btn-spinner hidden"></span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="transfer-modal">
      <div>
        <h2>Registrar Transferencia Interna</h2>
        <form id="transfer-form">
          <div>
            <div class="form-field">
              <label for="transfer-date">Fecha</label>
              <input id="transfer-date" required="" type="date" />
              <span class="input-error-message" id="transfer-date-error"></span>
            </div>
            <div class="form-field">
              <label for="transfer-from-bank">Desde la cuenta</label>
              <select id="transfer-from-bank" required=""></select>
              <span class="input-error-message" id="transfer-from-bank-error"></span>
            </div>
            <div class="form-field">
              <label for="transfer-to-bank">Hacia la cuenta</label>
              <select id="transfer-to-bank" required=""></select>
              <span class="input-error-message" id="transfer-to-bank-error"></span>
            </div>
            <div class="form-field">
              <label for="transfer-amount">Monto a Transferir</label>
              <input id="transfer-amount" required="" step="0.01" type="number" />
              <span class="input-error-message" id="transfer-amount-error"></span>
            </div>
          </div>
          <div>
            <button id="transfer-cancel-btn" type="button">Cancelar</button>
            <button id="confirm-transfer-btn" type="submit">
              Confirmar Transferencia
              <span class="btn-spinner hidden"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="recurring-expense-modal">
      <div id="recurring-modal-content">
        <div id="recurring-modal-header">
          <h2 id="recurring-modal-title">Añadir Gasto Recurrente</h2>
          <button id="close-recurring-modal-btn" type="button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="recurring-expense-form" novalidate>
          <div id="recurring-modal-body">
            <input id="recurring-expense-id" type="hidden" />

            <div>
              <label for="recurring-description">Descripción</label>
              <input
                id="recurring-description"
                list="description-list"
                required
                type="text"
                placeholder="Ej: Pago de Alquiler"
              />
              <span class="input-error-message" id="recurring-description-error"></span>
            </div>

            <div class="recurring-grid-container">
              <div>
                <label for="recurring-category">Categoría</label>
                <select id="recurring-category" required></select>
                <span class="input-error-message" id="recurring-category-error"></span>
              </div>
              <div>
                <label for="recurring-bank">Banco/Cuenta</label>
                <select id="recurring-bank" required></select>
                <span class="input-error-message" id="recurring-bank-error"></span>
              </div>
            </div>

            <div class="recurring-grid-container">
              <div>
                <label for="recurring-amount">Monto Fijo Mensual</label>
                <input
                  id="recurring-amount"
                  required
                  step="0.01"
                  type="number"
                  placeholder="0.00"
                />
                <span class="input-error-message" id="recurring-amount-error"></span>
              </div>
              <div>
                <label for="recurring-day">Día de Pago (1-31)</label>
                <input
                  id="recurring-day"
                  max="31"
                  min="1"
                  required
                  type="number"
                  placeholder="Ej: 15"
                />
                <span class="input-error-message" id="recurring-day-error"></span>
              </div>
            </div>
          </div>

          <div id="recurring-modal-footer">
            <button id="save-recurring-btn" type="submit">
              Guardar y Añadir Otro
              <span class="btn-spinner hidden"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="credit-card-modal">
      <div>
        <h2>Añadir Tarjeta</h2>
        <form id="credit-card-form">
          <div>
            <div class="form-field full-width-field">
              <label for="credit-card-bank">Banco</label>
              <input
                id="credit-card-bank"
                placeholder="Ej: Banco Mercantil"
                required=""
                type="text"
              />
              <span class="input-error-message" id="credit-card-bank-error"></span>
            </div>

            <div class="form-field">
              <label for="credit-card-due-date">Día de Pago (1-31)</label>
              <input id="credit-card-due-date" max="31" min="1" required="" type="number" />
              <span class="input-error-message" id="credit-card-due-date-error"></span>
            </div>
            <div class="form-field">
              <label for="credit-card-amount">Monto Adeudado</label>
              <input id="credit-card-amount" required="" step="0.01" type="number" />
              <span class="input-error-message" id="credit-card-amount-error"></span>
            </div>
            <div class="form-field">
              <label for="credit-card-rate">Interés (Anual %)</label>
              <input id="credit-card-rate" required="" step="0.01" type="number" />
              <span class="input-error-message" id="credit-card-rate-error"></span>
            </div>
            <div class="form-field">
              <label for="credit-card-months">Meses para Saldar</label>
              <input id="credit-card-months" min="1" required="" type="number" />
              <span class="input-error-message" id="credit-card-months-error"></span>
            </div>
          </div>
          <div>
            <button id="credit-card-cancel-btn" type="button">Cancelar</button>
            <button id="save-credit-card-btn" type="submit">
              Añadir Tarjeta
              <span class="btn-spinner hidden"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal" id="confirm-modal">
      <div>
        <div>
          <svg
            aria-hidden="true"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewbox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              stroke-linecap="round"
              stroke-linejoin="round"
            ></path>
          </svg>
        </div>
        <h2 id="confirm-modal-title">Confirmar Acción</h2>
        <p id="confirm-modal-message">¿Estás seguro? Esta acción no se puede deshacer.</p>
        <div>
          <button id="confirm-modal-cancel-btn" type="button">Cancelar</button>
          <button id="confirm-modal-confirm-btn" type="button">Confirmar</button>
        </div>
      </div>
    </div>
    <div class="modal" id="message-modal">
      <div>
        <h2 id="message-modal-title">Mensaje</h2>
        <p id="message-modal-content"></p>
        <button id="message-modal-close-btn" type="button">Cerrar</button>
      </div>
    </div>
    <div class="modal" id="brand-story-modal">
      <div id="brand-story-content">
        <div id="brand-story-header">
          <h2>El Corazón de Foresee Finances</h2>
          <button id="close-brand-story-btn">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="brand-story-body">
          <div class="story-separator">
            <h3>El Origen de Foresee Finances: Una Historia Personal</h3>
            <p>
              Mi nombre es Melecio Matos, el creador de Foresee Finances. Esta aplicación no nació
              en una sala de juntas, sino a partir de conversaciones reales con amigos y familiares.
              Vi a personas trabajadoras, inteligentes y llenas de metas, sentirse atrapadas por el
              estrés financiero. Veía cómo la falta de un sistema simple para entender su propio
              dinero les robaba la tranquilidad y les impedía avanzar.
            </p>
            <p>
              Frustrado con las aplicaciones existentes, que eran o demasiado complejas o demasiado
              invasivas (exigiendo acceso a sus cuentas bancarias), decidí crear la solución que yo
              mismo querría usar. Una herramienta que respetara la privacidad del usuario y que se
              basara en un principio simple: <strong>la claridad es poder.</strong>
            </p>
            <p>
              Foresee Finances fue diseñada para ser ese amigo honesto que te muestra la verdad de
              tus números sin juzgarte. Es el resultado de cientos de horas de desarrollo puestas al
              servicio de una sola idea: darte un mapa claro y sencillo de tu mundo financiero para
              que <strong>tú</strong>, y solo tú, seas el capitán de tu destino económico.
            </p>
          </div>
          <div>
            <h3>Nuestra Misión</h3>
            <p class="italic">
              Empoderar a cada persona para que tome decisiones financieras con claridad y
              confianza, transformando la ansiedad económica en paz mental y la incertidumbre en un
              plan de acción para alcanzar sus sueños.
            </p>
          </div>
          <div>
            <h3>Nuestra Visión</h3>
            <p class="italic">
              Ser el aliado digital más intuitivo y confiable en el camino hacia el bienestar
              financiero, demostrando que con las herramientas adecuadas, cualquiera puede dominar
              sus finanzas personales y construir un futuro próspero.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="privacy-policy-modal">
      <div class="legal-modal-content">
        <div class="legal-modal-header">
          <h2>Política de Privacidad</h2>
          <button class="close-legal-modal">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="legal-modal-body">
          <p><strong>Última actualización: 12 de agosto de 2025</strong></p>
          <p>
            Bienvenido a Foresee. Tu privacidad es de suma importancia para nosotros. Esta Política
            de Privacidad explica qué datos personales recopilamos, cómo los utilizamos, con quién
            los compartimos y los derechos que tienes sobre tu información. Al registrarte y
            utilizar Foresee, aceptas las prácticas descritas en esta política.
          </p>

          <h3>1. Responsable del Tratamiento</h3>
          <p>
            El responsable del tratamiento de tus datos es:<br />
            <strong>Nombre:</strong> Melecio Matos<br />
            <strong>Correo electrónico de contacto:</strong> albertomatosgil@gmail.com
          </p>

          <h3>2. Datos que Recopilamos</h3>
          <p>Recopilamos la siguiente información para poder ofrecerte nuestros servicios:</p>
          <ul>
            <li>
              <strong>Datos de Identificación y Contacto:</strong> Dirección de correo electrónico,
              contraseña (almacenada de forma segura) y el alias que elijas.
            </li>
            <li>
              <strong>Datos Financieros:</strong> Toda la información que introduces voluntariamente
              en la aplicación, como transacciones, presupuestos, categorías, bancos, etc.
            </li>
          </ul>

          <h3>3. Finalidad del Uso de Datos</h3>
          <p>Utilizamos tus datos para:</p>
          <ul>
            <li>
              <strong>Proveer y mantener el servicio:</strong> Autenticar tu acceso, gestionar tu
              presupuesto y organizar tus finanzas.
            </li>
            <li>
              <strong>Mejorar la aplicación:</strong> Analizar datos de uso de forma anónima para
              identificar errores y mejorar la experiencia.
            </li>
            <li>
              <strong>Comunicarnos contigo:</strong> Enviarte notificaciones importantes sobre tu
              cuenta o cambios en nuestros servicios.
            </li>
          </ul>

          <h3>4. Terceros con los que Compartimos Datos</h3>
          <p>
            No vendemos tus datos personales. Utilizamos los servicios de
            <strong>Google (Firebase y Firestore)</strong> para la autenticación y el almacenamiento
            seguro de toda tu información en la nube.
          </p>

          <h3>5. Derechos del Usuario (Derechos ARCO)</h3>
          <p>
            Tienes derecho a ejercer tus derechos de Acceso, Rectificación, Cancelación y Oposición:
          </p>
          <ul>
            <li>
              <strong>Acceso y Rectificación:</strong> Puedes editar casi toda tu información
              directamente desde la aplicación.
            </li>
            <li>
              <strong>Cancelación:</strong> Puedes eliminar datos específicos o usar la función
              "Reiniciar Todos los Datos" para borrar toda tu información financiera.
            </li>
            <li>
              <strong>Oposición:</strong> Puedes retirar tu consentimiento eliminando tu cuenta.
            </li>
          </ul>

          <h3>6. Seguridad de los Datos</h3>
          <p>
            Confiamos en la infraestructura segura y robusta de Google Firebase para la
            autenticación, el almacenamiento y la encriptación de tus datos, aplicando las mejores
            prácticas de seguridad.
          </p>

          <h3>7. Cambios en esta Política</h3>
          <p>
            Te notificaremos de cualquier cambio importante a través de la aplicación o por correo
            electrónico.
          </p>

          <h3>8. Contacto</h3>
          <p>
            Si tienes preguntas, contáctanos en:
            <strong>albertomatosgil@gmail.com</strong>
          </p>
        </div>
      </div>
    </div>

    <div class="modal" id="terms-conditions-modal">
      <div class="legal-modal-content">
        <div class="legal-modal-header">
          <h2>Términos y Condiciones</h2>
          <button class="close-legal-modal">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="legal-modal-body">
          <p><strong>Última actualización: 12 de agosto de 2025</strong></p>
          <p>
            Estos Términos y Condiciones ("Términos") rigen tu acceso y uso de la aplicación de
            finanzas personales Foresee ("la Aplicación", "el Servicio"). Al registrarte o utilizar
            la Aplicación, aceptas estar legalmente vinculado por estos Términos.
          </p>

          <h3>1. Descripción del Servicio</h3>
          <p>
            Foresee es una herramienta digital diseñada para ayudarte a registrar, categorizar y
            visualizar tus finanzas personales. La Aplicación es una herramienta de estimación y
            organización y no debe ser considerada como asesoramiento financiero, legal o fiscal.
          </p>

          <h3>2. Cuentas de Usuario</h3>
          <ul>
            <li>
              <strong>Creación de Cuenta:</strong> Para usar Foresee, debes registrarte con una
              dirección de correo electrónico válida y crear una contraseña.
            </li>
            <li>
              <strong>Responsabilidad del Usuario:</strong> Eres el único responsable de mantener la
              confidencialidad de tu contraseña y de toda la actividad que ocurra en tu cuenta.
            </li>
            <li>
              <strong>Exactitud de la Información:</strong> Eres responsable de la exactitud de la
              información financiera que introduces en la Aplicación.
            </li>
          </ul>

          <h3>3. Uso Aceptable</h3>
          <p>
            Te comprometes a no utilizar la Aplicación para ningún propósito ilegal o no autorizado.
          </p>

          <h3>4. Propiedad Intelectual</h3>
          <p>
            El Servicio y todo su contenido son propiedad exclusiva de Melecio Matos. La Aplicación
            está protegida por derechos de autor. No es de código abierto y todos los derechos están
            reservados.
          </p>

          <h3>5. Limitación de Responsabilidad y Descargo de Garantías</h3>
          <p>
            <strong>Por favor, lee esta sección con atención.</strong> La Aplicación se proporciona
            "tal cual", sin garantías. Las decisiones financieras que tomes basándote en la
            información de la Aplicación son de tu exclusiva responsabilidad. No seremos
            responsables por pérdidas económicas o daños derivados del uso de la Aplicación.
          </p>

          <h3>6. Terminación del Servicio</h3>
          <p>
            Puedes dejar de usar el servicio en cualquier momento. Nos reservamos el derecho de
            suspender tu cuenta si violas estos Términos.
          </p>

          <h3>7. Cambios en los Términos</h3>
          <p>
            Nos reservamos el derecho de modificar estos Términos. Te notificaremos de los cambios
            importantes.
          </p>

          <h3>8. Contacto</h3>
          <p>
            Si tienes alguna pregunta sobre estos Términos, contáctanos en:
            <strong>albertomatosgil@gmail.com</strong>
          </p>
        </div>
      </div>
    </div>

    <div class="modal" id="cookie-policy-modal">
      <div class="legal-modal-content">
        <div class="legal-modal-header">
          <h2>Política de Cookies</h2>
          <button class="close-legal-modal">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="legal-modal-body">
          <p><strong>Última actualización: 12 de agosto de 2025</strong></p>
          <p>
            Esta Política de Cookies explica cómo Foresee ("nosotros", "nuestro") utiliza cookies y
            tecnologías similares para reconocerte cuando visitas nuestra aplicación web.
          </p>

          <h3>1. ¿Qué son las cookies?</h3>
          <p>
            Las cookies son pequeños archivos de datos que se colocan en tu dispositivo para que los
            sitios web funcionen de manera más eficiente y proporcionen información de informes.
          </p>

          <h3>2. ¿Por qué usamos cookies?</h3>
          <p>
            No creamos cookies personalizadas con fines de seguimiento o publicidad. Sin embargo,
            nuestro proveedor de infraestructura, <strong>Firebase (de Google)</strong>, las utiliza
            por razones técnicas esenciales para el funcionamiento de Foresee, tales como:
          </p>
          <ul>
            <li>
              <strong>Cookies Técnicas o Esenciales:</strong> Son estrictamente necesarias para
              proporcionarte los servicios de la Aplicación.
            </li>
            <li>
              <strong>Autenticación y Sesión:</strong> Permiten que te mantengas conectado mientras
              navegas por la aplicación.
            </li>
            <li><strong>Seguridad:</strong> Ayudan a proteger tu cuenta y prevenir riesgos.</li>
          </ul>

          <h3>3. Tipos de Cookies que Utilizamos</h3>
          <ul>
            <li>
              <strong>Cookies de Sesión:</strong> Son temporales y se eliminan al cerrar el
              navegador.
            </li>
            <li>
              <strong>Cookies Persistentes:</strong> Permanecen en tu dispositivo y pueden usarse
              para recordar que has iniciado sesión previamente.
            </li>
          </ul>

          <h3>4. Cómo puedes gestionar las cookies</h3>
          <p>
            Puedes controlar las cookies a través de la configuración de tu navegador. Sin embargo,
            si decides deshabilitar las cookies esenciales utilizadas por Firebase,
            <strong>no podrás iniciar sesión ni utilizar la aplicación Foresee</strong>, ya que son
            fundamentales para su funcionamiento.
          </p>

          <h3>5. Cambios en esta Política de Cookies</h3>
          <p>
            Podemos actualizar esta Política ocasionalmente. Te notificaremos de cualquier cambio
            importante a través de la aplicación o por correo electrónico.
          </p>

          <h3>6. Contacto</h3>
          <p>
            Si tienes preguntas sobre nuestra Política de Cookies, contáctanos en:
            <strong>albertomatosgil@gmail.com</strong>
          </p>
        </div>
      </div>
    </div>

    <div class="modal" id="category-icon-modal">
      <div id="category-icon-modal-content">
        <div id="category-icon-modal-header">
          <h2>Selecciona un Ícono para la Categoría</h2>
          <button id="close-icon-modal-btn">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="category-icon-modal-body">
          <div>
            <label for="new-category-name-modal"> Nombre de la Nueva Categoría </label>
            <input
              id="new-category-name-modal"
              placeholder="Ej: Vivienda, Comida, Ocio"
              type="text"
            />
            <span class="input-error-message" id="new-category-name-modal-error"></span>
          </div>

          <label> Elige un ícono (o déjalo en "Por Defecto") </label>
          <div id="category-icon-grid"></div>
        </div>
        <div id="category-icon-modal-footer">
          <button id="save-new-category-btn" type="button">
            Guardar Categoría
            <span class="btn-spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="single-action-modal">
      <div id="single-action-modal-content">
        <p id="single-action-modal-title">Acción para el elemento seleccionado:</p>
        <div>
          <button id="single-action-edit-btn">Editar Selección</button>
          <button id="single-action-delete-btn">Eliminar Selección</button>
          <button id="single-action-cancel-btn">Cancelar</button>
        </div>
      </div>
    </div>

    <div class="modal" id="import-options-modal">
      <div id="import-options-modal-content">
        <div id="import-options-modal-header">
          <h2>Opciones de Importación</h2>
          <button id="close-import-options-btn">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="import-options-modal-body">
          <div>
            <p>
              Selecciona las secciones que deseas importar desde el archivo JSON. Las secciones que
              selecciones reemplazarán los datos actuales.
            </p>
            <button id="select-import-file-btn">Seleccionar Archivo JSON</button>
            <p id="selected-file-name">Ningún archivo seleccionado.</p>
          </div>
          <div id="import-checkboxes-container" class="hidden">
            <h3>Secciones a Importar:</h3>
            <label>
              <input type="checkbox" id="import-all-checkbox" />
              <span class="import-label-bold">Importar Todo</span>
            </label>
            <hr />
            <label>
              <input type="checkbox" data-section="transactions" class="import-section-checkbox" />
              <span>Registros (Transacciones)</span>
            </label>
            <label>
              <input type="checkbox" data-section="projections" class="import-section-checkbox" />
              <span>Proyección</span>
            </label>
            <label>
              <input
                type="checkbox"
                data-section="recurringExpenses"
                class="import-section-checkbox"
              />
              <span>Gastos Recurrentes</span>
            </label>
            <label>
              <input type="checkbox" data-section="creditCards" class="import-section-checkbox" />
              <span>Tarjetas de Crédito</span>
            </label>
            <label>
              <input type="checkbox" data-section="budgets" class="import-section-checkbox" />
              <span>Presupuestos</span>
            </label>
            <label>
              <input type="checkbox" data-section="config" class="import-section-checkbox" />
              <span>Configuración (Categorías, Bancos, Descripciones)</span>
            </label>
            <label>
              <input type="checkbox" data-section="general" class="import-section-checkbox" />
              <span>General (Saldo Inicial y Alias)</span>
            </label>
          </div>
        </div>
        <div id="import-options-modal-footer">
          <button id="cancel-import-btn" type="button">Cancelar</button>
          <button id="confirm-import-btn" type="button" disabled>
            Confirmar Importación
            <span class="btn-spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="category-select-modal">
      <div id="category-select-modal-content">
        <div id="category-select-modal-header">
          <h2>Selecciona una Categoría</h2>
          <button id="close-category-select-modal-btn">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div id="category-select-modal-body">
          <div>
            <button id="open-add-category-from-select-btn">+ Añadir Nueva Categoría</button>
          </div>
          <div id="category-select-grid"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="distribution-input-modal">
      <div id="distribution-modal-content">
        <h2 id="distribution-modal-title">Ingresar Valor</h2>
        <div id="distribution-modal-body">
          <form id="distribution-form">
            <div>
              <label id="distribution-modal-label" for="distribution-modal-input"> Valor </label>
              <input id="distribution-modal-input" required="" step="0.01" type="number" />
              <span class="input-error-message" id="distribution-modal-error"></span>
            </div>
          </form>
        </div>
        <div id="distribution-modal-footer">
          <button id="cancel-distribution-btn" type="button">Cancelar</button>
          <button id="save-distribution-btn" type="submit" form="distribution-form">Guardar</button>
        </div>
      </div>
    </div>

    <div class="modal" id="shared-expense-bank-modal">
      <div id="shared-expense-bank-content">
        <h2 id="shared-expense-bank-title">Seleccionar Banco para el Pago</h2>
        <div id="shared-expense-bank-body">
          <p id="shared-expense-summary"></p>
          <div>
            <label for="shared-expense-bank-select"> Banco/Cuenta de Origen </label>
            <select id="shared-expense-bank-select" required=""></select>
            <span class="input-error-message" id="shared-expense-bank-error"></span>
          </div>
        </div>
        <div id="shared-expense-bank-footer">
          <button id="cancel-shared-expense-bank-btn" type="button">Cancelar</button>
          <button id="confirm-shared-expense-bank-btn" type="submit">
            Registrar Pago
            <span class="btn-spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>

    <button id="open-tutorials-btn" title="Ver Videos Tutoriales">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="28"
        height="28"
        fill="currentColor"
        class="bi bi-play-btn-fill"
        viewBox="0 0 16 16"
      >
        <path
          d="M0 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2m6.79-6.907A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814z"
        />
      </svg>
    </button>

    <div class="modal" id="tutorials-modal">
      <div id="tutorials-modal-content">
        <div id="tutorials-modal-header">
          <h2 id="tutorials-modal-title">Videos Tutoriales</h2>
          <button id="close-tutorials-modal-btn" type="button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="tutorials-modal-body">
          <div id="video-player-section">
            <h3 id="current-video-title">Cargando video...</h3>
            <div class="video-container">
              <iframe
                id="tutorial-video-player"
                src=""
                title="Reproductor de Video Tutorial"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
          </div>
          <div id="video-list-section">
            <h4>Lista de Videos</h4>
            <div id="tutorials-list"></div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-container">
        <p>© 2025 Foresee Finances. Todos los derechos reservados. by Melecio Matos</p>
        <p id="app-version">Versión 0.0.3.7</p>
        <div class="footer-links">
          <a href="#" id="open-privacy-policy">Política de Privacidad</a>
          <span>|</span>
          <a href="#" id="open-terms-conditions">Términos de Uso</a>
          <span>|</span>
          <a href="#" id="open-cookie-policy">Política de Cookies</a>
        </div>
      </div>
    </footer>

    <script src="numberParser.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const { jsPDF } = window.jspdf;
        const app = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        const onAuthStateChanged = window.onAuthStateChanged;
        const signInAnonymously = window.signInAnonymously;
        const signInWithCustomToken = window.signInWithCustomToken;
        const doc = window.doc;
        const getDoc = window.getDoc;
        const setDoc = window.setDoc;
        const updateDoc = window.updateDoc;
        const deleteDoc = window.deleteDoc;
        const onSnapshot = window.onSnapshot;
        const collection = window.collection;
        const query = window.query;
        const getDocs = window.getDocs;
        const writeBatch = window.writeBatch;

        // --- Lógica de Pull-to-Refresh Manual
        const ptrContainer = document.getElementById('ptr-container');
        const ptrArrow = ptrContainer.querySelector('.ptr-arrow');
        let touchStartY = 0;
        let isRefreshing = false;
        let isInteractingWithElement = false;
        const pullThreshold = 80; // La distancia que el usuario debe deslizar para que se active el refresco.

        // Esta es la acción principal que se ejecuta al refrescar.
        async function handleRefresh() {
          isRefreshing = true;
          ptrContainer.classList.add('refreshing');
          ptrContainer.style.transform = 'translateY(0)'; // Mantiene el spinner visible mientras carga.

          showToast('Actualizando datos...', 'info', 2000);
          try {
            // AQUÍ OCURRE LA MAGIA: Llamamos a tu función que carga todo desde Firebase.
            await loadUserDataAndListen();
            showToast('¡Datos actualizados!', 'success');
          } catch (error) {
            console.error('Error durante el refresco manual:', error);
            showToast('No se pudieron actualizar los datos.', 'error');
          } finally {
            // Al terminar (con éxito o error), se oculta y resetea el indicador.
            resetPullToRefresh();
          }
        }

        // Esta función limpia y oculta el indicador.
        function resetPullToRefresh() {
          ptrContainer.style.transform = 'translateY(-100%)';
          ptrContainer.classList.remove('refreshing');
          ptrArrow.classList.remove('release');
          // Retrasamos un poco el cambio de 'isRefreshing' para que las animaciones terminen.
          setTimeout(() => {
            isRefreshing = false;
          }, 300);
        }

        // Se activa cuando el usuario PONE el dedo en la pantalla.
        function handleTouchStart(e) {
          // Verificamos si el toque comenzó en un botón, enlace u otro control.
          const targetElement = e.target;
          if (targetElement.closest('button, a, input, select, .tab-button')) {
            isInteractingWithElement = true; // Activamos la bandera
            return; // Salimos para no iniciar el pull-to-refresh
          }
          isInteractingWithElement = false; // Reseteamos la bandera

          if (isRefreshing || window.scrollY > 0) {
            touchStartY = 0;
            return;
          }
          touchStartY = e.touches[0].clientY;
        }

        // Se activa cuando el usuario MUEVE el dedo por la pantalla.
        function handleTouchMove(e) {
          // Si la interacción comenzó en un botón, no hacemos nada aquí.
          if (isInteractingWithElement) {
            return;
          }

          if (isRefreshing || touchStartY === 0) return;

          const currentY = e.touches[0].clientY;
          let pullDistance = currentY - touchStartY;

          if (pullDistance < 0) {
            touchStartY = 0;
            resetPullToRefresh();
            return;
          }

          if (window.scrollY === 0) {
            e.preventDefault(); // Esta línea ahora solo se ejecuta si NO se está interactuando con un botón.

            ptrContainer.style.transform = `translateY(${pullDistance - 60}px)`;

            if (pullDistance > pullThreshold) {
              ptrArrow.classList.add('release');
            } else {
              ptrArrow.classList.remove('release');
            }
          }
        }

        // Se activa cuando el usuario QUITA el dedo de la pantalla.
        function handleTouchEnd(e) {
          // Si se estaba interactuando con un elemento, solo reseteamos la bandera y salimos.
          if (isInteractingWithElement) {
            isInteractingWithElement = false;
            return;
          }

          if (isRefreshing || touchStartY === 0) return;

          const pullDistance = e.changedTouches[0].clientY - touchStartY;

          if (pullDistance > pullThreshold) {
            handleRefresh();
          } else {
            resetPullToRefresh();
          }

          touchStartY = 0;
        }

        if (!app || !db || !auth) {
          console.error('[App Init] Firebase no inicializado. La aplicación no puede funcionar.');
          return;
        }

        const firebaseProjectId = window.firebaseProjectId;
        if (!firebaseProjectId) {
          console.error(
            '[App Init] Firebase Project ID no disponible. No se pueden construir las rutas de Firestore.',
          );
          showMessageModal(
            'Error de Configuración',
            'El ID del proyecto Firebase no está disponible. Recarga la página o verifica tu configuración.',
            'error',
          );
          hideLoading();
          return;
        }

        const DEFAULT_ICON =
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514669/dinero_hgnyz4.png';

        const PRESET_ICONS = [
          DEFAULT_ICON,
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514703/vivienda_bsyk94.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/v1756889458/AA7C0FC4-9F29-48D3-BA63-CDF884DA716B_uwkqfp.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514702/viajes_duy42o.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514701/transporte_kv5zty.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/transferencia-interna_wjuhnq.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514700/telefonia_tfmo9l.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514698/tecnologia_zzpzjl.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514698/tarjetas-de-credito_maojob.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514671/entretenimiento2_uxheb0.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514697/tarjetas2_z3jokx.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514696/tarjetas_ngrqvg.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514695/servicios3_wq8cno.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514694/servicios2_lrrt0u.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514694/servicios_vd3ljj.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514693/salud_qt9xjk.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514692/saldos_lntcfz.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514691/saldo_src7bv.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/ropa_lneukc.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514690/reportes_qisw3e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514689/registro_mc8ed8.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514688/regalos_nlhx7g.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514687/recurrentes1_jllpdf.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/recurrentes_euwfqq.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514686/proyeccion2_iqtpug.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514685/proyeccion_hh3xyt.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514684/presupuesto_r7qkr9.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514683/otros_gg6l1e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/ocio_reehch.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514682/mascotas_puroqw.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514679/inversion2_yedas0.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/inversion_qyl3ly.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514678/ingresos_ci7j4p.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514677/ingreso_yhpbrn.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514676/impuestos2_l8lyx8.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514675/impuestos_anoyd1.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514674/gym_lihk76.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes2_udrbey.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514673/gastos-recurrentes_fhbneu.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514672/gasto_dowgd2.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514670/entretenimiento_ltr2qc.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514670/educacion_jyz87e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/deudas_jcqhez.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/configuracion_puo2ap.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514667/compras_u7wb1e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514666/comida_ecusji.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/celebraciones_pivh9h.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514665/categoria-default_mmpfg4.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514664/calculadora_k1j5hk.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514664/Banco_u87u1e.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514663/ahorro2_xugr6g.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514663/ahorro_vhwhw7.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514668/deudas_jcqhez.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756767509/comunes_xjuxxt.png',
          'https://res.cloudinary.com/datwdagbf/image/upload/v1756889218/51B410C2-D58E-47D8-9ECC-000296533E2C_udpy1y.png',
        ];

        let appState = {
          transactions: [],
          projections: [],
          categories: [],
          banks: [],
          descriptions: [],
          recurringExpenses: [],
          creditCards: [],
          openingBalance: 0,
          userAlias: null,
          categoryBudgets: {},
          budgetAlertsShown: {},
          gastosComunes: {
            // Estructura de datos para la nueva sección
            people: [], // Array de objetos { name: 'Nombre' }
            items: [], // Array de objetos { id, name, totalAmount, distribution: {} }
          },
        };

        let recognition = null; // <-- Esta variable recordará el estado del micrófono
        let userId = null;
        let unsubscribePreferences = null;
        let tempSharedExpenseData = null; // Datos temporales para gastos compartidos
        let unsubscribeTransactions = null;
        let unsubscribeProjections = null;
        let unsubscribeRecurring = null;
        let unsubscribeCreditCards = null;
        let isProcessingVoice = false;
        let importedFileData = null;
        let modalContext = 'registros';
        let isAuthReady = false;
        let currentMonthFilterValue = '';
        let initialTransactionsLoaded = false;
        let initialRecurringLoaded = false;
        let recurringProcessed = false;

        let unsubscribeGastosComunes = null;
        let activePopoverCell = null;
        let distributionModalCallback = null;
        let isAddingCategoryFromTransaction = false;
        const tutorialVideos = [
          {
            title: 'Paso 1: Construye tu Universo Financiero (La Configuración Inicial)',
            description:
              'Tu Viaje Hacia la Libertad Financiera Comienza Aquí. La Base del Éxito: Antes de que puedas conquistar tus finanzas, necesitas un mapa claro. Foresee te ayuda a crear ese mapa en minutos, no horas. Tu Misión: Ve a la pestaña Configuración (⚙️) y completa tres tareas rápidas: 1. Añade tus Categorías Personalizadas: ¿Gastos en Comida? ¿Ingresos por Freelance? ¿O tal vez un presupuesto para Ocio? Crea categorías que reflejen tu vida real. 2. Registra tus Bancos: Añade todas las cuentas bancarias que usas regularmente. Foresee las usará para categorizar automáticamente tus transacciones futuras. 3. Define Descripciones Clave: ¿Pagas Netflix cada mes? ¿O tienes un gasto recurrente en Amazon? Añade esas descripciones para que Foresee pueda reconocerlas y categorizarlas automáticamente en el futuro. ¡Y listo! Has creado el esqueleto de tu sistema financiero personal en minutos.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758512589/Paso_1_Bienvenida_y_Gestion_de_Categoria_y_Bancos_plya2u.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: 'Paso 2: Automatiza tu Tranquilidad (Gastos Recurrentes)',
            description:
              ' Pon tus pagos en automático. Registra una vez tus gastos fijos en Gastos Recurrentes y Foresee los repetirá cada mes avisándote antes del vencimiento, así evitas olvidos, recargos y preocupaciones.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758512570/Paso_2_Gastos_Recurrentes_mboofi.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: 'Paso 3: De monstruo a herramienta. Domina tus Deudas (Tarjetas de Crédito 💳)',
            description:
              ' Las tarjetas de crédito ya no tienen por qué ser un peso, con Foresee se convierten en un plan claro y manejable. Registra cada tarjeta 💳 con su deuda, interés y fecha de pago define en cuántos meses quieres liquidar y Foresee calculará tu pago mensual sugerido. Además, recibirás alertas antes de cada vencimiento, para que nunca más un pago se te pase por alto.Foresee transforma la ansiedad en control y te devuelve la claridad que necesitas para avanzar con confianza.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758512577/Paso_3_Targetas_de_Credito_krqk9f.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: '4 Registro Diaro: El Hábito que lo Cambia Todo (Registra tus Movimientos)',
            description:
              'El control de tu dinero empieza aquí con un registro. Con Foresee es fácil: un toque para ingresos, para gastos o la tabla que organiza todo al detalle. ¿Vas con prisa? Usa tu voz “Gasto en gasolina por 50 dólares”… y queda registrado. Un hábito pequeño, un impacto enorme. Foresee claridad y control en tus manos.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758512590/Paso_4_Registro_Diaro_cujs8c.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: 'Paso 5 Reportes Presupuesto y  Tablas',
            description:
              'Con Reportes, Saldos, Presupuesto y Tablas, Foresee te da una visión completa… y el poder de dirigir tu dinero con claridad.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758512588/Paso_5_Reportes_Presupuesto_y_Tablas_p0zj9b.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: 'Paso 6: Proyección — la esencia de Foresee.',
            description:
              'Anticipa lo que viene no solo mires lo que ya pasó.Registra tus ingresos, tus presupuestos y tus gastos diarios. Foresee hace el cálculo al instante. Sabrás cuánto puedes usar y cuánto puedes ahorrar. ¿Un mes corto o ajustado?  La Proyección te guía. Te ayuda a priorizar, a evitar excesos y a mantenerte en control. Cada número es claridad, cada proyección es poder. Con Proyección diriges tu dinero con inteligencia.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1758514065/Paso_6_Proyeccion_bhrr1a.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
          {
            title: 'Paso 7 Gastos Comunes',
            description:
              'Aquí tú actúas como el intermediario inteligente: recibes de cada persona su parte y luego cancelas el total.',
            url: 'https://res.cloudinary.com/datwdagbf/video/upload/v1759005488/Gastos_comunes_kvozqf.mp4', // <-- REEMPLAZA ESTE ENLACE
          },
        ];

        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const mainActionBtn = document.getElementById('main-action-btn');
        const mainActionBtnText = document.getElementById('main-action-btn-text');
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const transactionsTableBody = document.getElementById('transactions-table-body');

        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const proyeccionTableBody = document.getElementById('proyeccion-table-body');
        const noProyeccionMessage = document.getElementById('no-proyeccion-message');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const selectAllRegistrosCheckbox = document.getElementById('select-all-registros');
        const selectAllProyeccionCheckbox = document.getElementById('select-all-proyeccion');
        const selectAllRecurrentesCheckbox = document.getElementById('select-all-recurrentes');
        const filterMonth = document.getElementById('filter-month');
        const filterDescription = document.getElementById('filter-description');
        const filterCategory = document.getElementById('filter-category');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const importFileInput = document.getElementById('import-file-input');
        const creditCardsTableBody = document.getElementById('credit-cards-table-body');
        const noCreditCardsMessage = document.getElementById('no-credit-cards-message');
        const creditCardModal = document.getElementById('credit-card-modal');
        const creditCardForm = document.getElementById('credit-card-form');
        const openTransferModalBtn = document.getElementById('open-transfer-modal-btn');
        const transferModal = document.getElementById('transfer-modal');
        const transferForm = document.getElementById('transfer-form');
        const transferCancelBtn = document.getElementById('transfer-cancel-btn');
        const recurringExpenseModal = document.getElementById('recurring-expense-modal');
        const recurringExpenseForm = document.getElementById('recurring-expense-form');
        const migrateAllRecurringBtn = document.getElementById('migrate-all-recurring-btn');
        const recurringExpensesTableBody = document.getElementById('recurring-expenses-table-body');
        const noRecurringExpensesMessage = document.getElementById('no-recurring-expenses-message');
        const userAliasDisplay = document.getElementById('user-alias-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalContent = document.getElementById('message-modal-content');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const toastContainer = document.getElementById('toast-container');
        const creditCardAlertsDiv = document.getElementById('credit-card-alerts');
        const userAliasInput = document.getElementById('user-alias');
        const saveAliasBtn = document.getElementById('save-alias-btn');
        const authEmailError = document.getElementById('auth-email-error');
        const authPasswordError = document.getElementById('auth-password-error');
        const transactionDateError = document.getElementById('transaction-date-error');
        const transactionDescriptionError = document.getElementById(
          'transaction-description-error',
        );
        const transactionCategoryError = document.getElementById('transaction-category-error');
        const transactionBankError = document.getElementById('transaction-bank-error');
        const transactionAmountError = document.getElementById('transaction-amount-error');
        const recurringDescriptionError = document.getElementById('recurring-description-error');
        const recurringAmountError = document.getElementById('recurring-amount-error');
        const recurringCategoryError = document.getElementById('recurring-category-error');
        const recurringBankError = document.getElementById('recurring-bank-error');
        const recurringDayError = document.getElementById('recurring-day-error');
        const creditCardBankError = document.getElementById('credit-card-bank-error');

        const categorySelectModal = document.getElementById('category-select-modal');
        const categorySelectGrid = document.getElementById('category-select-grid');
        const categorySelectButton = document.getElementById('category-select-button');
        const transactionCategoryHiddenInput = document.getElementById(
          'transaction-category-hidden',
        );
        const closeCategorySelectModalBtn = document.getElementById(
          'close-category-select-modal-btn',
        );

        const openAddCategoryFromSelectBtn = document.getElementById(
          'open-add-category-from-select-btn',
        ); // <--- ¡Añade esta línea!

        const creditCardDueDateError = document.getElementById('credit-card-due-date-error');
        const creditCardAmountError = document.getElementById('credit-card-amount-error');
        const creditCardRateError = document.getElementById('credit-card-rate-error');
        const creditCardMonthsError = document.getElementById('credit-card-months-error');
        const newCategoryNameError = document.getElementById('new-category-name-error');
        const newBankNameError = document.getElementById('new-bank-name-error');
        const transferDateError = document.getElementById('transfer-date-error');
        const transferFromBankError = document.getElementById('transfer-from-bank-error');
        const transferToBankError = document.getElementById('transfer-to-bank-error');
        const transferAmountError = document.getElementById('transfer-amount-error');
        const userAliasError = document.getElementById('user-alias-error');
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password');

        const currentPasswordError = document.getElementById('current-password-error');
        const newPasswordError = document.getElementById('new-password-error');
        const confirmNewPasswordError = document.getElementById('confirm-new-password-error');
        let expensesChartInstance = null;
        let cashFlowChartInstance = null; // Para el nuevo gráfico de flujo de efectivo
        let confirmCallback = null;
        let listenersAttached = false; // Bandera para controlar los listeners
        onAuthStateChanged(
          auth,
          async (user) => {
            console.log('[Auth State Changed] Usuario:', user ? user.uid : 'null'); // Debugging
            try {
              if (user) {
                enterFullscreen(document.documentElement); // Activa la pantalla completa
                userId = user.uid;
                isAuthReady = true;
                hideAuthModal(); // Ocultar modal de autenticación si el usuario está logueado
                showDashboardView(); // <-- ¡ESTA ES LA CORRECCIÓN! Asegura que se muestre el dashboard.
                const appId = window.firebaseProjectId;
                const userDocRef = doc(
                  db,
                  `artifacts/${appId}/users/${userId}/user_data/preferences`,
                );
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                  console.log(
                    '[Firestore] Documento de preferencias no existe. Creando uno nuevo...',
                  );
                  await setDoc(userDocRef, {
                    categories: [],
                    banks: [],
                    descriptions: [],
                    openingBalance: 0,
                    userAlias: null,
                    categoryBudgets: {},
                  });
                  console.log('[Firestore] Documento de preferencias inicial creado con éxito.');
                }
                await loadUserDataAndListen();
                const promptElement = document.getElementById('mobile-fullscreen-prompt');
                const enterFullscreenBtn = document.getElementById('enter-fullscreen-btn');
                const isMobile = () => window.innerWidth <= 768;
                if (isMobile()) {
                  // Muestra la pantalla de bienvenida
                  promptElement.classList.add('active');
                  enterFullscreenBtn.addEventListener('click', () => {
                    // Llama a tu función existente para entrar en pantalla completa
                    enterFullscreen(document.documentElement);
                    // Oculta la pantalla de bienvenida después de tocar el botón
                    promptElement.classList.remove('active');
                  });
                }
                initApp(); // Inicializar la UI de la aplicación
              } else {
                const initialAuthToken =
                  typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                console.log('[Auth State Changed] initialAuthToken presente:', !!initialAuthToken); // Debugging
                if (initialAuthToken) {
                  try {
                    await window.signInWithCustomToken(auth, initialAuthToken); // Usar window.signInWithCustomToken
                    console.log('[Auth State Changed] Sesión iniciada con token personalizado.'); // Debugging
                  } catch (error) {
                    console.error(
                      '[Auth State Changed] Error al iniciar sesión con token personalizado:',
                      error,
                    );
                    showMessageModal(
                      'Error de Autenticación',
                      'No se pudo iniciar sesión automáticamente. Intenta iniciar sesión manualmente.',
                      'error',
                    );
                    showAuthModal(); // Mostrar modal para login/registro manual
                  }
                } else {
                  // En un entorno real sin token, mostrar el modal de autenticación
                  console.log(
                    '[Auth State Changed] No hay token inicial, mostrando modal de autenticación.',
                  ); // Debugging
                  showAuthModal();
                }
                // Asegurarse de que initApp y hideLoading se llamen siempre al final de esta rama
                initApp();
              }
            } catch (error) {
              console.error(
                '[Auth State Changed] Error general en el listener de autenticación:',
                error,
              ); // Debugging
              showMessageModal(
                'Error de Autenticación',
                'Hubo un problema con la autenticación. Por favor, recarga la página.',
                'error',
              );
            } finally {
              hideLoading(); // Asegurarse de ocultar la carga SIEMPRE al final del onAuthStateChanged
            }
          },
          (error) => {
            console.error('[Auth State Changed] Error en el listener de autenticación:', error); // Debugging
            showMessageModal(
              'Error de Autenticación',
              'Hubo un problema con la autenticación. Por favor, recarga la página.',
              'error',
            );
            hideLoading(); // Asegurarse de ocultar la carga en caso de error de listener
          },
        );
        function initApp() {
          console.log('[initApp] Inicializando la aplicación...'); // Debugging
          setupEventListeners();
          setCurrentMonthFilter();
          populateFilterDropdowns();
          renderAll();
          console.log('[initApp] Aplicación inicializada.'); // Debugging
        }
        function setupEventListeners() {
          document.body.addEventListener('click', function (event) {
            // Revisa si el elemento en el que se hizo clic (o su padre) es el botón de logout del header
            if (event.target.closest('#logout-btn')) {
              // Previene cualquier otro comportamiento por defecto si fuera necesario
              event.preventDefault();
              handleLogout();
            }

            // Revisa si el elemento en el que se hizo clic (o su padre) es el botón de salir de las pestañas
            if (event.target.closest('#logout-tab-btn')) {
              // Previene cualquier otro comportamiento por defecto
              event.preventDefault();
              handleLogout();
            }
          });
          if (listenersAttached) return; // Si ya están asignados, no hagas nada.
          if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.body.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.body.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.body.addEventListener('touchend', handleTouchEnd);
          }
          setupDashboardListeners();
          // --- Conectar el nuevo botón de cerrar vista (flecha) ---
          const closeContentViewBtn = document.getElementById('close-content-view-btn');
          if (closeContentViewBtn) {
            closeContentViewBtn.addEventListener('click', showDashboardView);
          }
          // Eventos para el nuevo selector de categorías
          categorySelectButton.addEventListener('click', openCategorySelector);
          closeCategorySelectModalBtn.addEventListener('click', () =>
            categorySelectModal.classList.remove('active'),
          );
          categorySelectModal.addEventListener('click', (e) => {
            if (e.target === categorySelectModal) {
              categorySelectModal.classList.remove('active');
            }
          });
          // Listener para el botón "+ Añadir Nueva Categoría" dentro del selector
          openAddCategoryFromSelectBtn.addEventListener('click', () => {
            isAddingCategoryFromTransaction = true; // Activamos nuestra "memoria"
            categorySelectModal.classList.remove('active'); // <-- ¡LÍNEA AÑADIDA! Cierra el modal actual
            openAddCategoryModal(); // Abrimos el modal de creación
          });

          // Eventos de Autenticación
          authForm.addEventListener('submit', handleLogin);
          registerBtn.addEventListener('click', handleRegister);

          // Eventos para los nuevos botones de Ingreso y Gasto
          document.getElementById('add-income-btn').addEventListener('click', () => {
            const activeTab = document
              .querySelector('.tab-pane.active')
              ?.id.replace('-content', '');
            modalContext = activeTab === 'proyeccion' ? 'proyeccion' : 'registros';
            openTransactionModal({ type: 'income' });
          });
          document.getElementById('add-expense-btn').addEventListener('click', () => {
            const activeTab = document
              .querySelector('.tab-pane.active')
              ?.id.replace('-content', '');
            modalContext = activeTab === 'proyeccion' ? 'proyeccion' : 'registros';
            openTransactionModal({ type: 'expense' });
          });

          document
            .getElementById('voice-recognition-btn')
            .addEventListener('click', handleVoiceCommand);
          document
            .getElementById('quick-voice-record-btn')
            .addEventListener('click', handleQuickVoiceRecord);

          document
            .getElementById('save-voice-text-btn')
            .addEventListener('click', processAndSaveVoiceText);
          // pegar aqui el nuevo código
          document.getElementById('cancel-voice-text-btn').addEventListener('click', () => {
            // CORRECCIÓN: Se remueve la clase 'visible' para permitir que el panel se oculte.
            document.getElementById('voice-input-panel').classList.remove('visible');
            document.getElementById('voice-input-panel').classList.add('hidden');
          });

          // Botones de Pantalla Completa
          document
            .getElementById('IdbtOpenScreen')
            .addEventListener('click', () => enterFullscreen(document.documentElement));
          document.getElementById('IdbtCloseScreen').addEventListener('click', exitFullscreen);

          // Eventos de la Aplicación
          mainActionBtn.addEventListener('click', handleMainActionClick);
          transactionModal.addEventListener('click', (e) => {
            if (e.target === transactionModal) closeTransactionModal();
          });
          transactionForm.addEventListener('submit', handleFormSubmit);

          filterMonth.addEventListener('change', () => {
            currentMonthFilterValue = filterMonth.value;
            renderAll();
          });
          document.getElementById('filter-bank').addEventListener('change', renderAll);
          filterCategory.addEventListener('change', renderAll);

          document.querySelectorAll('.tab-button:not(#logout-tab-btn)').forEach((button) => {
            button.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
          });

          document
            .getElementById('open-add-category-modal-btn')
            .addEventListener('click', openAddCategoryModal);
          document.getElementById('save-new-category-btn').addEventListener('click', addCategory);
          document
            .getElementById('close-icon-modal-btn')
            .addEventListener('click', closeAddCategoryModal);
          document.getElementById('category-icon-modal').addEventListener('click', (e) => {
            if (e.target.id === 'category-icon-modal') closeAddCategoryModal();
          });

          document.getElementById('add-bank-btn').addEventListener('click', addBank);
          document
            .getElementById('initiate-new-month-btn')
            .addEventListener('click', initiateNewMonth);
          document.getElementById('reset-data-btn').addEventListener('click', resetAllData);
          document.getElementById('save-budgets-btn').addEventListener('click', handleSaveBudgets);
          confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) closeConfirmModal();
          });
          confirmModalCancelBtn.addEventListener('click', closeConfirmModal);

          confirmModalConfirmBtn.addEventListener('click', async () => {
            if (typeof confirmCallback === 'function') {
              await confirmCallback();
            }
            closeConfirmModal();
          });

          messageModalCloseBtn.addEventListener('click', closeMessageModal);
          messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) closeMessageModal();
          });

          document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
          document.getElementById('export-json-btn').addEventListener('click', exportData);

          // --- LÍNEAS MODIFICADAS Y AÑADIDAS PARA LA IMPORTACIÓN SELECTIVA ---
          // El botón de importar ahora abre el nuevo modal de opciones
          document.getElementById('import-json-btn').addEventListener('click', () => {
            // Resetea el estado del modal de importación antes de mostrarlo
            document.getElementById('selected-file-name').textContent =
              'Ningún archivo seleccionado.';
            document.getElementById('import-checkboxes-container').classList.add('hidden');
            document.getElementById('confirm-import-btn').disabled = true;
            document
              .querySelectorAll('.import-section-checkbox, #import-all-checkbox')
              .forEach((cb) => (cb.checked = false));
            importedFileData = null;
            document.getElementById('import-options-modal').classList.add('active');
          });

          importFileInput.addEventListener('change', importData);

          // --- NUEVOS LISTENERS PARA EL MODAL DE IMPORTACIÓN ---
          document
            .getElementById('select-import-file-btn')
            .addEventListener('click', () => importFileInput.click());
          document
            .getElementById('confirm-import-btn')
            .addEventListener('click', processSelectiveImport);

          const closeImportModal = () =>
            document.getElementById('import-options-modal').classList.remove('active');
          document
            .getElementById('close-import-options-btn')
            .addEventListener('click', closeImportModal);
          document.getElementById('cancel-import-btn').addEventListener('click', closeImportModal);
          document.getElementById('import-options-modal').addEventListener('click', (e) => {
            if (e.target.id === 'import-options-modal') closeImportModal();
          });

          // Lógica para el checkbox "Importar Todo"
          document.getElementById('import-all-checkbox').addEventListener('change', (e) => {
            document.querySelectorAll('.import-section-checkbox').forEach((cb) => {
              cb.checked = e.target.checked;
            });
          });

          // Lógica para desmarcar "Importar Todo" si un checkbox individual se desmarca
          document.querySelectorAll('.import-section-checkbox').forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
              const allCheckboxes = document.querySelectorAll('.import-section-checkbox');
              const allChecked = Array.from(allCheckboxes).every((cb) => cb.checked);
              document.getElementById('import-all-checkbox').checked = allChecked;
            });
          });
          // --- FIN DE LAS MODIFICACIONES DE IMPORTACIÓN ---

          creditCardModal.addEventListener('click', (e) => {
            if (e.target === creditCardModal) closeCreditCardModal();
          });
          document
            .getElementById('credit-card-cancel-btn')
            .addEventListener('click', closeCreditCardModal);
          creditCardForm.addEventListener('submit', handleCreditCardFormSubmit);

          creditCardsTableBody.addEventListener('change', handleCardDataChange);

          openTransferModalBtn.addEventListener('click', openTransferModal);
          transferCancelBtn.addEventListener('click', closeTransferModal);
          transferModal.addEventListener('click', (e) => {
            if (e.target === transferModal) closeTransferModal();
          });
          transferForm.addEventListener('submit', handleTransferFormSubmit);
          recurringExpenseModal.addEventListener('click', (e) => {
            if (e.target === recurringExpenseModal) closeRecurringExpenseModal();
          });
          recurringExpenseForm.addEventListener('submit', handleRecurringExpenseFormSubmit);
          document
            .getElementById('migrate-all-recurring-btn')
            .addEventListener('click', migrateAllRecurringToTransactions);

          saveAliasBtn.addEventListener('click', handleSaveAlias);
          changePasswordForm.addEventListener('submit', handleChangePassword);

          const brandStoryModal = document.getElementById('brand-story-modal');
          const openBrandStoryBtn = document.getElementById('open-brand-story-btn');
          const closeBrandStoryBtn = document.getElementById('close-brand-story-btn');

          if (brandStoryModal && openBrandStoryBtn && closeBrandStoryBtn) {
            openBrandStoryBtn.addEventListener('click', () =>
              brandStoryModal.classList.add('active'),
            );
            const closeModal = () => brandStoryModal.classList.remove('active');
            closeBrandStoryBtn.addEventListener('click', closeModal);
            brandStoryModal.addEventListener('click', (e) => {
              if (e.target === brandStoryModal) closeModal();
            });
          }

          const privacyModal = document.getElementById('privacy-policy-modal');
          const termsModal = document.getElementById('terms-conditions-modal');
          const cookieModal = document.getElementById('cookie-policy-modal');

          const openPrivacyBtn = document.getElementById('open-privacy-policy');
          const openTermsBtn = document.getElementById('open-terms-conditions');
          const openCookieBtn = document.getElementById('open-cookie-policy');

          const closeLegalModals = () => {
            privacyModal.classList.remove('active');
            termsModal.classList.remove('active');
            cookieModal.classList.remove('active');
          };

          openPrivacyBtn.addEventListener('click', (e) => {
            e.preventDefault();
            privacyModal.classList.add('active');
          });
          openTermsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            termsModal.classList.add('active');
          });
          openCookieBtn.addEventListener('click', (e) => {
            e.preventDefault();
            cookieModal.classList.add('active');
          });

          document.querySelectorAll('.modal').forEach((modal) => {
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                closeLegalModals();
              }
            });
          });
          document.querySelectorAll('.close-legal-modal').forEach((button) => {
            button.addEventListener('click', closeLegalModals);
          });

          const closeTransactionBtn = document.getElementById('close-transaction-modal-btn');
          if (closeTransactionBtn)
            closeTransactionBtn.addEventListener('click', closeTransactionModal);

          const closeRecurringBtn = document.getElementById('close-recurring-modal-btn');
          if (closeRecurringBtn)
            closeRecurringBtn.addEventListener('click', closeRecurringExpenseModal);

          // Nuevo listener para la fecha que abre el selector de categoría
          const transactionDateInput = document.getElementById('transaction-date');
          if (transactionDateInput) {
            transactionDateInput.addEventListener('change', () => {
              openCategorySelector();
            });
            transactionDateInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault(); // Evita que se envíe el formulario
                openCategorySelector();
              }
            });
          }

          const setupEnterKeyNavigation = (formId, fieldIds) => {
            const form = document.getElementById(formId);
            if (!form) return;
            fieldIds.forEach((fieldId, index) => {
              const element = document.getElementById(fieldId);
              if (!element) return;
              element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && index < fieldIds.length - 1) {
                  e.preventDefault();
                  const nextElement = document.getElementById(fieldIds[index + 1]);
                  if (nextElement) nextElement.focus();
                }
              });
            });
          };

          // Orden de navegación con "Enter" actualizado
          setupEnterKeyNavigation('transaction-form', [
            'transaction-date',
            'transaction-amount',
            'transaction-bank',
            'transaction-description',
            'save-transaction-btn',
          ]);
          setupEnterKeyNavigation('recurring-expense-form', [
            'recurring-description',
            'recurring-category',
            'recurring-bank',
            'recurring-amount',
            'recurring-day',
            'save-recurring-btn',
          ]);

          deleteSelectedBtn.addEventListener('click', handleDeleteSelected);
          const tablesContainer = document.getElementById('main-container');
          tablesContainer.addEventListener('change', (e) => {
            if (
              e.target.matches(
                '.transaction-checkbox, .projection-checkbox, .recurring-checkbox, #select-all-registros, #select-all-proyeccion, #select-all-recurrentes',
              )
            ) {
              updateDeleteButtonVisibility();
            }
          });

          selectAllRegistrosCheckbox.addEventListener('change', (e) =>
            document
              .querySelectorAll('#registros-content .transaction-checkbox')
              .forEach((cb) => (cb.checked = e.target.checked)),
          );
          selectAllProyeccionCheckbox.addEventListener('change', (e) =>
            document
              .querySelectorAll('#proyeccion-content .projection-checkbox')
              .forEach((cb) => (cb.checked = e.target.checked)),
          );
          selectAllRecurrentesCheckbox.addEventListener('change', (e) =>
            document
              .querySelectorAll('#recurrentes-content .recurring-checkbox')
              .forEach((cb) => (cb.checked = e.target.checked)),
          );

          const mostrarBtn = document.getElementById('mostrar');
          const tabButtons = document.querySelectorAll('#tabs .tab-button:not(#logout-tab-btn)');

          tabButtons.forEach((btn) => {
            btn.addEventListener('click', showContentView);
          });

          if (mostrarBtn) {
            mostrarBtn.addEventListener('click', showDashboardView);
          }

          const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
          const filtersContainer = document.getElementById('filters-container');

          if (toggleFiltersBtn && filtersContainer) {
            toggleFiltersBtn.addEventListener('click', () => {
              filtersContainer.classList.toggle('filters-visible');
              const isVisible = filtersContainer.classList.contains('filters-visible');
              toggleFiltersBtn.textContent = isVisible ? 'Ocultar Filtros' : 'Mostrar Filtros';
            });
          }
          document
            .getElementById('single-action-edit-btn')
            .addEventListener('click', handleSingleEditAction);
          document
            .getElementById('single-action-delete-btn')
            .addEventListener('click', handleSingleDeleteAction);
          document.getElementById('single-action-cancel-btn').addEventListener('click', () => {
            document.getElementById('single-action-modal').classList.remove('active');
            // Deselecciona cualquier casilla que estuviera marcada
            const checkedCheckbox = document.querySelector(
              '.tab-pane.active input[type="checkbox"]:checked',
            );
            if (checkedCheckbox) {
              checkedCheckbox.checked = false;
            }
            updateDeleteButtonVisibility(); // Oculta el panel
          });

          // =====================================================================
          // =========== INICIO DEL CÓDIGO A PEGAR (EVENTOS GASTOS COMUNES) ===========
          // =====================================================================
          // --- LÓGICA DE GASTOS COMUNES ---
          // Botones para añadir ítems y personas (sin cambios)
          document.getElementById('add-shared-item-btn').addEventListener('click', () => {
            if (!appState.gastosComunes.items) appState.gastosComunes.items = [];
            appState.gastosComunes.items.push({
              id: `item_${Date.now()}`,
              name: '',
              totalAmount: 0,
              distribution: {},
            });
            saveGastosComunesState();
          });

          document.getElementById('add-person-btn').addEventListener('click', () => {
            if (!appState.gastosComunes.people) appState.gastosComunes.people = [];
            const newIndex = appState.gastosComunes.people.length;
            appState.gastosComunes.people.push({ name: `Persona ${newIndex + 1}` });
            saveGastosComunesState();
          });

          const gastosComunesTable = document.getElementById('gastos-comunes-table');

          gastosComunesTable.addEventListener('input', (e) => {
            const row = e.target.closest('tr');
            // Ahora también manejamos el input del div editable del nombre de la persona
            if (e.target.matches('.person-name-editable')) {
              const personIndex = e.target.dataset.personIndex;
              appState.gastosComunes.people[personIndex].name = e.target.textContent.trim();
              // No guardamos aquí, solo actualizamos el estado en memoria
              return;
            }
            if (!row) return;
            const itemId = row.dataset.itemId;
            const item = appState.gastosComunes.items.find((i) => i.id === itemId);
            if (!item) return;

            if (e.target.matches('.item-name-input')) {
              item.name = e.target.value;
            } else if (e.target.matches('.item-total-input')) {
              item.totalAmount = parseFloat(e.target.value) || 0;
            } else if (e.target.matches('th[contenteditable="true"]')) {
              const personIndex = e.target.dataset.personIndex;
              appState.gastosComunes.people[personIndex].name = e.target.textContent
                .replace('✖', '')
                .trim();
            }
          });

          gastosComunesTable.addEventListener(
            'blur',
            (e) => {
              if (
                e.target.matches('th[contenteditable="true"], .item-name-input, .item-total-input')
              ) {
                saveGastosComunesState();
              }
            },
            true,
          );

          gastosComunesTable.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === 'Escape') {
              e.preventDefault();
              e.target.blur();
            }
          });

          // REEMPLAZA EL BLOQUE ANTERIOR CON ESTE CÓDIGO CORREGIDO
          gastosComunesTable.addEventListener('click', (e) => {
            // === CORRECCIÓN INICIA AQUÍ ===
            // 1. PRIMERO revisamos si se hizo clic en el botón 'OK'
            const registerBtn = e.target.closest('.register-shared-expense-btn');
            if (registerBtn) {
              // 2. Detenemos la propagación para que no se active el modal de distribución
              e.stopPropagation();

              const dayInput = registerBtn.previousElementSibling;
              const day = parseInt(dayInput.value, 10);

              if (isNaN(day) || day < 1 || day > 31) {
                showToast('Por favor, ingresa un día válido (1-31).', 'error');
                dayInput.focus();
                return;
              }

              const itemId = registerBtn.dataset.itemId;
              const personIndex = parseInt(registerBtn.dataset.personIndex, 10);
              const item = appState.gastosComunes.items.find((i) => i.id === itemId);
              const person = appState.gastosComunes.people[personIndex];

              if (!item || !person) {
                showToast('Error: No se encontró el ítem o la persona.', 'error');
                return;
              }

              const amount = calculateCellAmount(item, personIndex);
              const description = `${person.name} - ${item.name}`;
              const now = new Date();
              const transactionDate = new Date(now.getFullYear(), now.getMonth(), day);
              const formattedDate = transactionDate.toISOString().split('T')[0];

              const dataForModal = {
                amount,
                description,
                date: formattedDate,
                category: 'Gasto Común', // <--- ¡MEJORADO!
                originalItemId: itemId,
                originalPersonIndex: personIndex,
              };

              openSharedExpenseBankModal(dataForModal);
              return; // Salimos de la función una vez ejecutada la acción
            }
            // === CORRECCIÓN TERMINA AQUÍ ===

            const cell = e.target.closest('.distribution-cell');
            // === LÍNEA MODIFICADA ===
            // Ahora solo se abre el popover si se hizo clic en la celda PERO NO en el input de la fecha.
            if (cell && !e.target.matches('.shared-expense-day-input')) {
              showDistributionPopover(cell);
              return;
            }

            const deleteItemBtn = e.target.closest('.delete-item-btn');
            if (deleteItemBtn) {
              const itemId = deleteItemBtn.closest('tr').dataset.itemId;
              appState.gastosComunes.items = appState.gastosComunes.items.filter(
                (i) => i.id !== itemId,
              );
              saveGastosComunesState();
              return;
            }

            const deletePersonBtn = e.target.closest('.delete-person-btn');
            if (deletePersonBtn) {
              const personIndexToDelete = parseInt(deletePersonBtn.dataset.personIndex, 10);
              const personName =
                appState.gastosComunes.people[personIndexToDelete]?.name ||
                `Persona ${personIndexToDelete + 1}`;

              openConfirmModal(
                `Eliminar a ${personName}`,
                `¿Estás seguro de que quieres eliminar a "${personName}" y todos sus datos de la tabla? Esta acción no se puede deshacer.`,
                () => {
                  appState.gastosComunes.people.splice(personIndexToDelete, 1);
                  if (appState.gastosComunes.items) {
                    appState.gastosComunes.items.forEach((item) => {
                      if (!item.distribution) return;
                      const newDistribution = {};
                      Object.keys(item.distribution).forEach((keyStr) => {
                        const oldIndex = parseInt(keyStr, 10);
                        const value = item.distribution[keyStr];
                        if (oldIndex < personIndexToDelete) {
                          newDistribution[oldIndex] = value;
                        } else if (oldIndex > personIndexToDelete) {
                          newDistribution[oldIndex - 1] = value;
                        }
                      });
                      item.distribution = newDistribution;
                    });
                  }
                  saveGastosComunesState();
                },
              );
              return;
            }
          });

          // --- LÓGICA DEL POPOVER ACTUALIZADA ---
          document.getElementById('distribution-popover').addEventListener('click', (e) => {
            if (e.target.matches('[data-method]') && activePopoverCell) {
              const method = e.target.dataset.method;
              const row = activePopoverCell.closest('tr');
              const itemId = row.dataset.itemId;
              const personIndex = activePopoverCell.dataset.personIndex;
              const item = appState.gastosComunes.items.find((i) => i.id === itemId);

              if (!item) return;
              if (!item.distribution) item.distribution = {};
              if (!item.distribution[personIndex]) item.distribution[personIndex] = {};

              const currentValue = item.distribution[personIndex].value;

              const applyChange = (newValue) => {
                item.distribution[personIndex] = {
                  method: method,
                  value: parseFloat(newValue) || 0,
                };
                hideDistributionPopover();
                saveGastosComunesState();
              };

              if (method === 'percentage' || method === 'manual') {
                // Abre el nuevo modal en lugar del prompt
                openDistributionInputModal({ method, currentValue, callback: applyChange });
              } else {
                // Para 'partes iguales', no se necesita input
                applyChange(0);
              }
            }
          });

          document.addEventListener('click', (e) => {
            const popover = document.getElementById('distribution-popover');
            if (
              popover &&
              !popover.classList.contains('hidden') &&
              !e.target.closest('.distribution-cell') &&
              !e.target.closest('#distribution-popover')
            ) {
              hideDistributionPopover();
            }
          });

          // --- LISTENERS PARA EL NUEVO MODAL DE DISTRIBUCIÓN ---
          document.getElementById('distribution-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('distribution-modal-input');
            if (typeof distributionModalCallback === 'function') {
              distributionModalCallback(input.value);
            }
            closeDistributionInputModal();
          });

          document
            .getElementById('cancel-distribution-btn')
            .addEventListener('click', closeDistributionInputModal);
          document.getElementById('distribution-input-modal').addEventListener('click', (e) => {
            if (e.target.id === 'distribution-input-modal') {
              closeDistributionInputModal();
            }
          });

          document
            .getElementById('confirm-shared-expense-bank-btn')
            .addEventListener('click', handleConfirmSharedExpense);
          document
            .getElementById('cancel-shared-expense-bank-btn')
            .addEventListener('click', closeSharedExpenseBankModal);
          document.getElementById('shared-expense-bank-modal').addEventListener('click', (e) => {
            if (e.target.id === 'shared-expense-bank-modal') {
              closeSharedExpenseBankModal();
            }
          });

          // --- Event Listeners para el Modal de Tutoriales ---
          const openTutorialsBtn = document.getElementById('open-tutorials-btn');
          const closeTutorialsBtn = document.getElementById('close-tutorials-modal-btn');
          const tutorialsModal = document.getElementById('tutorials-modal');

          if (openTutorialsBtn && tutorialsModal) {
            openTutorialsBtn.addEventListener('click', () => {
              populateTutorialsList();
              tutorialsModal.classList.add('active');
            });
          }
          if (closeTutorialsBtn && tutorialsModal) {
            closeTutorialsBtn.addEventListener('click', () =>
              tutorialsModal.classList.remove('active'),
            );
          }
          if (tutorialsModal) {
            tutorialsModal.addEventListener('click', (e) => {
              if (e.target === tutorialsModal) {
                tutorialsModal.classList.remove('active');
              }
            });
          }

          listenersAttached = true;
        }

        // --- LÓGICA PARA EL TOOLTIP DE INFORMACIÓN DE TRANSACCIÓN ---
        document.body.addEventListener('click', (e) => {
          // Primero, si hay un tooltip visible, lo eliminamos.
          const existingTooltip = document.querySelector('.info-tooltip');
          if (existingTooltip) {
            existingTooltip.remove();
          }

          // Si el clic fue en un botón de info, creamos un nuevo tooltip.
          const infoBtn = e.target.closest('.info-btn');
          if (infoBtn) {
            // Evita que el clic en el botón se propague y cierre el tooltip inmediatamente.
            e.stopPropagation();

            const description = infoBtn.dataset.description;
            if (!description) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'info-tooltip';
            tooltip.textContent = description;
            document.body.appendChild(tooltip);

            // Posicionar el tooltip
            const btnRect = infoBtn.getBoundingClientRect();
            tooltip.style.left = `${btnRect.left}px`;
            tooltip.style.top = `${btnRect.bottom + 5}px`; // 5px debajo del botón

            // Forzar un reflow para que la animación de opacidad funcione
            void tooltip.offsetWidth;
            tooltip.classList.add('visible');
          }
        });

        function showAuthModal() {
          authModal.classList.add('active');
          document.body.classList.add('auth-modal-active'); // Ocultar contenido principal
          mainContentWrapper.style.display = 'none';
        }

        function hideAuthModal() {
          authModal.classList.remove('active');
          document.body.classList.remove('auth-modal-active');
          mainContentWrapper.style.display = 'block'; // Mostrar contenido principal
        }

        async function handleRegister(e) {
          e.preventDefault();
          clearValidationErrors(); // Limpiar errores previos

          const email = authEmailInput.value;
          const password = authPasswordInput.value;

          let isValid = true;
          if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
          if (!validatePassword(authPasswordInput, authPasswordError, 6)) isValid = false;

          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario.', 'error');
            return;
          }

          showButtonLoading(registerBtn);
          console.log('[Auth] Intentando registrar usuario:', email); // Debugging

          try {
            // Acceder a createUserWithEmailAndPassword a través de window
            await window.createUserWithEmailAndPassword(auth, email, password);
            showToast('¡Tu cuenta ha sido creada y has iniciado sesión!', 'success');
            // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
          } catch (error) {
            console.error('[Auth] Error de registro:', error); // Debugging
            let errorMessage = 'Error al registrar la cuenta. Inténtalo de nuevo.';
            if (error.code === 'auth/email-already-in-use') {
              errorMessage =
                'Este correo electrónico ya está en uso. Intenta iniciar sesión o usa otro correo.';
            } else if (error.code === 'auth/weak-password') {
              errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
            } else if (error.code === 'auth/invalid-email') {
              errorMessage = 'El formato del correo electrónico es inválido.';
            }
            showMessageModal('Error de Registro', errorMessage, 'error');
          } finally {
            hideButtonLoading(registerBtn);
          }
        }

        async function handleLogin(e) {
          e.preventDefault();
          clearValidationErrors(); // Limpiar errores previos

          const email = authEmailInput.value;
          const password = authPasswordInput.value;

          let isValid = true;
          if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
          if (
            !validateRequired(authPasswordInput, authPasswordError, 'La contraseña es obligatoria.')
          )
            isValid = false;

          if (!isValid) {
            showToast('Por favor, ingresa tu correo y contraseña.', 'error');
            return;
          }

          showButtonLoading(loginBtn);
          console.log('[Auth] Intentando iniciar sesión con:', email); // Debugging

          try {
            // Acceder a signInWithEmailAndPassword a través de window
            await window.signInWithEmailAndPassword(auth, email, password);
            showToast('¡Inicio de Sesión Exitoso! Bienvenido de nuevo.', 'success');
            // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
          } catch (error) {
            console.error('[Auth] Error de inicio de sesión:', error); // Debugging
            let errorMessage = 'Error al iniciar sesión. Verifica tu correo y contraseña.';
            if (
              error.code === 'auth/user-not-found' ||
              error.code === 'auth/wrong-password' ||
              error.code === 'auth/invalid-credential'
            ) {
              errorMessage = 'Correo electrónico o contraseña incorrectos.';
            } else if (error.code === 'auth/invalid-email') {
              errorMessage = 'El formato del correo electrónico es inválido.';
            } else if (error.code === 'auth/too-many-requests') {
              errorMessage = 'Demasiados intentos fallidos. Inténtalo de nuevo más tarde.';
            }
            showMessageModal('Error de Inicio de Sesión', errorMessage, 'error');
          } finally {
            hideButtonLoading(loginBtn);
          }
        }

        /** "Cuelga" todas las llamadas a la base de datos para evitar errores al cerrar sesión. */
        function unsubscribeAllListeners() {
          if (unsubscribePreferences) unsubscribePreferences();
          if (unsubscribeTransactions) unsubscribeTransactions();
          if (unsubscribeProjections) unsubscribeProjections();
          if (unsubscribeRecurring) unsubscribeRecurring();
          if (unsubscribeCreditCards) unsubscribeCreditCards();
          if (unsubscribeGastosComunes) unsubscribeGastosComunes();
          console.log('[Firestore] Todos los oyentes han sido desvinculados.');
        }

        /** Gestiona el cierre de sesión del usuario de forma limpia. */
        async function handleLogout() {
          openConfirmModal(
            'Cerrar Sesión',
            '¿Estás seguro de que quieres cerrar tu sesión?',
            async () => {
              exitFullscreen();
              showButtonLoading(logoutBtn);
              // 1. Colgamos las llamadas a la base de datos.
              unsubscribeAllListeners();

              console.log('[Auth] Intentando cerrar sesión...');
              try {
                // 2. Ahora sí, cerramos la sesión de forma segura.
                await window.signOut(auth);
                showToast('Sesión Cerrada Exitosamente.', 'info');
                // Limpia el estado de la aplicación
                appState = {
                  transactions: [],
                  projections: [],
                  categories: [],
                  banks: [],
                  descriptions: [],
                  recurringExpenses: [],
                  creditCards: [],
                  openingBalance: 0,
                  userAlias: null,
                  categoryBudgets: {},
                  budgetAlertsShown: {},
                };

                // Vuelve a la pantalla de inicio de sesión
                showAuthModal();
              } catch (error) {
                console.error('[Auth] Error al cerrar sesión:', error);
                showMessageModal('Error', 'No se pudo cerrar la sesión.', 'error');
              } finally {
                hideButtonLoading(logoutBtn);
              }
            },
          );
        }

        /** Abre el modal para seleccionar un icono y añadir una nueva categoría. */
        function openAddCategoryModal() {
          const modal = document.getElementById('category-icon-modal');
          const grid = document.getElementById('category-icon-grid');
          const nameInput = document.getElementById('new-category-name-modal');
          // Limpia el estado anterior del modal
          nameInput.value = '';
          grid.innerHTML = '';
          clearValidationErrors();

          // Rellena la rejilla con los iconos predefinidos
          PRESET_ICONS.forEach((iconPath) => {
            const option = document.createElement('div');
            option.className = 'icon-option';
            option.dataset.icon = iconPath;
            option.innerHTML = `<img src="${iconPath}" alt="Icono de categoría">`;

            // Marca el icono por defecto como seleccionado inicialmente
            if (iconPath === DEFAULT_ICON) {
              option.classList.add('selected');
            }

            // Añade el evento para seleccionar un icono
            option.addEventListener('click', () => {
              grid.querySelector('.selected')?.classList.remove('selected');
              option.classList.add('selected');
            });

            grid.appendChild(option);
          });

          modal.classList.add('active');
          nameInput.focus();
        }

        /** Cierra el modal de selección de iconos.*/
        function closeAddCategoryModal() {
          document.getElementById('category-icon-modal').classList.remove('active');
          isAddingCategoryFromTransaction = false; // <-- ¡Añade esta línea!
        }

        /**Función auxiliar para obtener el HTML de una categoría (icono + texto o solo texto).
         * @param {string} categoryName - El nombre de la categoría a mostrar.
         * @returns {string} El HTML para inyectar en la celda de la tabla.
         */
        // pegar aqui el nuevo código
        function getCategoryDisplay(categoryName) {
          // 1. Caso especial: Asignamos un ícono específico para las transferencias.
          if (categoryName === 'Transferencia Interna') {
            const transferIconUrl =
              'https://res.cloudinary.com/datwdagbf/image/upload/f_auto,q_auto/v1756514669/dinero_hgnyz4.png';
            return `<img src="${transferIconUrl}" class="category-icon" alt="${categoryName}"> <span>${categoryName}</span>`;
          }

          // 2. Buscamos la categoría en la configuración del usuario.
          const categoryObj = appState.categories.find((c) => c.name === categoryName);

          // 3. Determinamos el ícono a usar:
          // Si la categoría existe Y tiene un ícono, lo usamos. Si no, usamos el ÍCONO POR DEFECTO.
          const iconUrl = categoryObj && categoryObj.icon ? categoryObj.icon : DEFAULT_ICON;

          // 4. Siempre devolvemos el HTML con un ícono, asegurando que nunca falte.
          return `<img src="${iconUrl}" class="category-icon" alt="${categoryName}"> <span>${categoryName}</span>`;
        }

        async function loadUserDataAndListen() {
          if (!userId) {
            console.warn('[Firestore] No hay ID de usuario para cargar datos.');
            hideLoading();
            return;
          }
          console.log(`[Firestore] Cargando datos para el usuario: ${userId}`);

          const appId = firebaseProjectId;
          if (!appId) {
            console.error('[Firestore] ERROR: appId no disponible al cargar datos.');
            showMessageModal(
              'Error de Configuración',
              'El ID del proyecto Firebase no está disponible.',
            );
            hideLoading();
            return;
          }

          // Función para desuscribirse de todos los oyentes antes de crear nuevos
          if (typeof unsubscribeAllListeners === 'function') {
            unsubscribeAllListeners();
          }

          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
          const transactionsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/transactions`,
          );
          const recurringExpensesColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/recurringExpenses`,
          );
          const creditCardsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/creditCards`,
          );
          const projectionsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/projections`,
          );

          // Guardamos la función "unsubscribe" para cada oyente
          unsubscribePreferences = onSnapshot(
            userDocRef,
            (docSnap) => {
              console.log('[Firestore] onSnapshot preferences fired.');
              if (docSnap.exists()) {
                const data = docSnap.data();
                appState.categories = (data.categories || []).map((cat) =>
                  typeof cat === 'string' ? { name: cat, icon: DEFAULT_ICON } : cat,
                );
                appState.banks = data.banks || [];
                appState.descriptions = data.descriptions || [];
                appState.openingBalance = data.openingBalance || 0;
                appState.userAlias = data.userAlias || null;
                appState.categoryBudgets = data.categoryBudgets || {};
              }
              if (isAuthReady) {
                populateFilterDropdowns();
                populateModalDropdowns();
                populateRecurringModalDropdowns();
                populateDescriptionDatalist();
                populateTransferModalDropdowns();
                renderConfigurationLists();
                renderHeaderAlias();
                renderAll();
              }
            },
            (error) => {
              console.error('[Firestore] Error al escuchar preferencias del usuario:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar tus preferencias.',
                'error',
              );
            },
          );

          unsubscribeTransactions = onSnapshot(
            transactionsColRef,
            (snapshot) => {
              console.log('[Firestore] onSnapshot transactions fired.');
              appState.transactions = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              initialTransactionsLoaded = true;
              tryProcessRecurringExpenses();
              if (isAuthReady) renderAll();
            },
            (error) => {
              console.error('[Firestore] Error al escuchar transacciones:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar tus transacciones.',
                'error',
              );
            },
          );

          unsubscribeRecurring = onSnapshot(
            recurringExpensesColRef,
            (snapshot) => {
              console.log('[Firestore] onSnapshot recurringExpenses fired.');
              appState.recurringExpenses = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              initialRecurringLoaded = true;
              tryProcessRecurringExpenses();
              if (isAuthReady) {
                checkRecurringPaymentReminders();
                renderAll();
              }
            },
            (error) => {
              console.error('[Firestore] Error al escuchar gastos recurrentes:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar tus gastos recurrentes.',
                'error',
              );
            },
          );

          unsubscribeCreditCards = onSnapshot(
            creditCardsColRef,
            (snapshot) => {
              console.log('[Firestore] onSnapshot creditCards fired.');
              appState.creditCards = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              if (isAuthReady) renderAll();
            },
            (error) => {
              console.error('[Firestore] Error al escuchar tarjetas de crédito:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar tus tarjetas de crédito.',
                'error',
              );
            },
          );

          unsubscribeProjections = onSnapshot(
            projectionsColRef,
            (snapshot) => {
              console.log('[Firestore] onSnapshot projections fired.');
              appState.projections = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              if (isAuthReady) renderAll();
            },
            (error) => {
              console.error('[Firestore] Error al escuchar proyecciones:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar tus proyecciones.',
                'error',
              );
            },
          );
          // NUEVO OYENTE PARA GASTOS COMUNES
          const gastosComunesDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/user_data/gastosComunes`,
          );
          unsubscribeGastosComunes = onSnapshot(
            gastosComunesDocRef,
            (docSnap) => {
              console.log('[Firestore] onSnapshot gastosComunes fired.');
              if (docSnap.exists()) {
                appState.gastosComunes = docSnap.data();
              } else {
                // Si no existe el documento, lo inicializamos en Firebase
                setDoc(gastosComunesDocRef, { people: [], items: [] });
              }
              if (isAuthReady) renderAll();
            },
            (error) => {
              console.error('[Firestore] Error al escuchar gastos comunes:', error);
              showMessageModal(
                'Error de Carga',
                'Hubo un problema al cargar los datos de gastos comunes.',
                'error',
              );
            },
          );
        }

        // CÓDIGO NUEVO (DESPUÉS) - PEGA TODO ESTE BLOQUE
        /**
         * NUEVA FUNCIÓN GENÉRICA: Obtiene transacciones con filtros específicos.
         * Esta es la nueva "herramienta" principal para buscar datos.
         * @param {object} filters - Un objeto con los criterios de filtrado.
         */
        function getTransactions(filters = {}) {
          const { month, category, bank, description, source = appState.transactions } = filters;

          return source
            .filter((t) => {
              if (!t || typeof t.date !== 'string') return false;

              const transactionMonth = t.date.substring(0, 7);

              const matchesMonth = !month || transactionMonth === month;
              const matchesCategory = !category || t.category === category;
              const matchesBank = !bank || t.bank === bank;
              const matchesDescription =
                !description ||
                (t.description || '').toLowerCase().includes(description.toLowerCase());

              return matchesMonth && matchesCategory && matchesBank && matchesDescription;
            })
            .sort((a, b) => {
              const dateComparison = new Date(a.date) - new Date(b.date);
              if (dateComparison !== 0) return dateComparison;
              if (a.type === 'income' && b.type !== 'income') return -1;
              if (a.type !== 'income' && b.type === 'income') return 1;
              return 0;
            });
        }

        /**
         * FUNCIÓN ACTUALIZADA: Usada SOLO por la tabla de Registros.
         * Lee los filtros de la interfaz y llama a la nueva función genérica.
         */
        function getFilteredTransactions() {
          const month = filterMonth.value;
          const category = filterCategory.value;
          const bank = document.getElementById('filter-bank').value; // Leemos el nuevo filtro de banco

          // Llama a la función genérica pasando TODOS los filtros de la UI
          return getTransactions({
            month: month,
            category: category,
            bank: bank,
            // No pasamos 'description' porque ya no existe el filtro
          });
        }

        function getFilteredTransactionsForProyeccion() {
          const selectedMonth = filterMonth.value;
          const descriptionFilter = filterDescription.value.toLowerCase();
          const categoryFilter = filterCategory.value;

          // Esta función ahora lee de appState.projections
          return appState.projections
            .filter((t) => {
              // --- INICIO DE LA CORRECCIÓN ---
              if (!t || typeof t.date !== 'string') {
                console.warn('Se encontró una proyección sin fecha válida:', t);
                return false; // Se ignora para evitar el error.
              }

              const transactionMonth = t.date.substring(0, 7);
              const matchesMonth = !selectedMonth || transactionMonth === selectedMonth;
              const matchesDescription = (t.description || '')
                .toLowerCase()
                .includes(descriptionFilter);
              const matchesCategory = !categoryFilter || t.category === categoryFilter;
              return matchesMonth && matchesDescription && matchesCategory;
            })
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // --- RENDERIZADO ---
        // --- NUEVA FUNCIÓN: Revisar Límites de Presupuesto ---
        // --- NUEVA FUNCIÓN: Recordatorios de Pagos Recurrentes ---
        function checkRecurringPaymentReminders() {
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          const tomorrowDay = tomorrow.getDate();

          appState.recurringExpenses.forEach((expense) => {
            // Comprobar si el día de pago es mañana
            if (parseInt(expense.day, 10) === tomorrowDay) {
              const reminderKey = `reminder-${expense.id}-${tomorrow.toISOString().split('T')[0]}`;

              // Usar sessionStorage para no repetir el aviso en la misma sesión
              if (!sessionStorage.getItem(reminderKey)) {
                showToast(
                  `Recordatorio: Mañana vence tu pago de "${
                    expense.description
                  }" por ${formatCurrency(expense.amount)}.`,
                  'info',
                  6000,
                ); // Duración de 6 segundos
                sessionStorage.setItem(reminderKey, 'true');
              }
            }
          });
        }
        function checkBudgetLimits() {
          const transactionsForMonth = getFilteredTransactions();
          const expensesByCategory = transactionsForMonth
            .filter((t) => t.type === 'expense')
            .reduce((acc, t) => {
              acc[t.category] = (acc[t.category] || 0) + t.amount;
              return acc;
            }, {});

          for (const category in appState.categoryBudgets) {
            const budget = appState.categoryBudgets[category];
            const spent = expensesByCategory[category] || 0;

            if (budget > 0 && spent > 0) {
              const percentage = (spent / budget) * 100;
              const alertKey = `${filterMonth.value}-${category}`;

              // Comprobar si la alerta para esta categoría/mes ya se mostró
              if (!appState.budgetAlertsShown[alertKey]) {
                if (percentage >= 90) {
                  showToast(
                    `¡Alerta! Has gastado el ${percentage.toFixed(
                      0,
                    )}% de tu presupuesto para "${category}".`,
                    'error',
                  );
                  appState.budgetAlertsShown[alertKey] = true; // Marcar como mostrada
                } else if (percentage >= 80) {
                  showToast(
                    `Aviso: Has gastado el ${percentage.toFixed(
                      0,
                    )}% de tu presupuesto para "${category}".`,
                    'info',
                  );
                  appState.budgetAlertsShown[alertKey] = true; // Marcar como mostrada
                }
              }
            }
          }
        }

        function renderAll() {
          renderDashboard();
          renderTransactionsTable();
          renderProyeccionTable();
          renderConfigurationLists();
          //renderCreditCardAlerts(); // Renderizar alertas de tarjetas
          renderRecurringAlerts(); // Renderizar alertas de recurrentes
          renderHeaderAlias(); // Asegurarse de que el alias se muestre correctamente
          const activeTabElement = document.querySelector('.tab-pane.active');
          if (activeTabElement) {
            const activeTab = activeTabElement.id;
            if (activeTab === 'reportes-content') renderReports();
            if (activeTab === 'presupuesto-content') renderBudgetTable(); // <-- AGREGA ESTA LÍNEA
            if (activeTab === 'tarjetas-content') renderCreditCardsTable();
            if (activeTab === 'recurrentes-content') renderRecurringExpensesTable();
            if (activeTab === 'saldos-content') renderBankBalances(); // MODIFICACIÓN
            if (activeTab === 'gastos-comunes-content') renderGastosComunesTable();
          }
        }

        function renderHeaderAlias() {
          if (appState.userAlias) {
            userAliasDisplay.textContent = appState.userAlias;
            userAliasInput.value = appState.userAlias; // Cargar el alias en el input de configuración
          } else {
            userAliasDisplay.textContent = `Usuario (${
              userId ? userId.substring(0, 8) + '...' : 'Cargando...'
            })`; // Mostrar parte del UID si no hay alias
            userAliasInput.value = ''; // Limpiar el input si no hay alias
          }
        }

        function renderDashboard() {
          const transactionsForMonth = getTransactions({ month: filterMonth.value }); // Usa transacciones activas del mes
          const income = transactionsForMonth
            .filter((t) => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);
          const expenses = transactionsForMonth
            .filter((t) => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

          // Filtrar TODAS las transacciones activas para el Saldo Actual
          const activeTransactions = appState.transactions.filter((t) => !t.isArchived);
          const totalIncome = activeTransactions
            .filter((t) => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);
          const totalExpenses = activeTransactions
            .filter((t) => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);
          const currentBalance = appState.openingBalance + totalIncome - totalExpenses;

          document.getElementById('current-balance').textContent = formatCurrency(currentBalance);
          document.getElementById('monthly-income').textContent = formatCurrency(income);
          document.getElementById('monthly-expenses').textContent = formatCurrency(expenses);

          checkBudgetLimits();
        }

        function renderTransactionsTable() {
          const selectedMonth = filterMonth.value;
          const activeTransactions = appState.transactions;

          let runningBalance = appState.openingBalance;
          if (selectedMonth) {
            const transactionsBeforeFilter = activeTransactions
              .filter((t) => t.date.substring(0, 7) < selectedMonth)
              .sort((a, b) => new Date(a.date) - new Date(b.date));
            transactionsBeforeFilter.forEach((t) => {
              runningBalance += t.type === 'income' ? t.amount : -t.amount;
            });
          }
          const filteredTransactions = getFilteredTransactions();
          transactionsTableBody.innerHTML = '';

          const tableElement = document.querySelector('#registros-content table');
          const footerElement = tableElement.querySelector('tfoot');

          if (filteredTransactions.length === 0) {
            transactionsTableBody.classList.add('hidden');
            if (footerElement) footerElement.classList.add('hidden');
            noTransactionsMessage.classList.remove('hidden');
          } else {
            transactionsTableBody.classList.remove('hidden');
            if (footerElement) footerElement.classList.remove('hidden');
            noTransactionsMessage.classList.add('hidden');

            filteredTransactions.forEach((t) => {
              runningBalance += t.type === 'income' ? t.amount : -t.amount;
              const balanceStyle =
                runningBalance < 0
                  ? 'color: var(--expense-color);'
                  : 'color: var(--electric-blue);';
              const row = document.createElement('tr');

              let rowTextColorClass = '';
              if (t.category === 'Transferencia Interna') rowTextColorClass = 'transfer-text-row';
              else if (t.type === 'income') rowTextColorClass = 'income-text-row';
              else rowTextColorClass = 'expense-text-row';
              row.className = rowTextColorClass;
              // Construcción segura de celdas
              const cellCheckbox = row.insertCell();
              cellCheckbox.className = 'px-2 py-4 text-center';
              cellCheckbox.innerHTML = `<input type="checkbox" class="transaction-checkbox" data-id="${t.id}">`;
              const cellDate = row.insertCell();
              cellDate.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellDate.innerHTML = `<span class="desktop-date">${formatDate(
                t.date,
              )}</span><span class="mobile-date">${formatDateForMobile(t.date)}</span>`;
              const cellDesc = row.insertCell();
              cellDesc.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellDesc.textContent = t.description;
              const cellCat = row.insertCell();
              cellCat.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellCat.innerHTML = `<div class="category-cell-content">${getCategoryDisplay(
                t.category,
              )}<button class="info-btn" data-description="${t.description}">i</button></div>`;
              const cellBank = row.insertCell();
              cellBank.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellBank.textContent = t.bank;
              const cellAmount = row.insertCell();
              cellAmount.className = 'px-6 py-4 whitespace-nowrap text-sm text-right';
              cellAmount.style.fontWeight = '400';
              cellAmount.textContent = formatCurrency(t.amount);
              const cellBalance = row.insertCell();
              cellBalance.className =
                'px-6 py-4 whitespace-nowrap text-sm text-right balance-cell-bg';
              cellBalance.innerHTML = `<span style="${balanceStyle}">${formatCurrency(
                runningBalance,
              )}</span>`;

              const cellActions = row.insertCell();
              cellActions.className = 'px-6 py-4 whitespace-nowrap text-center text-sm';
              cellActions.style.fontWeight = '400';
              cellActions.innerHTML = `<button data-id="${t.id}" class="edit-btn mr-3">Editar</button><button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900">Eliminar</button>`;

              transactionsTableBody.appendChild(row);
            });

            const totalIncome = filteredTransactions
              .filter((t) => t.type === 'income')
              .reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = filteredTransactions
              .filter((t) => t.type === 'expense')
              .reduce((sum, t) => sum + t.amount, 0);

            // ===== ¡AJUSTE DEL FOOTER! =====
            //tableElement.querySelector('tfoot tr td:first-child').colSpan = 4; // Ajustado a 4 para alinear
            // =================================
            document.getElementById('registros-total-income').textContent =
              formatCurrency(totalIncome);
            document.getElementById('registros-total-expenses').textContent =
              formatCurrency(totalExpenses);
            // AÑADE ESTAS DOS LÍNEAS
            document.getElementById('mobile-registros-total-income').textContent =
              formatCurrency(totalIncome);
            document.getElementById('mobile-registros-total-expenses').textContent =
              formatCurrency(totalExpenses);
          }

          // ¡PARTE CRÍTICA! Aquí se vuelven a activar los botones después de crear la tabla.
          document
            .querySelectorAll('#registros-content .edit-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) =>
                openTransactionModal({ id: e.target.dataset.id }),
              ),
            );
          document
            .querySelectorAll('#registros-content .delete-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id)),
            );
          updateDeleteButtonVisibility();
        }

        function renderProyeccionTable() {
          const projections = getDynamicProjections();
          let runningBalance = appState.openingBalance;

          const selectedMonth = filterMonth.value;
          if (selectedMonth) {
            const transactionsBeforeFilter = appState.transactions
              .filter((t) => t.date.substring(0, 7) < selectedMonth)
              .sort((a, b) => new Date(a.date) - new Date(b.date));
            transactionsBeforeFilter.forEach((t) => {
              runningBalance += t.type === 'income' ? t.amount : -t.amount;
            });
          }

          proyeccionTableBody.innerHTML = '';
          const tableElement = document.querySelector('#proyeccion-content table');
          const footerElement = tableElement.querySelector('tfoot');

          if (projections.length === 0) {
            proyeccionTableBody.classList.add('hidden');
            if (footerElement) footerElement.classList.add('hidden');
            noProyeccionMessage.classList.remove('hidden');
          } else {
            proyeccionTableBody.classList.remove('hidden');
            if (footerElement) footerElement.classList.remove('hidden');
            noProyeccionMessage.classList.add('hidden');

            projections.forEach((p) => {
              runningBalance += p.type === 'income' ? p.amount : -p.amount;
              const balanceStyle =
                runningBalance < 0
                  ? 'color: var(--expense-color);'
                  : 'color: var(--electric-blue);';
              const row = document.createElement('tr');

              let rowTextColorClass = '';
              if (p.category === 'Transferencia Interna') rowTextColorClass = 'transfer-text-row';
              else if (p.type === 'income') rowTextColorClass = 'income-text-row';
              else rowTextColorClass = 'expense-text-row';

              if (p.isVirtual || p.isPureProjection) {
                row.style.fontStyle = 'italic';
                row.style.opacity = '0.75';
              }
              row.className = rowTextColorClass;

              const cellCheckbox = row.insertCell();
              cellCheckbox.className = 'px-2 py-4 text-center';
              if (!p.isVirtual) {
                cellCheckbox.innerHTML = `<input type="checkbox" class="projection-checkbox" data-id="${p.id}">`;
              }

              // El resto de las celdas (Fecha, Descripción, etc.) no cambian
              const cellDate = row.insertCell();
              cellDate.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellDate.innerHTML = `<span class="desktop-date">${formatDate(
                p.date,
              )}</span><span class="mobile-date">${formatDateForMobile(p.date)}</span>`;

              const cellDesc = row.insertCell();
              cellDesc.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellDesc.textContent = p.description;

              const cellCat = row.insertCell();
              cellCat.className = 'px-6 py-4 whitespace-nowrap text-sm';
              cellCat.innerHTML = `<div class="category-cell-content">${getCategoryDisplay(
                p.category,
              )}<button class="info-btn" data-description="${p.description}">i</button></div>`;

              const cellAmount = row.insertCell();
              cellAmount.className = 'px-6 py-4 whitespace-nowrap text-sm text-right';
              cellAmount.style.fontWeight = '400';
              cellAmount.textContent = formatCurrency(p.amount);

              const cellBalance = row.insertCell();
              cellBalance.className =
                'px-6 py-4 whitespace-nowrap text-sm text-right balance-cell-bg';
              cellBalance.innerHTML = `<span style="${balanceStyle}">${formatCurrency(
                runningBalance,
              )}</span>`;

              const cellActions = row.insertCell();
              cellActions.className = 'px-6 py-4 whitespace-nowrap text-center text-sm';
              cellActions.style.fontWeight = '400';

              // --- NUEVA LÓGICA DE ACCIONES ---
              if (p.isVirtual) {
                // Si es una proyección de un gasto recurrente, no tiene acciones.
                cellActions.innerHTML = `<span>(Proyectado)</span>`;
              } else if (p.isPureProjection) {
                // Si es una proyección manual: se puede EDITAR y ELIMINAR la proyección.
                cellActions.innerHTML = `<button data-id="${p.id}" class="edit-projection-btn edit-btn mr-3">Editar</button><button data-id="${p.id}" class="delete-projection-btn text-red-600 hover:text-red-900">Eliminar</button>`;
              } else {
                // Si es una transacción real: ahora también se podrá EDITAR y ELIMINAR la transacción.
                cellActions.innerHTML = `<button data-id="${p.id}" class="edit-projection-btn edit-btn mr-3">Editar</button><button data-id="${p.id}" class="delete-transaction-btn text-red-600 hover:text-red-900">Eliminar</button>`;
              }

              proyeccionTableBody.appendChild(row);
            });

            const totalIncome = projections
              .filter((p) => p.type === 'income')
              .reduce((sum, p) => sum + p.amount, 0);
            const totalExpenses = projections
              .filter((p) => p.type === 'expense')
              .reduce((sum, p) => sum + p.amount, 0);

            // Actualiza los totales de escritorio
            document.getElementById('proyeccion-total-income').textContent =
              formatCurrency(totalIncome);
            document.getElementById('proyeccion-total-expenses').textContent =
              formatCurrency(totalExpenses);

            // Actualiza los nuevos totales de móvil
            document.getElementById('mobile-proyeccion-total-income').textContent =
              formatCurrency(totalIncome);
            document.getElementById('mobile-proyeccion-total-expenses').textContent =
              formatCurrency(totalExpenses);
          }

          // --- ACTIVACIÓN DE BOTONES INTELIGENTE MEJORADA ---
          document
            .querySelectorAll('#proyeccion-content .delete-transaction-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id)),
            );
          document
            .querySelectorAll('#proyeccion-content .delete-projection-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteProjection(e.target.dataset.id)),
            );

          // Nuevo listener para el botón de editar proyección
          document.querySelectorAll('#proyeccion-content .edit-projection-btn').forEach((btn) =>
            btn.addEventListener('click', (e) => {
              modalContext = 'proyeccion'; // Asegura el contexto correcto
              openTransactionModal(e.target.dataset.id);
            }),
          );
        }

        function renderBankBalances() {
          const balancesGrid = document.getElementById('bank-balances-grid');
          const noBalancesMessage = document.getElementById('no-balances-message');
          balancesGrid.innerHTML = '';

          const activeTransactions = appState.transactions.filter((t) => !t.isArchived);

          const bankBalances = appState.banks.map((bankName) => {
            const income = activeTransactions
              .filter((t) => t.bank === bankName && t.type === 'income')
              .reduce((sum, t) => sum + t.amount, 0);
            const expenses = activeTransactions
              .filter((t) => t.bank === bankName && t.type === 'expense')
              .reduce((sum, t) => sum + t.amount, 0);
            return { name: bankName, balance: income - expenses };
          });

          if (bankBalances.length === 0) {
            noBalancesMessage.classList.remove('hidden');
            balancesGrid.classList.add('hidden');
          } else {
            noBalancesMessage.classList.remove('hidden');
            balancesGrid.classList.remove('hidden');

            bankBalances.forEach((bank) => {
              // Asignamos la nueva clase de la tarjeta (positiva o negativa)
              const balanceClass =
                bank.balance >= 0 ? 'balance-card-positive' : 'balance-card-negative';

              const card = document.createElement('div');
              // Eliminamos estilos de la tarjeta principal para que no interfieran
              card.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col justify-between';

              // **ESTRUCTURA HTML MEJORADA**
              // Aplicamos las nuevas clases directamente a la etiqueta <p> del saldo
              card.innerHTML = `
                              <div>
                                  <p class="text-lg font-semibold text-gray-700 mb-3">${
                                    bank.name
                                  }</p>
                                  <p class="balance-card-label ${balanceClass}">
                                      ${formatCurrency(bank.balance)}
                                  </p>
                              </div>
                          `;
              balancesGrid.appendChild(card);
            });
          }
        }

        function renderBudgetTable() {
          const budgetTableBody = document.getElementById('budget-table-body');
          const noCategoriesMessage = document.getElementById('no-categories-for-budget-message');
          budgetTableBody.innerHTML = '';

          if (!appState.categories || appState.categories.length === 0) {
            budgetTableBody.classList.add('hidden');
            noCategoriesMessage.classList.remove('hidden');
            return;
          }

          budgetTableBody.classList.remove('hidden');
          noCategoriesMessage.classList.add('hidden');

          const transactionsForMonth = getTransactions({ month: filterMonth.value });
          const expensesByCategory = transactionsForMonth
            .filter((t) => t.type === 'expense')
            .reduce((acc, t) => {
              acc[t.category] = (acc[t.category] || 0) + t.amount;
              return acc;
            }, {});

          let totalBudgeted = 0;
          let totalSpent = 0;
          let totalRemaining = 0;

          appState.categories.forEach((categoryObj) => {
            const categoryName = categoryObj.name;

            if (categoryName === 'Sueldo' || categoryName === 'Transferencia Interna') {
              return;
            }

            const budgetAmount = appState.categoryBudgets[categoryName] || 0;
            const spentAmount = expensesByCategory[categoryName] || 0;
            const remainingAmount = budgetAmount - spentAmount;

            totalBudgeted += budgetAmount;
            totalSpent += spentAmount;
            totalRemaining += remainingAmount;

            let balanceClass = 'zero-balance';
            if (remainingAmount > 0) balanceClass = 'positive-balance';
            if (remainingAmount < 0) balanceClass = 'negative-balance';

            const row = document.createElement('tr');
            row.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${getCategoryDisplay(
                            categoryName,
                          )}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                              <input 
                                  type="number" 
                                  min="0" 
                                  step="1" 
                                  data-category="${categoryName}"
                                  class="budget-table-input category-budget-input" 
                                  placeholder="Asignar" 
                                  value="${budgetAmount > 0 ? budgetAmount : ''}">
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-orange-500">${formatCurrency(
                            spentAmount,
                          )}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${balanceClass}">${formatCurrency(
              remainingAmount,
            )}</td>
                      `;
            budgetTableBody.appendChild(row);
          });

          document.getElementById('budget-total-budgeted').textContent =
            formatCurrency(totalBudgeted);
          document.getElementById('budget-total-spent').textContent = formatCurrency(totalSpent);
          document.getElementById('budget-total-remaining').textContent =
            formatCurrency(totalRemaining);
        }

        function renderReports() {
          const transactionsForMonth = getTransactions({ month: filterMonth.value });
          const expensesByCategory = transactionsForMonth
            .filter((t) => t.type === 'expense')
            .reduce((acc, t) => {
              acc[t.category] = (acc[t.category] || 0) + t.amount;
              return acc;
            }, {});

          const labels = Object.keys(expensesByCategory);
          const data = Object.values(expensesByCategory);
          const totalExpenses = data.reduce((sum, amount) => sum + amount, 0);

          const categoryTotalsList = document.getElementById('category-totals-list');
          categoryTotalsList.innerHTML = '';
          if (labels.length > 0) {
            const sortedCategories = Object.entries(expensesByCategory).sort(
              ([, a], [, b]) => b - a,
            );
            sortedCategories.forEach(([category, amount]) => {
              const item = document.createElement('div');
              item.className =
                'flex justify-between items-center text-sm p-2 bg-gray-50 rounded-md';
              // --- LÍNEA MODIFICADA ---
              item.innerHTML = `
                              <span class="text-gray-700">${getCategoryDisplay(category)}</span>
                              <span class="font-medium text-red-500">${formatCurrency(
                                amount,
                              )}</span>
                          `;
              categoryTotalsList.appendChild(item);
            });
          } else {
            categoryTotalsList.innerHTML =
              '<p class="text-gray-500 text-center">No hay gastos para mostrar en este período.</p>';
          }
          document.getElementById('total-expenses-report').textContent =
            formatCurrency(totalExpenses);

          const ctx = document.getElementById('expenses-chart').getContext('2d');
          if (expensesChartInstance) expensesChartInstance.destroy();
          expensesChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Gastos por Categoría',
                  data: data,
                  backgroundColor: [
                    '#ef4444',
                    '#f97316',
                    '#f59e0b',
                    '#eab308',
                    '#84cc16',
                    '#22c55e',
                    '#10b981',
                    '#14b8a6',
                    '#06b6d4',
                    '#0ea5e9',
                    '#3b82f6',
                    '#6366f1',
                    '#8b5cf6',
                    '#a855f7',
                    '#d946ef',
                    '#ec4899',
                  ],
                  hoverOffset: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' },
                title: {
                  display: true,
                  text: `Distribución de Gastos para ${formatMonthYear(filterMonth.value)}`,
                },
              },
            },
          });

          renderCashFlowChart();
        }

        function renderCashFlowChart() {
          const validTransactions = appState.transactions.filter(
            (t) => t && typeof t.date === 'string',
          );
          const allMonths = [
            ...new Set(validTransactions.map((t) => t.date.substring(0, 7))),
          ].sort();

          const monthlyData = allMonths.map((month) => {
            // Usamos 'validTransactions' en lugar de 'appState.transactions'
            const transactionsInMonth = validTransactions.filter((t) => t.date.startsWith(month));
            const income = transactionsInMonth
              .filter((t) => t.type === 'income')
              .reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactionsInMonth
              .filter((t) => t.type === 'expense')
              .reduce((sum, t) => sum + t.amount, 0);
            return { month, income, expenses };
          });

          const labels = monthlyData.map((d) => formatMonthYear(d.month));
          const incomeData = monthlyData.map((d) => d.income);
          const expensesData = monthlyData.map((d) => d.expenses);

          const ctx = document.getElementById('cash-flow-chart').getContext('2d');
          if (cashFlowChartInstance) cashFlowChartInstance.destroy();
          cashFlowChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Ingresos',
                  data: incomeData,
                  backgroundColor: '#22c55e', // green-500
                  borderColor: '#16a34a',
                  borderWidth: 1,
                },
                {
                  label: 'Gastos',
                  data: expensesData,
                  backgroundColor: '#ef4444', // red-500
                  borderColor: '#dc2626',
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Ingresos vs. Gastos por Mes' },
              },
              scales: {
                x: { stacked: false },
                y: { stacked: false, beginAtZero: true },
              },
            },
          });
        }

        function renderCreditCardAlerts() {
          creditCardAlertsDiv.innerHTML = '';
          const today = new Date();
          const alerts = [];

          appState.creditCards.forEach((card) => {
            const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
            if (today.getDate() > card.dueDate) {
              nextDueDate.setMonth(nextDueDate.getMonth() + 1);
            }
            const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

            if (daysDiff >= 0 && daysDiff <= 5) {
              let message = `¡Atención! El pago de tu tarjeta ${
                card.bank
              } vence en ${daysDiff} día(s). Monto: ${formatCurrency(card.amount)}.`;
              if (daysDiff === 0) {
                message = `¡Atención! El pago de tu tarjeta ${
                  card.bank
                } vence HOY. Monto: ${formatCurrency(card.amount)}.`;
              }
              alerts.push(message);
            }
          });

          if (alerts.length > 0) {
            alerts.forEach((alertText) => {
              const p = document.createElement('p');
              p.className =
                'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-2 mb-1 rounded-md shadow-sm';
              p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>${alertText}`;
              creditCardAlertsDiv.appendChild(p);
            });
          }
        }

        function renderRecurringAlerts() {
          const recurringAlertsDiv = document.getElementById('recurring-alerts');
          recurringAlertsDiv.innerHTML = '';
          const today = new Date();
          const alerts = [];

          appState.recurringExpenses.forEach((expense) => {
            const expenseDay = parseInt(expense.day, 10);
            const nextDueDate = new Date(today.getFullYear(), today.getMonth(), expenseDay);

            // Si la fecha de pago de este mes ya pasó, calcula para el mes siguiente.
            if (today.getDate() > expenseDay) {
              nextDueDate.setMonth(nextDueDate.getMonth() + 1);
            }

            const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

            // Nueva lógica: notificar si faltan 5 días o menos.
            if (daysDiff >= 0 && daysDiff <= 5) {
              let message = `¡Atención! El pago de "${
                expense.description
              }" vence en ${daysDiff} día(s). Monto: ${formatCurrency(expense.amount)}.`;
              if (daysDiff === 0) {
                message = `¡Atención! El pago de "${
                  expense.description
                }" vence HOY. Monto: ${formatCurrency(expense.amount)}.`;
              }

              // Determina el tipo de alerta (peligro o advertencia) según los días restantes.
              const alertType = daysDiff <= 2 ? 'danger' : 'warning';
              alerts.push({ text: message, type: alertType });
            }
          });

          if (alerts.length > 0) {
            alerts.forEach((alert) => {
              const p = document.createElement('p');
              // Asigna la clase 'danger' o 'warning' para que coincida con el CSS que creamos.
              p.className = alert.type;
              p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><path d="M12 8v4l-2 2"/></svg>${alert.text}`;
              recurringAlertsDiv.appendChild(p);
            });
          }
        }
        // --- MODALES Y NOTIFICACIONES ---
        function showLoading() {
          loadingOverlay.classList.add('active');
        }

        function hideLoading() {
          loadingOverlay.classList.remove('active');
        }

        /**
         * Muestra un modal de mensaje con título, contenido y tipo.
         * @param {string} title - Título del modal.
         * @param {string} message - Contenido del mensaje.
         * @param {'info'|'success'|'error'} type - Tipo de mensaje para estilos (info por defecto).
         */
        function showMessageModal(title, message, type = 'info') {
          if (!messageModal) return;
          messageModalTitle.textContent = title;
          messageModalContent.textContent = message;

          // Limpiar clases de tipo previas
          messageModalTitle.classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
          messageModalContent.classList.remove('text-blue-700', 'text-green-700', 'text-red-700');
          messageModal
            .querySelector('.mx-auto.flex')
            .classList.remove('bg-blue-100', 'bg-green-100', 'bg-red-100');
          messageModal
            .querySelector('.mx-auto.flex svg')
            .classList.remove('text-blue-600', 'text-green-600', 'text-red-600');

          let iconSvg = '';
          switch (type) {
            case 'success':
              messageModalTitle.classList.add('text-green-600');
              messageModalContent.classList.add('text-green-700');
              messageModal.querySelector('.mx-auto.flex').classList.add('bg-green-100');
              messageModal.querySelector('.mx-auto.flex svg').classList.add('text-green-600');
              iconSvg =
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
            case 'error':
              messageModalTitle.classList.add('text-red-600');
              messageModalContent.classList.add('text-red-700');
              messageModal.querySelector('.mx-auto.flex').classList.add('bg-red-100');
              messageModal.querySelector('.mx-auto.flex svg').classList.add('text-red-600');
              iconSvg =
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
            case 'info':
            default:
              messageModalTitle.classList.add('text-blue-600');
              messageModalContent.classList.add('text-blue-700');
              messageModal.querySelector('.mx-auto.flex').classList.add('bg-blue-100');
              messageModal.querySelector('.mx-auto.flex svg').classList.add('text-blue-600');
              iconSvg =
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
          }
          messageModal.querySelector('.mx-auto.flex').innerHTML = iconSvg; // Actualizar el icono
          messageModal.classList.add('active');
        }

        function closeMessageModal() {
          messageModal.classList.remove('active');
        }

        /**
         * Muestra una notificación "toast" temporal.
         * @param {string} message - Mensaje a mostrar.
         * @param {'success'|'error'|'info'} type - Tipo de notificación.
         * @param {number} duration - Duración en milisegundos (por defecto 3000).
         */
        function showToast(message, type = 'info', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          let iconSvg = '';
          switch (type) {
            case 'success':
              iconSvg =
                '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
            case 'error':
              iconSvg =
                '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
            case 'info':
            default:
              iconSvg =
                '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
              break;
          }
          toast.innerHTML = `${iconSvg}<span>${message}</span>`;
          toastContainer.appendChild(toast);

          // Forzar reflow para la animación
          void toast.offsetWidth;
          toast.classList.add('show');

          setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
          }, duration);
        }

        function openConfirmModal(title, message, onConfirm) {
          document.getElementById('confirm-modal-title').textContent = title;
          document.getElementById('confirm-modal-message').textContent = message;
          confirmCallback = onConfirm;
          confirmModal.classList.add('active');
        }

        function closeConfirmModal() {
          confirmModal.classList.remove('active');
          confirmCallback = null;
        }

        /**
         * Abre el modal de transacciones, ahora con opciones para pre-configurarlo.
         * @param {object} options - Opciones para abrir el modal.
         * @param {string|null} options.id - El ID del elemento a editar.
         * @param {'income'|'expense'} options.type - El tipo de transacción a preseleccionar.
         * @param {boolean} options.lockType - Si es true, deshabilita el otro tipo de transacción.
         */

        function openTransactionModal(options = {}) {
          const { id = null, type = 'expense' } = options;

          transactionForm.reset();
          clearValidationErrors();
          populateModalDropdowns();
          populateDescriptionDatalist();

          const modalTitle = document.getElementById('modal-title');
          let effectiveType = type; // El tipo por defecto es el que se pasa en 'options'
          let actionText = modalContext === 'proyeccion' ? 'Registrar Proyección de' : 'Registrar';

          if (id) {
            // --- Lógica para EDITAR un registro existente ---
            let item = appState.transactions.find((t) => t.id === id);
            let sourceCollection = 'transactions';
            if (!item) {
              item = appState.projections.find((p) => p.id === id);
              sourceCollection = 'proyections';
            }

            if (item) {
              effectiveType = item.type; // Sobrescribimos con el tipo real del item
              actionText = sourceCollection === 'proyections' ? 'Editar Proyección de' : 'Editar';

              // Llenar el formulario con los datos del item (esto no cambia)
              document.getElementById('transaction-id').value = item.id;
              document.getElementById('transaction-date').value = item.date;
              document.getElementById('transaction-description').value = item.description;
              const categoryObject = appState.categories.find((c) => c.name === item.category);
              if (categoryObject) {
                categorySelectButton.innerHTML = `
                            <img src="${categoryObject.icon || DEFAULT_ICON}" alt="${
                  categoryObject.name
                }">
                            <span>${categoryObject.name}</span>`;
                transactionCategoryHiddenInput.value = categoryObject.name;
              }
              document.getElementById('transaction-bank').value = item.bank;
              document.getElementById('transaction-amount').value = item.amount;
            } else {
              showMessageModal('Error', 'Elemento no encontrado.', 'error');
              return;
            }
          } else {
            // --- Lógica para un NUEVO registro (esto no cambia) ---
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-date').valueAsDate = new Date();
            categorySelectButton.innerHTML = `<span>Seleccionar Categoría...</span>`;
            transactionCategoryHiddenInput.value = '';
          }

          // --- LÓGICA UNIFICADA PARA CAMBIAR EL TÍTULO Y COLOR ---
          if (effectiveType === 'income') {
            modalTitle.textContent = `${actionText} Ingreso`;
            modalTitle.style.color = 'var(--electric-green)'; // Verde
          } else {
            // Por defecto, es un gasto
            modalTitle.textContent = `${actionText} Gasto`;
            modalTitle.style.color = 'var(--electric-red)'; // Rojo
          }

          document.getElementById('transaction-type-hidden').value = effectiveType;
          transactionModal.classList.add('active');
          document.getElementById('transaction-date').focus();
        }

        function closeTransactionModal() {
          transactionModal.classList.remove('active');
          clearValidationErrors(); // Limpiar errores al cerrar el modal
          document.getElementById('modal-title').style.color = ''; // Resetear color del título
        }

        /**
         * Abre el modal de selección de categorías y lo puebla con los iconos.
         */
        function openCategorySelector() {
          categorySelectGrid.innerHTML = ''; // Limpia la parrilla anterior

          appState.categories.forEach((cat) => {
            // No mostramos categorías especiales como 'Transferencia Interna' en el selector
            if (cat.name === 'Transferencia Interna') return;

            const option = document.createElement('div');
            option.className = 'category-select-option';
            option.dataset.categoryName = cat.name; // Guardamos el nombre para usarlo después

            option.innerHTML = `
                          <img src="${cat.icon || DEFAULT_ICON}" alt="${cat.name}">
                          <span>${cat.name}</span>
                      `;

            option.addEventListener('click', () => {
              // 1. Actualiza el botón visual
              categorySelectButton.innerHTML = `
                              <img src="${cat.icon || DEFAULT_ICON}" alt="${cat.name}">
                              <span>${cat.name}</span>
                          `;
              // 2. Guarda el valor en el campo oculto
              transactionCategoryHiddenInput.value = cat.name;

              // 3. Cierra el modal de selección
              categorySelectModal.classList.remove('active');

              // 4. (NUEVO) Pone el foco en el campo del monto
              document.getElementById('transaction-amount').focus();
            });

            categorySelectGrid.appendChild(option);
          });

          categorySelectModal.classList.add('active');
        }

        async function handleFormSubmit(e) {
          e.preventDefault();
          clearValidationErrors();

          const description = toTitleCase(
            document.getElementById('transaction-description').value.trim(),
          );
          const amount = parseFloat(document.getElementById('transaction-amount').value);
          const date = document.getElementById('transaction-date').value;
          const category = transactionCategoryHiddenInput.value;
          const bank = document.getElementById('transaction-bank').value;
          const type = document.getElementById('transaction-type-hidden').value; // <-- LÍNEA MODIFICADA
          const id = document.getElementById('transaction-id').value;

          let isValid = true;
          if (
            !validateRequired(
              document.getElementById('transaction-date'),
              transactionDateError,
              'La fecha es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transaction-description'),
              transactionDescriptionError,
              'La descripción es obligatoria.',
            )
          )
            isValid = false;
          // CORRECCIÓN: Apuntamos al input oculto correcto para la validación de la categoría.
          if (
            !validateRequired(
              document.getElementById('transaction-category-hidden'),
              transactionCategoryError,
              'La categoría es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transaction-bank'),
              transactionBankError,
              'El banco/cuenta es obligatorio.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('transaction-amount'),
              transactionAmountError,
              'El monto debe ser un número positivo.',
            )
          )
            isValid = false;
          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario.', 'error');
            return;
          }

          const saveBtn = document.getElementById('save-transaction-btn');
          showButtonLoading(saveBtn);
          const appId = firebaseProjectId;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          // Determina la colección correcta basándose en el contexto del modal.
          const targetCollection = modalContext === 'proyeccion' ? 'projections' : 'transactions';
          const collectionRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/${targetCollection}`,
          );

          const transactionData = { date, description, category, bank, amount, type };

          try {
            if (id) {
              // Lógica de actualización (funciona para ambas colecciones)
              const docRef = doc(collectionRef, id);
              await setDoc(docRef, transactionData, { merge: true });
              showToast(
                `${modalContext === 'proyeccion' ? 'Proyección' : 'Transacción'} actualizada.`,
                'success',
              );
              closeTransactionModal();
            } else {
              // Lógica de creación (funciona para ambas colecciones)
              const newDocRef = doc(collectionRef);
              await setDoc(newDocRef, { ...transactionData, id: newDocRef.id });
              showToast(
                `${modalContext === 'proyeccion' ? 'Proyección' : 'Transacción'} registrada.`,
                'success',
              );
            }

            if (!id) {
              // Solo si es una entrada nueva
              const isNewDescription =
                description &&
                !appState.descriptions.some((d) => d.toLowerCase() === description.toLowerCase());
              if (isNewDescription) {
                openConfirmModal(
                  'Guardar Descripción',
                  `La descripción "${description}" es nueva. ¿Deseas guardarla para usarla en el futuro?`,
                  async () => {
                    const updatedDescriptions = [...appState.descriptions, description].sort(
                      (a, b) => a.localeCompare(b),
                    );
                    await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                    showToast(`Descripción "${description}" guardada.`, 'info');
                  },
                );
              }
              transactionForm.reset();
              document.getElementById('transaction-date').valueAsDate = new Date();
              document.getElementById('transaction-date').focus();
            }
          } catch (error) {
            console.error(`[Firestore] Error al guardar en ${targetCollection}:`, error);
            showMessageModal('Error al Guardar', 'No se pudo guardar el registro.', 'error');
          } finally {
            hideButtonLoading(saveBtn);
          }
        }

        async function deleteTransaction(id) {
          openConfirmModal(
            'Eliminar Transacción',
            'Esta acción eliminará la transacción permanentemente. ¿Continuar?',
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              // Ahora solo necesitamos apuntar a la colección de transacciones
              const transactionDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/transactions`,
                id,
              );

              try {
                await deleteDoc(transactionDocRef);
                showToast('Transacción eliminada con éxito.', 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar transacción:', error);
                showMessageModal(
                  'Error al Eliminar',
                  'No se pudo eliminar la transacción.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        async function deleteProjection(id) {
          openConfirmModal(
            'Eliminar Proyección',
            'Esto eliminará esta proyección simulada. ¿Continuar?',
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              // Apunta a la colección de proyecciones
              const projectionDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/projections`,
                id,
              );

              try {
                await deleteDoc(projectionDocRef);
                showToast('Proyección eliminada con éxito.', 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar proyección:', error);
                showMessageModal(
                  'Error al Eliminar',
                  'No se pudo eliminar la proyección.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        function openTransferModal() {
          closeTransactionModal();
          transferForm.reset();
          clearValidationErrors(); // Limpiar errores
          populateTransferModalDropdowns();
          document.getElementById('transfer-date').valueAsDate = new Date();
          transferModal.classList.add('active');
        }

        function closeTransferModal() {
          transferModal.classList.remove('active');
          clearValidationErrors(); // Limpiar errores
        }

        async function handleTransferFormSubmit(e) {
          e.preventDefault();
          clearValidationErrors(); // Limpiar errores previos

          const fromBank = document.getElementById('transfer-from-bank').value;
          const toBank = document.getElementById('transfer-to-bank').value;
          const amount = parseFloat(document.getElementById('transfer-amount').value);
          const date = document.getElementById('transfer-date').value;

          let isValid = true;
          if (
            !validateRequired(
              document.getElementById('transfer-date'),
              transferDateError,
              'La fecha es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transfer-from-bank'),
              transferFromBankError,
              'La cuenta de origen es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('transfer-to-bank'),
              transferToBankError,
              'La cuenta de destino es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('transfer-amount'),
              transferAmountError,
              'El monto debe ser un número positivo.',
            )
          )
            isValid = false;

          if (fromBank === toBank) {
            showError(transferToBankError, 'La cuenta de origen y destino no pueden ser la misma.');
            isValid = false;
          }

          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario de transferencia.', 'error');
            return;
          }

          showButtonLoading(document.getElementById('confirm-transfer-btn'));
          const appId = firebaseProjectId;
          const transactionsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/transactions`,
          );

          const batch = writeBatch(db);
          const newExpenseDocRef = doc(transactionsColRef);
          const newIncomeDocRef = doc(transactionsColRef);

          const expenseTransaction = {
            id: newExpenseDocRef.id,
            date: date,
            description: `Transferencia a ${toBank}`,
            category: 'Transferencia Interna',
            bank: fromBank,
            amount: amount,
            type: 'expense',
          };
          const incomeTransaction = {
            id: newIncomeDocRef.id,
            date: date,
            description: `Transferencia desde ${fromBank}`,
            category: 'Transferencia Interna',
            bank: toBank,
            amount: amount,
            type: 'income',
          };

          batch.set(newExpenseDocRef, expenseTransaction);
          batch.set(newIncomeDocRef, incomeTransaction);
          console.log('[Firestore] Registrando transferencia interna.'); // Debugging

          try {
            await batch.commit();
            closeTransferModal();
            showToast('Transferencia registrada exitosamente.', 'success');
          } catch (error) {
            console.error('[Firestore] Error al registrar transferencia:', error); // Debugging
            showMessageModal(
              'Error al Registrar Transferencia',
              'No se pudo registrar la transferencia. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
              'error',
            );
          } finally {
            hideButtonLoading(document.getElementById('confirm-transfer-btn'));
          }
        }

        function renderConfigurationLists() {
          const categoryList = document.getElementById('category-list');
          const bankList = document.getElementById('bank-list');
          const descriptionListConfig = document.getElementById('description-list-config');

          categoryList.innerHTML = '';
          bankList.innerHTML = '';
          descriptionListConfig.innerHTML = '';

          // MODIFICADO: Muestra el icono junto al nombre de la categoría.
          if (appState.categories.length > 0) {
            appState.categories.forEach((cat) => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg gap-2';
              li.innerHTML = `
                              <span class="flex-grow flex items-center">${getCategoryDisplay(
                                cat.name,
                              )}</span>
                              <button data-name="${
                                cat.name
                              }" class="delete-category-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>
                          `;
              categoryList.appendChild(li);
            });
          } else {
            categoryList.innerHTML =
              '<p class="text-gray-500 text-sm p-2">No hay categorías añadidas.</p>';
          }

          if (appState.banks.length > 0) {
            appState.banks.forEach((bank) => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
              li.innerHTML = `<span>${bank}</span><button data-name="${bank}" class="delete-bank-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
              bankList.appendChild(li);
            });
          } else {
            bankList.innerHTML =
              '<p class="text-gray-500 text-sm p-2">No hay bancos/cuentas añadidos.</p>';
          }

          if (appState.descriptions.length === 0) {
            descriptionListConfig.innerHTML =
              '<p class="text-gray-500 text-sm p-2">No hay descripciones guardadas.</p>';
          } else {
            appState.descriptions.forEach((desc) => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
              li.innerHTML = `<span class="truncate pr-2">${desc}</span><button data-name="${desc}" class="delete-description-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
              descriptionListConfig.appendChild(li);
            });
          }

          document
            .querySelectorAll('.delete-category-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteCategory(e.target.dataset.name)),
            );
          document
            .querySelectorAll('.delete-bank-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteBank(e.target.dataset.name)),
            );
          document
            .querySelectorAll('.delete-description-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteDescription(e.target.dataset.name)),
            );
        }

        async function addCategory() {
          clearValidationErrors();
          const input = document.getElementById('new-category-name-modal');
          const errorElement = document.getElementById('new-category-name-modal-error');
          const name = toTitleCase(input.value.trim());
          const selectedIconElement = document.querySelector(
            '#category-icon-grid .icon-option.selected',
          );
          const icon = selectedIconElement ? selectedIconElement.dataset.icon : DEFAULT_ICON;

          let isValid = true;
          if (!validateRequired(input, errorElement, 'El nombre de la categoría es obligatorio.'))
            isValid = false;

          // MODIFICADO: Busca en el array de objetos por la propiedad 'name'.
          if (
            name &&
            appState.categories.some((c) => c.name.toLowerCase() === name.toLowerCase())
          ) {
            showError(errorElement, `La categoría "${name}" ya existe.`);
            isValid = false;
          }

          if (!isValid) {
            showToast('Por favor, corrige los errores para añadir la categoría.', 'error');
            return;
          }

          showButtonLoading(document.getElementById('save-new-category-btn'));
          const appId = firebaseProjectId;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          try {
            // MODIFICADO: Crea el nuevo objeto de categoría y lo añade al array.
            const newCategory = { name, icon };
            const updatedCategories = [...appState.categories, newCategory].sort((a, b) =>
              a.name.localeCompare(b.name),
            );

            console.log('[Firestore] Añadiendo categoría:', newCategory);
            await updateDoc(userDocRef, { categories: updatedCategories });

            showToast(`Categoría "${name}" añadida.`, 'success');

            if (isAddingCategoryFromTransaction) {
              // 1. Actualizamos el botón del formulario de transacción con la nueva categoría
              categorySelectButton.innerHTML = `
                              <img src="${newCategory.icon || DEFAULT_ICON}" alt="${
                newCategory.name
              }">
                              <span>${newCategory.name}</span>
                          `;
              // 2. Guardamos el valor en el campo oculto
              transactionCategoryHiddenInput.value = newCategory.name;

              // 3. Cerramos TODOS los modales abiertos
              closeAddCategoryModal();
              categorySelectModal.classList.remove('active');

              // 4. Reseteamos nuestra "memoria" para la próxima vez
              isAddingCategoryFromTransaction = false;
            } else {
              // Si no, simplemente cerramos el modal de creación (comportamiento normal)
              closeAddCategoryModal();
            }
          } catch (error) {
            console.error('[Firestore] Error al añadir categoría:', error);
            showMessageModal(
              'Error al Añadir Categoría',
              'No se pudo añadir la categoría.',
              'error',
            );
          } finally {
            hideButtonLoading(document.getElementById('save-new-category-btn'));
          }
        }

        async function deleteCategory(name) {
          openConfirmModal(
            'Eliminar Categoría',
            `¿Seguro que quieres eliminar la categoría "${name}"? Esto no eliminará las transacciones existentes con esta categoría.`,
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );
              console.log('[Firestore] Eliminando categoría:', name);
              try {
                // MODIFICADO: Filtra el array de objetos para eliminar la categoría por su nombre.
                const updatedCategories = appState.categories.filter((c) => c.name !== name);
                await updateDoc(userDocRef, { categories: updatedCategories });
                showToast(`Categoría "${name}" eliminada.`, 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar categoría:', error);
                showMessageModal(
                  'Error al Eliminar Categoría',
                  'No se pudo eliminar la categoría.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        async function addBank() {
          clearValidationErrors(); // Limpiar errores previos
          const input = document.getElementById('new-bank-name');
          const name = toTitleCase(input.value.trim());

          let isValid = true;
          if (
            !validateRequired(input, newBankNameError, 'El nombre del banco/cuenta es obligatorio.')
          )
            isValid = false;

          if (name && appState.banks.some((b) => b.toLowerCase() === name.toLowerCase())) {
            showError(newBankNameError, `El banco/cuenta "${name}" ya existe.`);
            isValid = false;
          }

          if (!isValid) {
            showToast('Por favor, corrige los errores para añadir el banco/cuenta.', 'error');
            return;
          }

          showButtonLoading(document.getElementById('add-bank-btn'));
          const appId = firebaseProjectId;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          try {
            const updatedBanks = [...appState.banks, name].sort((a, b) => a.localeCompare(b));
            console.log('[Firestore] Añadiendo banco:', name); // Debugging
            await updateDoc(userDocRef, { banks: updatedBanks });
            input.value = '';
            showToast(`Banco/Cuenta "${name}" añadido.`, 'success');
          } catch (error) {
            console.error('[Firestore] Error al añadir banco:', error); // Debugging
            showMessageModal(
              'Error al Añadir Banco/Cuenta',
              'No se pudo añadir el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
              'error',
            );
          } finally {
            hideButtonLoading(document.getElementById('add-bank-btn'));
          }
        }

        async function deleteBank(name) {
          openConfirmModal(
            'Eliminar Banco/Cuenta',
            `Al eliminar "${name}", también se eliminará la tarjeta de crédito asociada, si existe. ¿Deseas continuar?`,
            async () => {
              showLoading(); // Usar overlay global
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );
              const creditCardsColRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/creditCards`,
              );
              console.log('[Firestore] Eliminando banco:', name); // Debugging

              try {
                const batch = writeBatch(db);

                // Eliminar el banco de la lista de bancos
                const updatedBanks = appState.banks.filter((b) => b !== name);
                batch.update(userDocRef, { banks: updatedBanks });

                // Eliminar tarjetas de crédito asociadas
                const cardsToDelete = appState.creditCards.filter((cc) => cc.bank === name);
                cardsToDelete.forEach((card) => {
                  batch.delete(doc(creditCardsColRef, card.id));
                });

                await batch.commit();
                showToast(`Banco/Cuenta "${name}" y tarjetas asociadas eliminados.`, 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar banco/cuenta:', error); // Debugging
                showMessageModal(
                  'Error al Eliminar Banco/Cuenta',
                  'No se pudo eliminar el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        async function deleteDescription(name) {
          openConfirmModal(
            'Eliminar Descripción',
            `¿Seguro que quieres eliminar la descripción guardada "${name}"?`,
            async () => {
              showLoading(); // Usar overlay global
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );
              console.log('[Firestore] Eliminando descripción:', name); // Debugging
              try {
                const updatedDescriptions = appState.descriptions.filter((d) => d !== name);
                await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                showToast(`Descripción "${name}" eliminada.`, 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar descripción:', error); // Debugging
                showMessageModal(
                  'Error al Eliminar Descripción',
                  'No se pudo eliminar la descripción. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        async function handleSaveAlias() {
          clearValidationErrors(); // Limpiar errores previos
          const alias = userAliasInput.value.trim();

          let isValid = true;
          if (!validateRequired(userAliasInput, userAliasError, 'El alias no puede estar vacío.'))
            isValid = false;
          // Puedes añadir más validaciones aquí, como longitud máxima, caracteres permitidos, etc.

          if (!isValid) {
            showToast('Por favor, corrige los errores para guardar el alias.', 'error');
            return;
          }

          showButtonLoading(saveAliasBtn);
          const appId = firebaseProjectId;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          try {
            await updateDoc(userDocRef, { userAlias: alias });
            appState.userAlias = alias; // Actualizar el estado local inmediatamente
            renderHeaderAlias(); // Actualizar la cabecera
            showToast('Alias guardado exitosamente.', 'success');
          } catch (error) {
            console.error('[Firestore] Error al guardar alias:', error);
            showMessageModal(
              'Error al Guardar Alias',
              'No se pudo guardar el alias. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
              'error',
            );
          } finally {
            hideButtonLoading(saveAliasBtn);
          }
        }

        async function handleChangePassword(e) {
          e.preventDefault();
          clearValidationErrors();

          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmNewPassword = confirmNewPasswordInput.value;
          const user = auth.currentUser;

          // --- 1. Validaciones del formulario ---
          let isValid = true;
          if (
            !validateRequired(
              currentPasswordInput,
              currentPasswordError,
              'La contraseña actual es obligatoria.',
            )
          )
            isValid = false;
          if (!validatePassword(newPasswordInput, newPasswordError, 6)) isValid = false; // Mínimo 6 caracteres

          if (newPassword !== confirmNewPassword) {
            showError(confirmNewPasswordError, 'Las nuevas contraseñas no coinciden.');
            isValid = false;
          }

          if (currentPassword === newPassword) {
            showError(newPasswordError, 'La nueva contraseña no puede ser igual a la actual.');
            isValid = false;
          }

          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario.', 'error');
            return;
          }

          if (!user) {
            showMessageModal(
              'Error',
              'No se ha encontrado un usuario activo. Por favor, inicia sesión de nuevo.',
              'error',
            );
            return;
          }

          showButtonLoading(changePasswordBtn);

          try {
            // --- 2. Re-autenticar al usuario (Paso de seguridad) ---
            const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
            await window.reauthenticateWithCredential(user, credential);

            // --- 3. Si la re-autenticación es exitosa, actualizar la contraseña ---
            await window.updatePassword(user, newPassword);

            showMessageModal(
              'Éxito',
              'Tu contraseña ha sido actualizada correctamente.',
              'success',
            );
            changePasswordForm.reset(); // Limpiar el formulario
          } catch (error) {
            console.error('Error al cambiar la contraseña:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
              showError(currentPasswordError, 'La contraseña actual es incorrecta.');
            } else if (error.code === 'auth/weak-password') {
              showError(
                newPasswordError,
                'La nueva contraseña es demasiado débil. Debe tener al menos 6 caracteres.',
              );
            } else {
              showMessageModal(
                'Error',
                'Ocurrió un error inesperado al cambiar la contraseña. Inténtalo de nuevo.',
                'error',
              );
            }
          } finally {
            hideButtonLoading(changePasswordBtn);
          }
        }
        // --- NUEVA FUNCIÓN: Guardar Presupuestos ---
        async function handleSaveBudgets() {
          showButtonLoading(document.getElementById('save-budgets-btn'));
          const newBudgets = {};
          document.querySelectorAll('.category-budget-input').forEach((input) => {
            const category = input.dataset.category;
            const amount = parseFloat(input.value);
            if (category && !isNaN(amount) && amount > 0) {
              newBudgets[category] = amount;
            }
          });

          const appId = firebaseProjectId;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          try {
            await updateDoc(userDocRef, { categoryBudgets: newBudgets });
            appState.categoryBudgets = newBudgets; // Actualizar estado local
            showToast('Presupuestos guardados exitosamente.', 'success');
          } catch (error) {
            console.error('[Firestore] Error al guardar presupuestos:', error);
            showMessageModal(
              'Error al Guardar',
              'No se pudieron guardar los presupuestos.',
              'error',
            );
          } finally {
            hideButtonLoading(document.getElementById('save-budgets-btn'));
          }
        }

        async function initiateNewMonth() {
          openConfirmModal(
            'Iniciar Nuevo Mes',
            'Este proceso hará lo siguiente: 1. Limpiará y llenará su Proyección con todos los gastos recurrentes. 2. Registrará en sus Registros solo los gastos recurrentes ya vencidos. 3. Archivará sus registros actuales y actualizará su saldo inicial. ¿Continuar?',
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );
              const transactionsColRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/transactions`,
              );
              const projectionsColRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/projections`,
              );
              const archivesColRef = collection(db, `artifacts/${appId}/users/${userId}/archives`);

              console.log('[Firestore] Iniciando nuevo mes con lógica personalizada...');

              try {
                const transactionsToArchive = [...appState.transactions];
                // --- NUEVO: Obtener todas las proyecciones actuales para borrarlas ---
                const projectionsToDeleteSnapshot = await getDocs(projectionsColRef);

                if (transactionsToArchive.length > 0) {
                  const archiveTimestamp = new Date();
                  const archiveId = `archive-${archiveTimestamp.toISOString()}`;
                  await setDoc(doc(archivesColRef, archiveId), {
                    archivedAt: archiveTimestamp,
                    transactions: transactionsToArchive,
                  });
                }

                const finalBalance =
                  appState.openingBalance +
                  transactionsToArchive.reduce(
                    (sum, t) => (t.type === 'income' ? sum + t.amount : sum),
                    0,
                  ) -
                  transactionsToArchive.reduce(
                    (sum, t) => (t.type === 'expense' ? sum + t.amount : sum),
                    0,
                  );

                const batch = writeBatch(db);

                // Borrar todas las transacciones y proyecciones actuales
                transactionsToArchive.forEach((t) => batch.delete(doc(transactionsColRef, t.id)));
                projectionsToDeleteSnapshot.forEach((p) =>
                  batch.delete(doc(projectionsColRef, p.id)),
                );

                // Actualizar el saldo inicial
                batch.update(userDocRef, { openingBalance: finalBalance });

                const now = new Date();
                const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const currentDay = now.getDate(); // Día actual para la comparación

                appState.recurringExpenses.forEach((re) => {
                  const transactionDate = new Date(
                    nextMonthDate.getFullYear(),
                    nextMonthDate.getMonth(),
                    re.day,
                  );
                  const newId = doc(transactionsColRef).id; // Generar un ID único

                  const newTransactionData = {
                    id: newId,
                    date: transactionDate.toISOString().split('T')[0],
                    description: re.description,
                    category: re.category,
                    bank: re.bank,
                    amount: re.amount,
                    type: 'expense',
                  };

                  // 1. SIEMPRE se registra en Proyección
                  batch.set(doc(projectionsColRef, newId), newTransactionData);

                  // 2. SOLO se registra en Registros si el día de pago ya pasó en el mes actual
                  if (parseInt(re.day, 10) <= currentDay) {
                    batch.set(doc(transactionsColRef, newId), newTransactionData);
                  }
                });

                await batch.commit();

                setCurrentMonthFilter(nextMonthDate.toISOString().substring(0, 7));
                switchTab('registros');
                showToast('Nuevo mes iniciado con la nueva configuración.', 'success');
              } catch (error) {
                console.error('[Firestore] Error al iniciar nuevo mes:', error);
                showMessageModal(
                  'Error al Iniciar Nuevo Mes',
                  'No se pudo completar el proceso.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        async function resetAllData() {
          // MODIFICADO: El mensaje ahora indica que las descripciones se conservan.
          openConfirmModal(
            'Reiniciar Período',
            '¡ADVERTENCIA! Esto eliminará permanentemente sus Transacciones, Proyecciones y Presupuestos. Su Saldo Inicial volverá a cero. Se conservará toda su configuración (Categorías, Bancos, Descripciones, etc.). ¿Está seguro?',
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );
              const transactionsColRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/transactions`,
              );

              console.log(
                '[Firestore] Reiniciando datos del período, conservando toda la configuración...',
              );

              try {
                // Guardamos todos los datos que queremos conservar del estado local.
                const categoriesToKeep = appState.categories;
                const banksToKeep = appState.banks;
                const descriptionsToKeep = appState.descriptions; // AÑADIDO: Guardamos las descripciones.
                const recurringExpensesToKeep = appState.recurringExpenses;
                const creditCardsToKeep = appState.creditCards;
                const userAliasToKeep = appState.userAlias;

                const batch = writeBatch(db);

                // Borrar todas las transacciones existentes.
                const transactionsSnapshot = await getDocs(transactionsColRef);
                transactionsSnapshot.docs.forEach((d) =>
                  batch.delete(doc(transactionsColRef, d.id)),
                );

                // MODIFICADO: Actualizamos el documento de preferencias.
                // Se elimina la línea que reiniciaba las descripciones.
                batch.update(userDocRef, {
                  openingBalance: 0,
                  categoryBudgets: {},
                });

                await batch.commit();

                // Reconstruimos el estado local de la aplicación.
                appState = {
                  transactions: [], // Reiniciado
                  categories: categoriesToKeep, // Conservado
                  banks: banksToKeep, // Conservado
                  descriptions: descriptionsToKeep, // MODIFICADO: Se usan las descripciones conservadas.
                  recurringExpenses: recurringExpensesToKeep, // Conservado
                  creditCards: creditCardsToKeep, // Conservado
                  openingBalance: 0, // Reiniciado
                  userAlias: userAliasToKeep, // Conservado
                  categoryBudgets: {}, // Reiniciado
                  budgetAlertsShown: {}, // Reiniciado
                };

                initApp();

                // MODIFICADO: Mensaje de éxito actualizado.
                showMessageModal(
                  'Período Reiniciado',
                  'Se han eliminado las transacciones y proyecciones. Toda tu configuración se ha conservado.',
                  'success',
                );
              } catch (error) {
                console.error('[Firestore] Error al reiniciar datos:', error);
                showMessageModal(
                  'Error al Reiniciar Datos',
                  'No se pudieron reiniciar los datos.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        // --- GASTOS RECURRENTES ---
        function renderRecurringExpensesTable() {
          recurringExpensesTableBody.innerHTML = '';
          const table = recurringExpensesTableBody.closest('table');

          if (appState.recurringExpenses.length === 0) {
            table.querySelector('tbody').classList.add('hidden');
            table.querySelector('tfoot').classList.add('hidden');
            noRecurringExpensesMessage.classList.remove('hidden');
            return;
          }

          table.querySelector('tbody').classList.remove('hidden');
          table.querySelector('tfoot').classList.remove('hidden');
          noRecurringExpensesMessage.classList.add('hidden');

          const sortedRecurringExpenses = [...appState.recurringExpenses].sort((a, b) => {
            return a.day - b.day;
          });

          sortedRecurringExpenses.forEach((re) => {
            const row = document.createElement('tr');

            const cellCheckbox = row.insertCell();
            cellCheckbox.className = 'px-2 py-4 text-center';
            cellCheckbox.innerHTML = `<input type="checkbox" class="recurring-checkbox" data-id="${re.id}">`;

            const cellDay = row.insertCell();
            cellDay.className = 'px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500';
            cellDay.textContent = re.day;

            const cellDesc = row.insertCell();
            cellDesc.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
            cellDesc.textContent = re.description;

            const cellCat = row.insertCell();
            cellCat.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
            cellCat.innerHTML = getCategoryDisplay(re.category);

            const cellAmount = row.insertCell();
            cellAmount.className = 'px-6 py-4 whitespace-nowrap text-sm text-right text-red-600';
            cellAmount.textContent = formatCurrency(re.amount);

            const cellBank = row.insertCell();
            cellBank.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
            cellBank.textContent = re.bank;

            const cellActions = row.insertCell();
            cellActions.className = 'px-6 py-4 whitespace-nowrap text-center text-sm';
            cellActions.style.fontWeight = '400';
            cellActions.innerHTML = `<button data-id="${re.id}" class="edit-recurring-btn mr-3">Editar</button><button data-id="${re.id}" class="delete-recurring-btn text-red-600 hover:text-red-900">Eliminar</button>`;

            recurringExpensesTableBody.appendChild(row);
          });

          const totalRecurring = appState.recurringExpenses.reduce(
            (sum, expense) => sum + expense.amount,
            0,
          );

          // Actualiza los totales de escritorio y móvil
          document.getElementById('recurring-total').textContent = formatCurrency(totalRecurring);
          document.getElementById('mobile-recurring-total').textContent =
            formatCurrency(totalRecurring);

          // ¡PARTE CRÍTICA! Aquí se vuelven a activar los botones después de crear la tabla.
          document
            .querySelectorAll('.edit-recurring-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => openRecurringExpenseModal(e.target.dataset.id)),
            );
          document
            .querySelectorAll('.delete-recurring-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteRecurringExpense(e.target.dataset.id)),
            );
          updateDeleteButtonVisibility();
        }

        function openRecurringExpenseModal(id = null) {
          recurringExpenseForm.reset();
          clearValidationErrors(); // Limpiar errores
          populateRecurringModalDropdowns();
          populateDescriptionDatalist();
          if (id) {
            const expense = appState.recurringExpenses.find((re) => re.id === id);
            if (expense) {
              document.getElementById('recurring-modal-title').textContent =
                'Editar Gasto Recurrente';
              document.getElementById('recurring-expense-id').value = expense.id;
              document.getElementById('recurring-description').value = expense.description;
              document.getElementById('recurring-amount').value = expense.amount;
              document.getElementById('recurring-category').value = expense.category;
              document.getElementById('recurring-bank').value = expense.bank;
              document.getElementById('recurring-day').value = expense.day;
            } else {
              showMessageModal('Error', 'Gasto recurrente no encontrado.', 'error');
              closeRecurringExpenseModal();
              return;
            }
          } else {
            document.getElementById('recurring-modal-title').textContent =
              'Añadir Gasto Recurrente';
            document.getElementById('recurring-expense-id').value = '';
          }
          recurringExpenseModal.classList.add('active');
        }

        function closeRecurringExpenseModal() {
          recurringExpenseModal.classList.remove('active');
          clearValidationErrors(); // Limpiar errores
        }

        /**
         * Ahora, en lugar de cerrar el modal, resetea el formulario para añadir otro.
         */
        async function handleRecurringExpenseFormSubmit(e) {
          e.preventDefault();
          clearValidationErrors();

          const id = document.getElementById('recurring-expense-id').value;
          const description = toTitleCase(
            document.getElementById('recurring-description').value.trim(),
          );
          const amount = parseFloat(document.getElementById('recurring-amount').value);
          const category = document.getElementById('recurring-category').value;
          const bank = document.getElementById('recurring-bank').value;
          const day = parseInt(document.getElementById('recurring-day').value);

          // Validaciones (sin cambios)
          let isValid = true;
          if (
            !validateRequired(
              document.getElementById('recurring-description'),
              recurringDescriptionError,
              'La descripción es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('recurring-amount'),
              recurringAmountError,
              'El monto debe ser un número positivo.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('recurring-category'),
              recurringCategoryError,
              'La categoría es obligatoria.',
            )
          )
            isValid = false;
          if (
            !validateRequired(
              document.getElementById('recurring-bank'),
              recurringBankError,
              'El banco/cuenta es obligatorio.',
            )
          )
            isValid = false;
          if (
            !validateDayOfMonth(
              document.getElementById('recurring-day'),
              recurringDayError,
              'El día de pago debe ser entre 1 y 31.',
            )
          )
            isValid = false;
          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario.', 'error');
            return;
          }

          const saveBtn = document.getElementById('save-recurring-btn');
          showButtonLoading(saveBtn);
          const appId = firebaseProjectId;
          const recurringExpensesColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/recurringExpenses`,
          );
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

          const newRecurringExpenseData = { description, amount, category, bank, day };

          try {
            if (id) {
              await setDoc(doc(recurringExpensesColRef, id), newRecurringExpenseData, {
                merge: true,
              });
              showToast('Gasto recurrente actualizado exitosamente.', 'success');
              // Si se estaba editando, sí cerramos el modal.
              closeRecurringExpenseModal();
            } else {
              const newDocRef = doc(recurringExpensesColRef);
              await setDoc(newDocRef, { ...newRecurringExpenseData, id: newDocRef.id });
              showToast('Gasto recurrente añadido exitosamente.', 'success');

              // --- ¡CAMBIO CLAVE! ---
              // Reseteamos el formulario y devolvemos el foco al primer campo.
              recurringExpenseForm.reset();
              document.getElementById('recurring-description').focus();
            }

            const isNewDescription =
              description &&
              !appState.descriptions.some((d) => d.toLowerCase() === description.toLowerCase());
            if (isNewDescription) {
              const updatedDescriptions = [...appState.descriptions, description].sort((a, b) =>
                a.localeCompare(b),
              );
              await updateDoc(userDocRef, { descriptions: updatedDescriptions });
              showToast(`Descripción "${description}" guardada.`, 'info');
            }
            // Ya no cerramos el modal al crear un nuevo gasto: closeRecurringExpenseModal();
          } catch (error) {
            console.error('[Firestore] Error al guardar gasto recurrente:', error);
            showMessageModal(
              'Error al Guardar',
              'No se pudo guardar el gasto recurrente.',
              'error',
            );
          } finally {
            hideButtonLoading(saveBtn);
          }
        }
        async function deleteRecurringExpense(id) {
          openConfirmModal(
            'Eliminar Gasto Recurrente',
            '¿Estás seguro? Esto no afectará a transacciones ya creadas.',
            async () => {
              showLoading(); // Usar overlay global
              const appId = firebaseProjectId;
              const recurringExpenseDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/recurringExpenses`,
                id,
              );
              console.log('[Firestore] Eliminando gasto recurrente:', id); // Debugging
              try {
                await deleteDoc(recurringExpenseDocRef);
                showToast('Gasto recurrente eliminado exitosamente.', 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar gasto recurrente:', error); // Debugging
                showMessageModal(
                  'Error al Eliminar Gasto Recurrente',
                  'No se pudo eliminar el gasto recurrente. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        /**
         * Registra TODOS los gastos recurrentes como transacciones en el mes actual.
         * Ideal para que los nuevos usuarios inicialicen su primer mes.
         */
        // Nota: El nombre de la función se mantiene por consistencia, pero su lógica ha cambiado.
        async function migrateAllRecurringToTransactions() {
          openConfirmModal(
            'Poblar Proyección',
            'Esto registrará sus gastos recurrentes en la pestaña de Proyección para el mes actual, evitando duplicados. Esta acción NO afectará sus Registros. ¿Desea continuar?',
            async () => {
              showLoading();

              if (appState.recurringExpenses.length === 0) {
                hideLoading();
                showMessageModal(
                  'Información',
                  'No hay gastos recurrentes para registrar.',
                  'info',
                );
                return;
              }

              const appId = firebaseProjectId;
              // --- MODIFICADO: Solo necesitamos la referencia a Proyecciones ---
              const projectionsColRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/projections`,
              );

              try {
                const batch = writeBatch(db);
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                let newEntriesCount = 0;

                appState.recurringExpenses.forEach((re) => {
                  const transactionDate = new Date(currentYear, currentMonth, re.day);
                  const formattedDate = transactionDate.toISOString().split('T')[0];

                  // --- LÓGICA NUEVA: Comprobación de duplicados ---
                  const alreadyExists = appState.projections.some(
                    (p) =>
                      p.date === formattedDate &&
                      p.description.toLowerCase() === re.description.toLowerCase() &&
                      p.category === re.category,
                  );

                  // Si no existe, se prepara para añadirlo
                  if (!alreadyExists) {
                    const newTransactionData = {
                      date: formattedDate,
                      description: re.description,
                      category: re.category,
                      bank: re.bank,
                      amount: re.amount,
                      type: 'expense',
                    };

                    const newDocRef = doc(projectionsColRef);
                    batch.set(newDocRef, { ...newTransactionData, id: newDocRef.id });
                    newEntriesCount++;
                  }
                });

                if (newEntriesCount > 0) {
                  await batch.commit();
                  showToast(
                    `${newEntriesCount} gasto(s) recurrente(s) han sido añadidos a Proyección.`,
                    'success',
                  );
                } else {
                  showToast(
                    'No se añadieron gastos nuevos, parece que ya estaban todos registrados en Proyección.',
                    'info',
                  );
                }

                switchTab('proyeccion');
              } catch (error) {
                console.error('[Firestore] Error al registrar gastos en proyección:', error);
                showMessageModal(
                  'Error en el Proceso',
                  'No se pudieron registrar los gastos en Proyección.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }
        // --- TARJETAS DE CRÉDITO ---
        function renderCreditCardsTable() {
          creditCardsTableBody.innerHTML = '';
          if (appState.creditCards.length === 0) {
            creditCardsTableBody.classList.add('hidden');
            noCreditCardsMessage.classList.remove('hidden');
            // Limpiamos los totales si no hay tarjetas
            document.getElementById('cc-total-amount').textContent = formatCurrency(0);
            document.getElementById('cc-total-limit').textContent = formatCurrency(0);
            document.getElementById('cc-total-available').textContent = formatCurrency(0);
            document.getElementById('cc-total-monthly').textContent = formatCurrency(0);
            return;
          }

          creditCardsTableBody.classList.remove('hidden');
          noCreditCardsMessage.classList.add('hidden');

          const sortedCards = [...appState.creditCards].sort((a, b) => a.dueDate - b.dueDate);

          // Variables para calcular los totales
          let totalAdeudado = 0;
          let totalLimite = 0;
          // La variable totalDisponible ya no se calcula aquí dentro del bucle
          let totalPagoMensual = 0;

          sortedCards.forEach((card) => {
            const row = document.createElement('tr');
            row.dataset.cardId = card.id;

            const today = new Date();
            const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
            if (today.getDate() > card.dueDate) {
              nextDueDate.setMonth(nextDueDate.getMonth() + 1);
            }
            const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

            let bgColor = 'bg-white';
            if (daysDiff >= 0 && daysDiff <= 2) {
              bgColor = 'bg-red-100';
            } else if (daysDiff > 2 && daysDiff <= 5) {
              bgColor = 'bg-yellow-100';
            }
            row.className = bgColor;

            const monthlyPayment = calculateMonthlyPayment(card.amount, card.rate, card.months);
            const creditLimit = parseFloat(card.limit) || 0;
            const debtAmount = parseFloat(card.amount) || 0;
            const availableBalance = creditLimit - debtAmount;

            // Lógica de sumatoria de totales
            if (!card.exclude) {
              // Solo suma si la tarjeta NO está excluida
              totalAdeudado += debtAmount;
            }
            totalLimite += creditLimit;
            // totalDisponible += availableBalance; // <-- ERROR LÓGICO ELIMINADO DE AQUÍ
            totalPagoMensual += monthlyPayment;

            row.innerHTML = `
              <td class="px-2 py-4 whitespace-nowrap text-center">
                  <input type="checkbox" class="exclude-checkbox card-data-input" data-field="exclude" ${
                    card.exclude ? 'checked' : ''
                  }>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-weight: 400 text-gray-900">${
                card.bank
              }</td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${
                card.dueDate
              }</td>
              <td class="px-4 py-4 whitespace-nowrap text-sm">
                  <input type="number" class="table-input card-data-input" data-field="amount" value="${debtAmount.toFixed(
                    2,
                  )}" step="0.01">
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm">
                  <input type="number" class="table-input card-data-input" data-field="limit" value="${creditLimit.toFixed(
                    2,
                  )}" placeholder="0.00" step="0.01">
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-green-600 text-right">${formatCurrency(
                availableBalance,
              )}</td>
              <td class="px-4 py-4 whitespace-nowrap text-sm">
                  <input type="number" class="table-input card-data-input" data-field="rate" value="${Number(
                    card.rate,
                  ).toFixed(2)}" step="0.01">
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm">
                  <input type="number" class="table-input card-data-input" data-field="months" value="${
                    card.months
                  }" min="1">
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 monthly-payment-cell text-right">${formatCurrency(
                monthlyPayment,
              )}</td>
              <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-weight: 400">
                <button class="delete-card-btn text-red-600 hover:text-red-900" data-id="${
                  card.id
                }">Eliminar</button>
              </td>
            `;
            creditCardsTableBody.appendChild(row);
          });

          // --- INICIO DE LA CORRECCIÓN LÓGICA ---
          // Se calcula el total disponible DESPUÉS del bucle para asegurar consistencia
          const totalDisponible = totalLimite - totalAdeudado;
          // --- FIN DE LA CORRECCIÓN LÓGICA ---

          // Pinta los totales en el footer
          document.getElementById('cc-total-amount').textContent = formatCurrency(totalAdeudado);
          document.getElementById('cc-total-limit').textContent = formatCurrency(totalLimite);
          document.getElementById('cc-total-available').textContent =
            formatCurrency(totalDisponible); // Ahora usa el valor corregido
          document.getElementById('cc-total-monthly').textContent =
            formatCurrency(totalPagoMensual);

          // Vuelve a añadir los listeners a los botones de eliminar
          document
            .querySelectorAll('.delete-card-btn')
            .forEach((btn) =>
              btn.addEventListener('click', (e) => deleteCreditCard(e.target.dataset.id)),
            );
        }

        async function handleCardDataChange(e) {
          if (!e.target.classList.contains('card-data-input')) return;

          const inputElement = e.target;
          const field = inputElement.dataset.field;
          let value;

          // Determina el tipo de valor a guardar (booleano para el checkbox, número para los inputs)
          if (inputElement.type === 'checkbox') {
            value = inputElement.checked;
          } else {
            value = parseFloat(inputElement.value);
          }

          // Validación en línea para los campos numéricos de la tabla
          if (inputElement.type === 'number') {
            let isValid = true;
            if (isNaN(value) || value < 0) {
              showToast(`El valor para "${field}" debe ser un número positivo.`, 'error');
              inputElement.value = inputElement.defaultValue; // Revertir al valor original
              isValid = false;
            }
            if (field === 'months' && value < 1) {
              showToast('Los meses para saldar deben ser al menos 1.', 'error');
              inputElement.value = inputElement.defaultValue;
              isValid = false;
            }
            if (!isValid) return; // Detener si la validación falla
          }

          showButtonLoading(inputElement); // Simula carga en el input
          const appId = firebaseProjectId;
          const cardId = e.target.closest('tr').dataset.cardId;
          const creditCardDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/creditCards`,
            cardId,
          );

          try {
            console.log(`[Firestore] Actualizando tarjeta ${cardId}, campo ${field}: ${value}`);
            await updateDoc(creditCardDocRef, { [field]: value });
            showToast('Datos de tarjeta actualizados.', 'success');
          } catch (error) {
            console.error('[Firestore] Error al actualizar datos de la tarjeta:', error);
            showMessageModal('Error al Actualizar Tarjeta', 'No se pudieron actualizar los datos.');
          } finally {
            hideButtonLoading(inputElement);
          }
        }

        function calculateMonthlyPayment(principal, annualRate, months) {
          if (principal <= 0 || months <= 0) return 0;
          if (annualRate <= 0) return principal / months;

          const monthlyRate = annualRate / 100 / 12;
          const payment = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));
          return payment;
        }

        async function deleteCreditCard(cardId) {
          openConfirmModal(
            'Eliminar Tarjeta',
            `¿Seguro que quieres eliminar esta tarjeta?`,
            async () => {
              showLoading(); // Usar overlay global
              const appId = firebaseProjectId;
              const creditCardDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/creditCards`,
                cardId,
              );
              console.log('[Firestore] Eliminando tarjeta de crédito:', cardId); // Debugging
              try {
                await deleteDoc(creditCardDocRef);
                showToast('Tarjeta de crédito eliminada exitosamente.', 'success');
              } catch (error) {
                console.error('[Firestore] Error al eliminar tarjeta de crédito:', error); // Debugging
                showMessageModal(
                  'Error al Eliminar Tarjeta',
                  'No se pudo eliminar la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        function openCreditCardModal() {
          creditCardForm.reset();
          clearValidationErrors(); // Limpiar errores
          creditCardModal.classList.add('active');
        }

        function closeCreditCardModal() {
          creditCardModal.classList.remove('active');
          clearValidationErrors(); // Limpiar errores
        }

        async function handleCreditCardFormSubmit(e) {
          e.preventDefault();
          clearValidationErrors(); // Limpiar errores previos

          const bank = toTitleCase(document.getElementById('credit-card-bank').value.trim());
          const dueDate = parseInt(document.getElementById('credit-card-due-date').value);
          const amount = parseFloat(document.getElementById('credit-card-amount').value);
          const rate = parseFloat(document.getElementById('credit-card-rate').value);
          const months = parseInt(document.getElementById('credit-card-months').value);

          let isValid = true;
          if (
            !validateRequired(
              document.getElementById('credit-card-bank'),
              creditCardBankError,
              'El nombre del banco es obligatorio.',
            )
          )
            isValid = false;
          if (
            !validateDayOfMonth(
              document.getElementById('credit-card-due-date'),
              creditCardDueDateError,
              'El día de pago debe ser entre 1 y 31.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('credit-card-amount'),
              creditCardAmountError,
              'El monto adeudado debe ser un número positivo.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('credit-card-rate'),
              creditCardRateError,
              'La tasa de interés debe ser un número positivo.',
            )
          )
            isValid = false;
          if (
            !validatePositiveNumber(
              document.getElementById('credit-card-months'),
              creditCardMonthsError,
              'Los meses para saldar deben ser un número positivo.',
            )
          )
            isValid = false;

          if (
            bank &&
            appState.creditCards.some((c) => c.bank.toLowerCase() === bank.toLowerCase())
          ) {
            showError(creditCardBankError, 'Ya existe una tarjeta para este banco.');
            isValid = false;
          }

          if (!isValid) {
            showToast('Por favor, corrige los errores en el formulario.', 'error');
            return;
          }

          showButtonLoading(document.getElementById('save-credit-card-btn'));
          const appId = firebaseProjectId;
          const creditCardsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/creditCards`,
          );

          const newCardData = {
            bank: bank,
            dueDate: dueDate,
            amount: amount,
            rate: rate,
            months: months,
            limit: 0,
            exclude: false,
          };
          try {
            console.log('[Firestore] Añadiendo nueva tarjeta de crédito.'); // Debugging
            const newDocRef = doc(creditCardsColRef);
            await setDoc(newDocRef, { ...newCardData, id: newDocRef.id });
            closeCreditCardModal();
            showToast('Tarjeta añadida exitosamente.', 'success');
          } catch (error) {
            console.error('[Firestore] Error al añadir tarjeta de crédito:', error); // Debugging
            showMessageModal(
              'Error al Añadir Tarjeta',
              'No se pudo añadir la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.',
              'error',
            );
          } finally {
            hideButtonLoading(document.getElementById('save-credit-card-btn'));
          }
        }

        // --- IMPORTAR Y EXPORTAR ---
        function exportToPDF() {
          const doc = new jsPDF();
          const transactions = getFilteredTransactions();
          const monthString = formatMonthYear(filterMonth.value);

          doc.text(`Reporte de Transacciones - ${monthString}`, 14, 16);

          const tableColumn = ['Fecha', 'Descripción', 'Categoría', 'Ingreso', 'Gasto'];
          const tableRows = [];

          transactions.forEach((tx) => {
            const transactionData = [
              formatDate(tx.date),
              tx.description,
              tx.category,
              tx.type === 'income' ? formatCurrency(tx.amount) : '-',
              tx.type === 'expense' ? formatCurrency(tx.amount) : '-',
            ];
            tableRows.push(transactionData);
          });

          doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 24,
          });

          const finalY = doc.lastAutoTable.finalY || 24;
          const income = transactions
            .filter((t) => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);
          const expenses = transactions
            .filter((t) => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

          doc.text('Resumen del Mes:', 14, finalY + 10);
          doc.text(`Total Ingresos: ${formatCurrency(income)}`, 14, finalY + 16);
          doc.text(`Total Gastos: ${formatCurrency(expenses)}`, 14, finalY + 22);
          doc.text(`Balance del Mes: ${formatCurrency(income - expenses)}`, 14, finalY + 28);

          doc.save(`reporte_${filterMonth.value}.pdf`);
          showToast('Reporte PDF generado exitosamente.', 'success');
        }

        function exportData() {
          // Exportar el estado actual de appState, que está sincronizado con Firestore.
          // Esta versión incluye todas las secciones solicitadas.
          const dataToExport = {
            transactions: appState.transactions,
            projections: appState.projections, // Añadido
            categories: appState.categories,
            banks: appState.banks,
            descriptions: appState.descriptions,
            recurringExpenses: appState.recurringExpenses,
            creditCards: appState.creditCards,
            openingBalance: appState.openingBalance,
            userAlias: appState.userAlias,
            categoryBudgets: appState.categoryBudgets, // Añadido
          };
          const dataStr = JSON.stringify(dataToExport, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.download = `foresee_backup_${new Date().toISOString().split('T')[0]}.json`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);
          showToast('Copia de seguridad completa exportada a JSON.', 'success');
        }

        function importData(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              importedFileData = JSON.parse(e.target.result);
              document.getElementById('selected-file-name').textContent = file.name;
              document.getElementById('import-checkboxes-container').classList.remove('hidden');
              document.getElementById('confirm-import-btn').disabled = false;
              showToast('Archivo cargado. Selecciona qué importar.', 'info');
            } catch (error) {
              importedFileData = null;
              document.getElementById('selected-file-name').textContent =
                'Error al leer el archivo. Intenta de nuevo.';
              document.getElementById('import-checkboxes-container').classList.add('hidden');
              document.getElementById('confirm-import-btn').disabled = true;
              showMessageModal(
                'Error de Archivo',
                'El archivo seleccionado no es un archivo JSON válido.',
                'error',
              );
            }
          };
          reader.readAsText(file);
          importFileInput.value = ''; // Limpiar el input para permitir volver a seleccionar el mismo archivo
        }

        async function processSelectiveImport() {
          if (!importedFileData) {
            showToast('Primero debes seleccionar un archivo JSON válido.', 'error');
            return;
          }

          const sectionsToImport = {};
          const checkboxes = document.querySelectorAll('.import-section-checkbox:checked');
          if (checkboxes.length === 0) {
            showToast('Debes seleccionar al menos una sección para importar.', 'error');
            return;
          }

          checkboxes.forEach((cb) => {
            sectionsToImport[cb.dataset.section] = true;
          });

          // --- CAMBIO CLAVE: Primero cerramos el modal de opciones ---
          // Esto asegura que el modal de confirmación sea lo único visible.
          document.getElementById('import-options-modal').classList.remove('active');

          // Ahora, abrimos el modal de confirmación
          openConfirmModal(
            'Confirmar Importación Selectiva',
            'Esto reemplazará permanentemente los datos de las secciones seleccionadas con la información del archivo. Esta acción no se puede deshacer. ¿Deseas continuar?',
            async () => {
              showLoading(); // Muestra el spinner de "Cargando..."
              const appId = firebaseProjectId;
              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/user_data/preferences`,
              );

              try {
                const batch = writeBatch(db);

                // Función auxiliar para limpiar una colección
                const clearCollection = async (collectionName) => {
                  const collectionRef = collection(
                    db,
                    `artifacts/${appId}/users/${userId}/${collectionName}`,
                  );
                  const snapshot = await getDocs(collectionRef);
                  snapshot.docs.forEach((d) => batch.delete(doc(collectionRef, d.id)));
                };

                // Función auxiliar para poblar una colección
                const populateCollection = (collectionName, data) => {
                  if (data && Array.isArray(data)) {
                    const collectionRef = collection(
                      db,
                      `artifacts/${appId}/users/${userId}/${collectionName}`,
                    );
                    data.forEach((item) => {
                      const newDocRef = doc(collectionRef);
                      const itemWithId = { ...item, id: newDocRef.id };
                      batch.set(newDocRef, itemWithId);
                    });
                  }
                };

                // --- PROCESAR CADA SECCIÓN SELECCIONADA ---
                if (sectionsToImport.transactions) {
                  await clearCollection('transactions');
                  populateCollection('transactions', importedFileData.transactions);
                }
                if (sectionsToImport.projections) {
                  await clearCollection('projections');
                  populateCollection('projections', importedFileData.projections);
                }
                if (sectionsToImport.recurringExpenses) {
                  await clearCollection('recurringExpenses');
                  populateCollection('recurringExpenses', importedFileData.recurringExpenses);
                }
                if (sectionsToImport.creditCards) {
                  await clearCollection('creditCards');
                  populateCollection('creditCards', importedFileData.creditCards);
                }

                const preferencesUpdate = {};
                let configUpdated = false;

                if (sectionsToImport.budgets && importedFileData.categoryBudgets) {
                  preferencesUpdate.categoryBudgets = importedFileData.categoryBudgets;
                  configUpdated = true;
                }
                if (sectionsToImport.config) {
                  if (importedFileData.categories)
                    preferencesUpdate.categories = importedFileData.categories;
                  if (importedFileData.banks) preferencesUpdate.banks = importedFileData.banks;
                  if (importedFileData.descriptions)
                    preferencesUpdate.descriptions = importedFileData.descriptions;
                  configUpdated = true;
                }
                if (sectionsToImport.general) {
                  if (importedFileData.openingBalance !== undefined)
                    preferencesUpdate.openingBalance = importedFileData.openingBalance;
                  if (importedFileData.userAlias !== undefined)
                    preferencesUpdate.userAlias = importedFileData.userAlias;
                  configUpdated = true;
                }

                if (configUpdated) {
                  batch.update(userDocRef, preferencesUpdate);
                }

                await batch.commit();

                // Reseteamos la data del archivo importado
                importedFileData = null;

                // --- MEJORA EN LA RETROALIMENTACIÓN ---
                // El modal de confirmación se cierra automáticamente (ya programado)
                // y ahora mostramos un modal de éxito claro.
                showMessageModal(
                  'Importación Exitosa',
                  'Los datos de las secciones seleccionadas se han importado correctamente.',
                  'success',
                );
              } catch (error) {
                console.error('[Firestore] Error durante la importación selectiva:', error);
                showMessageModal(
                  'Error de Importación',
                  'Hubo un error al importar los datos. El proceso pudo quedar incompleto.',
                  'error',
                );
              } finally {
                hideLoading(); // Oculta el spinner de "Cargando..."
              }
            },
          );
        }

        /**
         * Obtiene el ID y la pestaña del único elemento seleccionado en la tabla activa.
         * @returns {{id: string, tab: string}|null} El objeto con el ID y la pestaña, o null si no hay una selección única.
         */
        function getSingleSelectedItem() {
          const activeTabElement = document.querySelector('.tab-pane.active');
          if (!activeTabElement) return null;

          const activeTab = activeTabElement.id.replace('-content', '');
          let checkboxClass = '';

          // Lógica para encontrar la clase correcta del checkbox
          switch (activeTab) {
            case 'registros':
              checkboxClass = 'transaction-checkbox';
              break;
            case 'proyeccion':
              checkboxClass = 'projection-checkbox';
              break;
            case 'recurrentes':
              checkboxClass = 'recurring-checkbox';
              break;
            default:
              return null;
          }

          const checkedCheckbox = document.querySelector(
            `#${activeTab}-content .${checkboxClass}:checked`,
          );

          if (checkedCheckbox) {
            return { id: checkedCheckbox.dataset.id, tab: activeTab };
          }

          return null;
        }

        // --- UTILIDADES Y VALIDACIÓN ---

        /**
         * Formatea una fecha para mostrar solo el número del día.
         * @param {string} dateString - La cadena de fecha (ej. "2025-09-01").
         * @returns {string} El número del día.
         */
        function formatDateForMobile(dateString) {
          const date = new Date(dateString + 'T00:00:00');
          return date.getDate().toString();
        }

        /**
         * GENERA LA VISTA DE PROYECCIÓN DINÁMICAMENTE.
         * Combina las transacciones reales del mes con los gastos recurrentes
         * que aún no han sido registrados en ese mes.
         * @returns {Array<Object>} Una lista unificada y ordenada de transacciones para la proyección.
         */

        function getDynamicProjections() {
          const realTransactions = getTransactions({ month: filterMonth.value });
          const recurringExpenses = appState.recurringExpenses;
          const selectedMonthFilter = filterMonth.value;

          // Se eliminan las variables 'descriptionFilter' y 'categoryFilter' que no se usan o causan error

          // Ahora, las proyecciones manuales se obtienen sin filtros extra, solo por mes
          const manualProjections = getTransactions({
            month: selectedMonthFilter,
            source: appState.projections,
          }).map((p) => ({ ...p, isPureProjection: true }));

          if (!selectedMonthFilter) {
            return [...realTransactions, ...manualProjections].sort(
              (a, b) => new Date(a.date) - new Date(b.date),
            );
          }

          const [year, month] = selectedMonthFilter.split('-').map(Number);

          const projectedFromRecurring = recurringExpenses.map((re) => ({
            id: `recurring-${re.id}`,
            date: new Date(year, month - 1, re.day).toISOString().split('T')[0],
            description: re.description,
            category: re.category,
            bank: re.bank,
            amount: re.amount,
            type: 'expense',
            isVirtual: true,
          }));

          const futureProjections = projectedFromRecurring.filter((proj) => {
            return !realTransactions.some(
              (realTx) =>
                realTx.date === proj.date &&
                realTx.description.toLowerCase() === proj.description.toLowerCase() &&
                realTx.category === proj.category,
            );
          });

          const combinedList = [...realTransactions, ...manualProjections, ...futureProjections];
          combinedList.sort((a, b) => new Date(a.date) - new Date(b.date));

          return combinedList;
        }
        /**
         * Entra en el modo de pantalla completa con depuración.
         * @param {HTMLElement} element El elemento a expandir.
         */
        function enterFullscreen(element) {
          console.log('Intentando entrar en pantalla completa...'); // Mensaje de depuración
          if (element.requestFullscreen) {
            element
              .requestFullscreen()
              .catch((err) =>
                console.error(`Error al solicitar pantalla completa: ${err.message}`),
              );
          } else if (element.mozRequestFullScreen) {
            // Firefox
            element
              .mozRequestFullScreen()
              .catch((err) =>
                console.error(`Error al solicitar pantalla completa (Firefox): ${err.message}`),
              );
          } else if (element.webkitRequestFullscreen) {
            // Chrome, Safari & Opera
            element
              .webkitRequestFullscreen()
              .catch((err) =>
                console.error(`Error al solicitar pantalla completa (WebKit): ${err.message}`),
              );
          } else if (element.msRequestFullscreen) {
            // IE/Edge
            element
              .msRequestFullscreen()
              .catch((err) =>
                console.error(`Error al solicitar pantalla completa (MS): ${err.message}`),
              );
          } else {
            console.error('La API de pantalla completa no es compatible con este navegador.');
          }
        }

        function exitFullscreen() {
          try {
            console.log('Intentando salir de pantalla completa...');
            if (
              document.fullscreenElement ||
              document.webkitFullscreenElement ||
              document.mozFullScreenElement ||
              document.msFullscreenElement
            ) {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.mozCancelFullScreen) {
                /* Firefox */
                document.mozCancelFullScreen();
              } else if (document.webkitExitFullscreen) {
                /* Chrome, Safari & Opera */
                document.webkitExitFullscreen();
              } else if (document.msExitFullscreen) {
                /* IE/Edge */
                document.msExitFullscreen();
              }
            } else {
              console.log('No se está en modo de pantalla completa.');
            }
          } catch (error) {
            // Este catch evita que un error aquí detenga otras funciones, como el logout.
            console.error(
              'Error controlado al intentar salir de pantalla completa:',
              error.message,
            );
          }
        }

        /**
         * Añade los event listeners a las tarjetas del dashboard.
         */
        function setupDashboardListeners() {
          const balanceCard = document.getElementById('balance-card');
          const incomeCard = document.getElementById('income-card');
          const expenseCard = document.getElementById('expense-card');

          if (balanceCard) {
            balanceCard.addEventListener('click', () => {
              switchTab('saldos');
              showContentView(); // Asegura que la vista de contenido se muestre
            });
          }

          if (incomeCard) {
            incomeCard.addEventListener('click', () => {
              modalContext = 'registros'; // El contexto es un registro normal
              // Abre el modal, pre-selecciona 'income' y bloquea el otro botón
              openTransactionModal({ type: 'income', lockType: true });
            });
          }

          if (expenseCard) {
            expenseCard.addEventListener('click', () => {
              modalContext = 'registros'; // El contexto es un registro normal
              // Abre el modal, pre-selecciona 'expense' y bloquea el otro botón
              openTransactionModal({ type: 'expense', lockType: true });
            });
          }
        }
        /**
         * Convierte una cadena a formato Title Case.
         * @param {string} str - La cadena a convertir.
         * @returns {string} La cadena en Title Case.
         */
        function toTitleCase(str) {
          if (!str) return '';
          return str
            .toLowerCase()
            .split(' ')
            .map((word) => {
              return word.charAt(0).toUpperCase() + word.slice(1);
            })
            .join(' ');
        }

        /**
         * Muestra un spinner dentro de un botón y deshabilita el botón.
         * @param {HTMLElement} buttonElement - El botón HTML.
         */
        function showButtonLoading(buttonElement) {
          const spinner = buttonElement.querySelector('.btn-spinner');
          if (spinner) {
            spinner.classList.remove('hidden');
          }
          buttonElement.disabled = true;
          // Opcional: guardar el texto original y reemplazarlo
          // buttonElement.dataset.originalText = buttonElement.textContent;
          // buttonElement.textContent = '';
        }

        /**
         * Oculta el spinner de un botón y lo habilita.
         * @param {HTMLElement} buttonElement - El botón HTML.
         */
        function hideButtonLoading(buttonElement) {
          const spinner = buttonElement.querySelector('.btn-spinner');
          if (spinner) {
            spinner.classList.add('hidden');
          }
          buttonElement.disabled = false;
          // Opcional: restaurar el texto original
          // if (buttonElement.dataset.originalText) {
          //     buttonElement.textContent = buttonElement.dataset.originalText;
          // }
        }

        /**
         * Muestra un mensaje de error para un campo de entrada.
         * @param {HTMLElement} errorElement - El elemento span donde se muestra el error.
         * @param {string} message - El mensaje de error.
         */
        function showError(errorElement, message) {
          if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('active');
          }
        }

        /**
         * Oculta un mensaje de error para un campo de entrada.
         * @param {HTMLElement} errorElement - El elemento span del error.
         */
        function hideError(errorElement) {
          if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.remove('active');
          }
        }

        /**
         * Limpia todos los mensajes de error de validación en la página.
         */
        function clearValidationErrors() {
          document.querySelectorAll('.input-error-message').forEach((el) => hideError(el));
        }

        /**
         * Valida que un campo requerido no esté vacío.
         * @param {HTMLInputElement|HTMLSelectElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si está vacío.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateRequired(inputElement, errorElement, errorMessage) {
          if (!inputElement.value.trim()) {
            showError(errorElement, errorMessage);
            return false;
          }
          hideError(errorElement);
          return true;
        }

        /**
         * Valida que un campo numérico sea positivo.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si no es positivo.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validatePositiveNumber(inputElement, errorElement, errorMessage) {
          const value = parseFloat(inputElement.value);
          if (isNaN(value) || value <= 0) {
            showError(errorElement, errorMessage);
            return false;
          }
          hideError(errorElement);
          return true;
        }

        /**
         * Valida un formato de correo electrónico básico.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateEmail(inputElement, errorElement) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!inputElement.value.trim()) {
            showError(errorElement, 'El correo electrónico es obligatorio.');
            return false;
          }
          if (!emailRegex.test(inputElement.value.trim())) {
            showError(errorElement, 'Formato de correo electrónico inválido.');
            return false;
          }
          hideError(errorElement);
          return true;
        }

        /**
         * Valida la longitud mínima de una contraseña.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {number} minLength - Longitud mínima requerida.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validatePassword(inputElement, errorElement, minLength) {
          if (!inputElement.value.trim()) {
            showError(errorElement, 'La contraseña es obligatoria.');
            return false;
          }
          if (inputElement.value.length < minLength) {
            showError(errorElement, `La contraseña debe tener al menos ${minLength} caracteres.`);
            return false;
          }
          hideError(errorElement);
          return true;
        }

        /**
         * Valida que un día del mes esté entre 1 y 31.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si no es válido.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateDayOfMonth(inputElement, errorElement, errorMessage) {
          const value = parseInt(inputElement.value);
          if (isNaN(value) || value < 1 || value > 31) {
            showError(errorElement, errorMessage);
            return false;
          }
          hideError(errorElement);
          return true;
        }

        function showDashboardView() {
          document.body.classList.remove('view-content');
          document.body.classList.add('view-dashboard');
        }

        function showContentView() {
          document.body.classList.remove('view-dashboard');
          document.body.classList.add('view-content');
        }
        // Reemplaza las 3 funciones de "populate" para categorías y bancos
        /**
         * Función genérica para poblar un elemento <select> con opciones.
         * @param {string} elementId - El ID del elemento <select>.
         * @param {Array<Object|string>} options - El array de datos (ej. appState.categories).
         * @param {string|null} valueKey - La propiedad del objeto a usar como valor (ej. 'name'). Si es null, se usa el item mismo.
         * @param {string|null} textKey - La propiedad del objeto a usar como texto (ej. 'name'). Si es null, se usa el item mismo.
         * @param {string|null} placeholder - Texto para la primera opción deshabilitada (opcional).
         */
        function populateSelectWithOptions(
          elementId,
          options,
          valueKey,
          textKey,
          placeholder = null,
        ) {
          const selectElement = document.getElementById(elementId);
          if (!selectElement) return;

          const currentValue = selectElement.value; // Guarda la selección actual
          selectElement.innerHTML = ''; // Limpia opciones existentes

          if (placeholder) {
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            selectElement.appendChild(placeholderOption);
          }

          options.forEach((optionData) => {
            const option = document.createElement('option');
            option.value = valueKey ? optionData[valueKey] : optionData;
            option.textContent = textKey ? optionData[textKey] : optionData;
            selectElement.appendChild(option);
          });

          selectElement.value = currentValue; // Intenta restaurar la selección
        }

        // Ahora, reemplazamos las llamadas antiguas por la nueva función
        function populateFilterDropdowns() {
          populateSelectWithOptions(
            'filter-category',
            appState.categories,
            'name',
            'name',
            'Todas las categorías',
          );
          populateSelectWithOptions('filter-bank', appState.banks, null, null, 'Todos los bancos');
        }

        function populateModalDropdowns() {
          populateSelectWithOptions('transaction-category', appState.categories, 'name', 'name');
          populateSelectWithOptions('transaction-bank', appState.banks, null, null);
        }

        function populateRecurringModalDropdowns() {
          populateSelectWithOptions('recurring-category', appState.categories, 'name', 'name');
          populateSelectWithOptions('recurring-bank', appState.banks, null, null);
        }

        function populateDescriptionDatalist() {
          const datalist = document.getElementById('description-list');
          datalist.innerHTML = '';
          appState.descriptions.forEach((desc) => {
            const option = document.createElement('option');
            option.value = desc;
            datalist.appendChild(option);
          });
        }

        function populateTransferModalDropdowns() {
          const fromBankSelect = document.getElementById('transfer-from-bank');
          const toBankSelect = document.getElementById('transfer-to-bank');
          fromBankSelect.innerHTML = '';
          toBankSelect.innerHTML = '';
          appState.banks.forEach((bank) => {
            const option1 = document.createElement('option');
            option1.value = bank;
            option1.textContent = bank;
            fromBankSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = bank;
            option2.textContent = bank;
            toBankSelect.appendChild(option2);
          });
        }

        function setCurrentMonthFilter(month = null) {
          if (month) {
            filterMonth.value = month;
          } else if (!currentMonthFilterValue) {
            const now = new Date();
            const year = now.getFullYear();
            const monthValue = (now.getMonth() + 1).toString().padStart(2, '0');
            filterMonth.value = `${year}-${monthValue}`;
          }
          currentMonthFilterValue = filterMonth.value;
        }

        // REEMPLAZA LA FUNCIÓN "switchTab" EXISTENTE CON ESTA:
        function switchTab(tabName) {
          if (!tabName) return;

          document.querySelectorAll('.tab-pane').forEach((pane) => {
            pane.classList.add('hidden');
            pane.classList.remove('active');
          });
          document.querySelectorAll('.tab-button').forEach((button) => {
            button.classList.remove('active');
          });

          const activePane = document.getElementById(`${tabName}-content`);
          const activeButton = document.querySelector(`button[data-tab="${tabName}"]`);
          if (activePane) {
            activePane.classList.remove('hidden');
            activePane.classList.add('active');
          }
          if (activeButton) {
            activeButton.classList.add('active');
          }

          const actionButtons = {
            main: document.getElementById('main-action-btn'),
            saveBudget: document.getElementById('save-budgets-btn'),
            migrateRecurring: document.getElementById('migrate-all-recurring-btn'),
            deleteSelected: document.getElementById('delete-selected-btn'),
            addIncome: document.getElementById('add-income-btn'),
            addExpense: document.getElementById('add-expense-btn'),
          };

          Object.values(actionButtons).forEach((btn) => btn && btn.classList.add('hidden'));

          // La lógica de los botones se mantiene, ya que la nueva pestaña tiene sus propios botones
          switch (tabName) {
            case 'registros':
            case 'proyeccion':
              actionButtons.addIncome.classList.remove('hidden');
              actionButtons.addExpense.classList.remove('hidden');
              break;
            case 'recurrentes':
              actionButtons.main.classList.remove('hidden');
              actionButtons.migrateRecurring.classList.remove('hidden');
              document.getElementById('main-action-btn-text').textContent =
                'Añadir Gasto Recurrente';
              break;
            case 'tarjetas':
              actionButtons.main.classList.remove('hidden');
              document.getElementById('main-action-btn-text').textContent = 'Añadir Tarjeta';
              break;
            case 'presupuesto':
              actionButtons.saveBudget.classList.remove('hidden');
              break;
            // No se añade caso para 'gastos-comunes' porque tiene sus propios botones
          }

          const filtersContainer = document.getElementById('filters-container');
          if (filtersContainer && window.innerWidth > 768) {
            if (tabName === 'registros') {
              filtersContainer.style.display = 'flex';
            } else {
              filtersContainer.style.display = 'none';
            }
          }

          if (selectAllRegistrosCheckbox) selectAllRegistrosCheckbox.checked = false;
          if (selectAllProyeccionCheckbox) selectAllProyeccionCheckbox.checked = false;
          if (selectAllRecurrentesCheckbox) selectAllRecurrentesCheckbox.checked = false;

          updateDeleteButtonVisibility();

          renderAll();
        }

        function handleMainActionClick() {
          const activeTabButton = document.querySelector('.tab-button.active');
          if (!activeTabButton) return;

          const activeTab = activeTabButton.dataset.tab;

          // Lógica CONTEXTUAL para abrir el modal
          if (activeTab === 'registros') {
            modalContext = 'registros'; // Establece el contexto a 'registros'
            openTransactionModal();
          } else if (activeTab === 'proyeccion') {
            modalContext = 'proyeccion'; // Establece el contexto a 'proyeccion'
            openTransactionModal(); // Sí, abre el mismo modal, pero el contexto lo cambia todo
          } else if (activeTab === 'recurrentes') {
            openRecurringExpenseModal();
          } else if (activeTab === 'tarjetas') {
            openCreditCardModal();
          }
        }
        /**
         * Procesa el texto del panel de voz, lo analiza y guarda la transacción directamente.
         */
        async function processAndSaveVoiceText() {
          const voiceTextArea = document.getElementById('voice-text-input');
          const text = voiceTextArea.value;

          if (!text.trim()) {
            showToast('La caja de texto está vacía. No hay nada que guardar.', 'info');
            return;
          }

          // 1. Llama a nuestro nuevo analizador inteligente
          const transactionData = parseSpeechV2(text);

          if (!transactionData) {
            // Si parseSpeech devuelve null, es porque faltó un dato clave (como el monto).
            // El propio parseSpeech ya habrá mostrado el error específico.
            return;
          }

          // 2. Guarda la transacción directamente en Firebase
          showLoading();
          const appId = firebaseProjectId;
          const transactionsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/transactions`,
          );

          try {
            // Se simplifica el proceso: ya no se necesita un "batch".
            const newDocRef = doc(transactionsColRef);
            const newId = newDocRef.id;

            // Ahora solo se guarda en la colección de transacciones.
            await setDoc(newDocRef, { ...transactionData, id: newId });

            showToast('Transacción por voz registrada con éxito.', 'success');

            // 3. Oculta el panel de voz
            const voicePanel = document.getElementById('voice-input-panel');
            voicePanel.classList.add('hidden');
            voicePanel.classList.remove('visible');
            if (recognition) {
              recognition.stop();
            }
          } catch (error) {
            console.error('[Firestore] Error al guardar transacción por voz:', error);
            showMessageModal(
              'Error al Guardar',
              'No se pudo guardar el registro por voz.',
              'error',
            );
          } finally {
            hideLoading();
          }
        }

        function formatCurrency(amount) {
          return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(
            amount,
          );
        }

        function formatDate(dateString) {
          const date = new Date(dateString + 'T00:00:00');
          return date.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
          });
        }

        function formatMonthYear(dateString) {
          if (!dateString) return 'el período actual';
          const [year, month] = dateString.split('-');
          const date = new Date(year, month - 1);
          return date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        }

        /**
         * Muestra u oculta el botón "Eliminar Seleccionados" según si hay
         * casillas marcadas en la tabla de la pestaña activa.
         */
        /**
         * Muestra u oculta los botones de acción según el número de casillas marcadas.
         * - Si hay 1 seleccionada: Muestra el panel de Editar/Eliminar.
         * - Si hay >1 seleccionadas: Muestra el botón "Eliminar Seleccionados".
         * - Si no hay ninguna: Oculta todo.
         */
        function updateDeleteButtonVisibility() {
          const activeTabElement = document.querySelector('.tab-pane.active');
          const singleActionModal = document.getElementById('single-action-modal');
          if (!activeTabElement || !singleActionModal) return;

          const activeTab = activeTabElement.id.replace('-content', '');
          let selector, selectAllCheckbox;

          // Define los selectores según la pestaña activa
          if (activeTab === 'registros') {
            selector = '.transaction-checkbox';
            selectAllCheckbox = selectAllRegistrosCheckbox;
          } else if (activeTab === 'proyeccion') {
            selector = '.projection-checkbox';
            selectAllCheckbox = selectAllProyeccionCheckbox;
          } else if (activeTab === 'recurrentes') {
            selector = '.recurring-checkbox';
            selectAllCheckbox = selectAllRecurrentesCheckbox;
          } else {
            deleteSelectedBtn.classList.add('hidden');
            singleActionModal.classList.remove('active');
            return;
          }

          const allCheckboxes = document.querySelectorAll(`#${activeTab}-content ${selector}`);
          const checkedCheckboxes = document.querySelectorAll(
            `#${activeTab}-content ${selector}:checked`,
          );
          const checkedCount = checkedCheckboxes.length;

          // ===== LÓGICA PRINCIPAL =====
          if (checkedCount === 1) {
            // Si hay exactamente UNA selección
            deleteSelectedBtn.classList.add('hidden'); // Oculta el botón viejo
            singleActionModal.classList.add('active'); // Muestra el nuevo panel
          } else if (checkedCount > 1) {
            // Si hay MÁS DE UNA selección
            deleteSelectedBtn.classList.remove('hidden'); // Muestra el botón viejo
            singleActionModal.classList.remove('active'); // Oculta el nuevo panel
          } else {
            // Si NO HAY NINGUNA selección
            deleteSelectedBtn.classList.add('hidden'); // Oculta ambos
            singleActionModal.classList.remove('active');
          }

          // Actualiza el estado del checkbox "seleccionar todo"
          if (allCheckboxes.length > 0 && checkedCount === allCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else if (checkedCount > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          }
        }

        /**
         * Maneja la lógica para eliminar los elementos seleccionados de Firestore.
         */
        async function handleDeleteSelected() {
          const activeTab = document.querySelector('.tab-pane.active').id.replace('-content', '');
          let collectionName, checkboxSelector, itemTypeName;

          if (activeTab === 'registros') {
            collectionName = 'transactions';
            checkboxSelector = '.transaction-checkbox';
            itemTypeName = 'registros';
          } else if (activeTab === 'proyeccion') {
            collectionName = 'projections';
            checkboxSelector = '.projection-checkbox';
            itemTypeName = 'proyecciones';
          } else if (activeTab === 'recurrentes') {
            collectionName = 'recurringExpenses';
            checkboxSelector = '.recurring-checkbox';
            itemTypeName = 'gastos recurrentes';
          } else {
            return;
          }

          const checkedCheckboxes = document.querySelectorAll(
            `#${activeTab}-content ${checkboxSelector}:checked`,
          );
          const idsToDelete = Array.from(checkedCheckboxes).map((cb) => cb.dataset.id);

          if (idsToDelete.length === 0) {
            showToast('No has seleccionado ningún elemento para eliminar.', 'info');
            return;
          }

          openConfirmModal(
            `Eliminar ${itemTypeName} seleccionados`,
            `¿Estás seguro de que quieres eliminar permanentemente los ${idsToDelete.length} ${itemTypeName} seleccionados? Esta acción no se puede deshacer.`,
            async () => {
              showLoading();
              const appId = firebaseProjectId;
              const collectionRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/${collectionName}`,
              );
              try {
                const batch = writeBatch(db);
                idsToDelete.forEach((id) => {
                  const docRef = doc(collectionRef, id);
                  batch.delete(docRef);
                });
                await batch.commit();
                showToast(`${idsToDelete.length} ${itemTypeName} eliminados con éxito.`, 'success');
                // onSnapshot actualizará la UI automáticamente
              } catch (error) {
                console.error(`Error al eliminar ${itemTypeName} seleccionados:`, error);
                showMessageModal(
                  'Error al Eliminar',
                  `No se pudieron eliminar los ${itemTypeName} seleccionados.`,
                  'error',
                );
              } finally {
                hideLoading();
              }
            },
          );
        }

        /**
         * Orquesta el flujo de grabación por voz: muestra el panel de texto y activa el micrófono.
         */
        const handleQuickVoiceRecord = () => {
          switchTab('registros');
          const voicePanel = document.getElementById('voice-input-panel');
          voicePanel.classList.remove('hidden');
          voicePanel.classList.add('visible');
          handleVoiceCommand();
        };

        /**
         * Inicia el reconocimiento de voz y transcribe el resultado en el panel de texto.
         */
        const handleVoiceCommand = () => {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
            showToast('Tu navegador no soporta el reconocimiento de voz.', 'error');
            return;
          }

          const voiceTextArea = document.getElementById('voice-text-input');
          const quickVoiceBtnImg = document.querySelector('#quick-voice-record-btn img');
          isProcessingVoice = false;
          voiceTextArea.value = '';
          voiceTextArea.placeholder = 'Escuchando... por favor, habla ahora.';

          const recognition = new SpeechRecognition();
          recognition.lang = 'es-ES';
          recognition.interimResults = true;
          recognition.continuous = true;
          if (quickVoiceBtnImg) quickVoiceBtnImg.style.opacity = '0.5';

          recognition.start();

          recognition.onresult = (event) => {
            let transcript = Array.from(event.results)
              .map((result) => result[0])
              .map((result) => result.transcript)
              .join('');
            voiceTextArea.value = transcript;

            if (transcript.toLowerCase().includes('guardar') && !isProcessingVoice) {
              isProcessingVoice = true;
              recognition.stop();
              document.getElementById('save-voice-text-btn').click();
            }
          };

          recognition.onend = () => {
            if (quickVoiceBtnImg) quickVoiceBtnImg.style.opacity = '1';
            voiceTextArea.placeholder =
              'Ej: Gasto de mil doscientos en alquiler en wells fargo ayer guardar...';
          };

          recognition.onerror = (event) => {
            console.error('Error en el reconocimiento de voz:', event.error);
            if (quickVoiceBtnImg) quickVoiceBtnImg.style.opacity = '1';
            voiceTextArea.placeholder = 'Hubo un error al escuchar.';
          };
        };

        /**
         * MODULO PARSER DE NÚMEROS
         * Sistema autocontenido para interpretar números complejos en español.
         */
        const numberParser = (() => {
          const wordValues = {
            cero: 0,
            un: 1,
            una: 1,
            uno: 1,
            dos: 2,
            tres: 3,
            cuatro: 4,
            cinco: 5,
            seis: 6,
            siete: 7,
            ocho: 8,
            nueve: 9,
            diez: 10,
            once: 11,
            doce: 12,
            trece: 13,
            catorce: 14,
            quince: 15,
            dieciséis: 16,
            diecisiete: 17,
            dieciocho: 18,
            diecinueve: 19,
            veinte: 20,
            veintiún: 21,
            veintiuno: 21,
            veintidós: 22,
            veintitrés: 23,
            veinticuatro: 24,
            veinticinco: 25,
            veintiséis: 26,
            veintisiete: 27,
            veintiocho: 28,
            veintinueve: 29,
            treinta: 30,
            cuarenta: 40,
            cincuenta: 50,
            sesenta: 60,
            setenta: 70,
            ochenta: 80,
            noventa: 90,
            cien: 100,
            ciento: 100,
            doscientos: 200,
            trescientos: 300,
            cuatrocientos: 400,
            quinientos: 500,
            seiscientos: 600,
            setecientos: 700,
            ochocientos: 800,
            novecientos: 900,
          };
          const multipliers = { mil: 1000 };

          const parseChunk = (words) => {
            return words.reduce((acc, word) => acc + (wordValues[word] || 0), 0);
          };

          const parseSpanishNumber = (text) => {
            if (!text || typeof text !== 'string') return null;
            const cleanText = text.toLowerCase().trim();
            let integerPartStr = cleanText,
              decimalPartStr = '';
            const decimalSeparators = [' con ', ' punto '];

            for (const separator of decimalSeparators) {
              if (cleanText.includes(separator)) {
                const parts = cleanText.split(separator);
                integerPartStr = parts[0];
                decimalPartStr = parts.slice(1).join(separator);
                break;
              }
            }

            const words = integerPartStr.split(/\s+/).filter((w) => w !== 'y' && w);
            let total = 0,
              currentChunk = [];

            for (const word of words) {
              if (multipliers[word]) {
                const chunkValue = currentChunk.length > 0 ? parseChunk(currentChunk) : 1;
                total += chunkValue * multipliers[word];
                currentChunk = [];
              } else {
                currentChunk.push(word);
              }
            }
            total += parseChunk(currentChunk);

            if (decimalPartStr) {
              const decimalWords = decimalPartStr.split(/\s+/).filter((w) => w !== 'y' && w);
              total += parseChunk(decimalWords) / 100;
            }

            return total > 0 ? total : null;
          };
          return { parse: parseSpanishNumber };
        })();

        /**
         * Calcula la distancia de Levenshtein entre dos strings (mide su similitud).
         * Un resultado bajo (0, 1, 2) significa que son muy similares.
         */
        const levenshtein = (s1, s2) => {
          if (!s1.length) return s2.length;
          if (!s2.length) return s1.length;
          const arr = [];
          for (let i = 0; i <= s2.length; i++) {
            arr[i] = [i];
            for (let j = 1; j <= s1.length; j++) {
              arr[i][j] =
                i === 0
                  ? j
                  : Math.min(
                      arr[i - 1][j] + 1,
                      arr[i][j - 1] + 1,
                      arr[i - 1][j - 1] + (s1[j - 1] === s2[i - 1] ? 0 : 1),
                    );
            }
          }
          return arr[s2.length][s1.length];
        };
        /**
         * Analiza una cadena de texto de voz para extraer información de forma inteligente
         * usando coincidencia aproximada (Levenshtein) para robustez.
         */
        const parseSpeechV2 = (text) => {
          let lowerText = text.toLowerCase();
          let transaction = {};
          let remainingText = ` ${lowerText.replace(/\bguardar\b/g, '')} `;

          // --- Prioridad #1: Determinar TIPO de transacción (Ingreso/Gasto) ---
          const incomeKeywords = ['ingreso', 'gané', 'recibí', 'depósito', 'salario', 'pago de'];
          transaction.type = incomeKeywords.some((kw) => lowerText.includes(kw))
            ? 'income'
            : 'expense';

          // --- Prioridad #2: Extraer el MONTO (Lógica sin cambios) ---
          let amountFound = false;
          const numberWordMatch = remainingText.match(
            /(?:de|del|por)\s+((?:[a-zA-Z\s]+?))\s+(?:dólar|dólares|bolívares|euros)/,
          );
          if (numberWordMatch && numberWordMatch[1]) {
            const parsedAmount = numberParser.parse(numberWordMatch[1].trim());
            if (parsedAmount) {
              transaction.amount = parsedAmount;
              remainingText = remainingText.replace(numberWordMatch[0], ' ');
              amountFound = true;
            }
          }
          if (!amountFound) {
            const hybridMatch = remainingText.match(/(\d+)\s*(?:con|punto|,)\s*(\d+)/);
            if (hybridMatch) {
              transaction.amount = parseFloat(`${hybridMatch[1]}.${hybridMatch[2]}`);
              remainingText = remainingText.replace(hybridMatch[0], ' ');
              amountFound = true;
            }
          }
          if (!amountFound) {
            const numericMatch = remainingText.match(/(\d[\d,.]*)/);
            if (numericMatch) {
              transaction.amount = parseFloat(numericMatch[1].replace(',', '.'));
              remainingText = remainingText.replace(numericMatch[0], ' ');
              amountFound = true;
            }
          }
          if (!amountFound) {
            showToast('No se pudo detectar un monto válido en el comando.', 'error');
            return null;
          }

          const textWords = remainingText.trim().split(/\s+/);

          // --- Prioridad #3: Encontrar el BANCO con Coincidencia Aproximada (Lógica sin cambios) ---
          let bestBankMatch = { name: null, distance: 3, phrase: '' };
          for (const bank of appState.banks) {
            const bankLower = bank.toLowerCase();
            const bankWordCount = bank.split(' ').length;
            for (let i = 0; i <= textWords.length - bankWordCount; i++) {
              const phrase = textWords.slice(i, i + bankWordCount).join(' ');
              const distance = levenshtein(phrase, bankLower);
              if (distance < bestBankMatch.distance) {
                bestBankMatch = { name: bank, distance: distance, phrase: phrase };
              }
            }
          }
          if (bestBankMatch.name) {
            transaction.bank = bestBankMatch.name;
            remainingText = remainingText.replace(
              new RegExp(`\\b${bestBankMatch.phrase}\\b`, 'g'),
              ' ',
            );
          }

          // --- Prioridad #4: Encontrar la CATEGORÍA con Coincidencia Aproximada (NUEVA LÓGICA) ---
          let bestCategoryMatch = { name: null, distance: 3, phrase: '' };
          // Usamos .map(c => c.name) porque appState.categories es un array de objetos
          const categoryNames = appState.categories.map((c) => c.name);
          for (const category of categoryNames) {
            const categoryLower = category.toLowerCase();
            const categoryWordCount = category.split(' ').length;
            for (let i = 0; i <= textWords.length - categoryWordCount; i++) {
              const phrase = textWords.slice(i, i + categoryWordCount).join(' ');
              const distance = levenshtein(phrase, categoryLower);
              if (distance < bestCategoryMatch.distance) {
                bestCategoryMatch = { name: category, distance: distance, phrase: phrase };
              }
            }
          }
          if (bestCategoryMatch.name) {
            transaction.category = bestCategoryMatch.name;
            remainingText = remainingText.replace(
              new RegExp(`\\b${bestCategoryMatch.phrase}\\b`, 'g'),
              ' ',
            );
          }

          // --- Prioridad #5: Encontrar la DESCRIPCIÓN (NUEVA LÓGICA) ---
          let descriptionFound = false;
          // Ordenamos por longitud para encontrar frases más largas primero
          const sortedDescriptions = [...appState.descriptions].sort((a, b) => b.length - a.length);
          for (const desc of sortedDescriptions) {
            if (remainingText.toLowerCase().includes(desc.toLowerCase())) {
              transaction.description = desc; // Usamos la descripción guardada
              descriptionFound = true;
              break;
            }
          }

          if (!descriptionFound) {
            const remainingWords = remainingText
              .trim()
              .split(/\s+/)
              .filter((w) => w);
            if (remainingWords.length > 0) {
              // Limita la descripción a un máximo de 2 palabras
              transaction.description = toTitleCase(remainingWords.slice(0, 2).join(' '));
            }
          }

          // --- Rellenar datos por defecto si algo faltó ---
          if (!transaction.category) {
            transaction.category = transaction.type === 'income' ? 'Ingreso' : 'Compras';
          }
          if (!transaction.bank) {
            transaction.bank = appState.banks.length > 0 ? appState.banks[0] : 'General';
          }
          if (!transaction.description) {
            transaction.description = transaction.type === 'income' ? 'Ingreso' : 'Compras';
          }

          // Asignar fecha (lógica sin cambios)
          transaction.date = new Date().toISOString().split('T')[0];
          if (lowerText.includes('ayer')) {
            let yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            transaction.date = yesterday.toISOString().split('T')[0];
          }

          return transaction;
        };
        /**
         * Maneja la acción de edición para el único elemento seleccionado.
         */
        function handleSingleEditAction() {
          const selected = getSingleSelectedItem();
          if (!selected) return;

          // Llama a la función de abrir modal correspondiente según la pestaña
          if (selected.tab === 'registros') {
            openTransactionModal({ id: selected.id });
          } else if (selected.tab === 'recurrentes') {
            openRecurringExpenseModal(selected.id);
          } else if (selected.tab === 'proyeccion') {
            modalContext = 'proyeccion';
            openTransactionModal({ id: selected.id });
          }

          document.getElementById('single-action-modal').classList.remove('active');
        }

        /**
         * Maneja la acción de eliminación para el único elemento seleccionado.
         */
        function handleSingleDeleteAction() {
          const selected = getSingleSelectedItem();
          if (!selected) return;

          // Llama a la función de eliminar correspondiente según la pestaña
          if (selected.tab === 'registros') {
            deleteTransaction(selected.id);
          } else if (selected.tab === 'recurrentes') {
            deleteRecurringExpense(selected.id);
          } else if (selected.tab === 'proyeccion') {
            deleteProjection(selected.id);
          }

          document.getElementById('single-action-modal').classList.remove('active');
        }
        /**
         * Procesa los gastos recurrentes para registrar automáticamente los que han vencido
         * en el mes actual y que aún no han sido registrados.
         */
        async function processRecurringExpenses() {
          // Si no hay gastos recurrentes configurados, no hace nada.
          if (!appState.recurringExpenses || appState.recurringExpenses.length === 0) {
            console.log('[Auto-Registro] No hay gastos recurrentes para procesar.');
            return;
          }

          const today = new Date();
          const currentYear = today.getFullYear();
          const currentMonth = today.getMonth(); // 0 para Enero, 11 para Diciembre
          const currentDay = today.getDate();

          const transactionsToCreate = [];

          // 1. Revisa cada gasto recurrente configurado.
          for (const expense of appState.recurringExpenses) {
            const expenseDay = parseInt(expense.day, 10);

            // Solo considera los gastos cuya fecha de pago ya pasó en el mes actual.
            if (expenseDay <= currentDay) {
              // 2. Comprueba si ya existe un registro similar para este gasto en el mes actual.
              const alreadyExists = appState.transactions.some((t) => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                // La condición de duplicado: mismo año, mes, día, descripción y categoría.
                // El monto se ignora intencionadamente.
                return (
                  transactionDate.getFullYear() === currentYear &&
                  transactionDate.getMonth() === currentMonth &&
                  transactionDate.getDate() === expenseDay &&
                  t.description.toLowerCase() === expense.description.toLowerCase() &&
                  t.category === expense.category
                );
              });

              // 3. Si NO existe, lo añade a una lista para crearlo.
              if (!alreadyExists) {
                transactionsToCreate.push(expense);
              }
            }
          }

          // 4. Si hay transacciones en la lista, las crea en la base de datos.
          if (transactionsToCreate.length > 0) {
            console.log(
              `[Auto-Registro] Se van a registrar ${transactionsToCreate.length} gastos recurrentes.`,
            );
            showLoading();
            const appId = firebaseProjectId;
            const transactionsColRef = collection(
              db,
              `artifacts/${appId}/users/${userId}/transactions`,
            );
            const projectionsColRef = collection(
              db,
              `artifacts/${appId}/users/${userId}/projections`,
            );

            try {
              const batch = writeBatch(db);

              transactionsToCreate.forEach((expense) => {
                const newTransactionDate = new Date(currentYear, currentMonth, expense.day);
                const formattedDate = newTransactionDate.toISOString().split('T')[0];

                const newTransactionData = {
                  date: formattedDate,
                  description: expense.description,
                  category: expense.category,
                  bank: expense.bank,
                  amount: expense.amount,
                  type: 'expense',
                };

                // Crea el registro en ambas colecciones (Registros y Proyección) con el mismo ID
                const newDocRef = doc(transactionsColRef);
                const newId = newDocRef.id;
                batch.set(doc(transactionsColRef, newId), { ...newTransactionData, id: newId });
                //batch.set(doc(projectionsColRef, newId), { ...newTransactionData, id: newId });
              });

              await batch.commit();
              showToast(
                `${transactionsToCreate.length} gasto(s) recurrente(s) se registraron automáticamente.`,
                'success',
                4000,
              );
              // La UI se actualizará sola gracias a los listeners onSnapshot que ya existen.
            } catch (error) {
              console.error('[Auto-Registro] Error al registrar gastos recurrentes:', error);
              showMessageModal(
                'Error de Auto-Registro',
                'No se pudieron registrar los gastos recurrentes vencidos.',
                'error',
              );
            } finally {
              hideLoading();
            }
          } else {
            console.log(
              '[Auto-Registro] Todos los gastos recurrentes vencidos ya están registrados.',
            );
          }
        }
        /**
         * Intenta ejecutar el procesamiento de gastos recurrentes.
         * Solo se ejecuta UNA VEZ por sesión, cuando tanto las transacciones iniciales
         * como los gastos recurrentes iniciales se han cargado.
         */
        function tryProcessRecurringExpenses() {
          // Si ambas cargas iniciales no han terminado, o si el proceso ya se ejecutó, no hace nada.
          if (!initialTransactionsLoaded || !initialRecurringLoaded || recurringProcessed) {
            return;
          }

          // Marca que el proceso ya se va a ejecutar para no repetirlo.
          recurringProcessed = true;

          console.log(
            '[Auto-Registro] Datos listos. Iniciando la verificación de gastos recurrentes.',
          );
          // Llama a la función principal que hace el trabajo.
          processRecurringExpenses();
        }

        // --- REGISTRAR EL SERVICE WORKER PARA LA PWA ---
        // Esto le dice al navegador que empiece a usar nuestro "ayudante" para el modo sin conexión.
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker
              .register('./sw.js')
              .then((registration) => {
                console.log('Service Worker registrado con éxito:', registration);
              })
              .catch((error) => {
                console.log('Fallo en el registro del Service Worker:', error);
              });
          });
        }

        /**
         * Puebla la lista de videos en el modal y carga el primer video por defecto.
         */
        function populateTutorialsList() {
          const listContainer = document.getElementById('tutorials-list');
          if (!listContainer || tutorialVideos.length === 0) return;

          listContainer.innerHTML = ''; // Limpia la lista

          tutorialVideos.forEach((video, index) => {
            const item = document.createElement('div');
            item.className = 'tutorial-list-item';
            item.dataset.index = index;
            item.innerHTML = `
                          <h5>${video.title}</h5>
                          <p>${video.description}</p>
                      `;

            item.addEventListener('click', () => {
              playTutorialVideo(video.url, video.title, item);
            });

            listContainer.appendChild(item);
          });

          // Carga el primer video de la lista por defecto
          playTutorialVideo(
            tutorialVideos[0].url,
            tutorialVideos[0].title,
            listContainer.querySelector('.tutorial-list-item'),
          );
        }
        /**
         * Cambia el video que se está reproduciendo en el iframe.
         * @param {string} url - La URL del video a reproducir.
         * @param {string} title - El título del video.
         * @param {HTMLElement} clickedItem - El elemento de la lista al que se le hizo clic.
         */
        function playTutorialVideo(url, title, clickedItem) {
          const player = document.getElementById('tutorial-video-player');
          const videoTitleElement = document.getElementById('current-video-title');

          if (player) player.src = url;
          if (videoTitleElement) videoTitleElement.textContent = title;

          // Actualiza la clase 'active' en la lista
          const listContainer = document.getElementById('tutorials-list');
          if (listContainer) {
            listContainer.querySelector('.active')?.classList.remove('active');
          }
          if (clickedItem) {
            clickedItem.classList.add('active');
          }
        }

        /**
         * Abre el modal personalizado para ingresar un valor de distribución.
         * @param {object} options - Opciones de configuración.
         * @param {'percentage'|'manual'} options.method - El método para el cual se pide el valor.
         * @param {number} options.currentValue - El valor actual para pre-llenar el input.
         * @param {function} options.callback - La función a ejecutar al guardar, recibe el nuevo valor.
         */
        function openDistributionInputModal({ method, currentValue, callback }) {
          const modal = document.getElementById('distribution-input-modal');
          const title = document.getElementById('distribution-modal-title');
          const label = document.getElementById('distribution-modal-label');
          const input = document.getElementById('distribution-modal-input');

          if (method === 'percentage') {
            title.textContent = 'Ingresar Porcentaje';
            label.textContent = 'Porcentaje (%)';
            input.placeholder = '50';
          } else {
            title.textContent = 'Ingresar Monto Manual';
            label.textContent = 'Monto Fijo ($)';
            input.placeholder = '100.00';
          }

          input.value = currentValue || '';
          distributionModalCallback = callback; // Guardamos la función callback

          modal.classList.add('active');
          input.focus();
        }

        function closeDistributionInputModal() {
          const modal = document.getElementById('distribution-input-modal');
          document.getElementById('distribution-form').reset();
          clearValidationErrors();
          distributionModalCallback = null; // Limpiamos el callback
          modal.classList.remove('active');
        }

        /**
         * Abre el modal de selección de banco para un pago de gasto común.
         * @param {object} data - La información pre-calculada de la transacción.
         */
        function openSharedExpenseBankModal(data) {
          tempSharedExpenseData = data; // Guardar datos temporalmente
          const modal = document.getElementById('shared-expense-bank-modal');
          const summaryEl = document.getElementById('shared-expense-summary');

          // Poblar el resumen en el modal para que el usuario sepa qué está registrando
          summaryEl.innerHTML = `
                Registrando un gasto de <strong>${formatCurrency(data.amount)}</strong> por 
                <strong>"${data.description}"</strong> con fecha 
                <strong>${formatDate(data.date)}</strong>.
            `;

          // Poblar el select con los bancos del usuario
          populateSelectWithOptions(
            'shared-expense-bank-select',
            appState.banks,
            null,
            null,
            'Selecciona un banco...',
          );

          modal.classList.add('active');
        }

        /**
         * Cierra el modal de selección de banco.
         */
        function closeSharedExpenseBankModal() {
          const modal = document.getElementById('shared-expense-bank-modal');
          modal.classList.remove('active');
          tempSharedExpenseData = null; // Limpiar datos temporales para evitar errores
          clearValidationErrors();
        }

        /**
         * Maneja la confirmación final: añade el banco y guarda la transacción en Firebase.
         */
        async function handleConfirmSharedExpense() {
          if (!tempSharedExpenseData) return;

          const bankSelect = document.getElementById('shared-expense-bank-select');
          const bankError = document.getElementById('shared-expense-bank-error');
          const selectedBank = bankSelect.value;

          if (!validateRequired(bankSelect, bankError, 'Debes seleccionar un banco.')) {
            return;
          }

          const transactionData = {
            ...tempSharedExpenseData,
            bank: selectedBank,
          };

          const confirmBtn = document.getElementById('confirm-shared-expense-bank-btn');
          showButtonLoading(confirmBtn);

          const appId = firebaseProjectId;
          const transactionsColRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/transactions`,
          );

          try {
            const newDocRef = doc(transactionsColRef);
            const newId = newDocRef.id;

            const dataToSave = {
              id: newId,
              date: transactionData.date,
              description: transactionData.description,
              category: transactionData.category,
              bank: transactionData.bank,
              amount: transactionData.amount,
              type: 'income',
            };

            await setDoc(newDocRef, dataToSave);
            showToast('Pago de gasto común registrado con éxito.', 'success');

            // === INICIO DE LA NUEVA LÓGICA DE PERSISTENCIA ===
            // 1. Encontrar el ítem en el estado local.
            const itemToUpdate = appState.gastosComunes.items.find(
              (item) => item.id === transactionData.originalItemId,
            );

            if (itemToUpdate) {
              const personIndex = transactionData.originalPersonIndex;
              // Extraemos solo el día del string de fecha 'YYYY-MM-DD'
              const dayOfPayment = new Date(transactionData.date + 'T00:00:00').getDate();

              // 2. Asegurarse de que la estructura de distribución exista.
              if (!itemToUpdate.distribution) itemToUpdate.distribution = {};
              if (!itemToUpdate.distribution[personIndex])
                itemToUpdate.distribution[personIndex] = { method: 'equal' };

              // 3. Añadir la marca de que fue pagado en ese día.
              itemToUpdate.distribution[personIndex].paidDay = dayOfPayment;

              // 4. Guardar el estado completo de gastosComunes en Firebase.
              // Esto disparará el 'onSnapshot' y la tabla se volverá a dibujar correctamente.
              await saveGastosComunesState();
            }
            // === FIN DE LA NUEVA LÓGICA ===

            closeSharedExpenseBankModal();
          } catch (error) {
            console.error('[Firestore] Error al registrar pago de gasto común:', error);
            showMessageModal(
              'Error al Registrar',
              'No se pudo guardar el pago en la tabla de registros.',
              'error',
            );
          } finally {
            hideButtonLoading(confirmBtn);
          }
        }

        /**
         * Guarda el estado actual de la sección de gastos comunes en Firebase.
         */
        async function saveGastosComunesState() {
          if (!userId) return;
          const appId = firebaseProjectId;
          const gastosComunesDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/user_data/gastosComunes`,
          );
          try {
            // Se clona el objeto para evitar problemas de referencia circular de Firebase
            const stateToSave = JSON.parse(JSON.stringify(appState.gastosComunes));
            await setDoc(gastosComunesDocRef, stateToSave);
            console.log('[Firestore] Estado de Gastos Comunes guardado.');
          } catch (error) {
            console.error('[Firestore] Error al guardar estado de Gastos Comunes:', error);
            showToast('No se pudo guardar el cambio en Gastos Comunes.', 'error');
          }
        }

        /**
         * Renderiza la tabla completa de gastos comunes basándose en el appState.
         */
        function renderGastosComunesTable() {
          const table = document.getElementById('gastos-comunes-table');
          const thead = table.querySelector('thead') || table.createTHead();
          const tbody = table.querySelector('tbody') || table.createTBody();
          const tfoot = table.querySelector('tfoot') || table.createTFoot();
          const noDataMessage = document.getElementById('no-shared-expenses-message');

          thead.innerHTML = '';
          tbody.innerHTML = '';
          tfoot.innerHTML = '';

          const { people, items } = appState.gastosComunes;

          if (!people || !items || (people.length === 0 && items.length === 0)) {
            table.classList.add('hidden');
            noDataMessage.classList.remove('hidden');
            return;
          }
          table.classList.remove('hidden');
          noDataMessage.classList.add('hidden');

          const headerRow = thead.insertRow();
          headerRow.innerHTML = `
            <th>Ítem a Pagar</th>
            <th>Monto Total</th>
          `;
          people.forEach((person, index) => {
            const th = document.createElement('th');
            th.innerHTML = `
            <div class="person-header-container">
              <div contenteditable="true" class="person-name-editable" data-person-index="${index}">${
              person.name || `Persona ${index + 1}`
            }</div>
              <span class="delete-person-btn" data-person-index="${index}" title="Eliminar Persona">&#x2716;</span>
            </div>
          `;
            headerRow.appendChild(th);
          });
          headerRow.insertAdjacentHTML('beforeend', '<th class="actions-column"></th>');

          items.forEach((item) => {
            const itemRow = tbody.insertRow();
            itemRow.dataset.itemId = item.id;
            itemRow.insertCell().innerHTML = `<input type="text" class="table-input item-name-input" value="${
              item.name || ''
            }" placeholder="Ej: Alquiler">`;
            itemRow.insertCell().innerHTML = `<input type="number" class="table-input item-total-input" value="${
              item.totalAmount || ''
            }" placeholder="0.00" step="0.01">`;

            people.forEach((_, personIndex) => {
              const distCell = itemRow.insertCell();
              distCell.className = 'distribution-cell';
              distCell.dataset.personIndex = personIndex;

              // === INICIO DE LA LÓGICA DE RENDERIZADO CONDICIONAL ===
              const distData = item.distribution?.[personIndex] || { method: 'equal', value: 0 };
              const paidDay = distData.paidDay; // Obtenemos el día de pago si existe.
              const isPaid = !!paidDay;

              let indicatorText = '';
              switch (distData.method) {
                case 'percentage':
                  indicatorText = `${distData.value || 0}%`;
                  break;
                case 'manual':
                  indicatorText = 'Manual';
                  break;
                default:
                  indicatorText = 'Igual';
                  break;
              }

              const calculatedAmount = calculateCellAmount(item, personIndex);

              // Aplicamos la clase de color verde si está pagado.
              let amountClass = 'font-semibold text-lg';
              if (isPaid) {
                amountClass += ' text-green-500';
              }

              let inputAndButtonHtml = '';
              if (isPaid) {
                // Si está pagado, mostramos el input deshabilitado con el día y un check.
                inputAndButtonHtml = `
                  <input
                    type="number"
                    class="table-input w-14 text-center shared-expense-day-input"
                    value="${paidDay}"
                    disabled
                    style="background-color: #2E3A4B; cursor: not-allowed;"
                  >
                  <button
                    class="register-shared-expense-btn bg-green-800 text-white rounded px-2 py-1 text-xs"
                    title="Pago ya registrado"
                    disabled
                  >
                    ✔
                  </button>
                `;
              } else {
                // Si no está pagado, mostramos el input vacío y el botón 'OK'.
                inputAndButtonHtml = `
                  <input
                    type="number"
                    min="1" max="31"
                    class="table-input w-14 text-center shared-expense-day-input"
                    placeholder="Día"
                    title="Día del pago (1-31)"
                  >
                  <button
                    class="register-shared-expense-btn bg-green-600 text-white rounded px-2 py-1 text-xs hover:bg-green-700 transition"
                    data-item-id="${item.id}"
                    data-person-index="${personIndex}"
                    title="Registrar este pago"
                  >
                    OK
                  </button>
                `;
              }

              distCell.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <span class="${amountClass}">${formatCurrency(calculatedAmount)}</span>
                    <span class="method-indicator -mt-1">${indicatorText}</span>
                    <div class="flex items-center gap-1 mt-1">
                        ${inputAndButtonHtml}
                    </div>
                </div>
              `;
              // === FIN DE LA LÓGICA DE RENDERIZADO CONDICIONAL ===
            });
            itemRow.insertCell(
              people.length + 2,
            ).innerHTML = `<button class="delete-item-btn" title="Eliminar Ítem">&#x1F5D1;</button>`;
          });

          const footerRow = tfoot.insertRow();
          footerRow.insertCell().textContent = 'TOTAL POR PERSONA';
          const totalGeneral = items.reduce(
            (sum, item) => sum + (parseFloat(item.totalAmount) || 0),
            0,
          );
          footerRow.insertCell().innerHTML = `<span class="total-general">${formatCurrency(
            totalGeneral,
          )}</span>`;
          people.forEach((_, personIndex) => {
            const totalPerPerson = items.reduce(
              (sum, item) => sum + calculateCellAmount(item, personIndex),
              0,
            );
            footerRow.insertCell().textContent = formatCurrency(totalPerPerson);
          });
          footerRow.insertCell();
        }

        /**
         * Calcula el monto para una celda específica basado en el método de distribución.
         */
        function calculateCellAmount(item, personIndex) {
          const distData = item.distribution?.[personIndex] || { method: 'equal' };
          const totalAmount = parseFloat(item.totalAmount) || 0;

          if (totalAmount === 0) return 0;

          switch (distData.method) {
            case 'percentage':
              return totalAmount * ((parseFloat(distData.value) || 0) / 100);
            case 'manual':
              return parseFloat(distData.value) || 0;
            case 'equal':
            default:
              const equalParticipants =
                Object.values(item.distribution || {}).filter((d) => d.method === 'equal').length ||
                appState.gastosComunes.people.length;
              return totalAmount / equalParticipants;
          }
        }

        /**
         * Muestra el popover para seleccionar el método de distribución.
         */
        function showDistributionPopover(cell) {
          hideDistributionPopover(); // Oculta cualquier otro popover abierto
          const popover = document.getElementById('distribution-popover');
          activePopoverCell = cell;

          const rect = cell.getBoundingClientRect();
          popover.style.top = `${rect.bottom + window.scrollY}px`;
          popover.style.left = `${rect.left + window.scrollX}px`;

          popover.classList.remove('hidden');
          cell.classList.add('active');
        }

        /**
         * Oculta el popover de distribución.
         */
        function hideDistributionPopover() {
          const popover = document.getElementById('distribution-popover');
          if (popover) popover.classList.add('hidden');
          if (activePopoverCell) {
            activePopoverCell.classList.remove('active');
            activePopoverCell = null;
          }
        }
      });
    </script>

    <script>
      const contributionTypeSelect = document.getElementById('contribution401kType');
      const contributionValueInput = document.getElementById('contribution401kValue');
      const contributionLabel = document.getElementById('contribution401kLabel');
      contributionTypeSelect.addEventListener('change', () => {
        if (contributionTypeSelect.value === 'percent') {
          contributionLabel.textContent = 'Valor 401(k) (%)';
          contributionValueInput.value = '5';
        } else {
          contributionLabel.textContent = 'Valor 401(k) ($)';
          contributionValueInput.value = '100';
        }
      });
      document.getElementById('calculateBtn').addEventListener('click', () => {
        // --- 1. OBTENER DATOS DEL USUARIO ---
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
        const totalHours = parseFloat(document.getElementById('hoursWorked').value) || 0;
        const filingStatus = document.getElementById('filingStatus').value;
        const contribution401kType = document.getElementById('contribution401kType').value;
        const contribution401kValue =
          parseFloat(document.getElementById('contribution401kValue').value) || 0;
        const medicalDeduction = parseFloat(document.getElementById('medicalDeduction').value) || 0;
        const dentalDeduction = parseFloat(document.getElementById('dentalDeduction').value) || 0;
        const visionDeduction = parseFloat(document.getElementById('visionDeduction').value) || 0;
        const loan401k = parseFloat(document.getElementById('loan401k').value) || 0;
        const payPeriods = 26; // Quincenal
        const regularHoursThreshold = 80;
        // --- 2. CONSTANTES FISCALES 2025 ---
        const FICA_RATES = {
          SOCIAL_SECURITY: 0.062,
          MEDICARE: 0.0145,
        };
        const FEDERAL_TAX = {
          DEDUCTION: { single: 15000, married: 30000 },
          BRACKETS: {
            single: [
              { rate: 0.1, upto: 11925 },
              { rate: 0.12, upto: 48475 },
              { rate: 0.22, upto: 103350 },
              { rate: 0.24, upto: 197300 },
              { rate: 0.32, upto: 250525 },
              { rate: 0.35, upto: 626350 },
              { rate: 0.37, upto: Infinity },
            ],
            married: [
              { rate: 0.1, upto: 23850 },
              { rate: 0.12, upto: 96950 },
              { rate: 0.22, upto: 206700 },
              { rate: 0.24, upto: 394600 },
              { rate: 0.32, upto: 501050 },
              { rate: 0.35, upto: 751600 },
              { rate: 0.37, upto: Infinity },
            ],
          },
        };
        // --- 3. CÁLCULOS PRINCIPALES ---
        // Salario Bruto con Overtime
        let regularHours = Math.min(totalHours, regularHoursThreshold);
        let overtimeHours = Math.max(0, totalHours - regularHoursThreshold);
        let overtimeRate = hourlyRate * 1.5;
        let grossPay = regularHours * hourlyRate + overtimeHours * overtimeRate;
        // Deducciones Pre-Impuestos (401k Contribution)
        let contribution401kAmount = 0;
        if (contribution401kType === 'percent') {
          contribution401kAmount = grossPay * (contribution401kValue / 100);
        } else {
          contribution401kAmount = contribution401kValue;
        }
        const preTaxDeductions =
          contribution401kAmount + medicalDeduction + dentalDeduction + visionDeduction;
        // Ingreso Imponible para Impuesto Federal
        const annualTaxableIncome = (grossPay - preTaxDeductions) * payPeriods;
        // Calcular Impuesto Federal Anual
        const standardDeduction = FEDERAL_TAX.DEDUCTION[filingStatus];
        const finalTaxableIncome = Math.max(0, annualTaxableIncome - standardDeduction);
        const brackets = FEDERAL_TAX.BRACKETS[filingStatus];
        let federalTaxAnnual = 0;
        let incomeLeft = finalTaxableIncome;
        let previousLimit = 0;
        for (const bracket of brackets) {
          if (incomeLeft > 0) {
            const taxableInBracket = Math.min(incomeLeft, bracket.upto - previousLimit);
            federalTaxAnnual += taxableInBracket * bracket.rate;
            incomeLeft -= taxableInBracket;
            previousLimit = bracket.upto;
          }
        }
        const federalTaxPerPeriod = federalTaxAnnual / payPeriods;
        // Calcular Impuestos FICA (Social Security & Medicare)
        // Se basa en el Salario Bruto total
        const socialSecurityTax = grossPay * FICA_RATES.SOCIAL_SECURITY;
        const medicareTax = grossPay * FICA_RATES.MEDICARE;
        const ficaTaxes = socialSecurityTax + medicareTax;
        // Deducciones Post-Impuestos
        const postTaxDeductions = loan401k;
        // Calcular Salario Neto
        const totalDeductions =
          preTaxDeductions + federalTaxPerPeriod + ficaTaxes + postTaxDeductions;
        const netPay = grossPay - totalDeductions;
        // --- 4. MOSTRAR RESULTADOS ---
        document.getElementById('results').classList.remove('hidden');
        const formatCurrency = (value) =>
          `$${Math.max(0, value)
            .toFixed(2)
            .replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
        document.getElementById('grossPayResult').textContent = formatCurrency(grossPay);
        document.getElementById('preTaxDeductionsResult').textContent =
          formatCurrency(preTaxDeductions);
        document.getElementById('federalTaxResult').textContent =
          formatCurrency(federalTaxPerPeriod);
        document.getElementById('ficaTaxResult').textContent = formatCurrency(ficaTaxes);
        document.getElementById('postTaxDeductionsResult').textContent =
          formatCurrency(postTaxDeductions);
        document.getElementById('netPayResult').textContent = formatCurrency(netPay);
      });
    </script>
  </body>
</html>
